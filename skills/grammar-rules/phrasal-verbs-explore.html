<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>INTUITY - Phrasal Verbs Explorer</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0d0d0d;
      background-image: radial-gradient(circle at 20% 50%, rgba(201, 169, 97, 0.04) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(201, 169, 97, 0.03) 0%, transparent 50%);
      color: #e5e5e5;
      min-height: 100vh;
      padding: 1rem;
      overflow-x: hidden;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }
    
    /* TOP NAV - matches integrated file */
    .top-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      margin-bottom: 0.5rem;
      gap: 1rem;
    }
    
    .nav-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .nav-link {
      color: #8e8e93;
      text-decoration: none;
      font-size: 0.875rem;
      font-weight: 500;
      transition: color 0.3s ease;
      white-space: nowrap;
    }
    
    .nav-link:hover {
      color: #C9A961;
    }
    
    .nav-center {
      flex: 1;
      text-align: center;
    }
    
    .nav-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      color: #C9A961;
      letter-spacing: -0.04em;
      text-transform: uppercase;
      background: linear-gradient(135deg, #C9A961 0%, rgba(201, 169, 97, 0.8) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    /* HEADER - matches integrated file */
    header {
      text-align: center;
      margin-bottom: 0.5rem;
      padding: 0.5rem 0 0.25rem;
    }
    
    .subtitle {
      font-size: 0.75rem;
      color: #8e8e93;
      margin-bottom: 0.25rem;
      font-weight: 500;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }
    
    .author {
      font-size: 0.625rem;
      color: #636366;
      font-weight: 400;
      letter-spacing: 0.02em;
    }

    /* MODE TOGGLE - matches integrated file */
    .mode-toggle-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin: 1rem 0;
      padding: 0.75rem;
    }

    .mode-toggle {
      display: inline-flex;
      background: rgba(0,0,0,0.4);
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.06);
      overflow: hidden;
    }

    .mode-btn {
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 0.65rem;
      padding: 0.4rem 1rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
      font-family: inherit;
    }

    .mode-btn.active {
      background: rgba(201, 169, 97, 0.2);
      color: #f9fafb;
    }

    .mode-btn:hover:not(.active) {
      color: #d1d1d6;
    }

    /* VERB SELECTOR */
    .verb-selector {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: rgba(28, 28, 30, 0.6);
      backdrop-filter: blur(40px) saturate(150%);
      border-radius: 1rem;
      border: 1px solid rgba(201, 169, 97, 0.25);
    }

    .verb-btn {
      padding: 0.5rem 1rem;
      background: rgba(201, 169, 97, 0.15);
      border: 1px solid rgba(201, 169, 97, 0.3);
      border-radius: 0.625rem;
      color: #C9A961;
      cursor: pointer;
      font-size: 0.8125rem;
      font-weight: 600;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .verb-btn:hover {
      background: rgba(201, 169, 97, 0.25);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(201, 169, 97, 0.3);
    }

    .verb-btn.active {
      background: rgba(201, 169, 97, 0.35);
      border-color: #C9A961;
      box-shadow: 0 4px 16px rgba(201, 169, 97, 0.4);
    }

    /* MAIN STAGE */
    .main-stage {
      background: rgba(28, 28, 30, 0.6);
      backdrop-filter: blur(40px) saturate(150%);
      border-radius: 1.25rem;
      border: 1px solid rgba(201, 169, 97, 0.25);
      padding: 2rem;
      margin-bottom: 1.5rem;
      min-height: 600px;
      position: relative;
    }

    /* MIND MAP CANVAS */
    .mindmap-canvas {
      position: relative;
      width: 100%;
      height: 500px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 2rem;
    }

    .verb-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 3rem;
      font-weight: 700;
      color: #C9A961;
      opacity: 0;
      transition: all 0.5s ease;
      z-index: 10;
    }

    .verb-center.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }

    /* PARTICLES */
    .particle {
      position: absolute;
      padding: 0.75rem 1.25rem;
      background: rgba(96, 165, 250, 0.2);
      border: 2px solid rgba(96, 165, 250, 0.4);
      border-radius: 0.75rem;
      color: #60a5fa;
      font-size: 1rem;
      font-weight: 600;
      opacity: 0;
      transform: scale(0);
      transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 5;
    }

    .particle.show {
      opacity: 1;
      transform: scale(1);
      animation: gentleHover 2s ease-in-out infinite;
    }

    @keyframes gentleHover {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }

    /* PARTICLE POSITIONS (Radial) */
    .particle.pos-0 { top: 5%; left: 50%; transform: translateX(-50%) scale(0); }
    .particle.pos-1 { top: 15%; right: 15%; }
    .particle.pos-2 { top: 40%; right: 5%; }
    .particle.pos-3 { bottom: 15%; right: 15%; }
    .particle.pos-4 { bottom: 5%; left: 50%; transform: translateX(-50%) scale(0); }
    .particle.pos-5 { bottom: 15%; left: 15%; }
    .particle.pos-6 { top: 40%; left: 5%; }
    .particle.pos-7 { top: 15%; left: 15%; }
    .particle.pos-8 { top: 50%; right: 20%; transform: translateY(-50%) scale(0); }
    .particle.pos-9 { top: 50%; left: 20%; transform: translateY(-50%) scale(0); }

    /* CONNECTION LINES */
    .connections {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    .connection-line {
      stroke: rgba(201, 169, 97, 0.3);
      stroke-width: 2;
      fill: none;
      stroke-dasharray: 200;
      stroke-dashoffset: 200;
      transition: stroke-dashoffset 0.5s ease;
    }

    .connection-line.show {
      stroke-dashoffset: 0;
    }

    /* TEXT DISPLAY */
    .text-display {
      background: rgba(48, 48, 51, 0.5);
      border-radius: 0.875rem;
      padding: 1.5rem;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      margin-bottom: 1.5rem;
      border: 1px solid rgba(84, 84, 88, 0.2);
    }

    .phrasal-verb-display {
      font-size: 1.75rem;
      font-weight: 700;
      color: #60a5fa;
      margin-bottom: 0.75rem;
      opacity: 0;
      transition: all 0.4s ease;
    }

    .phrasal-verb-display.show {
      opacity: 1;
    }

    .meaning-display {
      font-size: 1rem;
      color: #e5e5e7;
      font-style: italic;
      margin-bottom: 0.5rem;
      opacity: 0;
      transition: all 0.4s ease 0.2s;
    }

    .meaning-display.show {
      opacity: 1;
    }

    .example-display {
      font-size: 0.9375rem;
      color: #9ca3af;
      padding: 0.75rem 1.25rem;
      background: rgba(28, 28, 30, 0.6);
      border-radius: 0.5rem;
      border-left: 3px solid rgba(96, 165, 250, 0.5);
      max-width: 90%;
      opacity: 0;
      transition: all 0.4s ease 0.4s;
    }

    .example-display.show {
      opacity: 1;
    }

    /* CONTROLS */
    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .control-btn {
      width: 3.5rem;
      height: 3.5rem;
      border-radius: 50%;
      background: rgba(201, 169, 97, 0.2);
      border: 2px solid rgba(201, 169, 97, 0.4);
      color: #C9A961;
      font-size: 1.25rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .control-btn:hover:not(:disabled) {
      background: rgba(201, 169, 97, 0.35);
      transform: scale(1.1);
      box-shadow: 0 4px 16px rgba(201, 169, 97, 0.5);
    }

    .control-btn:active {
      transform: scale(0.95);
    }

    .control-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .control-btn.play-pause {
      width: 4rem;
      height: 4rem;
      background: rgba(201, 169, 97, 0.3);
      border: 2px solid #C9A961;
    }

    .progress-indicator {
      font-size: 0.9375rem;
      color: #8e8e93;
      font-weight: 600;
    }

    .progress-indicator .current {
      color: #C9A961;
      font-size: 1.25rem;
    }

    /* SLIDE DOTS */
    .slide-dots {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .slide-dot {
      width: 0.625rem;
      height: 0.625rem;
      border-radius: 50%;
      background: rgba(99, 99, 102, 0.3);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .slide-dot:hover {
      background: rgba(201, 169, 97, 0.5);
    }

    .slide-dot.active {
      background: #C9A961;
      width: 2rem;
      border-radius: 0.3125rem;
      box-shadow: 0 0 8px rgba(201, 169, 97, 0.5);
    }

    /* SPEED CONTROL */
    .speed-control {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      margin-top: 1rem;
    }

    .speed-btn {
      padding: 0.375rem 0.75rem;
      background: rgba(99, 99, 102, 0.25);
      border: 1px solid rgba(99, 99, 102, 0.3);
      border-radius: 0.5rem;
      color: #8e8e93;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .speed-btn:hover {
      background: rgba(99, 99, 102, 0.35);
      color: #e5e5e7;
    }

    .speed-btn.active {
      background: rgba(201, 169, 97, 0.25);
      border-color: rgba(201, 169, 97, 0.4);
      color: #C9A961;
    }

    /* LOADING */
    .loading {
      text-align: center;
      padding: 3rem;
      color: #8e8e93;
    }

    /* MOBILE */
    @media (max-width: 768px) {
      .mode-btn {
        font-size: 0.6rem;
        padding: 0.35rem 0.75rem;
      }

      .mindmap-canvas {
        height: 400px;
      }

      .verb-center {
        font-size: 2rem;
      }

      .particle {
        padding: 0.5rem 0.875rem;
        font-size: 0.875rem;
      }

      .phrasal-verb-display {
        font-size: 1.25rem;
      }

      .control-btn {
        width: 3rem;
        height: 3rem;
        font-size: 1rem;
      }

      .control-btn.play-pause {
        width: 3.5rem;
        height: 3.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    
    <!-- TOP NAVIGATION - matches integrated file -->
    <div class="top-nav">
      <div class="nav-left">
        <a href="../../index.html?openModal=grammar" class="nav-link">‚Üê Back</a>
      </div>
      <div class="nav-center">
        <div class="nav-title">INTUITY</div>
      </div>
    </div>

    <!-- HEADER - matches integrated file -->
    <header>
      <p class="subtitle">Interactive Grammar System</p>
      <p class="author">Majid Nashtai ¬∑ B2 First Phrasal Verbs</p>
      
      <div class="mode-toggle-container">
        <div class="mode-toggle">
          <button class="mode-btn active" data-mode="explore">üó∫Ô∏è Explore</button>
          <button class="mode-btn" data-mode="rules">üìñ Rules</button>
          <button class="mode-btn" data-mode="practice">‚úçÔ∏è Practice</button>
          <button class="mode-btn" data-mode="gapfill">üìù Quiz</button>
        </div>
      </div>
    </header>

    <!-- VERB SELECTOR -->
    <div class="verb-selector" id="verbSelector">
      <button class="verb-btn active" data-verb="go">GO</button>
      <button class="verb-btn" data-verb="take">TAKE</button>
      <button class="verb-btn" data-verb="look">LOOK</button>
      <button class="verb-btn" data-verb="get">GET</button>
      <button class="verb-btn" data-verb="put">PUT</button>
      <button class="verb-btn" data-verb="keep">KEEP</button>
    </div>

    <!-- MAIN STAGE -->
    <div class="main-stage">
      
      <!-- MIND MAP CANVAS -->
      <div class="mindmap-canvas" id="mindmapCanvas">
        <svg class="connections" id="connectionsLayer"></svg>
        <div class="verb-center" id="verbCenter"></div>
        <div id="particlesContainer"></div>
      </div>

      <!-- TEXT DISPLAY -->
      <div class="text-display">
        <div class="phrasal-verb-display" id="phrasalVerbDisplay"></div>
        <div class="meaning-display" id="meaningDisplay"></div>
        <div class="example-display" id="exampleDisplay"></div>
      </div>

      <!-- CONTROLS -->
      <div class="controls">
        <button class="control-btn" id="prevBtn" onclick="prevSlide()">‚Üê</button>
        <button class="control-btn play-pause" id="playPauseBtn" onclick="togglePlayPause()">‚ñ∂Ô∏è</button>
        <button class="control-btn" id="nextBtn" onclick="nextSlide()">‚Üí</button>
      </div>

      <div class="progress-indicator" id="progressIndicator">
        <span class="current" id="currentSlide">0</span> / <span id="totalSlides">0</span>
      </div>

      <!-- SLIDE DOTS -->
      <div class="slide-dots" id="slideDots"></div>

      <!-- SPEED CONTROL -->
      <div class="speed-control">
        <button class="speed-btn" data-speed="5000" onclick="setSpeed(5000)">Slow</button>
        <button class="speed-btn active" data-speed="6000" onclick="setSpeed(6000)">Normal</button>
        <button class="speed-btn" data-speed="8000" onclick="setSpeed(8000)">Relaxed</button>
      </div>

    </div>

  </div>

  <script>
    // STATE
    let phrasalVerbsData = null;
    let currentVerb = 'go';
    let currentSlide = 0;
    let isPlaying = false;
    let playInterval = null;
    let slideDelay = 6000; // milliseconds per slide
    let slides = [];

    // INITIALIZE
    async function init() {
      try {
        const response = await fetch('../../data/grammar-rules/phrasal-verbs-rules.json');
        const data = await response.json();
        phrasalVerbsData = data;
        
        setupVerbSelector();
        setupModeNavigation();
        loadVerb('go');
        
      } catch (error) {
        console.error('Error loading data:', error);
        document.querySelector('.main-stage').innerHTML = '<div class="loading">Error loading phrasal verbs data</div>';
      }
    }

    // MODE NAVIGATION
    function setupModeNavigation() {
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const mode = btn.dataset.mode;
          
          if (mode === 'explore') {
            // Already in explore mode
            return;
          }
          
          // Navigate to parent page with mode parameter
          // Check if we're in an iframe
          if (window.parent !== window) {
            // Tell parent to switch mode
            window.parent.postMessage({ action: 'switchMode', mode: mode }, '*');
          } else {
            // Standalone - redirect to rules page with mode
            window.location.href = `phrasal-verbs-rules.html?mode=${mode}`;
          }
        });
      });
    }

    // VERB SELECTOR
    function setupVerbSelector() {
      document.querySelectorAll('.verb-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const verb = btn.dataset.verb;
          loadVerb(verb);
          
          document.querySelectorAll('.verb-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        });
      });
    }

    // LOAD VERB DATA
    function loadVerb(verb) {
      currentVerb = verb;
      currentSlide = 0;
      stopPlayback();
      
      const particles = phrasalVerbsData.verbs[verb];
      if (!particles) {
        console.warn(`No particles found for verb: ${verb}`);
        return;
      }
      
      // Build slides
      slides = [];
      
      // Intro slide
      slides.push({
        type: 'intro',
        verb: verb.toUpperCase(),
        text: `Let's explore ${verb.toUpperCase()}`
      });
      
      // Particle slides
      particles.forEach((particle, index) => {
        const key = `${verb}_${particle.replace(/ /g, '_')}`;
        const pvData = phrasalVerbsData.phrasalVerbs[key];
        
        if (pvData) {
          slides.push({
            type: 'particle',
            verb: verb,
            particle: particle,
            phrasalVerb: `${verb} ${particle}`,
            meaning: pvData.meaning,
            example: generateExample(verb, particle, pvData.meaning),
            position: index % 10
          });
        }
      });
      
      console.log(`‚úì Loaded ${verb.toUpperCase()} with ${slides.length - 1} particles`);
      
      renderSlide();
      updateUI();
    }

    // GENERATE EXAMPLE - Comprehensive examples for all verbs
    function generateExample(verb, particle, meaning) {
      // Comprehensive example bank for all 6 core verbs
      const examples = {
        // GO examples
        'go_on': 'The meeting went on for three hours.',
        'go_out': 'Would you like to go out for dinner?',
        'go_off': 'The alarm will go off at 6am.',
        'go_through': 'Let\'s go through the plan carefully.',
        'go_over': 'Can you go over my essay?',
        'go_up': 'Prices have gone up this year.',
        'go_back': 'We can\'t go back now.',
        'go_ahead': 'Let\'s go ahead with the project.',
        'go_down': 'The ship went down in 1912.',
        'go_away': 'Please go away, I\'m busy.',
        
        // TAKE examples
        'take_off': 'The plane will take off at 3pm.',
        'take_up': 'I\'ve decided to take up tennis.',
        'take_on': 'She took on a lot of responsibility.',
        'take_over': 'The new manager will take over next month.',
        'take_after': 'He takes after his father.',
        'take_back': 'I\'d like to take back what I said.',
        'take_out': 'Let me take you out for dinner.',
        'take_in': 'The refugees were taken in by local families.',
        'take_away': 'The police took the suspect away.',
        'take_down': 'Please take down these important points.',
        
        // LOOK examples
        'look_after': 'Can you look after my cat?',
        'look_for': 'I\'ve been looking for my keys everywhere.',
        'look_forward_to': 'We\'re looking forward to the summer holidays.',
        'look_into': 'Police are looking into the cause.',
        'look_out': 'Look out! There\'s a car coming!',
        'look_up': 'Look it up in the dictionary.',
        'look_down_on': 'She tends to look down on people.',
        'look_up_to': 'Children often look up to their siblings.',
        'look_over': 'Can you look over my homework?',
        'look_back': 'When I look back on my childhood...',
        
        // GET examples
        'get_up': 'I always get up at 6:30am.',
        'get_on': 'How are you getting on with your course?',
        'get_off': 'Please get off the bus at the next stop.',
        'get_over': 'It took me weeks to get over the flu.',
        'get_through': 'How will we get through all this work?',
        'get_away': 'The thieves managed to get away.',
        'get_back': 'What time did you get back from London?',
        'get_by': 'We don\'t earn much but we manage to get by.',
        'get_along': 'I get along really well with my flatmates.',
        'get_down': 'Don\'t let exam stress get you down.',
        
        // PUT examples
        'put_off': 'Don\'t put off until tomorrow what you can do today.',
        'put_on': 'Put on your coat - it\'s freezing outside.',
        'put_up': 'We can put you up for the night.',
        'put_away': 'Please put away your toys.',
        'put_down': 'The teacher had to put the phone down.',
        'put_out': 'Firefighters managed to put out the blaze.',
        'put_back': 'Can you put back the meeting for an hour?',
        'put_forward': 'She put forward an interesting idea.',
        'put_through': 'Could you put me through to the manager?',
        'put_up_with': 'I don\'t know how she puts up with his behavior.',
        
        // KEEP examples
        'keep_up': 'Well done! Keep up the good work.',
        'keep_on': 'The rain kept on falling all day.',
        'keep_off': 'Keep off the grass!',
        'keep_away': 'Try to keep away from junk food.',
        'keep_back': 'The police kept the crowds back.',
        'keep_out': 'Please keep out of the kitchen.',
        'keep_to': 'You must keep to your promise.',
        'keep_down': 'The doctor advised him to keep down his cholesterol.',
        'keep_in': 'They decided to keep the news in.',
        'keep_at': 'She kept at me for hours with her complaints.'
      };
      
      const key = `${verb}_${particle.replace(/ /g, '_')}`;
      return examples[key] || `Example: "${verb} ${particle}" - ${meaning.split(';')[0]}.`;
    }

    // RENDER SLIDE
    function renderSlide() {
      const slide = slides[currentSlide];
      if (!slide) return;
      
      clearCanvas();
      
      if (slide.type === 'intro') {
        renderIntroSlide(slide);
      } else if (slide.type === 'particle') {
        renderParticleSlide(slide);
      }
      
      updateDots();
      speak(slide);
    }

    // RENDER INTRO SLIDE
    function renderIntroSlide(slide) {
      const verbCenter = document.getElementById('verbCenter');
      verbCenter.textContent = slide.verb;
      verbCenter.classList.remove('show');
      
      setTimeout(() => {
        verbCenter.classList.add('show');
      }, 100);
      
      document.getElementById('phrasalVerbDisplay').textContent = '';
      document.getElementById('meaningDisplay').textContent = slide.text;
      document.getElementById('exampleDisplay').textContent = '';
      
      setTimeout(() => {
        document.getElementById('meaningDisplay').classList.add('show');
      }, 500);
    }

    // RENDER PARTICLE SLIDE
    function renderParticleSlide(slide) {
      const verbCenter = document.getElementById('verbCenter');
      verbCenter.textContent = slide.verb.toUpperCase();
      verbCenter.classList.add('show');
      
      // Show all previous particles faintly
      const particlesContainer = document.getElementById('particlesContainer');
      particlesContainer.innerHTML = '';
      
      for (let i = 1; i <= currentSlide; i++) {
        const prevSlide = slides[i];
        if (prevSlide.type === 'particle') {
          const particleEl = document.createElement('div');
          particleEl.className = `particle pos-${prevSlide.position} show`;
          particleEl.textContent = prevSlide.particle;
          if (i < currentSlide) {
            particleEl.style.opacity = '0.3';
          }
          particlesContainer.appendChild(particleEl);
          
          // Draw connection line
          drawConnectionLine(prevSlide.position);
        }
      }
      
      // Update text display
      document.getElementById('phrasalVerbDisplay').textContent = slide.phrasalVerb;
      document.getElementById('meaningDisplay').textContent = slide.meaning;
      document.getElementById('exampleDisplay').textContent = `"${slide.example}"`;
      
      setTimeout(() => {
        document.getElementById('phrasalVerbDisplay').classList.add('show');
        document.getElementById('meaningDisplay').classList.add('show');
        document.getElementById('exampleDisplay').classList.add('show');
      }, 500);
    }

    // DRAW CONNECTION LINE
    function drawConnectionLine(position) {
      const svg = document.getElementById('connectionsLayer');
      const canvas = document.getElementById('mindmapCanvas');
      const centerX = canvas.offsetWidth / 2;
      const centerY = canvas.offsetHeight / 2;
      
      const positions = [
        { x: centerX, y: 30 },           // top
        { x: centerX + 200, y: 100 },    // top-right
        { x: centerX + 250, y: centerY }, // right
        { x: centerX + 200, y: centerY + 150 }, // bottom-right
        { x: centerX, y: centerY + 220 }, // bottom
        { x: centerX - 200, y: centerY + 150 }, // bottom-left
        { x: centerX - 250, y: centerY }, // left
        { x: centerX - 200, y: 100 },    // top-left
        { x: centerX + 180, y: centerY }, // right-alt
        { x: centerX - 180, y: centerY }  // left-alt
      ];
      
      const pos = positions[position];
      
      const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      line.setAttribute('x1', centerX);
      line.setAttribute('y1', centerY);
      line.setAttribute('x2', pos.x);
      line.setAttribute('y2', pos.y);
      line.setAttribute('class', 'connection-line');
      
      svg.appendChild(line);
      
      setTimeout(() => {
        line.classList.add('show');
      }, 300);
    }

    // CLEAR CANVAS
    function clearCanvas() {
      document.getElementById('connectionsLayer').innerHTML = '';
      document.getElementById('phrasalVerbDisplay').classList.remove('show');
      document.getElementById('meaningDisplay').classList.remove('show');
      document.getElementById('exampleDisplay').classList.remove('show');
    }

    // SPEAK (UK VOICE)
    function speak(slide) {
      if (!('speechSynthesis' in window)) return;
      
      speechSynthesis.cancel();
      
      let textToSpeak = '';
      
      if (slide.type === 'intro') {
        textToSpeak = slide.text;
      } else if (slide.type === 'particle') {
        textToSpeak = `${slide.phrasalVerb} - ${slide.meaning}`;
      }
      
      if (!textToSpeak) return;
      
      setTimeout(() => {
        const utterance = new SpeechSynthesisUtterance(textToSpeak);
        utterance.lang = 'en-GB';
        utterance.rate = 0.8;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;

       // Add pause after speech completes
       utterance.onend = () => {
       // Speech finished - small buffer before next slide
        };

        const voices = speechSynthesis.getVoices();
        const ukVoice = voices.find(v => v.lang === 'en-GB' && v.name.includes('Female'));
        if (ukVoice) utterance.voice = ukVoice;
        
        speechSynthesis.speak(utterance);
      }, 800);
    }

    // NAVIGATION
    function nextSlide() {
      if (currentSlide < slides.length - 1) {
        currentSlide++;
        renderSlide();
        updateUI();
      } else {
        stopPlayback();
      }
    }

    function prevSlide() {
      if (currentSlide > 0) {
        currentSlide--;
        renderSlide();
        updateUI();
      }
    }

    function goToSlide(index) {
      currentSlide = index;
      renderSlide();
      updateUI();
    }

    // BACK
    function togglePlayPause() {
      if (isPlaying) {
        stopPlayback();
      } else {
        startPlayback();
      }
    }

  function startPlayback() {
  isPlaying = true;
  document.getElementById('playPauseBtn').textContent = '‚è∏Ô∏è';
  
  playInterval = setInterval(() => {
    // Check if Karen is still speaking
    if (!window.speechSynthesis.speaking) {
      if (currentSlide < slides.length - 1) {
        nextSlide();
      } else {
        stopPlayback();
        currentSlide = 0;
        renderSlide();
        updateUI();
      }
    }
    // If still speaking, wait for next interval check
  }, 1000); // Check every second instead of waiting full slideDelay
}
    
    function stopPlayback() {
      isPlaying = false;
      document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è';
      
      if (playInterval) {
        clearInterval(playInterval);
        playInterval = null;
      }
    }

    // SPEED CONTROL
    function setSpeed(delay) {
      slideDelay = delay;
      
      document.querySelectorAll('.speed-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.speed) === delay);
      });
      
      if (isPlaying) {
        stopPlayback();
        startPlayback();
      }
    }

    // UPDATE UI
    function updateUI() {
      document.getElementById('currentSlide').textContent = currentSlide + 1;
      document.getElementById('totalSlides').textContent = slides.length;
      
      document.getElementById('prevBtn').disabled = currentSlide === 0;
      document.getElementById('nextBtn').disabled = currentSlide === slides.length - 1;
    }

    // UPDATE DOTS
    function updateDots() {
      const dotsContainer = document.getElementById('slideDots');
      dotsContainer.innerHTML = '';
      
      slides.forEach((slide, index) => {
        const dot = document.createElement('div');
        dot.className = 'slide-dot' + (index === currentSlide ? ' active' : '');
        dot.addEventListener('click', () => {
          goToSlide(index);
          if (isPlaying) {
            stopPlayback();
          }
        });
        dotsContainer.appendChild(dot);
      });
    }

    // Load voices after page load
    window.speechSynthesis.onvoiceschanged = () => {
      console.log('Voices loaded:', speechSynthesis.getVoices().length);
    };

    // KEYBOARD NAVIGATION
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') prevSlide();
      if (e.key === 'ArrowRight') nextSlide();
      if (e.key === ' ') {
        e.preventDefault();
        togglePlayPause();
      }
    });

    // START
    init();
  </script>
</body>
</html>
