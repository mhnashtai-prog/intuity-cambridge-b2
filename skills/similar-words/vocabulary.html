<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>INTUITY - Word Choice Quiz</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Space+Grotesk:wght@600;700;800&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      min-height: 100vh;
      color: #f1f5f9;
      padding: 1rem;
      line-height: 1.6;
    }

    .container { max-width: 900px; margin: 0 auto; }
    .back-btn { display:inline-flex;align-items:center;gap:.5rem;color:#94a3b8;background:none;border:none;font-size:.875rem;cursor:pointer;margin-bottom:1rem;padding:.5rem 0;transition:color .2s; }
    .back-btn:hover { color:#cbd5e1; }

    .header { text-align:center; margin-bottom:1.25rem; }
    .logo { font-family:'Space Grotesk',sans-serif;font-size:2.5rem;font-weight:800;color:rgba(255,107,53,.9);letter-spacing:-.03em;margin-bottom:.25rem; }
    .subtitle { font-size:.8125rem;color:#94a3b8;margin-bottom:.125rem; }
    .author { font-size:.6875rem;color:#64748b; }

    .test-nav { display:flex;align-items:center;justify-content:center;gap:.75rem;margin-bottom:1rem; }
    .nav-btn { width:2.25rem;height:2.25rem;border:none;background:rgba(71,85,105,.3);color:#94a3b8;border-radius:.5rem;cursor:pointer;font-size:1.125rem;transition:.2s;display:flex;align-items:center;justify-content:center; }
    .nav-btn:hover:not(:disabled){background:rgba(71,85,105,.5);color:#e2e8f0;}
    .nav-btn:disabled{opacity:.3;cursor:not-allowed;}

    .dots{display:flex;gap:.375rem;flex-wrap:wrap;max-width:400px;}
    .dot{width:.625rem;height:.625rem;border-radius:50%;background:#475569;cursor:pointer;transition:.2s;}
    .dot:hover{background:#64748b;transform:scale(1.2);}
    .dot.active{background:rgba(255,107,53,.9);box-shadow:0 0 0 2px rgba(255,107,53,.2);}
    .dot.completed{background:#10b981;}

    .info-bar{text-align:center;color:#94a3b8;font-size:.8125rem;margin-bottom:1rem;font-weight:500;}

    .word-bank{display:flex;justify-content:center;gap:.375rem;margin-bottom:1rem;flex-wrap:wrap;max-width:100%;}
    .word-chip{background:rgba(255,107,53,.15);border:1px solid rgba(255,107,53,.3);color:rgba(255,107,53,.9);padding:.375rem .75rem;border-radius:.375rem;font-weight:600;font-size:.8125rem;transition:.2s;white-space:nowrap;cursor:pointer;}
    .word-chip.used{background:rgba(71,85,105,.3);border-color:rgba(71,85,105,.5);color:#64748b;text-decoration:line-through;cursor:not-allowed;}

    @media(max-width:640px){
      .word-chip{padding:.3rem .6rem;font-size:.75rem;}
      .word-bank{gap:.3rem;}
    }

    .quiz-box{background:rgba(30,41,59,.6);backdrop-filter:blur(20px);border:1px solid rgba(71,85,105,.5);border-radius:1rem;padding:1rem;box-shadow:0 20px 25px -5px rgba(0,0,0,.5);}
    .question{background:rgba(15,23,42,.5);border:1px solid rgba(71,85,105,.3);border-radius:.625rem;margin-bottom:.625rem;overflow:hidden;transition:.3s;}
    .question-header{display:flex;align-items:center;gap:.75rem;padding:.75rem;}
    .question-num{width:1.75rem;height:1.75rem;border-radius:50%;background:rgba(255,107,53,.8);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.8125rem;flex-shrink:0;}
    .question-num.answered{background:#3b82f6;}
    .question-num.correct{background:#10b981;}
    .question-num.incorrect{background:#f59e0b;}
    .question-text{flex:1;font-size:.875rem;line-height:1.5;}
    .blank{display:inline-block;min-width:70px;padding:.125rem .5rem;background:rgba(71,85,105,.4);border:1px solid rgba(71,85,105,.5);border-radius:.25rem;margin:0 .25rem;color:#94a3b8;font-weight:600;text-align:center;font-size:.8125rem;cursor:pointer;}
    .blank.filled{background:rgba(59,130,246,.2);border-color:rgba(59,130,246,.5);color:#60a5fa;}
    .blank.correct{background:rgba(16,185,129,.2);border-color:rgba(16,185,129,.5);color:#34d399;}
    .blank.incorrect{background:rgba(245,158,11,.2);border-color:rgba(245,158,11,.5);color:#fbbf24;}
    .blank.active{outline:2px solid rgba(255,107,53,.9);}

    .controls{display:flex;justify-content:center;gap:.5rem;margin-top:1.25rem;flex-wrap:wrap;}
    .control-btn{padding:.5rem 1.25rem;border:none;background:rgba(255,107,53,.15);color:rgba(255,107,53,.9);border-radius:.375rem;cursor:pointer;font-size:.8125rem;font-weight:600;transition:.2s;font-family:'Inter',sans-serif;white-space:nowrap;}
    .control-btn:hover{background:rgba(255,107,53,.25);transform:translateY(-1px);}

    .loading,.error{text-align:center;padding:2rem;font-size:1rem;}
    .error{color:#f87171;}
    .loading{color:#94a3b8;}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000;padding:1rem;}
    .modal.active{display:flex;}
    .modal-content{background:#1e293b;border:1px solid rgba(71,85,105,.5);border-radius:1rem;padding:1.5rem;max-width:400px;width:100%;text-align:center;}
    .modal-title{font-size:1.375rem;font-weight:700;color:rgba(255,107,53,.9);margin-bottom:1rem;}
    .modal-stats{margin:1.25rem 0;font-size:1rem;color:#cbd5e1;}
    .modal-stat{margin:.375rem 0;}
    .modal-close{padding:.625rem 1.75rem;border:none;background:rgba(255,107,53,.2);color:rgba(255,107,53,.9);border-radius:.5rem;cursor:pointer;font-size:.9375rem;font-weight:600;margin-top:.75rem;font-family:'Inter',sans-serif;}
    .modal-close:hover{background:rgba(255,107,53,.3);}
  </style>
</head>
<body>
  <div class="container">
    <button class="back-btn" onclick="goBack()">← Back to Menu</button>

    <div class="header">
      <div class="logo">INTUITY</div>
      <div class="subtitle">Word Choice Quiz - B2 Level</div>
      <div class="author">by Majid Nashtai</div>
    </div>

    <div class="test-nav">
      <button class="nav-btn" id="prevBtn" onclick="changeSet(-1)">←</button>
      <div class="dots" id="dotsContainer"></div>
      <button class="nav-btn" id="nextBtn" onclick="changeSet(1)">→</button>
    </div>

    <div class="info-bar" id="infoBar">Loading quiz...</div>
    <div class="word-bank" id="wordBank"></div>

    <div class="quiz-box">
      <div id="questionsContainer"><div class="loading">Loading questions...</div></div>
    </div>

    <div class="controls">
      <button class="control-btn" onclick="checkAnswers()">Check Answers</button>
      <button class="control-btn" onclick="showResults()">Show Score</button>
      <button class="control-btn" onclick="resetQuiz()">Reset</button>
    </div>
  </div>

  <div class="modal" id="resultsModal">
    <div class="modal-content">
      <div class="modal-title">Quiz Results</div>
      <div class="modal-stats" id="resultsContent"></div>
      <button class="modal-close" onclick="closeModal()">Close</button>
    </div>
  </div>

  <script>
    let quizData = null;
    let currentSetIndex = 0;
    let userAnswers = {};
    let checkedSets = new Set();
    let isChecked = false;
    let shuffledWords = {};
    let activeBlank = null; // NEW: track which blank is selected

    async function init() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const jsonPath = urlParams.get('json') || '../../datacentre/datasm-01.json';

        const response = await fetch(jsonPath);
        if (!response.ok) throw new Error(`Failed to load quiz (HTTP ${response.status})`);

        quizData = await response.json();
        if (!quizData.sets || quizData.sets.length === 0) throw new Error('No quiz sets found');

        // Pre-shuffle words for each set
        quizData.sets.forEach((set, setIdx) => {
          shuffledWords[setIdx] = shuffleWords(set.words);
        });

        renderDots();
        loadSet(0);
      } catch (error) {
        console.error('Error loading quiz:', error);
        document.getElementById('questionsContainer').innerHTML =
          `<div class="error">❌ Error loading quiz<br><small>${error.message}</small></div>`;
      }
    }

    // Proper shuffle
    function shuffleWords(originalWords) {
      const indices = Array.from(originalWords.keys());
      for (let i = indices.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [indices[i], indices[j]] = [indices[j], indices[i]];
      }
      const newWords = indices.map(idx => originalWords[idx]);
      const indexMap = {};
      indices.forEach((oldIdx, newIdx) => indexMap[oldIdx] = newIdx);
      return { words: newWords, indexMap };
    }

    function renderDots() {
      const container = document.getElementById('dotsContainer');
      container.innerHTML = '';
      quizData.sets.forEach((set, index) => {
        const dot = document.createElement('div');
        dot.className = 'dot';
        if (index === currentSetIndex) dot.classList.add('active');
        if (checkedSets.has(index)) dot.classList.add('completed');
        dot.onclick = () => loadSet(index);
        container.appendChild(dot);
      });
    }

    function loadSet(index) {
      currentSetIndex = index;
      userAnswers = {};
      isChecked = false;
      activeBlank = null;
      updateInfoBar();
      renderWordBank();
      renderQuestions();
      renderDots();
      updateNavButtons();
    }

    function updateInfoBar() {
      const set = quizData.sets[currentSetIndex];
      const answered = Object.keys(userAnswers).length;
      document.getElementById('infoBar').textContent =
        `Set ${currentSetIndex + 1} of ${quizData.sets.length} • ${answered}/${set.sentences.length} answered`;
    }

    function renderWordBank() {
      const container = document.getElementById('wordBank');
      const set = quizData.sets[currentSetIndex];
      const shuffled = shuffledWords[currentSetIndex];
      container.innerHTML = '';

      shuffled.words.forEach((word, wordIdx) => {
        const chip = document.createElement('div');
        chip.className = 'word-chip';
        const isUsed = Object.values(userAnswers).includes(wordIdx);
        if (isUsed) chip.classList.add('used');
        chip.textContent = word;

        chip.onclick = () => {
          if (activeBlank !== null && !isChecked && !chip.classList.contains('used')) {
            userAnswers[activeBlank] = wordIdx;
            activeBlank = null;
            updateInfoBar();
            renderWordBank();
            renderQuestions();
          }
        };

        container.appendChild(chip);
      });
    }

    function renderQuestions() {
      const container = document.getElementById('questionsContainer');
      const set = quizData.sets[currentSetIndex];
      const shuffled = shuffledWords[currentSetIndex];
      container.innerHTML = '';

      set.sentences.forEach((sentence, idx) => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question';

        const header = document.createElement('div');
        header.className = 'question-header';

        const numBadge = document.createElement('div');
        numBadge.className = 'question-num';
        if (userAnswers[idx] !== undefined) numBadge.classList.add('answered');
        if (isChecked) {
          const correctShuffledIdx = shuffled.indexMap[sentence.correct];
          if (userAnswers[idx] === correctShuffledIdx) {
            numBadge.classList.add('correct');
          } else if (userAnswers[idx] !== undefined) {
            numBadge.classList.add('incorrect');
          }
        }
        numBadge.textContent = idx + 1;

        const textDiv = document.createElement('div');
        textDiv.className = 'question-text';
        const parts = sentence.text.split('_____');
        const blank = document.createElement('span');
        blank.className = 'blank';
        if (activeBlank === idx) blank.classList.add('active');

        if (userAnswers[idx] !== undefined) {
          blank.textContent = shuffled.words[userAnswers[idx]];
          blank.classList.add('filled');
          if (isChecked) {
            const correctShuffledIdx = shuffled.indexMap[sentence.correct];
            blank.classList.add(userAnswers[idx] === correctShuffledIdx ? 'correct' : 'incorrect');
          }
        } else {
          blank.textContent = '_____';
        }

        blank.onclick = () => {
          if (!isChecked) {
            activeBlank = idx;
            renderQuestions();
          }
        };

        textDiv.innerHTML = parts[0];
        textDiv.appendChild(blank);
        if (parts[1]) textDiv.innerHTML += parts[1];

        header.appendChild(numBadge);
        header.appendChild(textDiv);
        questionDiv.appendChild(header);
        container.appendChild(questionDiv);
      });
    }

    function changeSet(direction) {
      const newIndex = currentSetIndex + direction;
      if (newIndex >= 0 && newIndex < quizData.sets.length) {
        loadSet(newIndex);
      }
    }

    function updateNavButtons() {
      document.getElementById('prevBtn').disabled = currentSetIndex === 0;
      document.getElementById('nextBtn').disabled = currentSetIndex === quizData.sets.length - 1;
    }

    function checkAnswers() {
      isChecked = true;
      checkedSets.add(currentSetIndex);
      activeBlank = null;
      renderWordBank();
      renderQuestions();
      renderDots();
    }

    function showResults() {
      const set = quizData.sets[currentSetIndex];
      const shuffled = shuffledWords[currentSetIndex];
      let correct = 0, answered = 0;

      set.sentences.forEach((sentence, idx) => {
        if (userAnswers[idx] !== undefined) {
          answered++;
          const correctShuffledIdx = shuffled.indexMap[sentence.correct];
          if (userAnswers[idx] === correctShuffledIdx) correct++;
        }
      });

      const total = set.sentences.length;
      const percentage = answered > 0 ? Math.round((correct / answered) * 100) : 0;
      const setsCompleted = checkedSets.size;

      document.getElementById('resultsContent').innerHTML = `
        <div class="modal-stat"><strong>Set:</strong> ${currentSetIndex + 1} of ${quizData.sets.length}</div>
        <div class="modal-stat"><strong>Answered:</strong> ${answered}/${total}</div>
        <div class="modal-stat"><strong>Correct:</strong> ${correct}/${answered}</div>
        <div class="modal-stat"><strong>Accuracy:</strong> ${percentage}%</div>
        <div class="modal-stat"><strong>Sets Completed:</strong> ${setsCompleted}/${quizData.sets.length}</div>
      `;
      document.getElementById('resultsModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('resultsModal').classList.remove('active');
    }

    function resetQuiz() {
      userAnswers = {};
      activeBlank = null;
      isChecked = false;
      updateInfoBar();
      renderWordBank();
      renderQuestions();
    }

    function goBack() {
      window.location.href = '../similar-words.html';
   
