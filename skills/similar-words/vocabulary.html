<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>INTUITY - Word Choice Quiz</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Space+Grotesk:wght@600;700;800&display=swap" rel="stylesheet">
  <style>
    /* ORIGINAL DESIGN RESTORED */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      min-height: 100vh;
      color: #f1f5f9;
      padding: 1rem;
      line-height: 1.6;
    }
    .container { max-width: 900px; margin: 0 auto; }
    .back-btn { display:inline-flex;align-items:center;gap:.5rem;color:#94a3b8;background:none;border:none;font-size:.875rem;cursor:pointer;margin-bottom:1rem;padding:.5rem 0;transition:color .2s; }
    .back-btn:hover { color:#cbd5e1; }
    .header { text-align:center; margin-bottom:1.25rem; }
    .logo { font-family:'Space Grotesk',sans-serif;font-size:2.5rem;font-weight:800;color:rgba(255,107,53,.9);letter-spacing:-.03em;margin-bottom:.25rem; }
    .subtitle { font-size:.8125rem;color:#94a3b8;margin-bottom:.125rem; }
    .author { font-size:.6875rem;color:#64748b; }
    
    .test-nav { display:flex;align-items:center;justify-content:center;gap:.75rem;margin-bottom:1rem;flex-wrap:wrap; }
    .nav-btn { width:2.25rem;height:2.25rem;border:none;background:rgba(71,85,105,.3);color:#94a3b8;border-radius:.5rem;cursor:pointer;font-size:1.125rem;transition:.2s;display:flex;align-items:center;justify-content:center; }
    .nav-btn:hover:not(:disabled){background:rgba(71,85,105,.5);color:#e2e8f0;}
    .nav-btn:disabled{opacity:.3;cursor:not-allowed;}
    .dots{display:flex;gap:.375rem;flex-wrap:wrap;max-width:400px;position:relative;}
    .dot{width:.625rem;height:.625rem;border-radius:50%;background:#475569;cursor:pointer;transition:.2s;}
    .dot:hover{background:#64748b;transform:scale(1.2);}
    .dot.active{background:rgba(255,107,53,.9);box-shadow:0 0 0 2px rgba(255,107,53,.2);}
    .dot.completed{background:#10b981;}
    
    .info-bar{text-align:center;color:#94a3b8;font-size:.8125rem;margin-bottom:1rem;font-weight:500;}
    .word-bank{display:flex;justify-content:center;gap:.375rem;margin-bottom:1rem;flex-wrap:wrap;max-width:100%;min-height:40px;position:sticky;top:0;background:linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);padding:1rem 0;z-index:10;border-bottom:1px solid rgba(71,85,105,.2);}
    .word-chip{background:rgba(255,107,53,.15);border:1px solid rgba(255,107,53,.3);color:rgba(255,107,53,.9);padding:.375rem .75rem;border-radius:.375rem;font-weight:600;font-size:.8125rem;transition:.2s;white-space:nowrap;cursor:pointer;user-select:none;}
    .word-chip.used{background:rgba(71,85,105,.3);border-color:rgba(71,85,105,.5);color:#64748b;text-decoration:line-through;cursor:not-allowed;}
    .word-chip:hover:not(.used){transform:scale(1.05);background:rgba(255,107,53,.25);}
    
    .quiz-box{background:rgba(30,41,59,.6);backdrop-filter:blur(20px);border:1px solid rgba(71,85,105,.5);border-radius:1rem;padding:1rem;box-shadow:0 20px 25px -5px rgba(0,0,0,.5);}
    
    /* NEW: Exercises container with vertical scrolling */
    .exercises-container {
      height: 60vh;
      overflow-y: auto;
      scroll-behavior: smooth;
      border-radius: 1rem;
      background: rgba(15,23,42,.3);
      border: 1px solid rgba(71,85,105,.3);
      position: relative;
    }
    
    .exercises-container::-webkit-scrollbar {
      width: 8px;
    }
    
    .exercises-container::-webkit-scrollbar-track {
      background: rgba(71,85,105,.3);
      border-radius: 4px;
    }
    
    .exercises-container::-webkit-scrollbar-thumb {
      background: rgba(255,107,53,.6);
      border-radius: 4px;
    }
    
    .exercises-container::-webkit-scrollbar-thumb:hover {
      background: rgba(255,107,53,.8);
    }
    
    /* Exercise layout */
    .exercise {
      min-height: calc(60vh - 2rem);
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 2rem 1rem;
      border-bottom: 2px solid rgba(71,85,105,.2);
      scroll-snap-align: start;
    }
    
    .exercise:last-child {
      border-bottom: none;
    }
    
    .exercise-header {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .exercise-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: rgba(255,107,53,.9);
      margin-bottom: 0.5rem;
    }
    
    .exercise-progress {
      font-size: 0.875rem;
      color: #94a3b8;
    }
    
    /* Enhanced dots for 23 tests */
    .dots {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(0.75rem, 1fr));
      gap: 0.25rem;
      max-width: 500px;
      position: relative;
    }
    
    @media (max-width: 768px) {
      .dots {
        grid-template-columns: repeat(8, 1fr);
        max-width: 300px;
      }
    }
    
    .dot {
      width: 0.75rem;
      height: 0.75rem;
      border-radius: 50%;
      background: #475569;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6rem;
      color: transparent;
    }
    
    .dot:hover {
      background: #64748b;
      transform: scale(1.3);
      color: white;
    }
    
    .dot.active {
      background: rgba(255,107,53,.9);
      box-shadow: 0 0 0 2px rgba(255,107,53,.2);
      transform: scale(1.2);
    }
    
    .dot.completed {
      background: #10b981;
    }
    
    /* Scroll indicators */
    .scroll-indicator {
      position: fixed;
      right: 2rem;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      z-index: 100;
    }
    
    .scroll-dot {
      width: 0.5rem;
      height: 0.5rem;
      border-radius: 50%;
      background: rgba(148,163,184,.3);
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .scroll-dot.active {
      background: rgba(255,107,53,.9);
      transform: scale(1.5);
    }
    
    /* Touch/swipe indicators */
    .swipe-hint {
      position: absolute;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      color: #64748b;
      font-size: 0.75rem;
      text-align: center;
      pointer-events: none;
    }
    
    .swipe-hint.show {
      animation: fadeInOut 3s ease-in-out;
    }
    
    /* Enhanced animations and micro-interactions */
    @keyframes wordPop {
      0% { transform: scale(1); }
      50% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }
    
    @keyframes blankFill {
      0% { background: rgba(71,85,105,.4); transform: scale(1); }
      50% { background: rgba(59,130,246,.4); transform: scale(1.05); }
      100% { background: rgba(59,130,246,.2); transform: scale(1); }
    }
    
    @keyframes correctPulse {
      0% { box-shadow: 0 0 0 0 rgba(16,185,129,.4); }
      70% { box-shadow: 0 0 0 15px rgba(16,185,129,0); }
      100% { box-shadow: 0 0 0 0 rgba(16,185,129,0); }
    }
    
    @keyframes incorrectShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    .word-chip.selecting { animation: wordPop 0.3s ease-out; }
    .blank.filling { animation: blankFill 0.5s ease-out; }
    .blank.correct { animation: correctPulse 1s ease-out; }
    .blank.incorrect { animation: incorrectShake 0.5s ease-out; }
    
    /* Streak counter */
    .streak-counter {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: linear-gradient(135deg, rgba(255,107,53,0.2), rgba(255,107,53,0.1));
      border: 1px solid rgba(255,107,53,0.3);
      border-radius: 1rem;
      padding: 0.75rem 1.25rem;
      color: rgba(255,107,53,0.9);
      font-weight: 600;
      font-size: 0.875rem;
      z-index: 200;
      backdrop-filter: blur(10px);
      transition: all 0.3s;
      transform: translateY(-100px);
      opacity: 0;
    }
    
    .streak-counter.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .streak-counter.fire {
      animation: correctPulse 0.6s ease-out;
      background: linear-gradient(135deg, rgba(245,158,11,0.2), rgba(245,158,11,0.1));
      border-color: rgba(245,158,11,0.3);
      color: rgba(245,158,11,0.9);
    }
    
    /* Smart hints */
    .hint-bubble {
      position: absolute;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(71,85,105,0.5);
      border-radius: 0.75rem;
      padding: 1rem 1.5rem;
      color: #e2e8f0;
      font-size: 0.875rem;
      max-width: 300px;
      z-index: 500;
      backdrop-filter: blur(20px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s ease-out;
      pointer-events: none;
    }
    
    .hint-bubble.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .hint-bubble::before {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      border: 8px solid transparent;
      border-top-color: rgba(15,23,42,0.95);
    }
    
    /* Progress ring animation */
    .progress-ring {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 60px;
      height: 60px;
      z-index: 200;
    }
    
    .progress-ring circle {
      fill: none;
      stroke: rgba(71,85,105,0.3);
      stroke-width: 4;
    }
    
    .progress-ring .progress {
      stroke: rgba(255,107,53,0.9);
      stroke-linecap: round;
      transition: stroke-dashoffset 0.5s ease-out;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
    }
    
    /* Keyboard shortcuts indicator */
    .shortcuts-panel {
      position: fixed;
      bottom: 1rem;
      left: 1rem;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(71,85,105,0.5);
      border-radius: 0.75rem;
      padding: 1rem;
      color: #94a3b8;
      font-size: 0.75rem;
      max-width: 250px;
      backdrop-filter: blur(20px);
      transform: translateY(100%);
      transition: all 0.3s ease-out;
      z-index: 100;
    }
    
    .shortcuts-panel.show {
      transform: translateY(0);
    }
    
    .shortcut-key {
      background: rgba(71,85,105,0.3);
      color: #e2e8f0;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-weight: 600;
      font-family: monospace;
    }
    
    /* Achievement notifications */
    .achievement {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: linear-gradient(135deg, rgba(16,185,129,0.95), rgba(5,150,105,0.95));
      border-radius: 1rem;
      padding: 2rem;
      color: white;
      text-align: center;
      z-index: 1000;
      backdrop-filter: blur(20px);
      box-shadow: 0 25px 50px rgba(0,0,0,0.3);
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    .achievement.show {
      transform: translate(-50%, -50%) scale(1);
    }
    
    .achievement-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    
    .achievement-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    
    .achievement-desc {
      font-size: 1rem;
      opacity: 0.9;
    }
    
    /* Smart word suggestions */
    .word-suggestion {
      position: absolute;
      background: rgba(255,107,53,0.1);
      border: 2px solid rgba(255,107,53,0.3);
      border-radius: 0.5rem;
      transform: scale(1.05);
      animation: suggestPulse 2s ease-in-out infinite;
    }
    
    @keyframes suggestPulse {
      0%, 100% { 
        border-color: rgba(255,107,53,0.3);
        box-shadow: 0 0 0 0 rgba(255,107,53,0.3);
      }
      50% { 
        border-color: rgba(255,107,53,0.6);
        box-shadow: 0 0 0 8px rgba(255,107,53,0);
      }
    }
    
    /* Difficulty indicator */
    .difficulty-badge {
      position: absolute;
      top: -10px;
      right: -10px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      color: white;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    
    /* Epic achievement modal for perfect scores */
    .epic-achievement {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(10px);
    }
    
    .epic-achievement.show {
      display: flex;
      animation: epicFadeIn 0.8s ease-out;
    }
    
    @keyframes epicFadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }
    
    .epic-content {
      background: linear-gradient(135deg, 
        rgba(255,107,53,0.95) 0%, 
        rgba(245,158,11,0.95) 50%, 
        rgba(251,191,36,0.95) 100%);
      border-radius: 2rem;
      padding: 3rem;
      text-align: center;
      max-width: 500px;
      width: 90%;
      color: white;
      position: relative;
      overflow: hidden;
      box-shadow: 0 50px 100px rgba(0,0,0,0.5);
      transform: scale(0.8);
      animation: epicScale 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.2s forwards;
    }
    
    @keyframes epicScale {
      0% { transform: scale(0.8); }
      100% { transform: scale(1); }
    }
    
    .epic-content::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
      animation: epicShine 2s ease-in-out infinite;
    }
    
    @keyframes epicShine {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }
    
    .epic-icon {
      font-size: 5rem;
      margin-bottom: 1rem;
      animation: epicBounce 1s ease-out infinite alternate;
      text-shadow: 0 0 20px rgba(255,255,255,0.5);
    }
    
    @keyframes epicBounce {
      0% { transform: translateY(0) scale(1); }
      100% { transform: translateY(-10px) scale(1.1); }
    }
    
    .epic-title {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 1rem;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
      background: linear-gradient(45deg, #fff, #ffed4e, #fff);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: epicGlow 2s ease-in-out infinite alternate;
    }
    
    @keyframes epicGlow {
      0% { filter: drop-shadow(0 0 10px rgba(255,255,255,0.5)); }
      100% { filter: drop-shadow(0 0 20px rgba(255,237,78,0.8)); }
    }
    
    .epic-subtitle {
      font-size: 1.2rem;
      margin-bottom: 2rem;
      opacity: 0.9;
      text-shadow: 0 1px 5px rgba(0,0,0,0.3);
    }
    
    .epic-stats {
      background: rgba(0,0,0,0.2);
      border-radius: 1rem;
      padding: 1.5rem;
      margin: 2rem 0;
      backdrop-filter: blur(10px);
    }
    
    .epic-stat {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 0.5rem 0;
      font-size: 1.1rem;
      font-weight: 600;
    }
    
    .epic-close {
      background: rgba(255,255,255,0.2);
      border: 2px solid rgba(255,255,255,0.3);
      color: white;
      padding: 1rem 2rem;
      border-radius: 1rem;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: 700;
      transition: all 0.3s;
      backdrop-filter: blur(10px);
    }
    
    .epic-close:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    
    /* Achievement status indicator */
    .achievement-status {
      position: fixed;
      top: 1rem;
      left: 1rem;
      background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(5,150,105,0.1));
      border: 1px solid rgba(16,185,129,0.3);
      border-radius: 1rem;
      padding: 0.75rem 1.25rem;
      color: rgba(16,185,129,0.9);
      font-weight: 600;
      font-size: 0.875rem;
      z-index: 200;
      backdrop-filter: blur(10px);
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .achievement-status:hover {
      transform: scale(1.05);
      background: linear-gradient(135deg, rgba(16,185,129,0.3), rgba(5,150,105,0.2));
    }
    
    .achievement-status.epic {
      background: linear-gradient(135deg, rgba(255,107,53,0.3), rgba(245,158,11,0.2));
      border-color: rgba(255,107,53,0.4);
      color: rgba(255,107,53,0.9);
      animation: epicStatusGlow 2s ease-in-out infinite alternate;
    }
    
    @keyframes epicStatusGlow {
      0% { box-shadow: 0 0 10px rgba(255,107,53,0.3); }
      100% { box-shadow: 0 0 20px rgba(255,107,53,0.5); }
    }
    .question{background:rgba(15,23,42,.5);border:1px solid rgba(71,85,105,.3);border-radius:.625rem;margin-bottom:.625rem;overflow:hidden;transition:.3s;}
    .question-header{display:flex;align-items:center;gap:.75rem;padding:.75rem;}
    .question-num{width:1.75rem;height:1.75rem;border-radius:50%;background:rgba(255,107,53,.8);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.8125rem;flex-shrink:0;}
    .question-num.answered{background:#3b82f6;}
    .question-num.correct{background:#10b981;}
    .question-num.incorrect{background:#f59e0b;}
    .question-text{flex:1;font-size:.875rem;line-height:1.5;}
    
    .blank{display:inline-block;min-width:70px;padding:.125rem .5rem;background:rgba(71,85,105,.4);border:1px solid rgba(71,85,105,.5);border-radius:.25rem;margin:0 .25rem;color:#94a3b8;font-weight:600;text-align:center;font-size:.8125rem;cursor:pointer;transition:all .2s;}
    .blank.filled{background:rgba(59,130,246,.2);border-color:rgba(59,130,246,.5);color:#60a5fa;}
    .blank.correct{background:rgba(16,185,129,.25);border-color:rgba(16,185,129,.6);color:#10b981;box-shadow:0 0 0 2px rgba(16,185,129,.2);}
    .blank.incorrect{background:rgba(249,115,22,.25);border-color:rgba(249,115,22,.6);color:#f97316;box-shadow:0 0 0 2px rgba(249,115,22,.2);}
    .blank.active{outline:2px solid rgba(255,107,53,.9);outline-offset:2px;}
    
    .controls{display:flex;justify-content:center;gap:.5rem;margin-top:1.25rem;flex-wrap:wrap;position:relative;}
    
    /* Elegant dropdown menu */
    .control-center {
      position: relative;
      display: inline-block;
    }
    
    .control-trigger {
      background: linear-gradient(135deg, rgba(255,107,53,.15), rgba(255,107,53,.05));
      border: 1px solid rgba(255,107,53,.3);
      color: rgba(255,107,53,.9);
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    }
    
    .control-trigger:hover {
      background: linear-gradient(135deg, rgba(255,107,53,.25), rgba(255,107,53,.1));
      transform: translateY(-2px);
      box-shadow: 0 10px 25px -3px rgba(0,0,0,0.2);
      border-color: rgba(255,107,53,.5);
    }
    
    .control-trigger.active {
      background: linear-gradient(135deg, rgba(255,107,53,.3), rgba(255,107,53,.15));
      transform: translateY(-1px);
    }
    
    .control-arrow {
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 0.75rem;
      opacity: 0.7;
    }
    
    .control-trigger.active .control-arrow {
      transform: rotate(180deg);
    }
    
    .control-dropdown {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-8px);
      background: rgba(15,23,42,0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(71,85,105,.5);
      border-radius: 0.75rem;
      padding: 0.5rem;
      min-width: 200px;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
    }
    
    .control-dropdown.show {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(-12px);
    }
    
    .control-dropdown::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 8px solid transparent;
      border-top-color: rgba(15,23,42,0.95);
    }
    
    .control-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      color: #e2e8f0;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      border-radius: 0.5rem;
      transition: all 0.2s;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-family: 'Inter', sans-serif;
    }
    
    .control-item:hover {
      background: rgba(71,85,105,0.3);
      color: rgba(255,107,53,0.9);
      transform: translateX(4px);
    }
    
    .control-item:active {
      transform: translateX(2px);
    }
    
    .control-icon {
      width: 1.25rem;
      height: 1.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      opacity: 0.8;
    }
    
    .control-label {
      flex: 1;
    }
    
    .control-shortcut {
      font-size: 0.75rem;
      opacity: 0.6;
      font-family: monospace;
      background: rgba(71,85,105,0.3);
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
    }
    
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000;padding:1rem;}
    .modal.active{display:flex;}
    .modal-content{background:#1e293b;border:1px solid rgba(71,85,105,.5);border-radius:1rem;padding:1.5rem;max-width:400px;width:100%;text-align:center;}
    .modal-title{font-size:1.375rem;font-weight:700;color:rgba(255,107,53,.9);margin-bottom:1rem;}
    .modal-stats{margin:1.25rem 0;font-size:1rem;color:#cbd5e1;}
    .modal-stat{margin:.375rem 0;}
    .modal-close{padding:.625rem 1.75rem;border:none;background:rgba(255,107,53,.2);color:rgba(255,107,53,.9);border-radius:.5rem;cursor:pointer;font-size:.9375rem;font-weight:600;margin-top:.75rem;font-family:'Inter',sans-serif;}
    .modal-close:hover{background:rgba(255,107,53,.3);}
  </style>
</head>
<body>
  <div class="container">
    <button class="back-btn" onclick="goBack()">← Back to Menu</button>
    <div class="header">
      <div class="logo">INTUITY</div>
      <div class="subtitle">Word Choice Quiz - B2 Level</div>
      <div class="author">by Majid Nashtai</div>
    </div>
    
    <div class="test-nav">
      <button class="nav-btn" id="prevBtn" onclick="changeSet(-1)">←</button>
      <div class="dots" id="dotsContainer"></div>
      <button class="nav-btn" id="nextBtn" onclick="changeSet(1)">→</button>
    </div>
    
    <div class="info-bar" id="infoBar">Test 1 of 23 • Exercise 1 of 5 • Swipe or scroll through exercises</div>
    <div class="word-bank" id="wordBank"></div>
    
    <div class="exercises-container" id="exercisesContainer">
      <div class="quiz-box" id="quizContainer"></div>
    </div>
    
    <div class="controls">
      <div class="control-center">
        <button class="control-trigger" id="controlTrigger" onclick="toggleControlCenter()">
          <span>⚡</span>
          <span>Command Center</span>
          <span class="control-arrow">▼</span>
        </button>
        
        <div class="control-dropdown" id="controlDropdown">
          <button class="control-item" onclick="checkAnswers(); closeControlCenter();">
            <span class="control-icon">✓</span>
            <span class="control-label">Check Answers</span>
            <span class="control-shortcut">Space</span>
          </button>
          
          <button class="control-item" onclick="showResults(); closeControlCenter();">
            <span class="control-icon">📊</span>
            <span class="control-label">Show Score</span>
            <span class="control-shortcut"></span>
          </button>
          
          <button class="control-item" onclick="resetSet(); closeControlCenter();">
            <span class="control-icon">↻</span>
            <span class="control-label">Reset Test</span>
            <span class="control-shortcut"></span>
          </button>
          
          <button class="control-item" onclick="nextUnanswered(); closeControlCenter();">
            <span class="control-icon">⇥</span>
            <span class="control-label">Next Empty</span>
            <span class="control-shortcut">Tab</span>
          </button>
          
          <button class="control-item" onclick="showSmartHint(); closeControlCenter();">
            <span class="control-icon">💡</span>
            <span class="control-label">Smart Hint</span>
            <span class="control-shortcut">?</span>
          </button>
          
          <button class="control-item" onclick="toggleShortcutsPanel(); closeControlCenter();">
            <span class="control-icon">⌘</span>
            <span class="control-label">Shortcuts</span>
            <span class="control-shortcut">H</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Smart enhancements for wizard kids -->
  <div class="achievement-status" id="achievementStatus" onclick="showAchievementsList()">
    🏆 <span id="achievementCount">0</span> achievements
  </div>
  
  <div class="streak-counter" id="streakCounter">
    🔥 <span id="streakNumber">0</span> streak
  </div>
  
  <div class="progress-ring" id="progressRing">
    <svg width="60" height="60">
      <circle cx="30" cy="30" r="26" stroke-dasharray="163.36" stroke-dashoffset="163.36"></circle>
      <circle class="progress" cx="30" cy="30" r="26" stroke-dasharray="163.36" stroke-dashoffset="163.36"></circle>
    </svg>
  </div>
  
  <div class="shortcuts-panel" id="shortcutsPanel">
    <div style="font-weight:600;margin-bottom:0.5rem;">⚡ Quick Keys</div>
    <div><span class="shortcut-key">1-5</span> Select word</div>
    <div><span class="shortcut-key">↑↓</span> Scroll exercises</div>
    <div><span class="shortcut-key">←→</span> Change test</div>
    <div><span class="shortcut-key">Space</span> Check answers</div>
    <div><span class="shortcut-key">?</span> Smart hint</div>
  </div>
  
  <!-- Scroll indicators will be added dynamically -->
  
  <!-- Epic achievement modal -->
  <div class="epic-achievement" id="epicAchievement">
    <div class="epic-content">
      <div class="epic-icon">👑</div>
      <div class="epic-title">QUIZ MASTER!</div>
      <div class="epic-subtitle">You've achieved perfection!</div>
      <div class="epic-stats" id="epicStats">
        <div class="epic-stat">
          <span>Perfect Score:</span>
          <span>100% ✨</span>
        </div>
      </div>
      <button class="epic-close" onclick="closeEpicAchievement()">Continue Your Journey</button>
    </div>
  </div>
  
  <div class="modal" id="resultsModal">
    <div class="modal-content">
      <div class="modal-title">Quiz Results</div>
      <div class="modal-stats" id="resultsContent"></div>
      <button class="modal-close" onclick="closeModal()">Close</button>
    </div>
  </div>
  
  <script>
    // ENHANCED GLOBAL STATE FOR WIZARD FEATURES
    let currentTest = 0;
    let currentExercise = 0;
    let activeBlank = null;
    let userAnswers = {}; // Format: "testIndex-exerciseIndex": wordIndex
    let checkedTests = new Set();
    let quizData = null; // Will be loaded from JSON
    
    // Smart features with persistent storage
    let currentStreak = 0;
    let mistakes = [];
    let startTime = Date.now();
    let hintCount = 0;
    let achievements = [];
    let perfectScores = [];
    let totalScore = 0;
    
    // Expected structure: 23 tests, each with 5 exercises

    // INITIALIZE WITH JSON LOADING
    async function init() {
      console.log('🚀 Initializing quiz...');
      
      try {
        // Try to load JSON file
        const urlParams = new URLSearchParams(window.location.search);
        const jsonPath = urlParams.get('json') || '../datacentre/datasm-01.json';
        
        document.getElementById('infoBar').textContent = 'Loading quiz data...';
        
        const response = await fetch(jsonPath);
        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        
        quizData = await response.json();
        if (!quizData || !quizData.sets || quizData.sets.length === 0) {
          throw new Error('Invalid quiz data format or empty sets');
        }
        
        console.log('✅ Quiz data loaded successfully:', quizData.sets.length, 'tests');
        
        if (quizData.sets.length !== 23) {
          console.warn(`⚠️ Expected 23 tests, got ${quizData.sets.length}. Proceeding anyway...`);
        }
        
        // Validate each test has 5 exercises
        quizData.sets.forEach((test, index) => {
          if (!test.sentences || test.sentences.length !== 5) {
            console.warn(`⚠️ Test ${index + 1} has ${test.sentences?.length || 0} exercises, expected 5`);
          }
        });
        
        // Initialize the quiz
        createDots();
        loadTest(0);
        setupScrolling();
        setupTouchGestures();
        setupSmartFeatures();
        setupKeyboardShortcuts();
        loadProgress(); // Load all saved data
        
      } catch (error) {
        console.error('❌ Error loading quiz:', error);
        document.getElementById('infoBar').textContent = 'Error loading quiz data';
        document.getElementById('quizContainer').innerHTML = `
          <div style="text-align:center;padding:2rem;color:#f87171;">
            <h3>❌ Error Loading Quiz</h3>
            <p>Could not load quiz data from: <code>${urlParams.get('json') || '../datacentre/datasm-01.json'}</code></p>
            <p><strong>Error:</strong> ${error.message}</p>
            <br>
            <p><em>Please ensure the JSON file contains 23 tests with 5 exercises each.</em></p>
            <details style="margin-top:1rem;text-align:left;font-size:0.85rem;color:#94a3b8;">
              <summary>Expected JSON format:</summary>
              <pre style="margin-top:0.5rem;padding:1rem;background:rgba(0,0,0,0.3);border-radius:0.5rem;overflow-x:auto;">
{
  "sets": [
    {
      "words": ["word1", "word2", "word3", "word4", "word5"],
      "sentences": [
        { "text": "Sentence with _____.", "correct": 0 },
        { "text": "Another _____ sentence.", "correct": 1 },
        { "text": "Third _____ example.", "correct": 2 },
        { "text": "Fourth _____ sentence.", "correct": 3 },
        { "text": "Fifth _____ sentence.", "correct": 4 }
      ]
    }
    // ... 22 more tests
  ]
}</pre>
            </details>
          </div>
        `;
      }
    }

    // CREATE NAVIGATION DOTS FOR 23 TESTS
    function createDots() {
      const container = document.getElementById('dotsContainer');
      container.innerHTML = '';
      
      if (!quizData || !quizData.sets) return;
      
      for (let i = 0; i < quizData.sets.length; i++) {
        const dot = document.createElement('div');
        dot.className = 'dot';
        dot.title = `Test ${i + 1}`;
        dot.textContent = i + 1;
        dot.onclick = () => loadTest(i);
        container.appendChild(dot);
      }
      updateDots();
    }

    // UPDATE DOTS
    function updateDots() {
      const dots = document.querySelectorAll('.dot');
      dots.forEach((dot, index) => {
        dot.classList.toggle('active', index === currentTest);
        dot.classList.toggle('completed', checkedTests.has(index));
      });
    }

    // LOAD A TEST WITH 5 EXERCISES
    function loadTest(testIndex) {
      if (!quizData || !quizData.sets || testIndex >= quizData.sets.length) {
        console.error('❌ Cannot load test:', testIndex, 'Quiz data not available');
        return;
      }
      
      console.log('📁 Loading test:', testIndex + 1);
      currentTest = testIndex;
      currentExercise = 0;
      activeBlank = null;
      const test = quizData.sets[testIndex];
      
      // Update navigation
      document.getElementById('prevBtn').disabled = testIndex === 0;
      document.getElementById('nextBtn').disabled = testIndex === quizData.sets.length - 1;
      updateDots();
      
      // Clear containers
      document.getElementById('wordBank').innerHTML = '';
      document.getElementById('quizContainer').innerHTML = '';
      
      // Create word bank (shared across all 5 exercises)
      test.words.forEach((word, index) => {
        const chip = document.createElement('div');
        chip.className = 'word-chip';
        chip.textContent = word;
        chip.onclick = () => selectWord(index, word);
        document.getElementById('wordBank').appendChild(chip);
      });
      
      // Create 5 exercises in scrollable container
      test.sentences.forEach((sentence, exerciseIndex) => {
        const exerciseDiv = document.createElement('div');
        exerciseDiv.className = 'exercise';
        exerciseDiv.id = `exercise-${exerciseIndex}`;
        
        const parts = sentence.text.split('_____');
        const answerKey = `${testIndex}-${exerciseIndex}`;
        const isAnswered = userAnswers[answerKey] !== undefined;
        
        exerciseDiv.innerHTML = `
          <div class="exercise-header">
            <div class="exercise-number">Exercise ${exerciseIndex + 1}</div>
            <div class="exercise-progress">Test ${testIndex + 1} of ${quizData.sets.length}</div>
          </div>
          <div class="question">
            <div class="question-header">
              <div class="question-num ${isAnswered ? 'answered' : ''}" id="badge-${testIndex}-${exerciseIndex}">1</div>
              <div class="question-text">
                ${parts[0]}<span class="blank ${isAnswered ? 'filled' : ''}" id="blank-${testIndex}-${exerciseIndex}" onclick="selectBlank(${testIndex}, ${exerciseIndex})">${isAnswered ? test.words[userAnswers[answerKey]] : '_____'}</span>${parts[1] || ''}
              </div>
            </div>
          </div>
          <div class="swipe-hint">
            ${exerciseIndex < 4 ? '↓ Swipe down for next exercise' : '↑ Swipe up to previous exercise'}
          </div>
        `;
        
        document.getElementById('quizContainer').appendChild(exerciseDiv);
      });
      
      // Create scroll indicators
      createScrollIndicators();
      updateWordBank();
      updateInfoBar();
      scrollToExercise(0);
    }

    // CREATE SCROLL INDICATORS
    function createScrollIndicators() {
      // Remove existing indicators
      const existing = document.querySelector('.scroll-indicator');
      if (existing) existing.remove();
      
      const indicator = document.createElement('div');
      indicator.className = 'scroll-indicator';
      
      for (let i = 0; i < 5; i++) {
        const dot = document.createElement('div');
        dot.className = 'scroll-dot';
        dot.onclick = () => scrollToExercise(i);
        indicator.appendChild(dot);
      }
      
      document.body.appendChild(indicator);
      updateScrollIndicators();
    }

    // UPDATE SCROLL INDICATORS
    function updateScrollIndicators() {
      const dots = document.querySelectorAll('.scroll-dot');
      dots.forEach((dot, index) => {
        dot.classList.toggle('active', index === currentExercise);
      });
    }

    // SCROLL TO SPECIFIC EXERCISE
    function scrollToExercise(exerciseIndex) {
      currentExercise = exerciseIndex;
      const exerciseElement = document.getElementById(`exercise-${exerciseIndex}`);
      if (exerciseElement) {
        exerciseElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
      updateScrollIndicators();
      updateInfoBar();
    }

    // SETUP SCROLLING DETECTION
    function setupScrolling() {
      const container = document.getElementById('exercisesContainer');
      if (!container) return;
      
      let scrollTimeout;
      container.addEventListener('scroll', () => {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
          detectCurrentExercise();
        }, 100);
      });
    }

    // DETECT CURRENT EXERCISE BASED ON SCROLL POSITION
    function detectCurrentExercise() {
      const container = document.getElementById('exercisesContainer');
      const exercises = document.querySelectorAll('.exercise');
      
      if (!container || exercises.length === 0) return;
      
      const containerTop = container.scrollTop;
      const containerHeight = container.clientHeight;
      const containerCenter = containerTop + containerHeight / 2;
      
      exercises.forEach((exercise, index) => {
        const exerciseTop = exercise.offsetTop;
        const exerciseHeight = exercise.clientHeight;
        const exerciseCenter = exerciseTop + exerciseHeight / 2;
        
        if (Math.abs(exerciseCenter - containerCenter) < exerciseHeight / 2) {
          if (currentExercise !== index) {
            currentExercise = index;
            updateScrollIndicators();
            updateInfoBar();
          }
        }
      });
    }

    // ENHANCED TOUCH GESTURES FOR VERTICAL SCROLLING
    function setupTouchGestures() {
      let touchStartY = 0;
      let touchStartTime = 0;
      
      document.addEventListener('touchstart', (e) => {
        touchStartY = e.touches[0].clientY;
        touchStartTime = Date.now();
      }, { passive: true });
      
      document.addEventListener('touchend', (e) => {
        const touchEndY = e.changedTouches[0].clientY;
        const touchDuration = Date.now() - touchStartTime;
        const deltaY = touchStartY - touchEndY;
        
        // Only process vertical swipes within exercises container
        if (e.target.closest('.exercises-container') && Math.abs(deltaY) > 50 && touchDuration < 500) {
          if (deltaY > 0 && currentExercise < 4) {
            // Swipe up - next exercise
            scrollToExercise(currentExercise + 1);
            showSwipeHint('↓ Next Exercise');
          } else if (deltaY < 0 && currentExercise > 0) {
            // Swipe down - previous exercise
            scrollToExercise(currentExercise - 1);
            showSwipeHint('↑ Previous Exercise');
          }
        }
      }, { passive: true });
    }

    // SHOW SWIPE HINT
    function showSwipeHint(text) {
      // Create temporary hint
      const hint = document.createElement('div');
      hint.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255,107,53,0.9);
        color: white;
        padding: 1rem 2rem;
        border-radius: 0.5rem;
        font-weight: 600;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
      `;
      hint.textContent = text;
      document.body.appendChild(hint);
      
      // Animate in and out
      setTimeout(() => hint.style.opacity = '1', 10);
      setTimeout(() => {
        hint.style.opacity = '0';
        setTimeout(() => hint.remove(), 300);
      }, 1000);
    }

    // SELECT A BLANK
    function selectBlank(testIndex, exerciseIndex) {
      console.log('🎯 Blank selected:', testIndex, exerciseIndex);
      
      // Remove previous active
      document.querySelectorAll('.blank').forEach(b => b.classList.remove('active'));
      
      // Set new active
      activeBlank = { test: testIndex, exercise: exerciseIndex };
      document.getElementById(`blank-${testIndex}-${exerciseIndex}`).classList.add('active');
    }

    // SELECT A WORD
    function selectWord(wordIndex, word) {
      console.log('💬 Word selected:', wordIndex, word);
      
      if (activeBlank === null) {
        alert('Please select a blank first!');
        return;
      }
      
      const { test: testIndex, exercise: exerciseIndex } = activeBlank;
      const answerKey = `${testIndex}-${exerciseIndex}`;
      
      // Fill the blank
      userAnswers[answerKey] = wordIndex;
      const blank = document.getElementById(`blank-${testIndex}-${exerciseIndex}`);
      const badge = document.getElementById(`badge-${testIndex}-${exerciseIndex}`);
      
      blank.textContent = word;
      blank.classList.add('filled');
      blank.classList.remove('active');
      badge.classList.add('answered');
      
      // Clear active blank
      activeBlank = null;
      
      updateWordBank();
      updateInfoBar();
      
      // Auto-advance to next exercise if available
      if (exerciseIndex < 4) {
        setTimeout(() => {
          scrollToExercise(exerciseIndex + 1);
        }, 1000);
      }
    }

    // UPDATE WORD BANK
    function updateWordBank() {
      const words = document.querySelectorAll('.word-chip');
      const usedWords = [];
      
      // Find used words in current test
      Object.keys(userAnswers).forEach(key => {
        if (key.startsWith(`${currentTest}-`)) {
          usedWords.push(userAnswers[key]);
        }
      });
      
      words.forEach((word, index) => {
        word.classList.toggle('used', usedWords.includes(index));
      });
    }

    // UPDATE INFO BAR
    function updateInfoBar() {
      if (!quizData || !quizData.sets) {
        document.getElementById('infoBar').textContent = 'Loading quiz data...';
        return;
      }
      
      const currentAnswers = Object.keys(userAnswers).filter(k => k.startsWith(`${currentTest}-`)).length;
      const totalExercises = 5;
      const totalTests = quizData.sets.length;
      
      document.getElementById('infoBar').textContent = 
        `Test ${currentTest + 1} of ${totalTests} • Exercise ${currentExercise + 1} of ${totalExercises} • ${currentAnswers}/5 answered`;
    }

    // CHANGE TEST
    function changeSet(direction) {
      if (!quizData || !quizData.sets) return;
      
      const newTest = currentTest + direction;
      if (newTest >= 0 && newTest < quizData.sets.length) {
        loadTest(newTest);
      }
    } => k.startsWith(`${currentSet}-`)).length;
      const totalQuestions = quizData.sets[currentSet].sentences.length;
      const totalSets = quizData.sets.length;
      
      document.getElementById('infoBar').textContent = 
        `Set ${currentSet + 1} of ${totalSets} • ${currentAnswers}/${totalQuestions} answered • Click a blank, then click a word`;
    }

    // CHANGE SET
    function changeSet(direction) {
      if (!quizData || !quizData.sets) return;
      
      const newSet = currentSet + direction;
      if (newSet >= 0 && newSet < quizData.sets.length) {
        loadSet(newSet);
      }
    }

    // CHECK ANSWERS
    function checkAnswers() {
      if (!quizData || !quizData.sets) {
        alert('Quiz data not loaded yet!');
        return;
      }
      
      console.log('🔍 Checking answers for set:', currentSet);
      const set = quizData.sets[currentSet];
      
      set.sentences.forEach((sentence, qIndex) => {
        const answerKey = `${currentSet}-${qIndex}`;
        if (userAnswers[answerKey] !== undefined) {
          const userAnswer = userAnswers[answerKey];
          const correctAnswer = sentence.correct;
          const blank = document.getElementById(`blank-${currentSet}-${qIndex}`);
          const badge = document.getElementById(`badge-${currentSet}-${qIndex}`);
          
          if (userAnswer === correctAnswer) {
            blank.classList.add('correct');
            blank.classList.remove('incorrect');
            badge.classList.add('correct');
            badge.classList.remove('incorrect');
          } else {
            blank.classList.add('incorrect');
            blank.classList.remove('correct');
            badge.classList.add('incorrect');
            badge.classList.remove('correct');
          }
        }
      });
      
      checkedSets.add(currentSet);
      updateDots();
    }

    // SHOW RESULTS
    function showResults() {
      if (!quizData || !quizData.sets) {
        alert('Quiz data not loaded yet!');
        return;
      }
      
      let totalCorrect = 0;
      let totalAnswered = 0;
      
      checkedSets.forEach(setIndex => {
        const set = quizData.sets[setIndex];
        set.sentences.forEach((sentence, qIndex) => {
          const answerKey = `${setIndex}-${qIndex}`;
          if (userAnswers[answerKey] !== undefined) {
            totalAnswered++;
            if (userAnswers[answerKey] === sentence.correct) {
              totalCorrect++;
            }
          }
        });
      });
      
      const percentage = totalAnswered > 0 ? Math.round((totalCorrect / totalAnswered) * 100) : 0;
      
      document.getElementById('resultsContent').innerHTML = `
        <div class="modal-stat"><strong>Sets Checked:</strong> ${checkedSets.size}/${quizData.sets.length}</div>
        <div class="modal-stat"><strong>Questions Answered:</strong> ${totalAnswered}</div>
        <div class="modal-stat"><strong>Correct Answers:</strong> ${totalCorrect}</div>
        <div class="modal-stat"><strong>Accuracy:</strong> ${percentage}%</div>
      `;
      
      document.getElementById('resultsModal').classList.add('active');
    }

    // RESET SET
    function resetSet() {
      if (!quizData || !quizData.sets) return;
      
      const set = quizData.sets[currentSet];
      
      set.sentences.forEach((_, qIndex) => {
        const answerKey = `${currentSet}-${qIndex}`;
        delete userAnswers[answerKey];
        
        const blank = document.getElementById(`blank-${currentSet}-${qIndex}`);
        const badge = document.getElementById(`badge-${currentSet}-${qIndex}`);
        
        blank.textContent = '_____';
        blank.className = 'blank';
        badge.className = 'question-num';
      });
      
      checkedSets.delete(currentSet);
      activeBlank = null;
      updateWordBank();
      updateInfoBar();
      updateDots();
    }

    // NEXT UNANSWERED
    function nextUnanswered() {
      if (!quizData || !quizData.sets) {
        alert('Quiz data not loaded yet!');
        return;
      }
      
      for (let s = 0; s < quizData.sets.length; s++) {
        const set = quizData.sets[s];
        for (let q = 0; q < set.sentences.length; q++) {
          const answerKey = `${s}-${q}`;
          if (userAnswers[answerKey] === undefined) {
            loadSet(s);
            selectBlank(s, q);
            return;
          }
        }
      }
      alert('All questions have been answered!');
    }

    // UTILITY FUNCTIONS
    function closeModal() {
      document.getElementById('resultsModal').classList.remove('active');
    }

    function goBack() {
      window.location.href = '../similar-words.html';
    }

    // 🧙‍♂️ SMART FEATURES FOR WIZARD KIDS
    
    function setupSmartFeatures() {
      updateProgressRing();
      showShortcutsPanel();
      
      // Show shortcuts panel briefly on load
      setTimeout(() => {
        document.getElementById('shortcutsPanel').classList.add('show');
        setTimeout(() => {
          document.getElementById('shortcutsPanel').classList.remove('show');
        }, 3000);
      }, 2000);
    }

    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        // Number keys 1-5 for word selection
        if (e.key >= '1' && e.key <= '5' && activeBlank) {
          e.preventDefault();
          const wordIndex = parseInt(e.key) - 1;
          const words = document.querySelectorAll('.word-chip:not(.used)');
          if (words[wordIndex]) {
            words[wordIndex].classList.add('selecting');
            setTimeout(() => words[wordIndex].click(), 150);
          }
        }
        
        // Arrow keys for navigation
        if (e.key === 'ArrowUp' && currentExercise > 0) {
          e.preventDefault();
          scrollToExercise(currentExercise - 1);
        }
        if (e.key === 'ArrowDown' && currentExercise < 4) {
          e.preventDefault();
          scrollToExercise(currentExercise + 1);
        }
        if (e.key === 'ArrowLeft') {
          e.preventDefault();
          changeSet(-1);
        }
        if (e.key === 'ArrowRight') {
          e.preventDefault();
          changeSet(1);
        }
        
        // Space to check answers
        if (e.key === ' ') {
          e.preventDefault();
          checkAnswers();
        }
        
        // ? for smart hint
        if (e.key === '?') {
          e.preventDefault();
          showSmartHint();
        }
        
        // Toggle shortcuts panel
        if (e.key === 'h' || e.key === 'H') {
          e.preventDefault();
          toggleShortcutsPanel();
        }
      });
    }

    function updateProgressRing() {
      const totalQuestions = quizData ? quizData.sets.length * 5 : 115; // 23 tests × 5 exercises
      const answeredQuestions = Object.keys(userAnswers).length;
      const progress = (answeredQuestions / totalQuestions) * 100;
      
      const circle = document.querySelector('.progress-ring .progress');
      const circumference = 2 * Math.PI * 26; // radius = 26
      const offset = circumference - (progress / 100) * circumference;
      
      circle.style.strokeDashoffset = offset;
    }

    function updateStreak(isCorrect) {
      if (isCorrect) {
        currentStreak++;
        document.getElementById('streakNumber').textContent = currentStreak;
        
        const streakEl = document.getElementById('streakCounter');
        streakEl.classList.add('show');
        
        if (currentStreak >= 5) {
          streakEl.classList.add('fire');
          setTimeout(() => streakEl.classList.remove('fire'), 600);
        }
        
        // Check for achievements
        checkAchievements();
      } else {
        if (currentStreak > 0) {
          currentStreak = 0;
          document.getElementById('streakNumber').textContent = '0';
          document.getElementById('streakCounter').classList.remove('show');
        }
      }
    }

    // 🏆 PERSISTENT STORAGE SYSTEM
    
    function saveProgress() {
      const progressData = {
        userAnswers,
        checkedTests: Array.from(checkedTests),
        achievements,
        currentStreak,
        perfectScores,
        totalScore,
        mistakes,
        startTime,
        lastSaved: Date.now()
      };
      
      localStorage.setItem('intuityQuizProgress', JSON.stringify(progressData));
      console.log('💾 Progress saved:', Object.keys(userAnswers).length, 'answers,', achievements.length, 'achievements');
    }
    
    function loadProgress() {
      try {
        const saved = localStorage.getItem('intuityQuizProgress');
        if (saved) {
          const data = JSON.parse(saved);
          
          userAnswers = data.userAnswers || {};
          checkedTests = new Set(data.checkedTests || []);
          achievements = data.achievements || [];
          currentStreak = data.currentStreak || 0;
          perfectScores = data.perfectScores || [];
          totalScore = data.totalScore || 0;
          mistakes = data.mistakes || [];
          startTime = data.startTime || Date.now();
          
          // Update UI
          updateAchievementStatus();
          updateProgressRing();
          document.getElementById('streakNumber').textContent = currentStreak;
          
          if (currentStreak > 0) {
            document.getElementById('streakCounter').classList.add('show');
          }
          
          console.log('📁 Progress loaded:', Object.keys(userAnswers).length, 'answers,', achievements.length, 'achievements');
          
          // Show welcome back message if they have progress
          if (Object.keys(userAnswers).length > 0) {
            setTimeout(() => {
              showHintBubble(`🎉 Welcome back! You have ${achievements.length} achievements and ${Object.keys(userAnswers).length} completed exercises.`, null);
            }, 1500);
          }
        }
      } catch (error) {
        console.error('❌ Error loading progress:', error);
      }
    }

    function updateAchievementStatus() {
      const statusEl = document.getElementById('achievementStatus');
      const countEl = document.getElementById('achievementCount');
      
      countEl.textContent = achievements.length;
      
      // Special styling for epic achievements
      if (achievements.includes('quizmaster') || achievements.includes('perfectionist')) {
        statusEl.classList.add('epic');
        statusEl.innerHTML = `👑 <span id="achievementCount">${achievements.length}</span> achievements`;
      }
    }

    function checkAchievements() {
      const newAchievements = [];
      
      // Regular achievements
      if (currentStreak === 5 && !achievements.includes('streak5')) {
        newAchievements.push({ id: 'streak5', title: 'Hot Streak!', desc: '5 correct answers in a row', icon: '🔥' });
      }
      if (currentStreak === 10 && !achievements.includes('streak10')) {
        newAchievements.push({ id: 'streak10', title: 'On Fire!', desc: '10 correct answers in a row', icon: '🚀' });
      }
      if (currentStreak === 20 && !achievements.includes('unstoppable')) {
        newAchievements.push({ id: 'unstoppable', title: 'Unstoppable!', desc: '20 correct answers in a row', icon: '⚡' });
      }
      if (Object.keys(userAnswers).length === 25 && !achievements.includes('quarter')) {
        newAchievements.push({ id: 'quarter', title: 'Quarter Master', desc: 'Completed 25 exercises', icon: '⭐' });
      }
      if (Object.keys(userAnswers).length === 50 && !achievements.includes('halfcentury')) {
        newAchievements.push({ id: 'halfcentury', title: 'Half Century!', desc: 'Completed 50 exercises', icon: '🎯' });
      }
      if (hintCount === 0 && Object.keys(userAnswers).length >= 10 && !achievements.includes('nohints')) {
        newAchievements.push({ id: 'nohints', title: 'Pure Skill', desc: '10+ answers without hints', icon: '🧠' });
      }
      if (perfectScores.length >= 5 && !achievements.includes('perfectionist')) {
        newAchievements.push({ id: 'perfectionist', title: 'Perfectionist', desc: '5 perfect test scores', icon: '💎' });
      }
      
      // Epic achievement for completing ALL tests perfectly
      const totalTests = quizData ? quizData.sets.length : 23;
      if (perfectScores.length === totalTests && !achievements.includes('grandmaster')) {
        newAchievements.push({ 
          id: 'grandmaster', 
          title: 'GRAND MASTER', 
          desc: 'Perfect scores on ALL tests!', 
          icon: '👑',
          epic: true 
        });
      }
      
      newAchievements.forEach(achievement => {
        achievements.push(achievement.id);
        if (achievement.epic) {
          showEpicAchievement(achievement);
        } else {
          showAchievement(achievement);
        }
      });
      
      if (newAchievements.length > 0) {
        updateAchievementStatus();
        saveProgress();
      }
    }

    // 👑 EPIC ACHIEVEMENT SYSTEM
    
    function showEpicAchievement(achievement) {
      const modal = document.getElementById('epicAchievement');
      const icon = modal.querySelector('.epic-icon');
      const title = modal.querySelector('.epic-title');
      const subtitle = modal.querySelector('.epic-subtitle');
      const stats = document.getElementById('epicStats');
      
      icon.textContent = achievement.icon;
      title.textContent = achievement.title;
      subtitle.textContent = achievement.desc;
      
      // Calculate amazing stats
      const totalAnswered = Object.keys(userAnswers).length;
      const timePlayed = Math.round((Date.now() - startTime) / 1000 / 60);
      const accuracy = totalAnswered > 0 ? Math.round((totalScore / totalAnswered) * 100) : 0;
      
      stats.innerHTML = `
        <div class="epic-stat">
          <span>Perfect Score:</span>
          <span>100% ✨</span>
        </div>
        <div class="epic-stat">
          <span>Total Exercises:</span>
          <span>${totalAnswered} 📚</span>
        </div>
        <div class="epic-stat">
          <span>Current Streak:</span>
          <span>${currentStreak} 🔥</span>
        </div>
        <div class="epic-stat">
          <span>Time Played:</span>
          <span>${timePlayed} minutes ⏰</span>
        </div>
        <div class="epic-stat">
          <span>Achievement Rank:</span>
          <span>LEGENDARY 👑</span>
        </div>
      `;
      
      modal.classList.add('show');
      
      // Play celebration sound effect (if you want to add audio later)
      console.log('🎊 EPIC ACHIEVEMENT UNLOCKED:', achievement.title);
    }
    
    function closeEpicAchievement() {
      document.getElementById('epicAchievement').classList.remove('show');
    }
    
    function showAchievementsList() {
      const achievementsList = achievements.map(id => {
        const achievementData = getAchievementData(id);
        return `${achievementData.icon} ${achievementData.title}`;
      }).join('\n');
      
      const message = achievements.length > 0 ? 
        `🏆 Your Achievements (${achievements.length}):\n\n${achievementsList}` :
        '🎯 No achievements yet. Keep playing to unlock them!';
        
      alert(message);
    }
    
    function getAchievementData(id) {
      const achievementMap = {
        'streak5': { icon: '🔥', title: 'Hot Streak!' },
        'streak10': { icon: '🚀', title: 'On Fire!' },
        'unstoppable': { icon: '⚡', title: 'Unstoppable!' },
        'quarter': { icon: '⭐', title: 'Quarter Master' },
        'halfcentury': { icon: '🎯', title: 'Half Century!' },
        'nohints': { icon: '🧠', title: 'Pure Skill' },
        'perfectionist': { icon: '💎', title: 'Perfectionist' },
        'quizmaster': { icon: '👑', title: 'Quiz Master!' },
        'grandmaster': { icon: '👑', title: 'GRAND MASTER' }
      };
      return achievementMap[id] || { icon: '🏆', title: 'Achievement' };
    }

    function showAchievement(achievement) {
      const achievementEl = document.createElement('div');
      achievementEl.className = 'achievement';
      achievementEl.innerHTML = `
        <div class="achievement-icon">${achievement.icon}</div>
        <div class="achievement-title">${achievement.title}</div>
        <div class="achievement-desc">${achievement.desc}</div>
      `;
      
      document.body.appendChild(achievementEl);
      
      setTimeout(() => achievementEl.classList.add('show'), 100);
      setTimeout(() => {
        achievementEl.classList.remove('show');
        setTimeout(() => achievementEl.remove(), 400);
      }, 3000);
    }

    function showSmartHint() {
      if (!activeBlank) {
        showHintBubble("💡 Select a blank first, then I can help!", null);
        return;
      }
      
      hintCount++;
      const { test: testIndex, exercise: exerciseIndex } = activeBlank;
      const testData = quizData.sets[testIndex];
      const correctAnswer = testData.sentences[exerciseIndex].correct;
      const correctWord = testData.words[correctAnswer];
      
      // Smart contextual hints
      const hints = [
        `🎯 Look for a word that means "${getWordHint(correctWord)}"`,
        `📝 The sentence structure suggests a ${getGrammarHint(correctWord)} here`,
        `🔍 Try the word that starts with "${correctWord[0].toUpperCase()}"`,
        `💫 This word has ${correctWord.length} letters`
      ];
      
      const hint = hints[Math.min(hintCount - 1, hints.length - 1)];
      const targetWord = document.querySelectorAll('.word-chip')[correctAnswer];
      
      showHintBubble(hint, targetWord);
      
      // Subtle highlight on correct word after 2 hints
      if (hintCount >= 2) {
        targetWord.classList.add('word-suggestion');
        setTimeout(() => targetWord.classList.remove('word-suggestion'), 3000);
      }
    }

    function getWordHint(word) {
      const hints = {
        'however': 'but, nevertheless',
        'although': 'even though, despite',
        'therefore': 'as a result, consequently',
        'beautiful': 'attractive, lovely',
        'quickly': 'fast, rapidly',
        'important': 'significant, crucial'
      };
      return hints[word.toLowerCase()] || 'something similar';
    }

    function getGrammarHint(word) {
      if (word.endsWith('ly')) return 'adverb';
      if (word.endsWith('ful') || word.endsWith('tive')) return 'adjective';
      return 'connector word';
    }

    function showHintBubble(text, targetElement) {
      const bubble = document.createElement('div');
      bubble.className = 'hint-bubble';
      bubble.textContent = text;
      
      document.body.appendChild(bubble);
      
      // Position bubble
      if (targetElement) {
        const rect = targetElement.getBoundingClientRect();
        bubble.style.left = rect.left + rect.width / 2 - 150 + 'px';
        bubble.style.top = rect.top - bubble.offsetHeight - 20 + 'px';
      } else {
        bubble.style.left = '50%';
        bubble.style.top = '30%';
        bubble.style.transform = 'translateX(-50%)';
      }
      
      bubble.classList.add('show');
      
      setTimeout(() => {
        bubble.classList.remove('show');
        setTimeout(() => bubble.remove(), 300);
      }, 3000);
    }

    // 🎛️ ELEGANT CONTROL CENTER
    
    function toggleControlCenter() {
      const trigger = document.getElementById('controlTrigger');
      const dropdown = document.getElementById('controlDropdown');
      
      const isOpen = trigger.classList.contains('active');
      
      if (isOpen) {
        closeControlCenter();
      } else {
        openControlCenter();
      }
    }
    
    function openControlCenter() {
      const trigger = document.getElementById('controlTrigger');
      const dropdown = document.getElementById('controlDropdown');
      
      trigger.classList.add('active');
      dropdown.classList.add('show');
      
      // Close on outside click
      setTimeout(() => {
        document.addEventListener('click', handleOutsideClick);
      }, 100);
    }
    
    function closeControlCenter() {
      const trigger = document.getElementById('controlTrigger');
      const dropdown = document.getElementById('controlDropdown');
      
      trigger.classList.remove('active');
      dropdown.classList.remove('show');
      
      document.removeEventListener('click', handleOutsideClick);
    }
    
    function handleOutsideClick(e) {
      const controlCenter = e.target.closest('.control-center');
      if (!controlCenter) {
        closeControlCenter();
      }
    }

    function toggleShortcutsPanel() {
      document.getElementById('shortcutsPanel').classList.toggle('show');
    }

    function showShortcutsPanel() {
      // Auto-hide shortcuts panel when user starts interacting
      let interactionCount = 0;
      const hideShortcuts = () => {
        interactionCount++;
        if (interactionCount >= 3) {
          document.getElementById('shortcutsPanel').classList.remove('show');
          document.removeEventListener('click', hideShortcuts);
        }
      };
      document.addEventListener('click', hideShortcuts);
    }

    // Enhanced word selection with auto-save
    function selectWordEnhanced(wordIndex, word) {
      console.log('💬 Word selected:', wordIndex, word);
      
      if (activeBlank === null) {
        showHintBubble("⚠️ Select a blank first!", null);
        return;
      }
      
      const { test: testIndex, exercise: exerciseIndex } = activeBlank;
      const answerKey = `${testIndex}-${exerciseIndex}`;
      
      // Fill the blank with animation
      userAnswers[answerKey] = wordIndex;
      const blank = document.getElementById(`blank-${testIndex}-${exerciseIndex}`);
      const badge = document.getElementById(`badge-${testIndex}-${exerciseIndex}`);
      
      blank.classList.add('filling');
      blank.textContent = word;
      blank.classList.add('filled');
      blank.classList.remove('active');
      badge.classList.add('answered');
      
      // Clear active blank
      activeBlank = null;
      
      updateWordBank();
      updateInfoBar();
      updateProgressRing();
      
      // Auto-save progress
      saveProgress();
      
      // Auto-advance to next exercise if available
      if (exerciseIndex < 4) {
        setTimeout(() => {
          scrollToExercise(exerciseIndex + 1);
        }, 800);
      }
      
      // Reset hint count for new question
      hintCount = 0;
    }intCount = 0;
    }

    // Enhanced check answers with perfect score detection
    function checkAnswersEnhanced() {
      if (!quizData || !quizData.sets) {
        showHintBubble("⚠️ Quiz data not loaded yet!", null);
        return;
      }
      
      console.log('🔍 Checking answers for test:', currentTest);
      const test = quizData.sets[currentTest];
      let correctCount = 0;
      let totalAnswered = 0;
      
      test.sentences.forEach((sentence, exerciseIndex) => {
        const answerKey = `${currentTest}-${exerciseIndex}`;
        if (userAnswers[answerKey] !== undefined) {
          totalAnswered++;
          const userAnswer = userAnswers[answerKey];
          const correctAnswer = sentence.correct;
          const blank = document.getElementById(`blank-${currentTest}-${exerciseIndex}`);
          const badge = document.getElementById(`badge-${currentTest}-${exerciseIndex}`);
          
          const isCorrect = userAnswer === correctAnswer;
          
          if (isCorrect) {
            correctCount++;
            totalScore++;
            blank.classList.add('correct');
            blank.classList.remove('incorrect');
            badge.classList.add('correct');
            badge.classList.remove('incorrect');
          } else {
            blank.classList.add('incorrect');
            blank.classList.remove('correct');
            badge.classList.add('incorrect');
            badge.classList.remove('correct');
            mistakes.push({ test: currentTest, exercise: exerciseIndex, userAnswer, correctAnswer });
          }
          
          updateStreak(isCorrect);
        }
      });
      
      checkedTests.add(currentTest);
      updateDots();
      
      // 🏆 PERFECT SCORE DETECTION
      if (totalAnswered === 5 && correctCount === 5) {
        perfectScores.push(currentTest);
        
        // Add Quiz Master achievement for first perfect score
        if (!achievements.includes('quizmaster')) {
          achievements.push('quizmaster');
          setTimeout(() => {
            showEpicAchievement({
              id: 'quizmaster',
              title: 'QUIZ MASTER!',
              desc: 'Your first perfect score!',
              icon: '👑',
              epic: true
            });
          }, 1500);
        } else {
          // Show congratulations for additional perfect scores
          setTimeout(() => {
            showHintBubble(`🎊 PERFECT SCORE! That's ${perfectScores.length} perfect tests!`, null);
          }, 1000);
        }
      } else if (totalAnswered === 5) {
        // Show completion message for non-perfect scores
        const percentage = Math.round((correctCount / 5) * 100);
        let message = '';
        if (percentage >= 80) message = '🌟 Excellent work!';
        else if (percentage >= 60) message = '👍 Good job!';
        else message = '💪 Keep practicing!';
        
        setTimeout(() => showHintBubble(message, null), 1000);
      }
      
      // Save progress after checking
      saveProgress();
      
      // Check for new achievements
      checkAchievements();
    }

    // Override the original functions with enhanced versions
    const selectWord = selectWordEnhanced;
    const checkAnswers = checkAnswersEnhanced;

    // START THE QUIZ
    window.onload = init;
  </script>
</body>
</html>
