<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>INTUITY - Word Choice Quiz</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Space+Grotesk:wght@600;700;800&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      min-height: 100vh;
      color: #f1f5f9;
      padding: 1rem;
      line-height: 1.6;
    }
    .container { max-width: 900px; margin: 0 auto; }
    .back-btn { display:inline-flex;align-items:center;gap:.5rem;color:#94a3b8;background:none;border:none;font-size:.875rem;cursor:pointer;margin-bottom:1rem;padding:.5rem 0;transition:color .2s; }
    .back-btn:hover { color:#cbd5e1; }
    .header { text-align:center; margin-bottom:1.25rem; }
    .logo { font-family:'Space Grotesk',sans-serif;font-size:2.5rem;font-weight:800;color:rgba(255,107,53,.9);letter-spacing:-.03em;margin-bottom:.25rem; }
    .subtitle { font-size:.8125rem;color:#94a3b8;margin-bottom:.125rem; }
    .author { font-size:.6875rem;color:#64748b; }
    .test-nav { display:flex;align-items:center;justify-content:center;gap:.75rem;margin-bottom:1rem;flex-wrap:wrap; }
    .nav-btn { width:2.25rem;height:2.25rem;border:none;background:rgba(71,85,105,.3);color:#94a3b8;border-radius:.5rem;cursor:pointer;font-size:1.125rem;transition:.2s;display:flex;align-items:center;justify-content:center; }
    .nav-btn:hover:not(:disabled){background:rgba(71,85,105,.5);color:#e2e8f0;}
    .nav-btn:disabled{opacity:.3;cursor:not-allowed;}
    .info-bar{text-align:center;color:#94a3b8;font-size:.875rem;margin-bottom:1rem;font-weight:500;}
    .test-wrapper{background:rgba(30,41,59,.6);backdrop-filter:blur(20px);border:1px solid rgba(71,85,105,.5);border-radius:1rem;padding:1.5rem;box-shadow:0 20px 25px -5px rgba(0,0,0,.5);margin-bottom:1.5rem;}
    .word-bank{display:flex;justify-content:center;align-items:center;gap:.5rem;margin:0 auto 1.5rem;flex-wrap:wrap;background:rgba(30,41,59,.6);backdrop-filter:blur(20px);border:1px solid rgba(71,85,105,.5);border-radius:.75rem;padding:1rem;box-shadow:0 10px 25px -5px rgba(0,0,0,.3);}
    .word-chip{background:rgba(255,107,53,.15);border:1px solid rgba(255,107,53,.3);color:rgba(255,107,53,.9);padding:.5rem 1rem;border-radius:.5rem;font-weight:600;font-size:.875rem;transition:.2s;white-space:nowrap;cursor:pointer;user-select:none;min-width:80px;text-align:center;}
    .word-chip.used{background:rgba(71,85,105,.3);border-color:rgba(71,85,105,.5);color:#64748b;text-decoration:line-through;cursor:not-allowed;}
    .word-chip:hover:not(.used){transform:scale(1.05);background:rgba(255,107,53,.25);}
    .set-divider{margin:2rem 0;padding-top:1rem;border-top:1px solid rgba(71,85,105,.3);}
    .set-title{font-size:.9rem;font-weight:600;color:rgba(255,107,53,.9);margin-bottom:1rem;}
    .question{background:rgba(15,23,42,.5);border:1px solid rgba(71,85,105,.3);border-radius:.625rem;margin-bottom:.625rem;overflow:hidden;transition:.3s;}
    .question-header{display:flex;align-items:center;gap:.75rem;padding:.75rem;}
    .question-num{width:1.75rem;height:1.75rem;border-radius:50%;background:rgba(255,107,53,.8);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.8125rem;flex-shrink:0;}
    .question-text{flex:1;font-size:.875rem;line-height:1.5;}
    .blank{display:inline-block;min-width:70px;padding:.125rem .5rem;background:rgba(71,85,105,.4);border:1px solid rgba(71,85,105,.5);border-radius:.25rem;margin:0 .25rem;color:#94a3b8;font-weight:600;text-align:center;font-size:.8125rem;cursor:pointer;transition:all .2s;}
    .blank.filled{background:rgba(59,130,246,.2);border-color:rgba(59,130,246,.5);color:#60a5fa;}
    .blank.correct{background:rgba(16,185,129,.2);border-color:rgba(16,185,129,.5);color:#34d399;}
    .blank.incorrect{background:rgba(249,115,22,.2);border-color:rgba(249,115,22,.5);color:#fb923c;}
    .blank.active{outline:2px solid rgba(255,107,53,.9);outline-offset:2px;}
    .controls{display:flex;justify-content:center;gap:.5rem;margin-top:1.5rem;padding-top:1rem;border-top:1px solid rgba(71,85,105,.3);flex-wrap:wrap;}
    .control-btn{padding:.65rem 1.5rem;border:none;background:rgba(255,107,53,.15);color:rgba(255,107,53,.9);border-radius:.375rem;cursor:pointer;font-size:.875rem;font-weight:600;transition:.2s;font-family:'Inter',sans-serif;white-space:nowrap;}
    .control-btn:hover{background:rgba(255,107,53,.25);transform:translateY(-1px);}
    .loading,.error{text-align:center;padding:2rem;font-size:1rem;}
    .error{color:#f87171;}
    .loading{color:#94a3b8;}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000;padding:1rem;}
    .modal.active{display:flex;}
    .modal-content{background:#1e293b;border:1px solid rgba(71,85,105,.5);border-radius:1rem;padding:1.5rem;max-width:400px;width:100%;text-align:center;}
    .modal-title{font-size:1.375rem;font-weight:700;color:rgba(255,107,53,.9);margin-bottom:1rem;}
    .modal-stats{margin:1.25rem 0;font-size:1.125rem;color:#cbd5e1;}
    .modal-stat{margin:.5rem 0;}
    .modal-close{padding:.625rem 1.75rem;border:none;background:rgba(255,107,53,.2);color:rgba(255,107,53,.9);border-radius:.5rem;cursor:pointer;font-size:.9375rem;font-weight:600;margin-top:.75rem;font-family:'Inter',sans-serif;}
    .modal-close:hover{background:rgba(255,107,53,.3);}
    .perfect-score{background:linear-gradient(135deg, #10b981 0%, #059669 100%);color:white;padding:1rem;border-radius:.75rem;margin:1rem 0;box-shadow:0 10px 30px rgba(16,185,129,.3);}
    .trophy{font-size:4rem;margin-bottom:.5rem;animation:bounce 1s ease-in-out infinite;}
    @keyframes bounce{0%,100%{transform:translateY(0);}50%{transform:translateY(-10px);}}
  </style>
</head>
<body>
  <div class="container">
    <button class="back-btn" onclick="goBack()">← Back to Menu</button>
    <div class="header">
      <div class="logo">INTUITY</div>
      <div class="subtitle">Word Choice Quiz - B2 Level</div>
      <div class="author">by Majid Nashtai</div>
    </div>
    
    <div class="test-nav">
      <button class="nav-btn" id="prevBtn" onclick="navigateTest(-1)">←</button>
      <div class="info-bar" id="infoBar">Loading...</div>
      <button class="nav-btn" id="nextBtn" onclick="navigateTest(1)">→</button>
    </div>
    
    <div id="testContainer"></div>
  </div>
  
  <div class="modal" id="scoreModal">
    <div class="modal-content">
      <div class="modal-title">Test Score</div>
      <div class="modal-stats" id="scoreContent"></div>
      <button class="modal-close" onclick="closeModal()">Close</button>
    </div>
  </div>
  
  <script>
    let quizData = null;
    let currentTestIndex = 0;
    let userAnswers = {};
    let activeBlank = null;
    let activeWord = null;
    let checkedTests = new Set();
    const SETS_PER_TEST = 5;

    async function init() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        let jsonPath = urlParams.get('json') || 'datacentre/datasm-01.json';
        
        if (!jsonPath.startsWith('http') && !jsonPath.startsWith('/')) {
          jsonPath = '/' + jsonPath;
        }
        
        const response = await fetch(jsonPath);
        if (!response.ok) throw new Error(`Failed to load quiz (HTTP ${response.status})`);
        quizData = await response.json();
        if (!quizData.sets || quizData.sets.length === 0) throw new Error('No quiz sets found');
        
        loadSavedProgress();
        loadTest(0);
        
      } catch (error) {
        console.error('Error loading quiz:', error);
        document.getElementById('testContainer').innerHTML =
          `<div class="error">❌ Error loading quiz<br><small>${error.message}</small></div>`;
      }
    }

    function loadTest(testIndex) {
      currentTestIndex = testIndex;
      activeBlank = null;
      activeWord = null;
      
      const totalTests = Math.ceil(quizData.sets.length / SETS_PER_TEST);
      const startSet = testIndex * SETS_PER_TEST;
      const endSet = Math.min(startSet + SETS_PER_TEST, quizData.sets.length);
      
      let html = '<div class="test-wrapper">';
      
      for (let setIdx = startSet; setIdx < endSet; setIdx++) {
        const set = quizData.sets[setIdx];
        
        if (setIdx > startSet) {
          html += '<div class="set-divider"></div>';
        }
        
        html += `<div class="set-title">Set ${set.setNumber}</div>`;
        
        // Word bank for this set
        html += '<div class="word-bank">';
        set.words.forEach((word, wordIdx) => {
          let isUsed = false;
          set.sentences.forEach((_, sentIdx) => {
            const key = `${setIdx}-${sentIdx}`;
            if (userAnswers[key] === wordIdx) isUsed = true;
          });
          html += `<div class="word-chip ${isUsed ? 'used' : ''}" onclick="handleWordClick(${setIdx}, ${wordIdx})">${word}</div>`;
        });
        html += '</div>';
        
        // Questions
        set.sentences.forEach((sentence, sentIdx) => {
          const key = `${setIdx}-${sentIdx}`;
          const answer = userAnswers[key];
          const parts = sentence.text.split('_____');
          
          let blankClass = 'blank';
          let blankText = '_____';
          
          if (answer !== undefined) {
            blankClass += ' filled';
            blankText = set.words[answer];
            
            if (checkedTests.has(testIndex)) {
              blankClass += answer === sentence.correct ? ' correct' : ' incorrect';
            }
          }
          
          html += `
            <div class="question">
              <div class="question-header">
                <div class="question-num">${sentIdx + 1}</div>
                <div class="question-text">
                  ${parts[0]}<span class="${blankClass}" onclick="handleBlankClick(${setIdx}, ${sentIdx})">${blankText}</span>${parts[1] || ''}
                </div>
              </div>
            </div>
          `;
        });
      }
      
      // Controls
      html += `
        <div class="controls">
          <button class="control-btn" onclick="showAnswers()">Show Answers</button>
          <button class="control-btn" onclick="showScore()">Score</button>
          <button class="control-btn" onclick="resetTest()">Reset</button>
          <button class="control-btn" onclick="nextTest()">Next Test →</button>
        </div>
      </div>`;
      
      document.getElementById('testContainer').innerHTML = html;
      updateInfoBar();
      updateNavButtons();
    }

    function handleBlankClick(setIdx, sentIdx) {
      const key = `${setIdx}-${sentIdx}`;
      
      // If filled, clear it
      if (userAnswers[key] !== undefined) {
        delete userAnswers[key];
        saveProgress();
        loadTest(currentTestIndex);
        return;
      }
      
      // If word selected, fill immediately
      if (activeWord !== null && activeWord.set === setIdx) {
        userAnswers[key] = activeWord.wordIdx;
        activeWord = null;
        saveProgress();
        loadTest(currentTestIndex);
        return;
      }
      
      // Otherwise select this blank
      activeBlank = { set: setIdx, sent: sentIdx };
    }

    function handleWordClick(setIdx, wordIdx) {
      // Check if already used
      const set = quizData.sets[setIdx];
      let isUsed = false;
      set.sentences.forEach((_, sentIdx) => {
        const key = `${setIdx}-${sentIdx}`;
        if (userAnswers[key] === wordIdx) isUsed = true;
      });
      
      if (isUsed) return;
      
      // If blank selected, fill it
      if (activeBlank !== null && activeBlank.set === setIdx) {
        const key = `${activeBlank.set}-${activeBlank.sent}`;
        userAnswers[key] = wordIdx;
        activeBlank = null;
        saveProgress();
        loadTest(currentTestIndex);
        return;
      }
      
      // Otherwise select this word
      activeWord = { set: setIdx, wordIdx: wordIdx };
    }

    function saveProgress() {
      const data = {
        answers: userAnswers,
        checkedTests: Array.from(checkedTests),
        currentTest: currentTestIndex,
        timestamp: new Date().toISOString()
      };
      localStorage.setItem('intuityQuizProgress', JSON.stringify(data));
    }

    function loadSavedProgress() {
      try {
        const saved = localStorage.getItem('intuityQuizProgress');
        if (saved) {
          const data = JSON.parse(saved);
          userAnswers = data.answers || {};
          checkedTests = new Set(data.checkedTests || []);
          currentTestIndex = data.currentTest || 0;
        }
      } catch (e) {
        console.error('Error loading saved progress:', e);
      }
    }

    function showAnswers() {
      checkedTests.add(currentTestIndex);
      loadTest(currentTestIndex);
    }

    function showScore() {
      const startSet = currentTestIndex * SETS_PER_TEST;
      const endSet = Math.min(startSet + SETS_PER_TEST, quizData.sets.length);
      
      let correct = 0;
      let total = 0;
      
      for (let setIdx = startSet; setIdx < endSet; setIdx++) {
        const set = quizData.sets[setIdx];
        set.sentences.forEach((sentence, sentIdx) => {
          const key = `${setIdx}-${sentIdx}`;
          if (userAnswers[key] !== undefined) {
            total++;
            if (userAnswers[key] === sentence.correct) correct++;
          }
        });
      }
      
      const percentage = total > 0 ? Math.round((correct / total) * 100) : 0;
      const totalQuestions = (endSet - startSet) * 4;
      
      let content = '';
      
      // Perfect score celebration!
      if (percentage === 100 && total === totalQuestions) {
        content = `
          <div class="perfect-score">
            <div class="trophy">🏆</div>
            <div style="font-size:1.5rem;font-weight:800;margin-bottom:0.5rem;">PERFECT SCORE!</div>
            <div style="font-size:1rem;">Outstanding work! You got every single answer correct!</div>
          </div>
          <div class="modal-stat" style="color:#10b981;font-weight:700;">100% - All ${totalQuestions} questions correct! 🎉</div>
          <div style="margin-top:1rem;color:#94a3b8;font-size:0.9rem;">You're absolutely crushing it! Keep up this amazing effort!</div>
        `;
      } else {
        content = `
          <div class="modal-stat"><strong>Answered:</strong> ${total}/${totalQuestions}</div>
          <div class="modal-stat"><strong>Correct:</strong> ${correct}</div>
          <div class="modal-stat"><strong>Score:</strong> ${percentage}%</div>
        `;
        
        if (percentage >= 90) {
          content += `<div style="margin-top:1rem;color:#10b981;">Excellent work! Almost perfect! 🌟</div>`;
        } else if (percentage >= 80) {
          content += `<div style="margin-top:1rem;color:#60a5fa;">Great job! You're doing really well! 💪</div>`;
        } else if (percentage >= 70) {
          content += `<div style="margin-top:1rem;color:#94a3b8;">Good effort! Keep practicing! 📚</div>`;
        } else if (total > 0) {
          content += `<div style="margin-top:1rem;color:#94a3b8;">Keep going! Every attempt makes you better! ✨</div>`;
        }
      }
      
      document.getElementById('scoreContent').innerHTML = content;
      document.getElementById('scoreModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('scoreModal').classList.remove('active');
    }

    function resetTest() {
      if (!confirm('Clear all answers for this test?')) return;
      
      const startSet = currentTestIndex * SETS_PER_TEST;
      const endSet = Math.min(startSet + SETS_PER_TEST, quizData.sets.length);
      
      for (let setIdx = startSet; setIdx < endSet; setIdx++) {
        const set = quizData.sets[setIdx];
        set.sentences.forEach((_, sentIdx) => {
          delete userAnswers[`${setIdx}-${sentIdx}`];
        });
      }
      
      checkedTests.delete(currentTestIndex);
      saveProgress();
      loadTest(currentTestIndex);
    }

    function nextTest() {
      const totalTests = Math.ceil(quizData.sets.length / SETS_PER_TEST);
      if (currentTestIndex < totalTests - 1) {
        loadTest(currentTestIndex + 1);
      }
    }

    function navigateTest(direction) {
      const totalTests = Math.ceil(quizData.sets.length / SETS_PER_TEST);
      const newIndex = currentTestIndex + direction;
      if (newIndex >= 0 && newIndex < totalTests) {
        loadTest(newIndex);
      }
    }

    function updateInfoBar() {
      const totalTests = Math.ceil(quizData.sets.length / SETS_PER_TEST);
      const startSet = currentTestIndex * SETS_PER_TEST;
      const endSet = Math.min(startSet + SETS_PER_TEST, quizData.sets.length);
      
      let answered = 0;
      let total = 0;
      
      for (let setIdx = startSet; setIdx < endSet; setIdx++) {
        const set = quizData.sets[setIdx];
        set.sentences.forEach((_, sentIdx) => {
          total++;
          if (userAnswers[`${setIdx}-${sentIdx}`] !== undefined) answered++;
        });
      }
      
      document.getElementById('infoBar').textContent = 
        `Test ${currentTestIndex + 1} of ${totalTests} • ${answered}/${total} answered`;
    }

    function updateNavButtons() {
      const totalTests = Math.ceil(quizData.sets.length / SETS_PER_TEST);
      document.getElementById('prevBtn').disabled = currentTestIndex === 0;
      document.getElementById('nextBtn').disabled = currentTestIndex === totalTests - 1;
    }

    function goBack() {
      window.location.href = '../similar-words.html';
    }

    window.onload = init;
  </script>
</body>
</html>
