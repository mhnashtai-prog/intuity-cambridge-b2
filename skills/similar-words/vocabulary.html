<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>INTUITY - Word Choice Quiz</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Space+Grotesk:wght@600;700;800&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      min-height: 100vh;
      color: #f1f5f9;
      padding: 1rem;
      line-height: 1.6;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    /* Header - More Compact */
    .header {
      text-align: center;
      margin-bottom: 1.25rem;
    }

    .logo {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 2.5rem;
      font-weight: 800;
      color: rgba(255, 107, 53, 0.9);
      letter-spacing: -0.03em;
      margin-bottom: 0.25rem;
    }

    .subtitle {
      font-size: 0.8125rem;
      color: #94a3b8;
      margin-bottom: 0.125rem;
    }

    .author {
      font-size: 0.6875rem;
      color: #64748b;
    }

    /* Test Navigation - Compact */
    .test-nav {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .nav-btn {
      width: 2.25rem;
      height: 2.25rem;
      border: none;
      background: rgba(71, 85, 105, 0.3);
      color: #94a3b8;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 1.125rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-btn:hover:not(:disabled) {
      background: rgba(71, 85, 105, 0.5);
      color: #e2e8f0;
    }

    .nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .dots {
      display: flex;
      gap: 0.375rem;
      flex-wrap: wrap;
      max-width: 400px;
    }

    .dot {
      width: 0.625rem;
      height: 0.625rem;
      border-radius: 50%;
      background: #475569;
      cursor: pointer;
      transition: all 0.2s;
    }

    .dot:hover {
      background: #64748b;
      transform: scale(1.2);
    }

    .dot.active {
      background: rgba(255, 107, 53, 0.9);
      box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.2);
    }

    .dot.completed {
      background: #10b981;
    }

    /* Info Bar - Compact */
    .info-bar {
      text-align: center;
      color: #94a3b8;
      font-size: 0.8125rem;
      margin-bottom: 1rem;
      font-weight: 500;
    }

    /* Quiz Container - Reduced Padding */
    .quiz-box {
      background: rgba(30, 41, 59, 0.6);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(71, 85, 105, 0.5);
      border-radius: 1rem;
      padding: 1rem;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
    }

    /* Question Item - Tighter */
    .question {
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid rgba(71, 85, 105, 0.3);
      border-radius: 0.625rem;
      margin-bottom: 0.625rem;
      overflow: hidden;
      transition: all 0.3s;
    }

    .question.open {
      background: rgba(51, 65, 85, 0.5);
      border-color: rgba(255, 107, 53, 0.3);
    }

    .question-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      cursor: pointer;
    }

    .question-num {
      width: 1.75rem;
      height: 1.75rem;
      border-radius: 50%;
      background: rgba(255, 107, 53, 0.8);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.8125rem;
      flex-shrink: 0;
      transition: all 0.2s;
    }

    .question-num.answered {
      background: #3b82f6;
    }

    .question-num.correct {
      background: #10b981;
    }

    .question-num.incorrect {
      background: #f59e0b;
    }

    .question-text {
      flex: 1;
      font-size: 0.875rem;
      line-height: 1.5;
    }

    .blank {
      display: inline-block;
      min-width: 70px;
      padding: 0.125rem 0.5rem;
      background: rgba(71, 85, 105, 0.4);
      border: 1px solid rgba(71, 85, 105, 0.5);
      border-radius: 0.25rem;
      margin: 0 0.25rem;
      color: #94a3b8;
      font-weight: 600;
      text-align: center;
      font-size: 0.8125rem;
    }

    .blank.filled {
      background: rgba(59, 130, 246, 0.2);
      border-color: rgba(59, 130, 246, 0.5);
      color: #60a5fa;
    }

    .blank.correct {
      background: rgba(16, 185, 129, 0.2);
      border-color: rgba(16, 185, 129, 0.5);
      color: #34d399;
    }

    .blank.incorrect {
      background: rgba(245, 158, 11, 0.2);
      border-color: rgba(245, 158, 11, 0.5);
      color: #fbbf24;
    }

    .close-icon {
      color: #64748b;
      font-size: 1.125rem;
      cursor: pointer;
      padding: 0.125rem;
      transition: color 0.2s;
    }

    .close-icon:hover {
      color: #94a3b8;
    }

    /* Options Panel - Reduced Padding */
    .options-panel {
      padding: 0 0.75rem 0.75rem;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .options-grid {
      display: flex;
      gap: 0.5rem;
      background: rgba(15, 23, 42, 0.5);
      padding: 0.75rem;
      border-radius: 0.5rem;
    }

    .option-btn {
      flex: 1;
      padding: 0.5rem 0.5rem;
      border: 1px solid rgba(71, 85, 105, 0.5);
      background: rgba(51, 65, 85, 0.3);
      color: #cbd5e1;
      border-radius: 0.375rem;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 600;
      transition: all 0.2s;
      font-family: 'Inter', sans-serif;
      text-align: center;
    }

    .option-btn:hover:not(.used) {
      background: rgba(71, 85, 105, 0.5);
      border-color: rgba(255, 107, 53, 0.5);
      transform: translateY(-2px);
    }

    .option-btn.used {
      opacity: 0.3;
      cursor: not-allowed;
    }

    /* Controls - REDUCED HEIGHT */
    .controls {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 1.25rem;
      flex-wrap: wrap;
    }

    .control-btn {
      padding: 0.5rem 1.25rem;
      border: none;
      background: rgba(255, 107, 53, 0.15);
      color: rgba(255, 107, 53, 0.9);
      border-radius: 0.375rem;
      cursor: pointer;
      font-size: 0.8125rem;
      font-weight: 600;
      transition: all 0.2s;
      font-family: 'Inter', sans-serif;
      white-space: nowrap;
    }

    .control-btn:hover {
      background: rgba(255, 107, 53, 0.25);
      transform: translateY(-1px);
    }

    /* Loading & Error States */
    .loading, .error {
      text-align: center;
      padding: 2rem;
      font-size: 1rem;
    }

    .error {
      color: #f87171;
    }

    .loading {
      color: #94a3b8;
    }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: #1e293b;
      border: 1px solid rgba(71, 85, 105, 0.5);
      border-radius: 1rem;
      padding: 1.5rem;
      max-width: 400px;
      width: 100%;
      text-align: center;
    }

    .modal-title {
      font-size: 1.375rem;
      font-weight: 700;
      color: rgba(255, 107, 53, 0.9);
      margin-bottom: 1rem;
    }

    .modal-stats {
      margin: 1.25rem 0;
      font-size: 1rem;
      color: #cbd5e1;
    }

    .modal-stat {
      margin: 0.375rem 0;
    }

    .modal-close {
      padding: 0.625rem 1.75rem;
      border: none;
      background: rgba(255, 107, 53, 0.2);
      color: rgba(255, 107, 53, 0.9);
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 0.9375rem;
      font-weight: 600;
      margin-top: 0.75rem;
      font-family: 'Inter', sans-serif;
    }

    .modal-close:hover {
      background: rgba(255, 107, 53, 0.3);
    }

    /* Mobile Optimizations */
    @media (max-width: 640px) {
      body {
        padding: 0.75rem;
      }

      .logo {
        font-size: 2rem;
      }

      .subtitle {
        font-size: 0.75rem;
      }

      .author {
        font-size: 0.625rem;
      }
      
      .quiz-box {
        padding: 0.75rem;
      }

      .question-header {
        padding: 0.625rem;
        gap: 0.625rem;
      }

      .question-text {
        font-size: 0.8125rem;
      }
      
      .options-grid {
        gap: 0.375rem;
        padding: 0.625rem;
      }

      .option-btn {
        padding: 0.5rem 0.375rem;
        font-size: 0.8125rem;
      }

      .control-btn {
        padding: 0.5rem 1rem;
        font-size: 0.75rem;
      }

      .controls {
        gap: 0.375rem;
      }
    }

    @media (max-width: 360px) {
      .logo {
        font-size: 1.75rem;
      }

      .option-btn {
        font-size: 0.75rem;
        padding: 0.5rem 0.25rem;
      }
    }

    @media (min-width: 768px) {
      body {
        padding: 1.5rem;
      }

      .logo {
        font-size: 3rem;
      }

      .header {
        margin-bottom: 2rem;
      }

      .test-nav {
        margin-bottom: 1.5rem;
      }

      .quiz-box {
        padding: 1.5rem;
      }

      .question {
        margin-bottom: 0.875rem;
      }

      .question-header {
        padding: 1rem;
        gap: 1rem;
      }

      .question-text {
        font-size: 0.9375rem;
      }

      .options-grid {
        gap: 0.625rem;
        padding: 1rem;
      }

      .option-btn {
        padding: 0.625rem 0.75rem;
        font-size: 0.9375rem;
      }

      .control-btn {
        padding: 0.625rem 1.5rem;
        font-size: 0.875rem;
      }

      .controls {
        gap: 0.75rem;
        margin-top: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="logo">INTUITY</div>
      <div class="subtitle">Word Choice Quiz - B2 Level</div>
      <div class="author">by Majid Nashtai</div>
    </div>

    <!-- Test Navigation -->
    <div class="test-nav">
      <button class="nav-btn" id="prevBtn" onclick="changeSet(-1)">←</button>
      <div class="dots" id="dotsContainer"></div>
      <button class="nav-btn" id="nextBtn" onclick="changeSet(1)">→</button>
    </div>

    <!-- Info Bar -->
    <div class="info-bar" id="infoBar">Loading quiz...</div>

    <!-- Quiz Container -->
    <div class="quiz-box">
      <div id="questionsContainer">
        <div class="loading">Loading questions...</div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <button class="control-btn" onclick="checkAnswers()">Check Answers</button>
      <button class="control-btn" onclick="showResults()">Show Score</button>
      <button class="control-btn" onclick="resetQuiz()">Reset</button>
    </div>
  </div>

  <!-- Results Modal -->
  <div class="modal" id="resultsModal">
    <div class="modal-content">
      <div class="modal-title">Quiz Results</div>
      <div class="modal-stats" id="resultsContent"></div>
      <button class="modal-close" onclick="closeModal()">Close</button>
    </div>
  </div>

  <script>
    // State
    let quizData = null;
    let currentSetIndex = 0;
    let userAnswers = {};
    let openQuestions = new Set();
    let checkedSets = new Set();
    let isChecked = false;

    // Initialize
    async function init() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        // FIXED: Corrected default path from vocabulary.html location
        const jsonPath = urlParams.get('json') || '../../../datacentre/datasm-01.json';
        
        console.log('Attempting to load:', jsonPath);
        
        const response = await fetch(jsonPath);
        if (!response.ok) throw new Error(`Failed to load quiz data (${response.status})`);
        
        quizData = await response.json();
        
        if (!quizData.sets || quizData.sets.length === 0) {
          throw new Error('No quiz sets found');
        }
        
        renderDots();
        loadSet(0);
      } catch (error) {
        document.getElementById('questionsContainer').innerHTML = 
          `<div class="error">Error: ${error.message}<br><small>Check browser console for details</small></div>`;
        console.error('Quiz loading error:', error);
      }
    }

    // Render navigation dots
    function renderDots() {
      const container = document.getElementById('dotsContainer');
      container.innerHTML = '';
      
      quizData.sets.forEach((set, index) => {
        const dot = document.createElement('div');
        dot.className = 'dot';
        if (index === currentSetIndex) dot.classList.add('active');
        if (checkedSets.has(index)) dot.classList.add('completed');
        dot.onclick = () => loadSet(index);
        container.appendChild(dot);
      });
    }

    // Load a specific set
    function loadSet(index) {
      currentSetIndex = index;
      userAnswers = {};
      openQuestions.clear();
      isChecked = false;
      
      updateInfoBar();
      renderQuestions();
      renderDots();
      updateNavButtons();
    }

    // Update info bar
    function updateInfoBar() {
      const set = quizData.sets[currentSetIndex];
      const answered = Object.keys(userAnswers).length;
      document.getElementById('infoBar').textContent = 
        `Set ${currentSetIndex + 1} of ${quizData.sets.length} • ${answered}/${set.sentences.length} answered`;
    }

    // Render questions
    function renderQuestions() {
      const container = document.getElementById('questionsContainer');
      const set = quizData.sets[currentSetIndex];
      
      container.innerHTML = '';
      
      set.sentences.forEach((sentence, idx) => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question';
        if (openQuestions.has(idx)) questionDiv.classList.add('open');
        
        // Question header
        const header = document.createElement('div');
        header.className = 'question-header';
        header.onclick = () => toggleQuestion(idx);
        
        // Number badge
        const numBadge = document.createElement('div');
        numBadge.className = 'question-num';
        if (userAnswers[idx] !== undefined) numBadge.classList.add('answered');
        if (isChecked) {
          if (userAnswers[idx] === sentence.correct) {
            numBadge.classList.add('correct');
          } else if (userAnswers[idx] !== undefined) {
            numBadge.classList.add('incorrect');
          }
        }
        numBadge.textContent = idx + 1;
        
        // Question text
        const textDiv = document.createElement('div');
        textDiv.className = 'question-text';
        
        const parts = sentence.text.split('_____');
        const blank = document.createElement('span');
        blank.className = 'blank';
        
        if (userAnswers[idx] !== undefined) {
          blank.textContent = set.words[userAnswers[idx]];
          blank.classList.add('filled');
          if (isChecked) {
            blank.classList.add(userAnswers[idx] === sentence.correct ? 'correct' : 'incorrect');
          }
        } else {
          blank.textContent = '_____';
        }
        
        textDiv.innerHTML = parts[0];
        textDiv.appendChild(blank);
        if (parts[1]) textDiv.innerHTML += parts[1];
        
        header.appendChild(numBadge);
        header.appendChild(textDiv);
        
        // Close icon for open questions
        if (openQuestions.has(idx)) {
          const closeIcon = document.createElement('div');
          closeIcon.className = 'close-icon';
          closeIcon.innerHTML = '✕';
          closeIcon.onclick = (e) => {
            e.stopPropagation();
            toggleQuestion(idx);
          };
          header.appendChild(closeIcon);
        }
        
        questionDiv.appendChild(header);
        
        // Options panel (if open and not checked)
        if (openQuestions.has(idx) && !isChecked) {
          const optionsPanel = document.createElement('div');
          optionsPanel.className = 'options-panel';
          
          const optionsGrid = document.createElement('div');
          optionsGrid.className = 'options-grid';
          
          set.words.forEach((word, wordIdx) => {
            const usedInOther = Object.entries(userAnswers).some(
              ([qIdx, aIdx]) => qIdx != idx && aIdx === wordIdx
            );
            
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            if (usedInOther) btn.classList.add('used');
            btn.textContent = word;
            btn.onclick = () => {
              if (!usedInOther) {
                userAnswers[idx] = wordIdx;
                updateInfoBar();
                renderQuestions();
              }
            };
            
            optionsGrid.appendChild(btn);
          });
          
          optionsPanel.appendChild(optionsGrid);
          questionDiv.appendChild(optionsPanel);
        }
        
        container.appendChild(questionDiv);
      });
    }

    // Toggle question open/closed
    function toggleQuestion(idx) {
      if (isChecked) return;
      
      if (openQuestions.has(idx)) {
        openQuestions.delete(idx);
      } else {
        openQuestions.add(idx);
      }
      renderQuestions();
    }

    // Change set
    function changeSet(direction) {
      const newIndex = currentSetIndex + direction;
      if (newIndex >= 0 && newIndex < quizData.sets.length) {
        loadSet(newIndex);
      }
    }

    // Update navigation buttons
    function updateNavButtons() {
      document.getElementById('prevBtn').disabled = currentSetIndex === 0;
      document.getElementById('nextBtn').disabled = currentSetIndex === quizData.sets.length - 1;
    }

    // Check answers
    function checkAnswers() {
      isChecked = true;
      checkedSets.add(currentSetIndex);
      openQuestions.clear();
      renderQuestions();
      renderDots();
    }

    // Show results modal
    function showResults() {
      const set = quizData.sets[currentSetIndex];
      let correct = 0;
      let answered = 0;
      
      set.sentences.forEach((sentence, idx) => {
        if (userAnswers[idx] !== undefined) {
          answered++;
          if (userAnswers[idx] === sentence.correct) correct++;
        }
      });
      
      const total = set.sentences.length;
      const percentage = answered > 0 ? Math.round((correct / answered) * 100) : 0;
      const setsCompleted = checkedSets.size;
      
      document.getElementById('resultsContent').innerHTML = `
        <div class="modal-stat"><strong>Set:</strong> ${currentSetIndex + 1} of ${quizData.sets.length}</div>
        <div class="modal-stat"><strong>Answered:</strong> ${answered}/${total}</div>
        <div class="modal-stat"><strong>Correct:</strong> ${correct}/${answered}</div>
        <div class="modal-stat"><strong>Accuracy:</strong> ${percentage}%</div>
        <div class="modal-stat"><strong>Sets Completed:</strong> ${setsCompleted}/${quizData.sets.length}</div>
      `;
      
      document.getElementById('resultsModal').classList.add('active');
    }

    // Close modal
    function closeModal() {
      document.getElementById('resultsModal').classList.remove('active');
    }

    // Reset quiz
    function resetQuiz() {
      userAnswers = {};
      openQuestions.clear();
      isChecked = false;
      updateInfoBar();
      renderQuestions();
    }

    // Start
    window.onload = init;
  </script>
</body>
</html>
