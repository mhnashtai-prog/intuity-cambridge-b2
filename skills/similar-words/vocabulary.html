<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>INTUITY - Word Choice Quiz</title>
  <style>
    body {
      background: #0f172a;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    .word-bank {
      margin: 20px auto;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    .word-chip {
      padding: 8px 14px;
      border-radius: 20px;
      background: #f97316;
      cursor: pointer;
      transition: background 0.2s;
    }
    .word-chip.used {
      background: gray;
      cursor: not-allowed;
    }
    .question {
      margin: 15px auto;
      padding: 15px;
      background: #1e293b;
      border-radius: 12px;
      max-width: 800px;
      text-align: left;
      line-height: 1.6;
    }
    .blank {
      display: inline-block;
      min-width: 80px;
      padding: 3px 6px;
      border-bottom: 2px solid #f97316;
      cursor: pointer;
      text-align: center;
    }
    .blank.active {
      outline: 2px solid #f97316;
    }
    .blank.correct {
      background: #16a34a;
      color: white;
      border-radius: 6px;
    }
    .blank.incorrect {
      background: #dc2626;
      color: white;
      border-radius: 6px;
    }
    .info-bar {
      margin: 15px;
    }
    .buttons {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }
    button {
      background: #f97316;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
    }
    button:disabled {
      background: gray;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>INTUITY</h1>
  <h3>Word Choice Quiz - B2 Level</h3>
  <div class="info-bar" id="infoBar"></div>
  <div class="word-bank" id="wordBank"></div>
  <div id="questions"></div>
  <div class="buttons">
    <button id="checkBtn">Check Answers</button>
    <button id="repeatBtn">Repeat</button>
    <button id="backBtn">Back</button>
    <button id="nextBtn">Next Set</button>
  </div>

  <script>
    let sets = [];
    let currentSet = 0;
    let userAnswers = [];
    let activeBlank = null;
    let isChecked = false;

    async function init() {
      const urlParams = new URLSearchParams(window.location.search);
      const jsonPath = urlParams.get('json') || '../datacentre/datasm-01.json';
      const res = await fetch(jsonPath);
      sets = await res.json();
      loadSet(0);
    }

    function shuffleWords(words) {
      const indices = Array.from(words.keys());
      for (let i = indices.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [indices[i], indices[j]] = [indices[j], indices[i]];
      }
      const newWords = indices.map(i => words[i]);
      const indexMap = {};
      indices.forEach((oldIdx, newIdx) => {
        indexMap[oldIdx] = newIdx;
      });
      return { words: newWords, indexMap };
    }

    function loadSet(index) {
      currentSet = index;
      isChecked = false;
      activeBlank = null;
      const set = sets[currentSet];
      const { words, indexMap } = shuffleWords(set.words);
      set.words = words;
      set.sentences.forEach(s => {
        s.answer = indexMap[s.answer];
      });
      userAnswers = Array(set.sentences.length).fill(null);
      renderWordBank();
      renderQuestions();
      updateInfoBar();
      document.getElementById("checkBtn").disabled = false;
    }

    function renderWordBank() {
      const wordBank = document.getElementById("wordBank");
      wordBank.innerHTML = "";
      sets[currentSet].words.forEach((word, wordIdx) => {
        const chip = document.createElement("div");
        chip.className = "word-chip";
        chip.textContent = word;
        if (userAnswers.includes(wordIdx)) chip.classList.add("used");
        chip.onclick = () => {
          if (activeBlank !== null && !isChecked && !chip.classList.contains("used")) {
            userAnswers[activeBlank] = wordIdx;
            activeBlank = null;
            renderWordBank();
            renderQuestions();
            updateInfoBar();
          }
        };
        wordBank.appendChild(chip);
      });
    }

    function renderQuestions() {
      const container = document.getElementById("questions");
      container.innerHTML = "";
      const set = sets[currentSet];
      set.sentences.forEach((sentence, idx) => {
        const div = document.createElement("div");
        div.className = "question";

        const parts = sentence.sentence.split("____");
        const before = parts[0] || "";
        const after = parts[1] || "";

        const blank = document.createElement("span");
        blank.className = "blank";
        if (activeBlank === idx) blank.classList.add("active");

        if (userAnswers[idx] !== null) {
          blank.textContent = set.words[userAnswers[idx]];
        } else {
          blank.innerHTML = "&nbsp;";
        }

        if (isChecked) {
          if (userAnswers[idx] === sentence.answer) {
            blank.classList.add("correct");
          } else {
            blank.classList.add("incorrect");
          }
        }

        blank.onclick = () => {
          if (isChecked) return;
          activeBlank = idx;
          renderQuestions();
        };

        div.innerHTML = before;
        div.appendChild(blank);
        div.innerHTML += after;

        container.appendChild(div);
      });
    }

    function updateInfoBar() {
      const answered = userAnswers.filter(x => x !== null).length;
      document.getElementById("infoBar").textContent =
        `Set ${currentSet + 1} of ${sets.length} â€¢ ${answered}/${userAnswers.length} answered`;
    }

    function checkAnswers() {
      isChecked = true;
      activeBlank = null;
      renderQuestions();
      document.getElementById("checkBtn").disabled = true;
    }

    function repeatSet() {
      loadSet(currentSet);
    }

    function nextSet() {
      if (currentSet < sets.length - 1) {
        loadSet(currentSet + 1);
      }
    }

    function backSet() {
      if (currentSet > 0) {
        loadSet(currentSet - 1);
      }
    }

    document.getElementById("checkBtn").onclick = checkAnswers;
    document.getElementById("repeatBtn").onclick = repeatSet;
    document.getElementById("nextBtn").onclick = nextSet;
    document.getElementById("backBtn").onclick = backSet;

    init();
  </script>
</body>
</html>

