<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>INTUITY - Speaking Part 3 Dialogue</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'DM Sans', 'Inter', -apple-system, sans-serif;
  background: #0d0d0d;
  background-image: radial-gradient(circle at 20% 50%, rgba(201, 169, 97, 0.04) 0%, transparent 50%),
                    radial-gradient(circle at 80% 80%, rgba(201, 169, 97, 0.03) 0%, transparent 50%);
  color: #e5e5e5;
  min-height: 100vh;
  padding: 1rem;
  overflow-x: hidden;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  position: relative;
  z-index: 1;
}

/* ========== HEADER ========== */
.header {
  text-align: center;
  margin-bottom: 2rem;
  padding: 1rem 0;
  position: relative;
}

.back-link {
  position: absolute;
  left: 0;
  top: 50%;
  transform: translateY(-50%);
  color: #8e8e93;
  text-decoration: none;
  font-size: 0.875rem;
  font-weight: 500;
  transition: color 0.3s ease;
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.back-link:hover { color: #C9A961; }

.header h1 {
  font-family: 'Space Grotesk', sans-serif;
  font-size: 2rem;
  font-weight: 700;
  background: linear-gradient(135deg, #C9A961 0%, rgba(201, 169, 97, 0.8) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-transform: uppercase;
  letter-spacing: -0.04em;
  margin-bottom: 0.5rem;
}

.subtitle {
  font-size: 0.8125rem;
  color: #8e8e93;
  font-weight: 500;
  letter-spacing: 0.04em;
  text-transform: uppercase;
}

/* ========== TOPIC SELECTOR ========== */
.topic-selector {
  background: rgba(28, 28, 30, 0.6);
  backdrop-filter: blur(40px);
  border-radius: 1rem;
  border: 1px solid rgba(201, 169, 97, 0.25);
  padding: 1.5rem;
  margin-bottom: 2rem;
}

.topic-selector label {
  display: block;
  font-size: 0.875rem;
  color: #8e8e93;
  margin-bottom: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  font-weight: 600;
}

.topic-buttons {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 0.75rem;
}

.topic-btn {
  padding: 0.875rem 1rem;
  background: rgba(0, 0, 0, 0.4);
  border: 1px solid rgba(84, 84, 88, 0.3);
  border-radius: 0.75rem;
  color: #8e8e93;
  font-size: 0.8125rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: center;
}
.topic-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1rem;
}

.topic-card {
  position: relative;
  cursor: pointer;
  border-radius: 1rem;
  overflow: hidden;
  border: 2px solid rgba(84, 84, 88, 0.3);
  transition: all 0.3s ease;
  background: rgba(0, 0, 0, 0.4);
}

.topic-card:hover {
  border-color: rgba(201, 169, 97, 0.6);
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(201, 169, 97, 0.3);
}

.topic-card.active {
  border-color: #C9A961;
  box-shadow: 0 8px 24px rgba(201, 169, 97, 0.5);
}

.topic-card-image {
  width: 100%;
  height: 160px;
  object-fit: cover;
}

.topic-card-content {
  padding: 1rem;
  background: linear-gradient(to top, rgba(0,0,0,0.95), rgba(0,0,0,0.7));
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
}

.topic-card-title {
  font-size: 0.9375rem;
  font-weight: 700;
  color: #e5e5e7;
  margin-bottom: 0.25rem;
}

.topic-card-subtitle {
  font-size: 0.75rem;
  color: #8e8e93;
}
    
.topic-btn:hover {
  background: rgba(201, 169, 97, 0.15);
  border-color: rgba(201, 169, 97, 0.4);
  color: #C9A961;
  transform: translateY(-2px);
}

.topic-btn.active {
  background: rgba(201, 169, 97, 0.25);
  border-color: #C9A961;
  color: #C9A961;
  box-shadow: 0 4px 12px rgba(201, 169, 97, 0.3);
}

/* ========== LAYOUT: DIALOGUE + MIND MAP ========== */
.main-layout {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
  margin-bottom: 2rem;
}

/* ========== LEFT SIDE: DIALOGUE ========== */
.dialogue-stage {
  background: rgba(28, 28, 30, 0.6);
  backdrop-filter: blur(40px);
  border-radius: 1.5rem;
  border: 1px solid rgba(201, 169, 97, 0.25);
  padding: 2rem;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
}

/* Progress */
.progress-bar {
  width: 100%;
  height: 6px;
  background: rgba(99, 99, 102, 0.3);
  border-radius: 3px;
  overflow: hidden;
  margin-bottom: 1rem;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #C9A961 0%, #d4b46e 100%);
  width: 0%;
  transition: width 0.3s ease;
  box-shadow: 0 0 10px rgba(201, 169, 97, 0.5);
}

.progress-text {
  text-align: center;
  font-size: 0.75rem;
  color: #8e8e93;
  margin-bottom: 1.5rem;
}

/* Speakers */
.speakers {
  display: flex;
  justify-content: space-around;
  padding: 1.5rem 0;
  gap: 3rem;
  margin-bottom: 2rem;
}

.speaker {
  display: flex;
  flex-direction: column;
  align-items: center;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  opacity: 0.4;
  transform: scale(0.95);
}

.speaker.active {
  opacity: 1;
  transform: scale(1.05);
}

.avatar {
  width: 90px;
  height: 90px;
  border-radius: 50%;
  background: linear-gradient(135deg, rgba(201, 169, 97, 0.3) 0%, rgba(201, 169, 97, 0.1) 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 3.5rem;
  border: 3px solid rgba(201, 169, 97, 0.2);
  transition: all 0.3s ease;
  margin-bottom: 0.75rem;
}

.speaker.active .avatar {
  border-color: #C9A961;
  box-shadow: 0 0 30px rgba(201, 169, 97, 0.6);
  background: linear-gradient(135deg, rgba(201, 169, 97, 0.4) 0%, rgba(201, 169, 97, 0.2) 100%);
}

.speaker-name {
  font-family: 'Space Grotesk', sans-serif;
  font-size: 1rem;
  font-weight: 700;
  color: #8e8e93;
  margin-bottom: 0.5rem;
  transition: color 0.3s ease;
}

.speaker.active .speaker-name {
  color: #C9A961;
}

.speaking-indicator {
  width: 50px;
  height: 4px;
  background: rgba(99, 99, 102, 0.3);
  border-radius: 2px;
  position: relative;
  overflow: hidden;
}

.speaking-indicator.pulsing::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, #C9A961, transparent);
  animation: speaking 1.5s ease-in-out infinite;
}

@keyframes speaking {
  0% { left: -100%; }
  100% { left: 100%; }
}

/* Dialogue Bubble */
.dialogue-bubble {
  background: rgba(48, 48, 51, 0.5);
  border-radius: 1.25rem;
  padding: 2rem;
  margin-bottom: 2rem;
  border: 1px solid rgba(84, 84, 88, 0.2);
  min-height: 140px;
  position: relative;
}

.speaker-label {
  font-family: 'Space Grotesk', sans-serif;
  font-size: 0.875rem;
  font-weight: 700;
  color: #C9A961;
  text-transform: uppercase;
  margin-bottom: 0.875rem;
  letter-spacing: 0.05em;
}

.text-content {
  font-size: 1.125rem;
  color: #e5e5e7;
  line-height: 1.7;
}

/* Discourse Highlighting */
.agreement-phrase { color: inherit; transition: all 0.3s; }
.disagreement-phrase { color: inherit; transition: all 0.3s; }
.linking-phrase { color: inherit; transition: all 0.3s; }
.opinion-phrase { color: inherit; transition: all 0.3s; }

.text-content.discourse-active .agreement-phrase {
  color: #4ade80 !important;
  font-weight: 600 !important;
  border-bottom: 2px solid rgba(74, 222, 128, 0.4) !important;
  padding-bottom: 2px;
}

.text-content.discourse-active .disagreement-phrase {
  color: #fb923c !important;
  font-weight: 600 !important;
  border-bottom: 2px solid rgba(251, 146, 60, 0.4) !important;
  padding-bottom: 2px;
}

.text-content.discourse-active .linking-phrase {
  color: #60a5fa !important;
  font-weight: 600 !important;
  border-bottom: 2px solid rgba(96, 165, 250, 0.4) !important;
  padding-bottom: 2px;
}

.text-content.discourse-active .opinion-phrase {
  color: #a78bfa !important;
  font-weight: 600 !important;
  border-bottom: 2px solid rgba(167, 139, 250, 0.4) !important;
  padding-bottom: 2px;
}

/* Phrase hint buttons */
.phrase-hint-btn {
  display: none;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  margin-left: 3px;
  background: rgba(96, 165, 250, 0.15);
  border: 1px solid rgba(96, 165, 250, 0.3);
  border-radius: 50%;
  font-size: 11px;
  cursor: pointer;
  opacity: 0.75;
  transition: all 0.3s;
  vertical-align: middle;
  position: relative;
  top: -2px;
  padding: 0;
}

.text-content.phrase-explorer-active .phrase-hint-btn {
  display: inline-flex;
}

.phrase-hint-btn:hover {
  opacity: 1;
  background: rgba(96, 165, 250, 0.25);
  transform: scale(1.2);
  box-shadow: 0 0 12px rgba(96, 165, 250, 0.5);
}

/* Action Buttons */
.action-buttons {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
  justify-content: center;
}

.action-btn {
  padding: 0.5rem 1rem;
  border-radius: 999px;
  border: 1px solid rgba(255, 255, 255, 0.08);
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(10px);
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
  cursor: pointer;
  transition: all 0.3s;
  min-height: 44px;
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

.discourse-btn {
  color: #7dd3fc;
}

.discourse-btn:hover {
  background: rgba(125, 211, 252, 0.15);
  border-color: rgba(125, 211, 252, 0.3);
  transform: translateY(-1px);
}

.discourse-btn.active {
  background: rgba(125, 211, 252, 0.2);
  border-color: rgba(125, 211, 252, 0.4);
  box-shadow: 0 0 12px rgba(125, 211, 252, 0.3);
}

.phrase-btn {
  color: #10b981;
}

.phrase-btn:hover {
  background: rgba(16, 185, 129, 0.15);
  border-color: rgba(16, 185, 129, 0.3);
  transform: translateY(-1px);
}

.phrase-btn.active {
  background: rgba(16, 185, 129, 0.2);
  border-color: rgba(16, 185, 129, 0.4);
  box-shadow: 0 0 12px rgba(16, 185, 129, 0.3);
}

/* Controls */
.controls {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}

.control-btn {
  padding: 0.875rem 1.5rem;
  background: rgba(0, 0, 0, 0.4);
  border: 1px solid rgba(84, 84, 88, 0.3);
  border-radius: 999px;
  color: #8e8e93;
  font-size: 0.875rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  text-transform: uppercase;
  letter-spacing: 0.04em;
}

.control-btn:hover:not(:disabled) {
  background: rgba(201, 169, 97, 0.15);
  border-color: rgba(201, 169, 97, 0.4);
  color: #C9A961;
  transform: translateY(-2px);
}

.control-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.control-btn.primary {
  background: linear-gradient(135deg, #C9A961 0%, rgba(201, 169, 97, 0.8) 100%);
  border-color: #C9A961;
  color: #0d0d0d;
  box-shadow: 0 4px 12px rgba(201, 169, 97, 0.3);
}

.control-btn.primary:hover:not(:disabled) {
  background: linear-gradient(135deg, #d4b46e 0%, #C9A961 100%);
  box-shadow: 0 6px 16px rgba(201, 169, 97, 0.4);
}

/* ========== RIGHT SIDE: MIND MAP ========== */
.mindmap-stage {
  background: rgba(28, 28, 30, 0.6);
  backdrop-filter: blur(40px);
  border-radius: 1.5rem;
  border: 1px solid rgba(201, 169, 97, 0.25);
  padding: 2rem;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
  display: flex;
  flex-direction: column;
}

.mindmap-header {
  margin-bottom: 1.5rem;
}

.mindmap-title {
  font-family: 'Space Grotesk', sans-serif;
  font-size: 1.125rem;
  font-weight: 700;
  color: #C9A961;
  margin-bottom: 0.5rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.mindmap-subtitle {
  font-size: 0.8125rem;
  color: #8e8e93;
  font-style: italic;
}

.mindmap-canvas {
  position: relative;
  flex: 1;
  min-height: 500px;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 1rem;
  border: 1px solid rgba(84, 84, 88, 0.2);
  overflow: hidden;
}

/* SVG will be inserted here */
#mindmapSVG {
  width: 100%;
  height: 100%;
}

/* Mind Map Nodes */
.node-center {
  fill: rgba(201, 169, 97, 0.3);
  stroke: #C9A961;
  stroke-width: 3;
  filter: drop-shadow(0 4px 12px rgba(201, 169, 97, 0.4));
}

.node-branch {
  fill: rgba(96, 165, 250, 0.2);
  stroke: #60a5fa;
  stroke-width: 2;
  opacity: 0;
  transition: opacity 0.5s ease;
}

.node-branch.active {
  opacity: 1;
  animation: nodeAppear 0.5s ease;
}

@keyframes nodeAppear {
  from {
    opacity: 0;
    transform: scale(0.8);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.node-text {
  fill: #e5e5e7;
  font-family: 'DM Sans', sans-serif;
  font-size: 14px;
  font-weight: 600;
  text-anchor: middle;
  pointer-events: none;
}

.node-text-small {
  font-size: 11px;
  font-weight: 500;
}

.connection-line {
  stroke: rgba(201, 169, 97, 0.4);
  stroke-width: 2;
  fill: none;
  opacity: 0;
  transition: opacity 0.5s ease;
}

.connection-line.active {
  opacity: 1;
  animation: lineGrow 0.5s ease;
}

@keyframes lineGrow {
  from { stroke-dashoffset: 1000; }
  to { stroke-dashoffset: 0; }
}

/* Legend */
.mindmap-legend {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0.5rem;
  margin-top: 1rem;
  padding: 1rem;
  background: rgba(0, 0, 0, 0.3);
  border-radius: 0.75rem;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.75rem;
  color: #8e8e93;
}

.legend-color {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: 2px solid;
}

.legend-agreement { background: rgba(74, 222, 128, 0.3); border-color: #4ade80; }
.legend-disagreement { background: rgba(251, 146, 60, 0.3); border-color: #fb923c; }
.legend-linking { background: rgba(96, 165, 250, 0.3); border-color: #60a5fa; }
.legend-opinion { background: rgba(167, 139, 250, 0.3); border-color: #a78bfa; }

/* ========== YOUR TURN ========== */
.your-turn-section {
  background: linear-gradient(135deg, rgba(201, 169, 97, 0.15) 0%, rgba(201, 169, 97, 0.05) 100%);
  border: 2px solid #C9A961;
  border-radius: 1.5rem;
  padding: 2.5rem 2rem;
  text-align: center;
  animation: fadeInScale 0.5s ease;
  margin-bottom: 2rem;
}

@keyframes fadeInScale {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

.prompt-icon {
  font-size: 4rem;
  margin-bottom: 1rem;
  animation: float 3s ease-in-out infinite;
}

@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

.prompt-text {
  font-family: 'Space Grotesk', sans-serif;
  font-size: 1.5rem;
  font-weight: 700;
  color: #C9A961;
  margin-bottom: 1rem;
}

.prompt-hint {
  font-size: 1rem;
  color: #e5e5e7;
  line-height: 1.6;
  margin-bottom: 1.5rem;
}

.prompt-topic {
  font-style: italic;
  color: #60a5fa;
}

/* ========== ALTERNATIVES MODAL ========== */
.alternatives-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(6px);
  z-index: 2000;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 1rem;
  animation: fadeIn 0.2s ease;
}

.alternatives-modal-overlay.active {
  display: flex;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.alternatives-modal {
  position: relative;
  background: rgba(20, 20, 22, 0.98);
  backdrop-filter: blur(30px);
  border-radius: 1.25rem;
  border: 1px solid rgba(16, 185, 129, 0.3);
  max-width: 520px;
  width: 100%;
  max-height: 80vh;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9), 0 0 40px rgba(16, 185, 129, 0.1);
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-header {
  padding: 1.5rem 2rem;
  background: linear-gradient(145deg, rgba(16, 185, 129, 0.1), rgba(0, 0, 0, 0.3));
  border-bottom: 1px solid rgba(16, 185, 129, 0.2);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-title {
  font-family: 'Space Grotesk', sans-serif;
  font-size: 1.25rem;
  font-weight: 700;
  color: #10b981;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.modal-close {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 50%;
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #8e8e93;
  font-size: 1.25rem;
  cursor: pointer;
  transition: all 0.3s;
}

.modal-close:hover {
  background: rgba(255, 255, 255, 0.1);
  color: #e5e5e7;
}

.modal-body {
  padding: 2rem;
  max-height: calc(80vh - 100px);
  overflow-y: auto;
}

.current-phrase-section {
  background: rgba(16, 185, 129, 0.08);
  border-left: 3px solid #10b981;
  border-radius: 0.75rem;
  padding: 1rem 1.25rem;
  margin-bottom: 1.5rem;
}

.current-phrase-label {
  font-size: 0.65rem;
  color: #10b981;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  font-weight: 700;
  margin-bottom: 0.5rem;
}

.current-phrase-text {
  font-size: 1.1rem;
  color: #e5e7eb;
  font-weight: 600;
}

.alternatives-section {
  margin-bottom: 1rem;
}

.alternatives-header {
  font-size: 0.7rem;
  color: #C9A961;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  font-weight: 700;
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid rgba(201, 169, 97, 0.2);
}

.alternative-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
  padding: 0.875rem 1rem;
  background: rgba(0, 0, 0, 0.25);
  border-radius: 0.625rem;
  margin-bottom: 0.5rem;
  cursor: pointer;
  transition: all 0.3s;
  border-left: 3px solid transparent;
}

.alternative-item:hover {
  background: rgba(16, 185, 129, 0.08);
  border-left-color: #10b981;
  transform: translateX(4px);
}

.alternative-text {
  flex: 1;
  color: #e5e7eb;
  font-size: 0.95rem;
  font-weight: 500;
  line-height: 1.4;
}

.copy-btn {
  background: rgba(16, 185, 129, 0.15);
  border: 1px solid rgba(16, 185, 129, 0.3);
  border-radius: 0.5rem;
  padding: 0.375rem 0.75rem;
  color: #10b981;
  font-size: 0.7rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  opacity: 0;
  flex-shrink: 0;
}

.alternative-item:hover .copy-btn {
  opacity: 1;
}

.copy-btn:hover {
  background: rgba(16, 185, 129, 0.25);
  transform: scale(1.05);
}

/* ========== TOAST ========== */
.toast {
  position: fixed;
  bottom: 2rem;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: rgba(16, 185, 129, 0.95);
  color: #000;
  padding: 0.875rem 1.5rem;
  border-radius: 999px;
  font-size: 0.875rem;
  font-weight: 600;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
  z-index: 3000;
  opacity: 0;
  transition: all 0.3s ease;
}

.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

/* ========== MOBILE ========== */
@media (max-width: 1024px) {
  .main-layout {
    grid-template-columns: 1fr;
  }
  
  .mindmap-stage {
    order: -1;
  }
  
  .mindmap-canvas {
    min-height: 400px;
  }
}

@media (max-width: 768px) {
  .speakers {
    gap: 2rem;
  }

  .avatar {
    width: 70px;
    height: 70px;
    font-size: 2.5rem;
  }

  .dialogue-bubble {
    padding: 1.5rem;
  }

  .text-content {
    font-size: 1rem;
  }

  .controls {
    flex-wrap: wrap;
  }

  .control-btn {
    padding: 0.75rem 1.25rem;
    font-size: 0.8125rem;
  }

  .prompt-text {
    font-size: 1.25rem;
  }

  .topic-buttons {
    grid-template-columns: 1fr;
  }
  
  .mindmap-legend {
    grid-template-columns: 1fr;
  }
}
  </style>
</head>
<body>
<div class="container">
  
  <!-- HEADER -->
  <div class="header">
    <a href="../../../index.html?openModal=speaking" class="back-link">‚Üê Back</a>
    <h1>INTUITY</h1>
    <p class="subtitle">Speaking Part 3 ¬∑ Collaborative Discussion with Mind Mapping</p>
  </div>

  <!-- TOPIC SELECTOR -->
 <div class="topic-selector">
  <label>Choose a Discussion Topic</label>
  <div class="topic-grid" id="topicGrid"></div>
</div>

  <!-- MAIN LAYOUT: DIALOGUE + MIND MAP -->
  <div class="main-layout">
    
    <!-- LEFT: DIALOGUE STAGE -->
    <div class="dialogue-stage">
      
      <!-- Progress -->
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text" id="progressText">Select a topic to begin...</div>

      <!-- Speakers -->
      <div class="speakers">
        <div class="speaker" id="speaker-emma">
          <div class="avatar">üë©</div>
          <div class="speaker-name">Emma</div>
          <div class="speaking-indicator" id="indicator-emma"></div>
        </div>
        
        <div class="speaker" id="speaker-lucas">
          <div class="avatar">üë®</div>
          <div class="speaker-name">Lucas</div>
          <div class="speaking-indicator" id="indicator-lucas"></div>
        </div>
      </div>

      <!-- Dialogue Bubble -->
      <div class="dialogue-bubble" id="dialogueBubble">
        <div class="speaker-label" id="speakerLabel"></div>
        <div class="text-content" id="textContent">Select a topic to begin...</div>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button class="action-btn discourse-btn" id="discourseBtn">
          <span>üî¨</span>
          <span>Discourse</span>
        </button>
        <button class="action-btn phrase-btn" id="phraseBtn">
          <span>üí°</span>
          <span>Phrases</span>
        </button>
      </div>

      <!-- Controls -->
      <div class="controls">
        <button class="control-btn" id="playBtn" onclick="playDialogue()">
          ‚ñ∂Ô∏è Play
        </button>
        <button class="control-btn" id="pauseBtn" onclick="pauseDialogue()" disabled>
          ‚è∏Ô∏è Pause
        </button>
        <button class="control-btn" id="replayBtn" onclick="replayDialogue()">
          üîÅ Replay
        </button>
        <button class="control-btn primary" id="yourTurnBtn" onclick="showRecordPrompt()" style="display: none;">
          üéôÔ∏è Your Turn
        </button>
      </div>

    </div>

    <!-- RIGHT: MIND MAP STAGE -->
    <div class="mindmap-stage">
      
      <div class="mindmap-header">
        <div class="mindmap-title">üß† Argument Structure</div>
        <div class="mindmap-subtitle">Watch ideas build as the discussion progresses</div>
      </div>

      <div class="mindmap-canvas" id="mindmapCanvas">
        <svg id="mindmapSVG" viewBox="0 0 600 600" preserveAspectRatio="xMidYMid meet"></svg>
      </div>

      <div class="mindmap-legend">
        <div class="legend-item">
          <div class="legend-color legend-agreement"></div>
          <span>Agreement</span>
        </div>
        <div class="legend-item">
          <div class="legend-color legend-disagreement"></div>
          <span>Disagreement</span>
        </div>
        <div class="legend-item">
          <div class="legend-color legend-linking"></div>
          <span>Linking Ideas</span>
        </div>
        <div class="legend-item">
          <div class="legend-color legend-opinion"></div>
          <span>Opinion/Speculation</span>
        </div>
      </div>

    </div>

  </div>

  <!-- YOUR TURN SECTION -->
  <div id="yourTurnSection" style="display: none;">
    <div class="your-turn-section">
      <div class="prompt-icon">üéôÔ∏è</div>
      <div class="prompt-text">Now It's Your Turn!</div>
      <div class="prompt-hint">
        Join the discussion about: <span class="prompt-topic" id="promptTopic"></span>
      </div>
      <button class="control-btn primary" onclick="startRecording()" style="margin: 0 auto;">
        üî¥ Start Recording
      </button>
    </div>
  </div>

</div>

<!-- ALTERNATIVES MODAL -->
<div class="alternatives-modal-overlay" id="alternativesModal">
  <div class="alternatives-modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title">
        <span>üí°</span>
        <span>Alternative Expressions</span>
      </div>
      <button class="modal-close" onclick="closeAlternativesModal()">√ó</button>
    </div>
    <div class="modal-body" id="alternativesModalBody"></div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>
  
<script>
// ==================== STATE ====================
let dialogues = null;
let currentDialogue = null;
let currentTurn = 0;
let isPlaying = false;
let isPaused = false;
let showDiscourse = false;
let phraseExplorerActive = false;

// Mind map state
let mindMapNodes = [];
let currentMindMapStep = 0;

// ==================== DISCOURSE MARKERS DATABASE ====================
const DISCOURSE_MARKERS = {
  agreement: [
    "I think", "I agree", "absolutely", "exactly", "that's true", "you're right",
    "I see your point", "that's a good point", "that's a valid point", "fair enough",
    "I suppose you're right"
  ],
  disagreement: [
    "but", "however", "though", "on the other hand", "I partly agree",
    "wouldn't you say", "I'd argue", "that may be true, but", "have you considered",
    "still"
  ],
  linking: [
    "so", "therefore", "ultimately", "building on that", "in my experience",
    "for instance", "think of", "that's because", "which means", "as a result"
  ],
  opinion: [
    "in my view", "I honestly think", "I'd say", "perhaps", "it seems to me",
    "from my perspective", "the way I see it"
  ]
};

// ==================== PHRASE ALTERNATIVES DATABASE ====================
const PHRASE_ALTERNATIVES = {
  "I think": [
    { phrase: "In my opinion", level: "B2" },
    { phrase: "From my perspective", level: "C1" },
    { phrase: "I'd argue that", level: "C1" },
    { phrase: "It seems to me that", level: "B2" }
  ],
  "That's a good point": [
    { phrase: "That's a valid observation", level: "C1" },
    { phrase: "You raise an interesting point", level: "B2" },
    { phrase: "I see the merit in what you're saying", level: "C1" },
    { phrase: "That's definitely worth considering", level: "B2" }
  ],
  "but": [
    { phrase: "however", level: "B2" },
    { phrase: "on the other hand", level: "B2" },
    { phrase: "that said", level: "C1" },
    { phrase: "having said that", level: "C1" }
  ],
  "wouldn't you say": [
    { phrase: "don't you think", level: "B2" },
    { phrase: "would you agree", level: "B2" },
    { phrase: "wouldn't you agree", level: "B2" }
  ],
  "I mean": [
    { phrase: "What I'm suggesting is", level: "B2" },
    { phrase: "To clarify", level: "B2" },
    { phrase: "In other words", level: "B2" }
  ],
  "Fair enough": [
    { phrase: "I take your point", level: "B2" },
    { phrase: "That's a fair assessment", level: "C1" },
    { phrase: "I concede that point", level: "C1" }
  ],
  "in my experience": [
    { phrase: "from what I've observed", level: "B2" },
    { phrase: "based on my observations", level: "C1" },
    { phrase: "in my personal experience", level: "B2" }
  ],
  "I see what you mean": [
    { phrase: "I understand your point", level: "B2" },
    { phrase: "I follow your reasoning", level: "C1" },
    { phrase: "I grasp your argument", level: "C1" }
  ],
  "perhaps": [
    { phrase: "possibly", level: "B2" },
    { phrase: "conceivably", level: "C1" },
    { phrase: "it's plausible that", level: "C1" }
  ],
  "Absolutely": [
    { phrase: "Precisely", level: "B2" },
    { phrase: "Indeed", level: "C1" },
    { phrase: "Without a doubt", level: "B2" }
  ],
  "I'd add that": [
    { phrase: "Furthermore", level: "B2" },
    { phrase: "Moreover", level: "C1" },
    { phrase: "In addition to that", level: "B2" }
  ],
  "ultimately": [
    { phrase: "in the end", level: "B2" },
    { phrase: "at the end of the day", level: "B2" },
    { phrase: "in the final analysis", level: "C1" }
  ],
  "I honestly think": [
    { phrase: "In all honesty", level: "B2" },
    { phrase: "To be frank", level: "B2" },
    { phrase: "I genuinely believe", level: "B2" }
  ],
  "surely": [
    { phrase: "certainly", level: "B2" },
    { phrase: "undoubtedly", level: "C1" },
    { phrase: "without question", level: "B2" }
  ],
  "for instance": [
    { phrase: "for example", level: "B1" },
    { phrase: "to illustrate", level: "B2" },
    { phrase: "as an illustration", level: "C1" }
  ],
  "I'd say": [
    { phrase: "I would suggest", level: "B2" },
    { phrase: "I would maintain", level: "C1" },
    { phrase: "My view would be", level: "B2" }
  ],
  "have you considered": [
    { phrase: "have you thought about", level: "B2" },
    { phrase: "did you take into account", level: "B2" },
    { phrase: "have you factored in", level: "C1" }
  ],
  "Perhaps, but": [
    { phrase: "That may be so, but", level: "B2" },
    { phrase: "While that's true", level: "B2" },
    { phrase: "I grant you that, however", level: "C1" }
  ],
  "I think both": [
    { phrase: "I believe we need a combination", level: "B2" },
    { phrase: "Both approaches have merit", level: "C1" },
    { phrase: "A dual approach is necessary", level: "C1" }
  ]
};

// ==================== LOAD DIALOGUES ====================
async function loadDialogues() {
  try {
    const response = await fetch('data/dialogues-data.json');
    dialogues = await response.json();
    
    // Enhance dialogues with discourse markers
    dialogues.forEach(d => {
      d.turns.forEach(turn => {
        turn.discourseMarkers = identifyDiscourseMarkers(turn.text);
      });
    });
    
    renderTopicButtons();
  } catch (error) {
    console.error('Error loading dialogues:', error);
    document.getElementById('textContent').textContent = 'Error loading dialogue data.';
  }
}

// ==================== IDENTIFY DISCOURSE MARKERS ====================
function identifyDiscourseMarkers(text) {
  const markers = [];
  
  for (const [category, phrases] of Object.entries(DISCOURSE_MARKERS)) {
    phrases.forEach(phrase => {
      const regex = new RegExp(`\\b${escapeRegex(phrase)}\\b`, 'gi');
      if (regex.test(text)) {
        markers.push({ phrase, category });
      }
    });
  }
  
  return markers;
}

function escapeRegex(str) {
  return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// ==================== RENDER TOPIC CARDS WITH PHOTOS ====================
function renderTopicButtons() {
  const container = document.getElementById('topicGrid');
  container.innerHTML = '';
  
  dialogues.forEach((dialogue, index) => {
    const card = document.createElement('div');
    card.className = 'topic-card';
    card.onclick = () => selectTopic(index);
    
    // Use the first photo from the dialogue or a default placeholder
    const photoUrl = dialogue.photos && dialogue.photos[0] 
      ? dialogue.photos[0].url 
      : 'https://images.unsplash.com/photo-1523240795612-9a054b0db644?w=500';
    
    card.innerHTML = `
      <img src="${photoUrl}" alt="${dialogue.topic}" class="topic-card-image">
      <div class="topic-card-content">
        <div class="topic-card-title">${dialogue.topic}</div>
        <div class="topic-card-subtitle">Click to start discussion</div>
      </div>
    `;
    
    container.appendChild(card);
  });
}

// ==================== SELECT TOPIC ====================
function selectTopic(index) {
  currentDialogue = dialogues[index];
  currentTurn = 0;
  currentMindMapStep = 0;
  isPaused = false;
  
  // Update UI
  document.querySelectorAll('.topic-btn').forEach((btn, i) => {
    btn.classList.toggle('active', i === index);
  });
  
  document.getElementById('textContent').textContent = 'Press Play to start the discussion';
  document.getElementById('speakerLabel').textContent = '';
  document.getElementById('yourTurnSection').style.display = 'none';
  document.getElementById('yourTurnBtn').style.display = 'none';
  document.getElementById('playBtn').disabled = false;
  document.getElementById('pauseBtn').disabled = true;
  
  // Initialize mind map
  initializeMindMap();
  updateProgress();
}

// ==================== MIND MAP INITIALIZATION ====================
function initializeMindMap() {
  const svg = document.getElementById('mindmapSVG');
  svg.innerHTML = '';
  
  mindMapNodes = generateMindMapStructure(currentDialogue);
  
  // Draw center node
  const centerNode = mindMapNodes[0];
  drawNode(svg, centerNode, 'center');
  
  // Draw all branch nodes (hidden initially)
  mindMapNodes.slice(1).forEach(node => {
    drawConnectionLine(svg, centerNode, node);
    drawNode(svg, node, 'branch');
  });
}

function generateMindMapStructure(dialogue) {
  const nodes = [];
  
  // Center node
  nodes.push({
    x: 300,
    y: 300,
    text: shortenText(dialogue.topic, 30),
    type: 'center',
    id: 'center'
  });
  
  // Generate branch nodes based on dialogue turns
  // We'll create 6-8 main branches positioned around the center
  const angles = [0, 60, 120, 180, 240, 300];
  const radius = 180;
  
  dialogue.turns.forEach((turn, i) => {
    const angle = angles[i % angles.length];
    const rad = (angle * Math.PI) / 180;
    
    nodes.push({
      x: 300 + Math.cos(rad) * radius,
      y: 300 + Math.sin(rad) * radius,
      text: extractKeyIdea(turn.text),
      type: 'branch',
      id: `node-${i}`,
      speaker: turn.speaker,
      turnIndex: i,
      category: turn.discourseMarkers[0]?.category || 'linking'
    });
  });
  
  return nodes;
}

function extractKeyIdea(text) {
  // Extract first meaningful phrase (up to 40 chars)
  const sentences = text.split(/[.!?]/);
  const firstSentence = sentences[0].trim();
  return shortenText(firstSentence, 35);
}

function shortenText(text, maxLen) {
  if (text.length <= maxLen) return text;
  return text.substring(0, maxLen - 3) + '...';
}

function drawNode(svg, node, type) {
  const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  g.setAttribute('id', node.id);
  
  // Circle
  const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  circle.setAttribute('cx', node.x);
  circle.setAttribute('cy', node.y);
  circle.setAttribute('r', type === 'center' ? 60 : 45);
  circle.setAttribute('class', `node-${type}`);
  
  // Color based on category for branch nodes
  if (type === 'branch' && node.category) {
    const colors = {
      agreement: 'rgba(74, 222, 128, 0.3)',
      disagreement: 'rgba(251, 146, 60, 0.3)',
      linking: 'rgba(96, 165, 250, 0.3)',
      opinion: 'rgba(167, 139, 250, 0.3)'
    };
    circle.setAttribute('fill', colors[node.category] || colors.linking);
  }
  
  g.appendChild(circle);
  
  // Text (wrapped)
  const words = node.text.split(' ');
  const lineHeight = 14;
  const maxWidth = type === 'center' ? 100 : 70;
  let lines = [];
  let currentLine = '';
  
  words.forEach(word => {
    const testLine = currentLine + word + ' ';
    if (testLine.length * 7 > maxWidth && currentLine.length > 0) {
      lines.push(currentLine.trim());
      currentLine = word + ' ';
    } else {
      currentLine = testLine;
    }
  });
  if (currentLine.length > 0) lines.push(currentLine.trim());
  
  // Limit to 3 lines
  lines = lines.slice(0, 3);
  
  const startY = node.y - ((lines.length - 1) * lineHeight) / 2;
  
  lines.forEach((line, i) => {
    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    text.setAttribute('x', node.x);
    text.setAttribute('y', startY + i * lineHeight);
    text.setAttribute('class', type === 'center' ? 'node-text' : 'node-text node-text-small');
    text.textContent = line;
    g.appendChild(text);
  });
  
  svg.appendChild(g);
}

function drawConnectionLine(svg, fromNode, toNode) {
  const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  
  // Calculate control point for curved line
  const midX = (fromNode.x + toNode.x) / 2;
  const midY = (fromNode.y + toNode.y) / 2;
  
  // Create a slight curve
  const dx = toNode.x - fromNode.x;
  const dy = toNode.y - fromNode.y;
  const angle = Math.atan2(dy, dx);
  const perpAngle = angle + Math.PI / 2;
  const curvature = 20;
  const ctrlX = midX + Math.cos(perpAngle) * curvature;
  const ctrlY = midY + Math.sin(perpAngle) * curvature;
  
  const d = `M ${fromNode.x} ${fromNode.y} Q ${ctrlX} ${ctrlY} ${toNode.x} ${toNode.y}`;
  line.setAttribute('d', d);
  line.setAttribute('class', 'connection-line');
  line.setAttribute('id', `line-to-${toNode.id}`);
  line.setAttribute('stroke-dasharray', '1000');
  line.setAttribute('stroke-dashoffset', '1000');
  
  svg.insertBefore(line, svg.firstChild);
}

function activateMindMapNode(turnIndex) {
  const node = mindMapNodes.find(n => n.turnIndex === turnIndex);
  if (!node) return;
  
  // Activate connection line
  const line = document.getElementById(`line-to-${node.id}`);
  if (line) {
    line.classList.add('active');
  }
  
  // Activate node
  const nodeEl = document.getElementById(node.id);
  if (nodeEl) {
    const circle = nodeEl.querySelector('circle');
    if (circle) {
      circle.classList.add('active');
    }
  }
}

// ==================== PLAY DIALOGUE ====================
async function playDialogue() {
  if (!currentDialogue) {
    alert('Please select a topic first!');
    return;
  }
  
  isPlaying = true;
  isPaused = false;
  
  document.getElementById('playBtn').disabled = true;
  document.getElementById('pauseBtn').disabled = false;
  
  // If resuming from pause
  if (currentTurn > 0) {
    await continueDialogue();
    return;
  }
  
  // Start from beginning
  currentTurn = 0;
  currentMindMapStep = 0;
  await continueDialogue();
}

// ==================== CONTINUE DIALOGUE ====================
async function continueDialogue() {
  while (currentTurn < currentDialogue.turns.length && isPlaying && !isPaused) {
    const turn = currentDialogue.turns[currentTurn];
    
    // Highlight speaker
    highlightSpeaker(turn.speaker);
    
    // Display text INSTANTLY (no typing effect during speech)
    displayText(turn);
    
    // Activate mind map node
    activateMindMapNode(currentTurn);
    
    // Speak (wait for it to finish)
    await speak(turn);
    
    // Wait between turns
    if (isPlaying && !isPaused) {
      await wait(1200);  // Longer pause between speakers
    }
    
    currentTurn++;
    updateProgress();
  }
  
  // Dialogue finished
  if (currentTurn >= currentDialogue.turns.length && isPlaying) {
    isPlaying = false;
    document.getElementById('playBtn').disabled = true;
    document.getElementById('pauseBtn').disabled = true;
    showYourTurn();
  }
}

// ==================== PAUSE DIALOGUE ====================
function pauseDialogue() {
  isPaused = true;
  isPlaying = false;
  speechSynthesis.cancel();
  
  document.getElementById('playBtn').disabled = false;
  document.getElementById('pauseBtn').disabled = true;
  
  // Remove speaking indicator
  document.querySelectorAll('.speaking-indicator').forEach(ind => {
    ind.classList.remove('pulsing');
  });
}

// ==================== REPLAY DIALOGUE ====================
function replayDialogue() {
  speechSynthesis.cancel();
  isPlaying = false;
  isPaused = false;
  currentTurn = 0;
  currentMindMapStep = 0;
  
  document.getElementById('yourTurnSection').style.display = 'none';
  document.getElementById('yourTurnBtn').style.display = 'none';
  
  // Reset speakers
  document.querySelectorAll('.speaker').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.speaking-indicator').forEach(ind => ind.classList.remove('pulsing'));
  
  // Reset mind map
  initializeMindMap();
  
  updateProgress();
  playDialogue();
}

// ==================== HIGHLIGHT SPEAKER ====================
function highlightSpeaker(speaker) {
  document.querySelectorAll('.speaker').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.speaking-indicator').forEach(ind => ind.classList.remove('pulsing'));
  
  const speakerEl = document.getElementById(`speaker-${speaker.toLowerCase()}`);
  if (speakerEl) {
    speakerEl.classList.add('active');
    
    const indicator = document.getElementById(`indicator-${speaker.toLowerCase()}`);
    if (indicator) {
      indicator.classList.add('pulsing');
    }
  }
}

// ==================== DISPLAY TEXT WITH DISCOURSE HIGHLIGHTING ====================
function displayText(turn) {
  const speakerLabel = document.getElementById('speakerLabel');
  const textContent = document.getElementById('textContent');
  
  speakerLabel.textContent = turn.speaker;
  
  let html = turn.text;
  
  // Apply discourse highlighting if active
  if (turn.discourseMarkers && turn.discourseMarkers.length > 0) {
    turn.discourseMarkers.forEach(marker => {
      const phrase = marker.phrase;
      const category = marker.category;
      const escapedPhrase = escapeRegex(phrase);
      const regex = new RegExp(`\\b(${escapedPhrase})\\b`, 'gi');
      
      const categoryClass = `${category}-phrase`;
      
      if (phraseExplorerActive && PHRASE_ALTERNATIVES[phrase]) {
        const escapedForJs = phrase.replace(/'/g, "\\'").replace(/"/g, '\\"');
        const altsJson = JSON.stringify(PHRASE_ALTERNATIVES[phrase]).replace(/"/g, '&quot;');
        html = html.replace(regex, `<span class="${categoryClass}"><span class="phrase-enhanced">$1<button class="phrase-hint-btn" onclick="event.stopPropagation(); showAlternatives('${escapedForJs}', ${altsJson})">üí°</button></span></span>`);
      } else {
        html = html.replace(regex, `<span class="${categoryClass}">$1</span>`);
      }
    });
  }
  
  // Set instantly (no typing effect)
  textContent.innerHTML = html;
  textContent.classList.toggle('discourse-active', showDiscourse);
  textContent.classList.toggle('phrase-explorer-active', phraseExplorerActive);
}

// ==================== SPEAK ====================
async function speak(turn) {
  return new Promise((resolve) => {
    if (!isPlaying || isPaused) {
      resolve();
      return;
    }
    
    const utterance = new SpeechSynthesisUtterance(turn.text);
    utterance.lang = 'en-GB';
    utterance.rate = 0.85;
    utterance.pitch = 1.0;
    
    // Select voice based on speaker
    const voices = speechSynthesis.getVoices();
    let voice;
    
    if (turn.speaker === 'Emma') {
      voice = voices.find(v => v.lang === 'en-GB' && v.name.includes('Female'));
    } else {
      voice = voices.find(v => v.lang === 'en-GB' && v.name.includes('Male'));
    }
    
    if (voice) utterance.voice = voice;
    
    utterance.onend = () => {
      const indicator = document.getElementById(`indicator-${turn.speaker.toLowerCase()}`);
      if (indicator) indicator.classList.remove('pulsing');
      resolve();
    };
    
    utterance.onerror = () => {
      resolve();
    };
    
    speechSynthesis.speak(utterance);
  });
}

// ==================== UPDATE PROGRESS ====================
function updateProgress() {
  if (!currentDialogue) return;
  
  const progress = (currentTurn / currentDialogue.turns.length) * 100;
  document.getElementById('progressFill').style.width = progress + '%';
  document.getElementById('progressText').textContent = 
    `Turn ${currentTurn} of ${currentDialogue.turns.length}`;
}

// ==================== DISCOURSE TOGGLE ====================
document.getElementById('discourseBtn').addEventListener('click', function() {
  showDiscourse = !showDiscourse;
  this.classList.toggle('active', showDiscourse);
  
  const textContent = document.getElementById('textContent');
  textContent.classList.toggle('discourse-active', showDiscourse);
  
  // Re-render current turn to apply discourse highlighting
  if (currentDialogue && currentTurn > 0) {
    const turn = currentDialogue.turns[currentTurn - 1];
    displayText(turn);
  }
});

// ==================== PHRASE EXPLORER TOGGLE ====================
document.getElementById('phraseBtn').addEventListener('click', function() {
  phraseExplorerActive = !phraseExplorerActive;
  this.classList.toggle('active', phraseExplorerActive);
  
  const textContent = document.getElementById('textContent');
  textContent.classList.toggle('phrase-explorer-active', phraseExplorerActive);
  
  // Re-render current turn
  if (currentDialogue && currentTurn > 0) {
    const turn = currentDialogue.turns[currentTurn - 1];
    displayText(turn);
  }
});

// ==================== SHOW ALTERNATIVES MODAL ====================
function showAlternatives(phrase, alternatives) {
  const modalBody = document.getElementById('alternativesModalBody');
  
  let html = `
    <div class="current-phrase-section">
      <div class="current-phrase-label">Currently Used</div>
      <div class="current-phrase-text">${escapeHtml(phrase)}</div>
    </div>

    <div class="alternatives-section">
      <div class="alternatives-header">
        üéØ ${alternatives.length} Alternative${alternatives.length > 1 ? 's' : ''}
      </div>
  `;

  alternatives.forEach(alt => {
    html += `
      <div class="alternative-item" onclick="copyAlternative('${escapeHtml(alt.phrase)}')">
        <span class="alternative-text">${escapeHtml(alt.phrase)} <span style="color: #8e8e93; font-size: 0.75rem;">(${alt.level})</span></span>
        <button class="copy-btn" onclick="event.stopPropagation(); copyAlternative('${escapeHtml(alt.phrase)}')">Copy</button>
      </div>
    `;
  });

  html += `</div>`;
  
  modalBody.innerHTML = html;
  document.getElementById('alternativesModal').classList.add('active');
}

function closeAlternativesModal() {
  document.getElementById('alternativesModal').classList.remove('active');
}

function copyAlternative(text) {
  navigator.clipboard.writeText(text).then(() => {
    showToast(`Copied: "${text}" ‚úì`);
  }).catch(err => {
    console.error('Failed to copy:', err);
    showToast('Failed to copy', false);
  });
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ==================== SHOW YOUR TURN ====================
function showYourTurn() {
  document.getElementById('yourTurnBtn').style.display = 'flex';
}

function showRecordPrompt() {
  document.getElementById('yourTurnSection').style.display = 'block';
  document.getElementById('promptTopic').textContent = currentDialogue.topic;
  document.getElementById('yourTurnSection').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function startRecording() {
  alert('Recording interface will be implemented soon!\n\nFor now, practice speaking with a partner about:\n"' + currentDialogue.topic + '"');
}

// ==================== TOAST ====================
function showToast(message, success = true) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.style.background = success 
    ? 'rgba(16, 185, 129, 0.95)' 
    : 'rgba(239, 68, 68, 0.95)';
  toast.classList.add('show');
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, 2500);
}

// ==================== UTILITY ====================
function wait(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// ==================== MODAL CLICK OUTSIDE ====================
document.getElementById('alternativesModal').addEventListener('click', function(e) {
  if (e.target.id === 'alternativesModal') closeAlternativesModal();
});

// ==================== INITIALIZE ====================
window.speechSynthesis.onvoiceschanged = () => {
  console.log('Voices loaded:', speechSynthesis.getVoices().length);
};

window.addEventListener('load', loadDialogues);
</script>
</body>
</html>
