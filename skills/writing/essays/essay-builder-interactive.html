<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Build — INTUITY</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=DM+Sans:ital,wght@0,400;0,500;0,700;1,400&display=swap" rel="stylesheet"/>
<style>
:root {
  --bg:      #0c0c0c;
  --gold:    #C9A961;
  --gold-d:  #9B7D3A;
  --gold-l:  #E8D4A0;
  --white:   #FAFAF8;
  --ink:     #0d0d0d;
  --soft:    rgba(13,13,13,0.55);
  --settled: rgba(13,13,13,0.82);
  --rule:    rgba(0,0,0,0.07);
}
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html, body { width:100%; height:100%; overflow:hidden; position:fixed; background:var(--bg); font-family:'Inter',sans-serif; -webkit-font-smoothing:antialiased; }
.shell { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; padding:2vh 3vw; }
.card { width:100%; height:100%; max-width:900px; max-height:95vh; background:var(--white); border-radius:1.5rem; box-shadow:0 0 0 1px rgba(201,169,97,0.15),0 24px 80px rgba(0,0,0,0.65),0 4px 16px rgba(0,0,0,0.4); display:flex; flex-direction:column; overflow:hidden; position:relative; }
.card::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; background:linear-gradient(90deg,var(--gold-d),var(--gold-l),var(--gold-d)); z-index:5; }
.card-brand { flex-shrink:0; display:flex; align-items:center; justify-content:space-between; padding:1rem 1.5rem 0.75rem; margin-top:3px; border-bottom:1px solid var(--rule); position:relative; z-index:10; }
.home-link { text-decoration:none; font-size:1rem; font-weight:600; color:var(--gold); padding:0.4rem 0.6rem; border-radius:0.5rem; transition:all 0.2s; }
.home-link:hover { background:rgba(201,169,97,0.1); color:var(--gold-d); }
.home-link:active { transform:scale(0.95); }
.brand-word { position:absolute; left:50%; transform:translateX(-50%); font-size:0.65rem; font-weight:800; letter-spacing:0.22em; text-transform:uppercase; color:rgba(0,0,0,0.18); pointer-events:none; }
.menu-btn { background:#000; border:none; width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all 0.2s; }
.menu-btn:hover { background:rgba(0,0,0,0.8); }
.menu-btn:active { transform:scale(0.95); }
.menu-dots { display:flex; gap:4px; }
.menu-dots span { width:4px; height:4px; border-radius:50%; background:#fff; }
.menu-dropdown { position:absolute; top:calc(100% + 0.5rem); right:1rem; background:#fff; border-radius:0.75rem; box-shadow:0 0 0 1px rgba(0,0,0,0.08),0 8px 24px rgba(0,0,0,0.12); min-width:190px; padding:0.5rem; z-index:200; display:none; }
.menu-dropdown.open { display:block; animation:menuIn 0.2s ease-out; }
@keyframes menuIn { from{opacity:0;transform:translateY(-8px)} to{opacity:1;transform:translateY(0)} }
.menu-item { padding:0.65rem 0.85rem; border-radius:0.5rem; font-size:0.8rem; font-weight:500; color:rgba(0,0,0,0.7); cursor:pointer; transition:all 0.15s; }
.menu-item:hover { background:rgba(0,0,0,0.04); }
.progress-strip { flex-shrink:0; padding:0.5rem 1.5rem 0.6rem; border-bottom:1px solid var(--rule); display:flex; align-items:center; gap:0.875rem; }
.bar-track { flex:1; height:3px; background:rgba(0,0,0,0.07); border-radius:2px; overflow:hidden; }
.bar-fill { height:100%; width:0%; background:linear-gradient(90deg,var(--gold-d),var(--gold)); border-radius:2px; transition:width 0.55s cubic-bezier(0.4,0,0.2,1); }
.progress-label { font-size:0.6rem; font-weight:800; text-transform:uppercase; letter-spacing:0.1em; color:rgba(0,0,0,0.28); white-space:nowrap; min-width:60px; text-align:right; transition:color 0.3s; }
.progress-label.done { color:var(--gold-d); }
.essay-canvas { flex:1; min-height:0; overflow-y:auto; -webkit-overflow-scrolling:touch; padding:2rem 3rem 2.5rem; }
.essay-canvas::-webkit-scrollbar { width:4px; }
.essay-canvas::-webkit-scrollbar-track { background:transparent; }
.essay-canvas::-webkit-scrollbar-thumb { background:rgba(0,0,0,0.1); border-radius:2px; }
.para-block { margin-bottom:2rem; }
.para-block:last-child { margin-bottom:0; }
.para-block + .para-block { padding-top:2rem; border-top:1.5px solid rgba(201,169,97,0.12); }
.para-label { font-size:0.55rem; font-weight:800; text-transform:uppercase; letter-spacing:0.14em; color:rgba(0,0,0,0.2); margin-bottom:0.75rem; display:flex; align-items:center; gap:0.5rem; transition:color 0.4s; }
.para-label .check { opacity:0; transform:scale(0); transition:opacity 0.4s,transform 0.4s cubic-bezier(0.34,1.56,0.64,1); color:var(--gold); }
.para-block.complete .para-label { color:var(--gold-d); }
.para-block.complete .para-label .check { opacity:1; transform:scale(1); }
.prose { font-family:'DM Sans',sans-serif; font-size:1.05rem; line-height:2; color:var(--settled); font-weight:400; }
.s-anchor { color:var(--ink); font-weight:500; }
.pill { display:inline-flex; align-items:center; justify-content:center; background:var(--gold); color:#fff; font-family:'Inter',sans-serif; font-size:0.68rem; font-weight:800; min-width:1.7rem; height:1.45rem; border-radius:2rem; padding:0 0.45rem; margin:0 0.15rem; vertical-align:middle; cursor:pointer; user-select:none; -webkit-user-select:none; position:relative; animation:breathe 3s ease-in-out infinite; transition:transform 0.15s,background 0.15s,box-shadow 0.15s; will-change:transform; }
@keyframes breathe { 0%,100%{box-shadow:0 0 0 0 rgba(201,169,97,0.5)} 60%{box-shadow:0 0 0 6px rgba(201,169,97,0)} }
.pill:nth-child(3n+1){animation-delay:0s} .pill:nth-child(3n+2){animation-delay:0.8s} .pill:nth-child(3n+3){animation-delay:1.6s}
.pill:hover { transform:scale(1.15) translateY(-2px); background:var(--gold-d); box-shadow:0 4px 14px rgba(155,125,58,0.55); animation:none; }
.pill:active { transform:scale(0.92); }
.s-new { display:inline; color:var(--gold-d); font-weight:600; animation:zipOpen 0.5s cubic-bezier(0.34,1.1,0.64,1) both; }
@keyframes zipOpen { from{clip-path:inset(0 100% 0 0);opacity:0.3} to{clip-path:inset(0 0% 0 0);opacity:1} }
.s-new.ink { color:var(--settled); font-weight:400; transition:color 0.9s ease,font-weight 0.9s ease; }
.celebration { position:fixed; inset:0; z-index:900; display:flex; align-items:center; justify-content:center; pointer-events:none; opacity:0; }
.celebration.show { animation:celebPop 2.8s ease forwards; }
@keyframes celebPop { 0%{opacity:0} 15%{opacity:1} 75%{opacity:1} 100%{opacity:0} }
.celeb-pill { background:var(--ink); color:var(--gold); padding:1rem 2.25rem; border-radius:3rem; font-size:1rem; font-weight:800; letter-spacing:0.07em; text-transform:uppercase; box-shadow:0 12px 48px rgba(0,0,0,0.45); animation:celebScale 0.45s cubic-bezier(0.34,1.56,0.64,1) both; }
@keyframes celebScale { from{transform:scale(0.7)} to{transform:scale(1)} }
.card-nav { flex-shrink:0; display:flex; justify-content:center; padding:0.75rem 1.125rem calc(env(safe-area-inset-bottom,0px) + 0.875rem); border-top:1px solid var(--rule); background:var(--white); }
.nav-pill { display:flex; gap:0.15rem; background:rgba(10,10,10,0.06); border-radius:2rem; padding:0.35rem 0.4rem; }
.nb { background:transparent; border:none; padding:0.5rem 1rem; border-radius:1.5rem; font-family:'Inter',sans-serif; font-size:0.7rem; letter-spacing:0.02em; color:rgba(0,0,0,0.28); cursor:pointer; transition:all 0.24s cubic-bezier(0.4,0,0.2,1); white-space:nowrap; min-height:36px; font-weight:500; }
.nb.on { background:var(--ink); color:var(--gold); font-weight:700; }
.nb:hover:not(.on) { color:rgba(0,0,0,0.5); }
.state-msg { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; gap:0.75rem; font-size:0.9rem; color:rgba(0,0,0,0.3); text-align:center; line-height:1.6; padding:2rem; }
@media(max-width:768px){ .shell{padding:1vh 2vw} .card{border-radius:1rem} .card-brand{padding:0.75rem 1rem 0.5rem} .brand-word{font-size:0.55rem} .essay-canvas{padding:1.5rem 1.25rem 2rem} .prose{font-size:0.95rem;line-height:1.9} .pill{font-size:0.62rem;min-width:1.5rem;height:1.3rem} .nb{padding:0.4rem 0.75rem;font-size:0.65rem;min-height:32px} .progress-strip{padding:0.4rem 1rem 0.5rem} }
@media(max-width:400px){ .essay-canvas{padding:1.25rem 1rem 1.5rem} .prose{font-size:0.88rem} .nb{padding:0.35rem 0.6rem;font-size:0.6rem} }
@media(min-width:1400px){ .card{max-width:1200px} .essay-canvas{padding:3rem 5rem 3rem} .prose{font-size:1.2rem;line-height:2.1} .pill{font-size:0.82rem;min-width:2rem;height:1.7rem} .nb{font-size:0.8rem;padding:0.6rem 1.25rem;min-height:42px} }
</style>
</head>
<body>

<div class="shell">
<div class="card">

  <div class="card-brand">
    <a class="home-link" href="essay-question-selector.html">← Questions</a>
    <span class="brand-word">INTUITY</span>
    <div style="flex:1"></div>
    <div class="menu-btn" id="menuBtn" onclick="toggleMenu()">
      <div class="menu-dots"><span></span><span></span><span></span></div>
    </div>
    <div class="menu-dropdown" id="menuDropdown">
      <div class="menu-item" onclick="revealAll()">Reveal all sentences</div>
      <div class="menu-item" onclick="resetAll()">Reset essay</div>
    </div>
  </div>

  <div class="progress-strip">
    <div class="bar-track"><div class="bar-fill" id="barFill"></div></div>
    <div class="progress-label" id="progressLabel">tap the numbers</div>
  </div>

  <div class="essay-canvas" id="essayCanvas">
    <div class="state-msg">Loading…</div>
  </div>

  <div class="card-nav">
    <div class="nav-pill">
      <button class="nb"    onclick="navTo('question')">question</button>
      <button class="nb"    onclick="navTo('plan')">plan</button>
      <button class="nb"    onclick="navTo('model')">model</button>
      <button class="nb on" onclick="navTo('build')">build</button>
      <button class="nb"    onclick="navTo('sample')">sample</button>
    </div>
  </div>

</div>
</div>

<div class="celebration" id="celebration">
  <div class="celeb-pill">Essay complete ✦</div>
</div>

<script>
let question    = null;
let sampleData  = null;
let sentences   = [];
let totalHidden = 0;
let revealCount = 0;

const PARA_LABELS = ['Introduction','Body Paragraph 1','Body Paragraph 2','Conclusion'];

function fromStructured(paragraphs) {
  return paragraphs.map(p => ({
    label:     p.label || null,
    sentences: (p.sentences || []).map(s => s.trim()).filter(Boolean)
  })).filter(p => p.sentences.length > 0);
}

const ABBR = /\b(Mr|Mrs|Ms|Dr|Prof|St|etc|e\.g|i\.e|vs|approx|dept)\s*$/i;
function splitSentences(text) {
  const raw = text.match(/[^.!?]*(?:[.!?]+(?=\s+[A-Z])|[.!?]+$)|[^.!?]+/g) || [text];
  const out = []; let buf = '';
  raw.forEach(chunk => {
    buf += chunk;
    if (ABBR.test(buf.trimEnd())) return;
    const s = buf.trim(); if (s) out.push(s); buf = '';
  });
  if (buf.trim()) out.push(buf.trim());
  return out.filter(Boolean);
}

function fromHTML(html) {
  const div = document.createElement('div');
  div.innerHTML = html;
  const ps = div.querySelectorAll('p');
  const paraTexts = ps.length
    ? Array.from(ps).map(p => p.textContent.trim()).filter(Boolean)
    : html.split(/\n\n+/).map(chunk => { const d = document.createElement('div'); d.innerHTML = chunk; return d.textContent.trim(); }).filter(Boolean);
  return paraTexts.map(text => ({ label: null, sentences: splitSentences(text) })).filter(p => p.sentences.length > 0);
}

function getParaSentences(match) {
  if (match.paragraphs && Array.isArray(match.paragraphs) && match.paragraphs.length)
    return fromStructured(match.paragraphs);
  const html = match.styles?.default || match.html || match.text || '';
  return fromHTML(html);
}

function render(paraSentences) {
  sentences = []; totalHidden = 0; revealCount = 0;
  const canvas = document.getElementById('essayCanvas');
  canvas.innerHTML = '';

  paraSentences.forEach((para, pi) => {
    const sents = Array.isArray(para) ? para : para.sentences;
    const label = (!Array.isArray(para) && para.label)
      ? para.label : (PARA_LABELS[pi] || `Paragraph ${pi + 1}`);

    const block = document.createElement('div');
    block.className = 'para-block'; block.id = `para-${pi}`;

    const lbl = document.createElement('div');
    lbl.className = 'para-label'; lbl.textContent = label;
    const checkSpan = document.createElement('span');
    checkSpan.className = 'check'; checkSpan.textContent = ' ✦';
    lbl.appendChild(checkSpan); block.appendChild(lbl);

    const prose = document.createElement('div');
    prose.className = 'prose';

    sents.forEach((text, si) => {
      const globalIdx = sentences.length;
      sentences.push({ paraIdx: pi, sentIdx: si, text, revealed: si === 0 });

      if (si === 0) {
        const span = document.createElement('span');
        span.className = 's-anchor'; span.textContent = text;
        prose.appendChild(span);
        prose.appendChild(document.createTextNode(' '));
      } else {
        totalHidden++;
        const pill = document.createElement('span');
        pill.className = 'pill'; pill.dataset.idx = globalIdx;
        pill.textContent = si + 1;
        pill.title = `Tap to reveal sentence ${si + 1}`;
        pill.onclick = () => tapPill(globalIdx, pill);
        prose.appendChild(pill);
        prose.appendChild(document.createTextNode(' '));
      }
    });

    block.appendChild(prose); canvas.appendChild(block);
  });
  updateProgress();
}

function tapPill(idx, pillEl) {
  const s = sentences[idx];
  if (!s || s.revealed) return;
  s.revealed = true; revealCount++;

  const span = document.createElement('span');
  span.className = 's-new';
  span.textContent = s.text + ' ';
  pillEl.replaceWith(span);
  setTimeout(() => span.classList.add('ink'), 1400);

  const paraSents = sentences.filter(x => x.paraIdx === s.paraIdx);
  if (paraSents.every(x => x.revealed))
    document.getElementById(`para-${s.paraIdx}`)?.classList.add('complete');

  updateProgress();
  if (revealCount === totalHidden) setTimeout(celebrate, 350);
}

function updateProgress() {
  const pct = totalHidden > 0 ? (revealCount / totalHidden) * 100 : 0;
  document.getElementById('barFill').style.width = pct + '%';
  const lbl = document.getElementById('progressLabel');
  if (revealCount === 0)            { lbl.textContent = 'tap the numbers'; lbl.classList.remove('done'); }
  else if (revealCount === totalHidden) { lbl.textContent = 'complete ✦'; lbl.classList.add('done'); }
  else                              { lbl.textContent = `${revealCount} / ${totalHidden}`; lbl.classList.remove('done'); }
}

function celebrate() {
  const el = document.getElementById('celebration');
  el.classList.remove('show'); void el.offsetWidth; el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2900);
}

function revealAll() {
  closeMenu();
  document.querySelectorAll('.pill').forEach(pill => tapPill(parseInt(pill.dataset.idx), pill));
}

function resetAll() {
  closeMenu();
  if (!sampleData?.paragraphs) return;
  render(fromStructured(sampleData.paragraphs));
}

function toggleMenu() { document.getElementById('menuDropdown').classList.toggle('open'); }
function closeMenu()  { document.getElementById('menuDropdown').classList.remove('open'); }
document.addEventListener('click', e => {
  if (!document.getElementById('menuDropdown').contains(e.target) &&
      !document.getElementById('menuBtn').contains(e.target)) closeMenu();
});

/* ════════════════════════════════
   FOOTER NAV — self-guard on build
════════════════════════════════ */
function navTo(dest) {
  if (dest === 'build') return;
  if (question) sessionStorage.setItem('currentQuestion', JSON.stringify(question));
  const map = {
    question: 'essay-question-selector.html',
    plan:     'essay-plan.html',
    model:    'essay-builder.html',
    sample:   'essay-master.html'
  };
  if (map[dest]) window.location.href = map[dest];
}

async function init() {
  try { question = JSON.parse(sessionStorage.getItem('currentQuestion')); } catch(e) { question = null; }

  if (!question) {
    document.getElementById('essayCanvas').innerHTML =
      `<div class="state-msg">No question selected.<br>Return to Questions to choose one.</div>`;
    return;
  }

  try {
    const res = await fetch('data/samples-build.json');
    if (!res.ok) throw new Error('samples-build.json not found');
    const data = await res.json();
    const paragraphs = data[question.id];

    if (!paragraphs || !Array.isArray(paragraphs) || paragraphs.length === 0) {
      document.getElementById('essayCanvas').innerHTML =
        `<div class="state-msg">No build data for this question yet.<br>
         <small style="opacity:0.35;margin-top:0.5rem;display:block;">id: ${question.id}</small></div>`;
      return;
    }

    sampleData = { paragraphs };
    render(fromStructured(paragraphs));

  } catch(err) {
    document.getElementById('essayCanvas').innerHTML =
      `<div class="state-msg">Could not load samples-build.json<br>
       <small style="opacity:0.35;margin-top:0.5rem;display:block;">${err.message}</small></div>`;
  }
}

init();
</script>
</body>
</html>
