<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>INTUITY — Essay Builder</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@700;800;900&display=swap" rel="stylesheet">
  
  <style>
* {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: fixed;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: #0f0f0f;
      color: #fff;
      -webkit-font-smoothing: antialiased;
      touch-action: pan-y;
    }

    /* BACK BUTTON */
    .back-btn {
      position: fixed;
      top: 1.5rem;
      left: 1.5rem;
      padding: 0.75rem 1.5rem;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: #D4AF37;
      font-size: 0.9rem;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      z-index: 2000;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateX(-4px);
      border-color: #D4AF37;
    }

    /* NAVIGATION BAR */
    .navigation-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(20, 20, 20, 0.98);
      backdrop-filter: blur(40px);
      border-bottom: 2px solid rgba(255, 255, 255, 0.05);
      z-index: 999;
      padding: 1rem 1.5rem 0;
    }

    .primary-tabs {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-bottom: 0;
      overflow-x: auto;
      padding-bottom: 0.75rem;
      scrollbar-width: none;
    }

    .primary-tabs::-webkit-scrollbar { display: none; }

    .primary-tab {
      padding: 0.875rem 1.75rem;
      background: transparent;
      border: none;
      border-bottom: 4px solid transparent;
      color: rgba(255, 255, 255, 0.4);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 800;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      white-space: nowrap;
    }

    .primary-tab:hover {
      color: #D4AF37;
      border-bottom-color: rgba(212, 175, 55, 0.4);
    }

    .primary-tab.active {
      color: #D4AF37;
      border-bottom-color: #D4AF37;
    }

    /* MODE TOGGLE - hidden on desktop */
    .secondary-controls {
      display: none;
    }

    .mode-toggle {
      display: flex;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      padding: 0.25rem;
      gap: 0.25rem;
    }

    .mode-btn {
      padding: 0.5rem 1rem;
      background: transparent;
      border: none;
      border-radius: 6px;
      color: rgba(255, 255, 255, 0.4);
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: capitalize;
      font-family: 'Inter', sans-serif;
    }

    .mode-btn.active {
      background: rgba(212, 175, 55, 0.15);
      color: #D4AF37;
    }

    /* SLIDES CONTAINER */
    .slides-container {
      position: fixed;
      top: 80px;
      left: 0;
      right: 0;
      bottom: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      overflow: hidden;
    }

    /* SLIDE CARD */
    .slide {
      position: relative;
      width: 100%;
      max-width: 1200px;
      height: 100%;
      background: #ffffff;
      border: 4px solid #000000;
      border-radius: 24px;
      padding: 2rem 3rem;
      opacity: 0;
      transition: opacity 0.4s ease;
      pointer-events: none;
      display: none;
      flex-direction: column;
      gap: 1rem;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      overflow: hidden;
    }

    .slide.active {
      opacity: 1;
      pointer-events: auto;
      display: flex;
      z-index: 1;
    }

    /* CARD HEADER */
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid rgba(0, 0, 0, 0.08);
      flex-shrink: 0;
    }

    .essay-type-title {
      font-family: 'Inter', sans-serif;
      font-size: 0.75rem;
      font-weight: 600;
      color: rgba(0, 0, 0, 0.4);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    /* TOGGLE SWITCH */
    .view-toggle {
      display: flex;
      background: rgba(0, 0, 0, 0.04);
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 8px;
      padding: 0.25rem;
      gap: 0.25rem;
    }

    .toggle-btn {
      padding: 0.4rem 0.875rem;
      background: transparent;
      border: none;
      border-radius: 6px;
      color: rgba(0, 0, 0, 0.5);
      font-size: 0.7rem;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.25s;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-family: 'Inter', sans-serif;
    }

    .toggle-btn:hover {
      color: rgba(0, 0, 0, 0.7);
    }

    .toggle-btn.active {
      background: #000000;
      color: #D4AF37;
    }

      /* SKELETON DISPLAY - AUTO-SCALING CONTAINER */
      .skeleton-display {
      font-family: 'Inter', sans-serif;
      color: rgba(0, 0, 0, 0.9);
      text-align: left;
      font-weight: 600;
      text-transform: none;
      letter-spacing: 0.1em;
      white-space: pre-line;
      word-wrap: break-word;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 0.5rem 0;
      font-size: 0.75rem;
    }

    .skeleton-display .paragraph-block {
      margin-bottom: 0.75rem;
      animation: fadeSlideIn 0.5s ease-out;
    }

    .skeleton-display .paragraph-block:last-child {
      margin-bottom: 0;
    }

    .skeleton-display .paragraph-title {
      color: rgba(0, 0, 0, 0.5);
      margin-bottom: 0.25rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.75rem;
    }

    /* Color coding for different sections */
    .skeleton-display .paragraph-title.intro {
      color: #90EE90;
    }

    .skeleton-display .paragraph-title.body {
      color: #ed8b34;
    }

    .skeleton-display .paragraph-title.conclusion {
      color: #4A90E2;
    }

    .skeleton-display .paragraph-text {
      color: rgba(0, 0, 0, 0.9);
      line-height: 1.4;
      margin-bottom: 0.2rem;
      font-size: 0.75rem;
    }

    .skeleton-display .paragraph-text:last-child {
      margin-bottom: 0;
    }

    .skeleton-display .divider {
      height: 1px;
      background: rgba(0, 0, 0, 0.1);
      margin: 0.5rem 0;
    }

    /* PHRASES DISPLAY - UPDATED TO MATCH SKELETON SIZING */
    .phrases-display {
      font-family: 'Inter', sans-serif;
      color: rgba(0, 0, 0, 0.9);
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 0.5rem 0;
      font-size: 0.75rem;
    }

    .phrase-category {
      margin-bottom: 2rem;
      animation: fadeSlideIn 0.5s ease-out;
    }

    .phrase-category:last-child {
      margin-bottom: 0;
    }

    .category-title {
      font-size: 0.75rem;
      font-weight: 800;
      color: rgba(0, 0, 0, 0.9);
      margin-bottom: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding-bottom: 0.3rem;
      border-bottom: 2px solid rgba(0, 0, 0, 0.2);
    }

    /* Color coding for phrase categories */
    .category-title.intro {
      color: #90EE90;
      border-bottom-color: #90EE90;
    }

    .category-title.body {
      color: #ed8b34;
      border-bottom-color: #ed8b34;
    }

    .category-title.conclusion {
      color: #4A90E2;
      border-bottom-color: #4A90E2;
    }

    .subcategory {
      margin-bottom: 1.25rem;
    }

    .subcategory:last-child {
      margin-bottom: 0;
    }

    .subcategory-title {
      font-size: 0.75rem;
      font-weight: 700;
      color: rgba(0, 0, 0, 0.7);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .phrase-list {
      list-style: none;
      padding: 0;
    }

    .phrase-item {
      font-size: 0.75rem;
      line-height: 1.6;
      color: rgba(0, 0, 0, 0.9);
      margin-bottom: 0.5rem;
      padding-left: 0.75rem;
      position: relative;
      font-weight: 400;
      text-transform: none;
      letter-spacing: 0;
    }

    .phrase-item:before {
      content: "→";
      position: absolute;
      left: 0;
      color: rgba(0, 0, 0, 0.6);
      font-weight: 700;
      font-size: 0.75rem;
    }

    /* NAVIGATION ARROWS */
    .nav-arrows {
      position: fixed;
      bottom: 1.5rem;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 0.75rem;
      z-index: 1000;
    }

    .nav-arrow {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: rgba(212, 175, 55, 0.1);
      border: 2px solid rgba(212, 175, 55, 0.3);
      color: #D4AF37;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
    }

    .nav-arrow:active {
      transform: scale(0.95);
    }

    .nav-arrow:disabled {
      opacity: 0.15;
      cursor: not-allowed;
    }

    /* PROGRESS DOTS */
    .progress-dots {
      position: fixed;
      bottom: 4.25rem;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 0.5rem;
      z-index: 1000;
    }

    .progress-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s;
      cursor: pointer;
    }

    .progress-dot.active {
      background: #D4AF37;
      border-color: #D4AF37;
      transform: scale(1.25);
      box-shadow: 0 0 10px rgba(212, 175, 55, 0.6);
    }

    /* MOBILE HEADER */
    .slide-header {
      display: none;
    }

    /* ============================================ */
    /* MOBILE OPTIMIZATIONS */
    /* ============================================ */
    @media (max-width: 768px) {
      html, body {
        width: 100vw;
        height: 100vh;
        height: -webkit-fill-available;
        overflow: hidden;
        position: fixed;
      }

      .navigation-bar {
        display: none;
      }

      .back-btn {
        top: 0.75rem;
        left: 0.75rem;
        padding: 0.5rem 0.85rem;
        font-size: 0.75rem;
        z-index: 5000;
        gap: 0.3rem;
      }

      .slides-container {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100vw;
        height: 100vh;
        height: -webkit-fill-available;
        padding: 0;
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }

      .slide {
        position: fixed;
        top: 5vh;
        left: 5vw;
        width: 90vw;
        height: 90vh;
        max-width: 90vw;
        border: none;
        border-radius: 20px;
        padding: 0;
        margin: 0;
        gap: 0;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        display: none;
        flex-direction: column;
        overflow: hidden;
      }

      .slide.active {
        display: flex !important;
      }

      /* iOS-STYLE MOBILE HEADER */
      .slide-header {
        display: flex !important;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        background: #ffffff;
        border-bottom: 2px solid rgba(0, 0, 0, 0.08);
        padding: 0.75rem;
        gap: 0.5rem;
        flex-shrink: 0;
        width: 100%;
        position: relative;
      }

      .category-menu-section {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-shrink: 0;
      }

      .category-label {
        font-size: 0.65rem;
        font-weight: 700;
        color: rgba(0, 0, 0, 0.5);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .category-menu-btn {
        width: 36px;
        height: 36px;
        background: #000000;
        border: none;
        border-radius: 50%;
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        gap: 3px;
        cursor: pointer;
        transition: all 0.2s;
        flex-shrink: 0;
      }

      .category-menu-btn:active {
        transform: scale(0.95);
        background: #1a1a1a;
      }

      .menu-dot {
        width: 4px;
        height: 4px;
        background: #ffffff;
        border-radius: 50%;
      }

      .header-spacer {
        flex: 1;
      }

      .category-dropdown {
        position: absolute;
        top: calc(100% + 0.5rem);
        left: 0.75rem;
        transform: translateY(-10px);
        background: rgba(245, 245, 245, 0.98);
        backdrop-filter: blur(20px);
        border-radius: 12px;
        padding: 0.5rem;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
        opacity: 0;
        pointer-events: none;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        z-index: 100;
        min-width: 200px;
        border: 1px solid rgba(0, 0, 0, 0.06);
      }

      .category-dropdown.show {
        opacity: 1;
        pointer-events: auto;
        transform: translateY(0);
      }

      .category-dropdown-item {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.6rem 1rem;
        background: transparent;
        border: none;
        border-radius: 8px;
        width: 100%;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
        margin-bottom: 0.15rem;
      }

      .category-dropdown-item:last-child {
        margin-bottom: 0;
      }

      .category-dropdown-item:active {
        transform: scale(0.97);
      }

      .category-dropdown-item.active {
        background: rgba(0, 0, 0, 0.08);
      }

      .category-dropdown-item:not(.active):hover {
        background: rgba(0, 0, 0, 0.04);
      }

      .category-dropdown-title {
        font-size: 0.7rem;
        font-weight: 700;
        color: #000000;
        letter-spacing: 0.01em;
        line-height: 1.2;
      }

      .slide-mode-toggle {
        display: flex !important;
        flex-shrink: 0;
      }

      .mobile-mode-toggle {
        display: flex !important;
        background: rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 10px;
        padding: 0.15rem;
        gap: 0.15rem;
      }

      .mobile-mode-toggle .mode-btn {
        padding: 0.3rem 0.7rem;
        font-size: 0.55rem;
        border-radius: 8px;
        background: transparent;
        border: none;
        color: rgba(0, 0, 0, 0.4);
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.02em;
        transition: all 0.2s;
      }

      .mobile-mode-toggle .mode-btn.active {
        background: #000000;
        color: #D4AF37;
      }

      .card-header {
        display: none !important;
      }

      .skeleton-display,
      .phrases-display {
        flex: 1;
        padding: 1.5rem;
        overflow: hidden;
      }

     .skeleton-display .paragraph-block {
        margin-bottom: 0.5rem;
      }

      .skeleton-display .paragraph-title {
        margin-bottom: 0.2rem;
      }

      .skeleton-display .paragraph-text {
        margin-bottom: 0.15rem;
        line-height: 1.15;
      }

      .skeleton-display .divider {
        margin: 0.35rem 0;
      }
      
      .phrases-display {
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      /* MOBILE PHRASES - Smaller to match skeleton better */
      .phrase-category {
        margin-bottom: 1.5rem;
      }

      .category-title {
        font-size: 0.75rem;
        margin-bottom: 0.6rem;
        color: rgba(0, 0, 0, 0.9);
      }

      .subcategory {
        margin-bottom: 1rem;
      }

      .subcategory-title {
        font-size: 0.75rem;
        margin-bottom: 0.4rem;
        color: rgba(0, 0, 0, 0.7);
      }

      .phrase-item {
        font-size: 0.75rem;
        margin-bottom: 0.4rem;
        padding-left: 0.6rem;
        line-height: 1.6;
        color: rgba(0, 0, 0, 0.9);
      }

      .phrase-item:before {
        font-size: 0.75rem;
        color: rgba(0, 0, 0, 0.6);
      }

      .nav-arrows {
        bottom: 1rem;
        gap: 0.6rem;
      }

      .nav-arrow {
        width: 48px;
        height: 48px;
        font-size: 1.2rem;
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
      }

      .progress-dots {
        bottom: 3.5rem;
        gap: 0.4rem;
      }

      .progress-dot {
        width: 6px;
        height: 6px;
      }
    }

    /* Extra small phones */
    @media (max-width: 375px) {
      .skeleton-display,
      .phrases-display {
        padding: 1.25rem;
      }

      .phrase-item {
        font-size: 0.4rem;
      }

      .category-title {
        font-size: 0.45rem;
      }

      .subcategory-title {
        font-size: 0.375rem;
      }
    }

    /* Desktop - hide mobile elements */
    @media (min-width: 769px) {
      .mobile-mode-toggle,
      .slide-header {
        display: none !important;
      }
    }
   
  </style>
</head>
<body>

<button class="back-btn" onclick="alert('Back navigation would go here')">
  <span>←</span>
  <span>Back</span>
</button>

<!-- DESKTOP NAVIGATION -->
<nav class="navigation-bar">
  <div class="primary-tabs" id="primaryTabs"></div>
  
  <div class="secondary-controls">
    <div class="mode-toggle">
      <button class="mode-btn active" data-mode="skeleton" onclick="setViewMode('skeleton')">Skeleton</button>
      <button class="mode-btn" data-mode="phrases" onclick="setViewMode('phrases')">Phrases</button>
    </div>
  </div>
</nav>

<!-- SLIDES CONTAINER -->
<div class="slides-container" id="slidesContainer"></div>

<!-- NAVIGATION -->
<div class="nav-arrows">
  <button class="nav-arrow" onclick="navigate(-1)">←</button>
  <button class="nav-arrow" onclick="navigate(1)">→</button>
</div>

<div class="progress-dots" id="progressDots"></div>

<script>
// ==================== STATE ====================
let skeletonData = null;
let phraseData = null;
let currentType = 'for-against';
let currentVariation = 0;
let viewMode = 'skeleton';

// ==================== INIT ====================
async function init() {
  try {
    // Load both JSON files
    const [skeletonResponse, phraseResponse] = await Promise.all([
      fetch('data/complete-essay-phrase-bank.json'),
      fetch('data/complete-essay-phrase-bank1.json')
    ]);
    
    if (!skeletonResponse.ok || !phraseResponse.ok) {
      throw new Error('Failed to load data files');
    }
    
    skeletonData = await skeletonResponse.json();
    phraseData = await phraseResponse.json();
    
    renderPrimaryTabs();
    renderContent();
    renderDots();
    updateNav();
    
  } catch (error) {
    console.error('Error loading data:', error);
    document.getElementById('slidesContainer').innerHTML = `
      <div style="text-align: center; padding: 2rem; color: #D4AF37;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">⚠️</div>
        <div style="font-size: 1.5rem; font-weight: 700;">Failed to load essay data</div>
        <div style="font-size: 1rem; margin-top: 1rem; opacity: 0.6;">${error.message}</div>
        <div style="font-size: 0.875rem; margin-top: 0.5rem; opacity: 0.4;">
          Looking for:<br>
          data/complete-essay-phrase-bank.json<br>
          data/complete-essay-phrase-bank1.json
        </div>
      </div>
    `;
  }
}

// ==================== RENDER PRIMARY TABS ====================
function renderPrimaryTabs() {
  const container = document.getElementById('primaryTabs');
  const types = Object.keys(skeletonData).filter(key => key !== 'meta');
  
  container.innerHTML = types.map(typeKey => {
    const typeData = skeletonData[typeKey];
    return `
      <button class="primary-tab ${typeKey === currentType ? 'active' : ''}" 
              onclick="switchType('${typeKey}')">
        ${typeData.label}
      </button>
    `;
  }).join('');
}

// ==================== SWITCH TYPE ====================
function switchType(type) {
  currentType = type;
  currentVariation = 0;
  renderPrimaryTabs();
  renderContent();
  renderDots();
  updateNav();
}

// ==================== RENDER CONTENT ====================
function renderContent() {
  const container = document.getElementById('slidesContainer');
  container.innerHTML = '';
  
  const slide = document.createElement('div');
  slide.className = 'slide active';
  slide.dataset.index = '0';
  
  const typeData = skeletonData[currentType];
  const variation = typeData.skeletons[currentVariation];
  
  // Build header with toggle
  const headerHTML = `
    <div class="card-header">
      <div class="essay-type-title">${typeData.label}${viewMode === 'skeleton' ? ` — ${variation.name}` : ''}</div>
      <div class="view-toggle">
        <button class="toggle-btn ${viewMode === 'skeleton' ? 'active' : ''}" onclick="setViewMode('skeleton')">
          Skeleton
        </button>
        <button class="toggle-btn ${viewMode === 'phrases' ? 'active' : ''}" onclick="setViewMode('phrases')">
          Phrases
        </button>
      </div>
    </div>
  `;
  
  // Build mobile header
  const types = Object.keys(skeletonData).filter(key => key !== 'meta');
  const dropdownHTML = types.map(typeKey => {
    const td = skeletonData[typeKey];
    return `
      <button class="category-dropdown-item ${typeKey === currentType ? 'active' : ''}" 
              onclick="selectCategoryFromDropdown('${typeKey}', event)">
        <div class="category-dropdown-title">${td.label}</div>
      </button>
    `;
  }).join('');
  
  const mobileHeaderHTML = `
    <div class="slide-header">
      <div class="category-menu-section">
        <span class="category-label">Essay Type</span>
        <button class="category-menu-btn" onclick="toggleCategoryDropdown(event)">
          <span class="menu-dot"></span>
          <span class="menu-dot"></span>
          <span class="menu-dot"></span>
        </button>
      </div>
      <div class="category-dropdown" id="categoryDropdown">
        ${dropdownHTML}
      </div>
      <div class="header-spacer"></div>
      <div class="slide-mode-toggle">
        <div class="mobile-mode-toggle">
          <button class="mode-btn ${viewMode === 'skeleton' ? 'active' : ''}" data-mode="skeleton" onclick="setViewMode('skeleton')">Skeleton</button>
          <button class="mode-btn ${viewMode === 'phrases' ? 'active' : ''}" data-mode="phrases" onclick="setViewMode('phrases')">Phrases</button>
        </div>
      </div>
    </div>
  `;
  
  let contentHTML = '';
  
  if (viewMode === 'skeleton') {
    contentHTML = renderSkeleton(variation);
  } else {
    contentHTML = renderPhrases(currentType);
  }
  
  slide.innerHTML = mobileHeaderHTML + headerHTML + contentHTML;
  container.appendChild(slide);
}

// ==================== RENDER SKELETON ====================
function renderSkeleton(variation) {
  let html = '<div class="skeleton-display">';
  
  variation.skeleton.forEach((para, index) => {
    html += '<div class="paragraph-block">';
    
    // Determine color class based on title content
    let colorClass = '';
    const titleLower = para.title.toLowerCase();
    if (titleLower.includes('intro') || titleLower.includes('opening') || titleLower.includes('hook')) {
      colorClass = 'intro';
    } else if (titleLower.includes('conclu') || titleLower.includes('closing') || titleLower.includes('final')) {
      colorClass = 'conclusion';
    } else {
      // Default to body for everything else (paragraphs, arguments, points, etc.)
      colorClass = 'body';
    }
    
    html += `<div class="paragraph-title ${colorClass}">${para.title}</div>`;
    
    para.lines.forEach(line => {
      if (line === "") {
        html += '<div class="paragraph-text">&nbsp;</div>';
      } else {
        html += `<div class="paragraph-text">${line}</div>`;
      }
    });
    
    if (index < variation.skeleton.length - 1) {
      html += '</div><div class="divider"></div>';
    } else {
      html += '</div>';
    }
  });
  
  html += '</div>';
  return html;
}

// ==================== RENDER PHRASES ====================
function renderPhrases(essayType) {
  // Check if we have phrase data for this type
  if (!phraseData[essayType] || !phraseData[essayType].categories) {
    return '<div class="phrases-display" style="padding: 2rem; text-align: center; color: rgba(0,0,0,0.4);">No phrase bank available for this essay type.</div>';
  }
  
  const categories = phraseData[essayType].categories;
  
  let html = '<div class="phrases-display">';
  
  categories.forEach(category => {
    html += '<div class="phrase-category">';
    
    // Determine color class based on category title
    let colorClass = '';
    const titleLower = category.title.toLowerCase();
    if (titleLower.includes('intro') || titleLower.includes('opening') || titleLower.includes('hook')) {
      colorClass = 'intro';
    } else if (titleLower.includes('conclu') || titleLower.includes('closing') || titleLower.includes('final')) {
      colorClass = 'conclusion';
    } else {
      // Default to body for everything else
      colorClass = 'body';
    }
    
    html += `<div class="category-title ${colorClass}">${category.title}</div>`;
    
    category.subcategories.forEach(sub => {
      html += '<div class="subcategory">';
      html += `<div class="subcategory-title">${sub.subtitle}</div>`;
      html += '<ul class="phrase-list">';
      
      sub.phrases.forEach(phrase => {
        html += `<li class="phrase-item">${phrase}</li>`;
      });
      
      html += '</ul></div>';
    });
    
    html += '</div>';
  });
  
  html += '</div>';
  return html;
}

// ==================== AUTO-SCALE FUNCTION (DESKTOP) ====================
function autoScaleSkeletonToFit(slideIndex) {
  const slide = document.querySelector(`.slide[data-index="${slideIndex}"]`);
  if (!slide) return;
  
  const skeletonDisplay = slide.querySelector('.skeleton-display');
  if (!skeletonDisplay) return;
  
  // Get available height for content
  const slideHeight = slide.clientHeight;
  const cardHeader = slide.querySelector('.card-header');
  const headerHeight = cardHeader ? cardHeader.offsetHeight : 0;
  
  // Calculate available space (accounting for padding and gaps)
  const slideComputedStyle = window.getComputedStyle(slide);
  const paddingTop = parseFloat(slideComputedStyle.paddingTop);
  const paddingBottom = parseFloat(slideComputedStyle.paddingBottom);
  const gap = parseFloat(slideComputedStyle.gap);
  
  const availableHeight = slideHeight - headerHeight - paddingTop - paddingBottom - gap - 40; // 40px buffer
  
  // Start with base font size
  let fontSize = 1.2; // rem - desktop base (increased from 0.875)
  
  // Binary search for optimal font size
  let minFont = 0.3;
  let maxFont = fontSize;
  let iterations = 0;
  const maxIterations = 15;
  
  while (iterations < maxIterations && (maxFont - minFont) > 0.01) {
    fontSize = (minFont + maxFont) / 2;
    
    // Apply font size
    skeletonDisplay.style.fontSize = `${fontSize}rem`;
    
    // Also scale paragraph titles proportionally
    const paragraphTitles = skeletonDisplay.querySelectorAll('.paragraph-title');
    const titleFontSize = fontSize * 0.57; // Proportional to main text
    paragraphTitles.forEach(title => {
      title.style.fontSize = `${titleFontSize}rem`;
    });
    
    // Also scale line-height for better fit
    const lineHeight = 1.3;
    skeletonDisplay.style.lineHeight = lineHeight;
    
    // Force reflow
    void skeletonDisplay.offsetHeight;
    
    // Check if content fits
    const contentHeight = skeletonDisplay.scrollHeight;
    
    if (contentHeight <= availableHeight) {
      // Content fits, try larger
      minFont = fontSize;
    } else {
      // Content overflows, try smaller
      maxFont = fontSize;
    }
    
    iterations++;
  }
  
  // Final adjustment - use minFont to ensure it definitely fits
  fontSize = minFont;
  skeletonDisplay.style.fontSize = `${fontSize}rem`;
  
  const paragraphTitles = skeletonDisplay.querySelectorAll('.paragraph-title');
  const titleFontSize = fontSize * 0.57;
  paragraphTitles.forEach(title => {
    title.style.fontSize = `${titleFontSize}rem`;
  });
  
  // Fine-tune line height based on final font size
  if (fontSize < 0.5) {
    skeletonDisplay.style.lineHeight = '1.2';
  } else if (fontSize < 0.7) {
    skeletonDisplay.style.lineHeight = '1.25';
  } else {
    skeletonDisplay.style.lineHeight = '1.3';
  }
  
  console.log(`Slide ${slideIndex}: Scaled to ${fontSize.toFixed(3)}rem (${iterations} iterations)`);
}

// ==================== AUTO-SCALE FUNCTION (MOBILE) ====================
function autoScaleSkeletonToFitMobile(slideIndex) {
  const slide = document.querySelector(`.slide[data-index="${slideIndex}"]`);
  if (!slide) return;
  
  const skeletonDisplay = slide.querySelector('.skeleton-display');
  if (!skeletonDisplay) return;
  
  // Get available height
  const slideHeight = slide.clientHeight;
  const slideHeader = slide.querySelector('.slide-header');
  const headerHeight = slideHeader ? slideHeader.offsetHeight : 0;
  
  // Account for padding
  const padding = 3; // 1.5rem top + 1.5rem bottom = 3rem
  const paddingPx = padding * parseFloat(getComputedStyle(document.documentElement).fontSize);
  
  const availableHeight = slideHeight - headerHeight - paddingPx - 20; // 20px buffer
  
  // Start with mobile base
  let fontSize = 0.85; // increased from 0.6125
  
  // Binary search
  let minFont = 0.25;
  let maxFont = fontSize;
  let iterations = 0;
  const maxIterations = 15;
  
  while (iterations < maxIterations && (maxFont - minFont) > 0.01) {
    fontSize = (minFont + maxFont) / 2;
    
    skeletonDisplay.style.fontSize = `${fontSize}rem`;
    
    const paragraphTitles = skeletonDisplay.querySelectorAll('.paragraph-title');
    const titleFontSize = fontSize * 0.82;
    paragraphTitles.forEach(title => {
      title.style.fontSize = `${titleFontSize}rem`;
    });
    
    skeletonDisplay.style.lineHeight = '1.2';
    
    void skeletonDisplay.offsetHeight;
    
    const contentHeight = skeletonDisplay.scrollHeight;
    
    if (contentHeight <= availableHeight) {
      minFont = fontSize;
    } else {
      maxFont = fontSize;
    }
    
    iterations++;
  }
  
  fontSize = minFont;
  skeletonDisplay.style.fontSize = `${fontSize}rem`;
  
  const paragraphTitles = skeletonDisplay.querySelectorAll('.paragraph-title');
  const titleFontSize = fontSize * 0.82;
  paragraphTitles.forEach(title => {
    title.style.fontSize = `${titleFontSize}rem`;
  });
  
  console.log(`Mobile Slide ${slideIndex}: Scaled to ${fontSize.toFixed(3)}rem`);
}

// ==================== SET VIEW MODE ====================
function setViewMode(mode) {
  viewMode = mode;
  
  // Update desktop mode buttons
  document.querySelectorAll('.mode-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.mode === mode);
  });
  
  renderContent();
  renderDots();
  updateNav();
}

// ==================== RENDER DOTS ====================
function renderDots() {
  const container = document.getElementById('progressDots');
  container.innerHTML = '';
  
  if (viewMode === 'skeleton') {
    const typeData = skeletonData[currentType];
    typeData.skeletons.forEach((skeleton, index) => {
      const dot = document.createElement('div');
      dot.className = `progress-dot ${index === currentVariation ? 'active' : ''}`;
      dot.onclick = () => switchVariation(index);
      container.appendChild(dot);
    });
  }
}

// ==================== SWITCH VARIATION ====================
function switchVariation(index) {
  currentVariation = index;
  renderContent();
  renderDots();
  updateNav();
}

// ==================== NAVIGATE ====================
function navigate(direction) {
  if (viewMode === 'skeleton') {
    const typeData = skeletonData[currentType];
    currentVariation += direction;
    currentVariation = Math.max(0, Math.min(currentVariation, typeData.skeletons.length - 1));
    renderDots();
  } else {
    // In phrases mode, navigate between essay types
    const types = Object.keys(skeletonData).filter(key => key !== 'meta');
    const currentIndex = types.indexOf(currentType);
    const newIndex = currentIndex + direction;
    if (newIndex >= 0 && newIndex < types.length) {
      switchType(types[newIndex]);
      return;
    }
  }
  
  renderContent();
  updateNav();
}

// ==================== UPDATE NAV ====================
function updateNav() {
  const arrows = document.querySelectorAll('.nav-arrow');
  
  if (viewMode === 'skeleton') {
    const typeData = skeletonData[currentType];
    arrows[0].disabled = currentVariation === 0;
    arrows[1].disabled = currentVariation === typeData.skeletons.length - 1;
  } else {
    const types = Object.keys(skeletonData).filter(key => key !== 'meta');
    const currentIndex = types.indexOf(currentType);
    arrows[0].disabled = currentIndex === 0;
    arrows[1].disabled = currentIndex === types.length - 1;
  }
}

// ==================== CATEGORY DROPDOWN ====================
function toggleCategoryDropdown(event) {
  if (event) {
    event.stopPropagation();
  }
  
  const dropdown = document.getElementById('categoryDropdown');
  if (dropdown) {
    dropdown.classList.toggle('show');
  }
}

function selectCategoryFromDropdown(categoryId, event) {
  if (event) {
    event.stopPropagation();
  }
  
  // Close dropdown
  const dropdown = document.getElementById('categoryDropdown');
  if (dropdown) {
    dropdown.classList.remove('show');
  }
  
  // Switch type
  switchType(categoryId);
}

// Close dropdown when clicking outside
document.addEventListener('click', (e) => {
  if (!e.target.closest('.category-menu-btn') && !e.target.closest('.category-dropdown')) {
    const dropdown = document.getElementById('categoryDropdown');
    if (dropdown) {
      dropdown.classList.remove('show');
    }
  }
});

// ==================== KEYBOARD NAV ====================
document.addEventListener('keydown', (e) => {
  if (e.key === 'ArrowLeft') navigate(-1);
  if (e.key === 'ArrowRight') navigate(1);
});

// ==================== WINDOW RESIZE HANDLER ====================
let resizeTimeout;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(() => {
    // No need to auto-scale anymore - using fixed font size
  }, 250);
});

// Prevent pull-to-refresh
document.body.addEventListener('touchmove', function(e) {
  if (e.target === document.body) {
    e.preventDefault();
  }
}, { passive: false });

// ==================== INIT ====================
init();
</script>

</body>
</html>
