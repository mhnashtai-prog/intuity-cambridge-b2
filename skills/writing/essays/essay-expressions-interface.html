<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>INTUITY - Essay Expressions Practice</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Roboto, sans-serif;
      background: #0d0d0d;
      background-image: radial-gradient(circle at 20% 50%, rgba(201, 169, 97, 0.04) 0%, transparent 50%);
      min-height: 100vh;
      color: #e5e5e5;
      padding: 1rem;
    }
    
    .top-nav {
      max-width: 62rem;
      margin: 0 auto 0.75rem;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      padding: 0 0.5rem;
      gap: 1rem;
    }
    
    .nav-left { justify-self: start; }
    .nav-center { justify-self: center; }
    .nav-right { justify-self: end; }
    
    .nav-link {
      color: #8e8e93;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.8125rem;
      font-weight: 400;
      transition: color 0.3s;
      text-decoration: none;
    }
    
    .nav-link:hover { color: #d1d1d6; }
    
    .nav-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #C9A961;
      letter-spacing: -0.04em;
    }
    
    .container { 
      max-width: 62rem; 
      margin: 0 auto; 
      padding: 0 1rem 3rem 1rem;
    }
    
    .header { 
      text-align: center; 
      margin-bottom: 2rem;
    }
    
    .subtitle { 
      font-size: 0.75rem; 
      color: #8e8e93;
      font-weight: 400;
      margin-bottom: 1rem;
    }
    
    .mode-selector {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 2rem;
      padding: 0.5rem;
      background: rgba(28, 28, 30, 0.6);
      border-radius: 1rem;
      border: 1px solid rgba(84, 84, 88, 0.25);
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .mode-btn {
      flex: 1;
      padding: 0.75rem 1.5rem;
      background: transparent;
      border: none;
      color: #8e8e93;
      font-size: 0.875rem;
      font-weight: 600;
      border-radius: 0.75rem;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .mode-btn:hover {
      color: #d1d1d6;
      background: rgba(99, 99, 102, 0.2);
    }
    
    .mode-btn.active {
      background: rgba(201, 169, 97, 0.25);
      color: #C9A961;
      box-shadow: 0 2px 8px rgba(201, 169, 97, 0.3);
    }
    
    .content-container {
      background: rgba(28, 28, 30, 0.6);
      backdrop-filter: blur(40px) saturate(150%);
      border-radius: 1.25rem;
      border: 1px solid rgba(84, 84, 88, 0.25);
      padding: 2rem;
      min-height: 400px;
    }
    
    .practice-mode .question {
      margin-bottom: 1.5rem;
      padding: 1.5rem;
      background: rgba(48, 48, 51, 0.4);
      border-radius: 1rem;
      border: 1px solid rgba(84, 84, 88, 0.2);
    }
    
    .question-text {
      font-size: 1rem;
      color: #f1f5f9;
      line-height: 1.6;
      margin-bottom: 1rem;
    }
    
    .blank {
      display: inline-block;
      min-width: 120px;
      padding: 0.25rem 0.75rem;
      background: rgba(71, 85, 105, 0.4);
      border: 1px solid rgba(71, 85, 105, 0.5);
      border-radius: 0.375rem;
      margin: 0 0.25rem;
      color: #94a3b8;
      font-weight: 600;
    }
    
    .options {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-top: 1rem;
    }
    
    .option-btn {
      padding: 0.5rem 1rem;
      background: rgba(201, 169, 97, 0.15);
      border: 2px solid transparent;
      color: #C9A961;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .option-btn:hover:not(:disabled) {
      background: rgba(201, 169, 97, 0.25);
      transform: scale(1.05);
    }
    
    .option-btn.selected {
      border-color: #C9A961;
      box-shadow: 0 0 0 2px rgba(201, 169, 97, 0.2);
    }

    .option-btn.correct {
      background: rgba(34, 197, 94, 0.25);
      border-color: #22c55e;
      color: #22c55e;
    }

    .option-btn.incorrect {
      background: rgba(239, 68, 68, 0.25);
      border-color: #ef4444;
      color: #ef4444;
    }

    .option-btn:disabled {
      cursor: not-allowed;
    }
    
    .study-mode .expression-card {
      margin-bottom: 1.5rem;
      padding: 1.5rem;
      background: rgba(48, 48, 51, 0.4);
      border-radius: 1rem;
      border: 1px solid rgba(84, 84, 88, 0.2);
    }
    
    .expression-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .expression-text {
      font-size: 1.125rem;
      color: #C9A961;
      font-weight: 600;
    }
    
    .badges {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .badge {
      padding: 0.25rem 0.625rem;
      border-radius: 0.375rem;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }
    
    .badge-level {
      background: rgba(59, 130, 246, 0.2);
      color: #60a5fa;
    }
    
    .badge-formality {
      background: rgba(168, 85, 247, 0.2);
      color: #c084fc;
    }
    
    .expression-example {
      color: #d1d1d6;
      font-style: italic;
      margin-bottom: 1rem;
      padding: 0.75rem;
      background: rgba(99, 99, 102, 0.15);
      border-radius: 0.5rem;
      border-left: 3px solid #C9A961;
    }
    
    .expression-notes {
      display: grid;
      gap: 0.75rem;
      margin-top: 1rem;
    }
    
    .note-item {
      display: flex;
      gap: 0.75rem;
      font-size: 0.875rem;
    }
    
    .note-label {
      color: #8e8e93;
      font-weight: 600;
      min-width: 100px;
    }
    
    .note-value {
      color: #d1d1d6;
      flex: 1;
    }
    
    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 300px;
      color: #8e8e93;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 2rem;
      height: 2rem;
      border: 2px solid rgba(142, 142, 147, 0.3);
      border-top-color: #C9A961;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 1rem;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .nav-controls {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 2rem;
    }
    
    .nav-btn {
      padding: 0.75rem 1.5rem;
      background: rgba(201, 169, 97, 0.25);
      border: 1px solid rgba(201, 169, 97, 0.3);
      color: #C9A961;
      border-radius: 0.75rem;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .nav-btn:hover:not(:disabled) {
      background: rgba(201, 169, 97, 0.35);
      transform: translateY(-1px);
    }
    
    .nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    .error-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 300px;
      color: #ef4444;
    }

    .feedback {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      text-align: center;
    }

    .feedback.correct {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .feedback.incorrect {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
  </style>
</head>
<body>
  <div class="top-nav">
    <div class="nav-left">
      <a href="essay-writer.html" class="nav-link">‚Üê Home</a>
    </div>
    <div class="nav-center">
      <div class="nav-title">INTUITY</div>
    </div>
    <div class="nav-right"></div>
  </div>

  <div class="container">
    <div class="header">
      <p class="subtitle">Essay Expressions ¬∑ B2/C1 Level</p>
      
      <div class="mode-selector">
        <button class="mode-btn active" id="practiceModeBtn" onclick="switchMode('practice')">
          ‚ö° Practice Mode
        </button>
        <button class="mode-btn" id="studyModeBtn" onclick="switchMode('study')">
          üìö Study Mode
        </button>
      </div>
    </div>

    <div class="content-container" id="contentContainer">
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <div>Loading content...</div>
      </div>
    </div>

    <div class="nav-controls">
      <button class="nav-btn" id="prevBtn" onclick="navigate(-1)">‚Üê Previous</button>
      <button class="nav-btn" id="nextBtn" onclick="navigate(1)">Next ‚Üí</button>
    </div>
  </div>

  <script>
    let currentMode = 'practice';
    let practiceData = null;
    let studyData = null;
    let currentSetIndex = 0;
    let currentQuestionIndex = 0;
    let selectedAnswers = {};

    async function loadData() {
      try {
        const basePath = 'data/';
        
        // Load practice data
        try {
          const practiceResponse = await fetch(basePath + 'data/essay-expressions-interface.json');
          console.log('Practice response status:', practiceResponse.status);
          
          if (practiceResponse.ok) {
            const text = await practiceResponse.text();
            console.log('Practice data length:', text.length);
            practiceData = JSON.parse(text);
            console.log('‚úì Practice data loaded:', practiceData);
            console.log('Sets:', practiceData?.sets?.length);
          } else {
            console.error('Failed to load practice data:', practiceResponse.status);
          }
        } catch (err) {
          console.error('Error loading practice data:', err);
        }

        // Load study data
        try {
          const studyResponse = await fetch(basePath + 'data/essay-expressions-database.json');
          console.log('Study response status:', studyResponse.status);
          
          if (studyResponse.ok) {
            const text = await studyResponse.text();
            console.log('Study data length:', text.length);
            studyData = JSON.parse(text);
            console.log('‚úì Study data loaded');
          } else {
            console.error('Failed to load study data:', studyResponse.status);
          }
        } catch (err) {
          console.error('Error loading study data:', err);
        }

        // Check if we have any data
        if (!practiceData && !studyData) {
          showError('Could not load any data files. Please check the file paths.');
          return;
        }

        if (!practiceData) {
          console.warn('Practice data not available, switching to study mode');
          switchMode('study');
        } else if (!studyData) {
          console.warn('Study data not available, staying in practice mode');
        }

        render();
      } catch (error) {
        console.error('Error in loadData:', error);
        showError(`Error: ${error.message}`);
      }
    }

    function showError(message) {
      const container = document.getElementById('contentContainer');
      container.innerHTML = `
        <div class="error-state">
          <div style="font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
          <div style="font-size: 1.125rem; margin-bottom: 0.5rem;">Error Loading Content</div>
          <div style="font-size: 0.875rem; color: #8e8e93; margin-top: 0.5rem; max-width: 500px; text-align: center;">
            ${message}
          </div>
          <div style="font-size: 0.75rem; color: #636366; margin-top: 1.5rem; text-align: left; max-width: 600px;">
            <strong>Debug info:</strong><br>
            Current URL: ${window.location.href}<br>
            Practice data loaded: ${practiceData ? 'Yes' : 'No'}<br>
            Study data loaded: ${studyData ? 'Yes' : 'No'}
          </div>
        </div>
      `;
    }

    function switchMode(mode) {
      // Check if data is available for the mode
      if (mode === 'practice' && !practiceData) {
        console.warn('Cannot switch to practice mode - no data available');
        return;
      }
      if (mode === 'study' && !studyData) {
        console.warn('Cannot switch to study mode - no data available');
        return;
      }

      currentMode = mode;
      currentSetIndex = 0;
      currentQuestionIndex = 0;
      selectedAnswers = {};
      
      document.getElementById('practiceModeBtn').classList.toggle('active', mode === 'practice');
      document.getElementById('studyModeBtn').classList.toggle('active', mode === 'study');
      
      render();
    }

    function navigate(direction) {
      if (currentMode === 'practice') {
        if (!practiceData?.sets) return;
        
        const set = practiceData.sets[currentSetIndex];
        const newQuestionIndex = currentQuestionIndex + direction;
        
        if (newQuestionIndex >= 0 && newQuestionIndex < set.sentences.length) {
          currentQuestionIndex = newQuestionIndex;
        } else if (direction > 0 && currentSetIndex < practiceData.sets.length - 1) {
          currentSetIndex++;
          currentQuestionIndex = 0;
        } else if (direction < 0 && currentSetIndex > 0) {
          currentSetIndex--;
          currentQuestionIndex = practiceData.sets[currentSetIndex].sentences.length - 1;
        }
      } else {
        const phrases = getAllStudyPhrases();
        const maxIndex = phrases.length - 1;
        currentSetIndex = Math.max(0, Math.min(maxIndex, currentSetIndex + direction));
      }
      
      render();
    }

    function getAllStudyPhrases() {
      if (!studyData) return [];
      
      const phrases = [];
      
      // Collect from all categories
      for (const catKey in studyData.categories) {
        const category = studyData.categories[catKey];
        
        if (category.subcategories) {
          for (const subKey in category.subcategories) {
            const subcat = category.subcategories[subKey];
            if (subcat.phrases) {
              subcat.phrases.forEach(phrase => {
                phrases.push({
                  ...phrase,
                  category: category.title,
                  subcategory: subcat.title
                });
              });
            }
          }
        }
        
        if (category.levels) {
          for (const levelKey in category.levels) {
            const level = category.levels[levelKey];
            if (level.phrases) {
              level.phrases.forEach(phrase => {
                phrases.push({
                  ...phrase,
                  category: category.title,
                  subcategory: level.name
                });
              });
            }
          }
        }
      }
      
      return phrases;
    }

    function render() {
      const container = document.getElementById('contentContainer');
      
      if (currentMode === 'practice') {
        renderPracticeMode(container);
      } else {
        renderStudyMode(container);
      }
      
      updateNavButtons();
    }

    function renderPracticeMode(container) {
      if (!practiceData?.sets || practiceData.sets.length === 0) {
        container.innerHTML = `
          <div class="loading-state">
            <div style="font-size: 2rem; margin-bottom: 1rem;">üìù</div>
            <div>No practice data available</div>
          </div>
        `;
        return;
      }

      const set = practiceData.sets[currentSetIndex];
      const sentence = set.sentences[currentQuestionIndex];
      const questionKey = `${currentSetIndex}-${currentQuestionIndex}`;
      const selectedAnswer = selectedAnswers[questionKey];
      const isAnswered = selectedAnswer !== undefined;
      
      container.className = 'content-container practice-mode';
      container.innerHTML = `
        <div style="text-align: center; margin-bottom: 2rem;">
          <h2 style="color: #C9A961; font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">
            Set ${set.setNumber}: ${set.topic}
          </h2>
          <p style="color: #8e8e93; font-size: 0.875rem;">
            Question ${currentQuestionIndex + 1} of ${set.sentences.length}
          </p>
        </div>
        
        <div class="question">
          <div class="question-text">
            ${sentence.text.replace('_____', '<span class="blank">______</span>')}
          </div>
          <div class="options">
            ${set.words.map((word, i) => {
              let classes = 'option-btn';
              if (isAnswered) {
                if (i === sentence.correct) classes += ' correct';
                else if (i === selectedAnswer) classes += ' incorrect';
              } else if (i === selectedAnswer) {
                classes += ' selected';
              }
              return `<button class="${classes}" onclick="selectOption(${i})" ${isAnswered ? 'disabled' : ''}>
                ${word}
              </button>`;
            }).join('')}
          </div>
          ${isAnswered ? `
            <div class="feedback ${selectedAnswer === sentence.correct ? 'correct' : 'incorrect'}">
              ${selectedAnswer === sentence.correct 
                ? '‚úì Correct! Well done.' 
                : `‚úó Incorrect. The correct answer is "${set.words[sentence.correct]}"`
              }
            </div>
          ` : ''}
        </div>
        
        <div style="text-align: center; color: #8e8e93; font-size: 0.875rem; margin-top: 2rem;">
          üí° Select the best option to fill the blank
        </div>
      `;
    }

    function renderStudyMode(container) {
      if (!studyData) {
        container.innerHTML = `
          <div class="loading-state">
            <div style="font-size: 2rem; margin-bottom: 1rem;">üìö</div>
            <div>No study data available</div>
          </div>
        `;
        return;
      }

      const phrases = getAllStudyPhrases();
      
      if (phrases.length === 0) {
        container.innerHTML = `
          <div class="loading-state">
            <div style="font-size: 2rem; margin-bottom: 1rem;">üìö</div>
            <div>No study phrases found in database</div>
          </div>
        `;
        return;
      }

      const phrase = phrases[currentSetIndex];

      container.className = 'content-container study-mode';
      container.innerHTML = `
        <div style="text-align: center; margin-bottom: 2rem;">
          <p style="color: #C9A961; font-size: 1rem; font-weight: 600; margin-bottom: 0.25rem;">
            ${phrase.category}
          </p>
          <p style="color: #636366; font-size: 0.75rem;">
            ${phrase.subcategory || ''} ¬∑ Expression ${currentSetIndex + 1} of ${phrases.length}
          </p>
        </div>
        
        <div class="expression-card">
          <div class="expression-header">
            <div class="expression-text">${phrase.text}</div>
            <div class="badges">
              ${phrase.level ? `<span class="badge badge-level">${phrase.level}</span>` : ''}
              ${phrase.formality ? `<span class="badge badge-formality">${phrase.formality}</span>` : ''}
            </div>
          </div>
          
          ${phrase.example ? `
            <div class="expression-example">
              "${phrase.example}"
            </div>
          ` : ''}
          
          <div class="expression-notes">
            ${phrase.grammarNote ? `
              <div class="note-item">
                <div class="note-label">Grammar:</div>
                <div class="note-value">${phrase.grammarNote}</div>
              </div>
            ` : ''}
            
            ${phrase.usage ? `
              <div class="note-item">
                <div class="note-label">Usage:</div>
                <div class="note-value">${phrase.usage}</div>
              </div>
            ` : ''}
            
            ${phrase.topics ? `
              <div class="note-item">
                <div class="note-label">Topics:</div>
                <div class="note-value">${phrase.topics.join(', ')}</div>
              </div>
            ` : ''}

            ${phrase.collocations ? `
              <div class="note-item">
                <div class="note-label">Collocations:</div>
                <div class="note-value">${phrase.collocations.join(', ')}</div>
              </div>
            ` : ''}
          </div>
        </div>
        
        <div style="text-align: center; color: #8e8e93; font-size: 0.875rem; margin-top: 2rem;">
          üìñ Study each expression with examples and usage notes
        </div>
      `;
    }

    function selectOption(index) {
      const questionKey = `${currentSetIndex}-${currentQuestionIndex}`;
      selectedAnswers[questionKey] = index;
      render();
    }

    function updateNavButtons() {
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      
      if (currentMode === 'practice') {
        if (!practiceData?.sets) {
          prevBtn.disabled = true;
          nextBtn.disabled = true;
          return;
        }

        const isFirstQuestion = currentSetIndex === 0 && currentQuestionIndex === 0;
        const set = practiceData.sets[currentSetIndex];
        const isLastQuestion = currentSetIndex === practiceData.sets.length - 1 && 
                              currentQuestionIndex === set.sentences.length - 1;
        
        prevBtn.disabled = isFirstQuestion;
        nextBtn.disabled = isLastQuestion;
      } else {
        const phrases = getAllStudyPhrases();
        prevBtn.disabled = currentSetIndex === 0;
        nextBtn.disabled = currentSetIndex >= phrases.length - 1;
      }
    }

    loadData();
  </script>
</body>
</html>
