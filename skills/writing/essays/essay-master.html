import React, { useState, useEffect } from 'react';

const EssayMaster = () => {
  const [currentMode, setCurrentMode] = useState('paragraphs');
  const [currentView, setCurrentView] = useState('questions'); // Default to questions
  const [currentParagraph, setCurrentParagraph] = useState(0);
  const [currentEssayIndex, setCurrentEssayIndex] = useState(0);
  const [showXRay, setShowXRay] = useState(false);
  
  const [questionsData, setQuestionsData] = useState([]);
  const [samplesData, setSamplesData] = useState([]);
  const [ideasData, setIdeasData] = useState({});
  const [loading, setLoading] = useState(true);

  const paragraphLabels = ['Intro', 'Body 1', 'Body 2', 'Body 3', 'Concl'];

  // Fetch all JSON data
  useEffect(() => {
    const fetchData = async () => {
      try {
        const [questionsRes, samplesRes, ideasRes] = await Promise.all([
          fetch('data/essay-questions.json'),
          fetch('data/samples.json'),
          fetch('data/ideas.json')
        ]);

        const questions = await questionsRes.json();
        const samples = await samplesRes.json();
        const ideas = await ideasRes.json();

        setQuestionsData(questions.questions || []);
        setSamplesData(samples.opinion || []);
        setIdeasData(ideas.opinion || {});
        setLoading(false);
      } catch (error) {
        console.error('Error loading data:', error);
        setLoading(false);
      }
    };

    fetchData();
  }, []);

  const extractParagraphs = (htmlAnswer) => {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = htmlAnswer;
    const paragraphs = Array.from(tempDiv.querySelectorAll('p'));
    return paragraphs.map(p => p.innerHTML);
  };

  const stripXRayClasses = (html) => {
    return html.replace(/<span class='[^']*'>(.*?)<\/span>/g, '$1');
  };

  const renderParagraph = (html) => {
    if (!showXRay) {
      const clean = stripXRayClasses(html);
      return <div dangerouslySetInnerHTML={{ __html: clean }} />;
    }
    return <div dangerouslySetInnerHTML={{ __html: html }} />;
  };

  const renderContent = () => {
    if (loading) {
      return <div className="loading">Loading essay data...</div>;
    }

    // ESSAY PLANS VIEW
    if (currentView === 'plans') {
      return (
        <div className="skeleton-view">
          {Object.entries(ideasData).map(([id, plan]) => (
            <div key={id} className="skeleton-section">
              <div className="skeleton-topic">{plan.topic}</div>
              {plan.skeleton?.map((section, idx) => (
                <div key={idx}>
                  <div className="skeleton-title">{section.title}</div>
                  {section.notes?.map((note, nIdx) => (
                    <div key={nIdx} className="skeleton-note">
                      <span className="note-marker">{note.marker}</span>
                      <div className="note-content">
                        <span className="note-text">{note.text}</span>
                        {note.verb && <span className="note-verb">{note.verb}</span>}
                        {note.sub && <div className="note-sub">{note.sub}</div>}
                      </div>
                    </div>
                  ))}
                </div>
              ))}
              {plan.magic_verbs && (
                <div className="magic-verbs">
                  <div className="magic-title">‚ú® Magic Verbs</div>
                  <div className="verb-list">
                    {plan.magic_verbs.map((verb, idx) => (
                      <span key={idx} className="verb-tag">{verb}</span>
                    ))}
                  </div>
                </div>
              )}
            </div>
          ))}
        </div>
      );
    }

    // QUESTIONS VIEW (default)
    if (currentView === 'questions') {
      const currentSample = samplesData[currentEssayIndex];
      if (!currentSample) {
        return <div className="loading">No essay available</div>;
      }

      const paragraphs = extractParagraphs(currentSample.answer);

      if (currentMode === 'paragraphs') {
        // Show one paragraph at a time
        const paragraph = paragraphs[currentParagraph];
        if (!paragraph) {
          return <div className="loading">No content for this paragraph</div>;
        }

        return (
          <div className="paragraph-view">
            <div className="essay-title-small">{currentSample.title}</div>
            <div className="essay-subtitle">{paragraphLabels[currentParagraph]}</div>
            <div className="paragraph-text">
              {renderParagraph(paragraph)}
            </div>
          </div>
        );
      } else {
        // Show full essay
        return (
          <div className="full-text-view">
            <div className="essay-title-small">{currentSample.title}</div>
            <div className="essay-subtitle">Full Essay</div>
            {paragraphs.map((para, idx) => (
              <div key={idx} className="full-paragraph">
                {renderParagraph(para)}
              </div>
            ))}
          </div>
        );
      }
    }
  };

  return (
    <div style={{
      fontFamily: "'DM Sans', sans-serif",
      background: 'radial-gradient(circle at top, #1a1a1a 0, #050505 45%, #000 100%)',
      minHeight: '100vh',
      color: '#e5e5e7',
      padding: '1rem'
    }}>
      {/* Header */}
      <div style={{
        background: 'rgba(28, 28, 30, 0.95)',
        backdropFilter: 'blur(40px)',
        borderRadius: '1rem',
        padding: '1rem 1.5rem',
        marginBottom: '1rem',
        textAlign: 'center',
        borderBottom: '1px solid rgba(84, 84, 88, 0.3)'
      }}>
        <div style={{
          fontFamily: "'Space Grotesk', sans-serif",
          fontSize: '1.6rem',
          fontWeight: 700,
          background: 'linear-gradient(135deg, #C9A961 0%, rgba(255,255,255,0.85) 100%)',
          WebkitBackgroundClip: 'text',
          WebkitTextFillColor: 'transparent',
          textTransform: 'uppercase'
        }}>
          INTUITY
        </div>
        <div style={{ fontSize: '0.75rem', color: '#636366', marginTop: '0.25rem' }}>
          Essay Master
        </div>
      </div>

      {/* Two-Toggle Navigation - Side by Side */}
      <div style={{
        background: 'rgba(28, 28, 30, 0.8)',
        borderRadius: '1rem',
        padding: '1rem 1.5rem',
        marginBottom: '1rem',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between',
        gap: '2rem'
      }}>
        {/* Left Toggle: Paragraphs vs Full Text */}
        <div style={{
          display: 'flex',
          alignItems: 'center',
          gap: '0.75rem',
          flex: 1
        }}>
          <span style={{
            fontSize: '0.7rem',
            color: currentMode === 'paragraphs' ? '#7dd3fc' : '#636366',
            fontWeight: 600,
            textTransform: 'uppercase',
            whiteSpace: 'nowrap'
          }}>
            üí¨ Paragraphs
          </span>
          
          <div
            onClick={() => setCurrentMode(currentMode === 'paragraphs' ? 'full' : 'paragraphs')}
            style={{
              position: 'relative',
              width: '48px',
              height: '24px',
              background: 'rgba(125, 211, 252, 0.2)',
              borderRadius: '999px',
              cursor: 'pointer',
              border: '1px solid rgba(125, 211, 252, 0.3)',
              transition: 'all 0.3s'
            }}
          >
            <div style={{
              position: 'absolute',
              top: '2px',
              left: currentMode === 'full' ? '24px' : '2px',
              width: '18px',
              height: '18px',
              background: '#7dd3fc',
              borderRadius: '50%',
              transition: 'all 0.3s',
              boxShadow: '0 2px 4px rgba(0, 0, 0, 0.3)'
            }} />
          </div>
          
          <span style={{
            fontSize: '0.7rem',
            color: currentMode === 'full' ? '#7dd3fc' : '#636366',
            fontWeight: 600,
            textTransform: 'uppercase',
            whiteSpace: 'nowrap'
          }}>
            üìÑ Full Text
          </span>
        </div>

        {/* Right Toggle: Questions vs Essay Plans */}
        <div style={{
          display: 'flex',
          alignItems: 'center',
          gap: '0.75rem',
          flex: 1,
          justifyContent: 'flex-end'
        }}>
          <span style={{
            fontSize: '0.7rem',
            color: currentView === 'questions' ? '#7dd3fc' : '#636366',
            fontWeight: 600,
            textTransform: 'uppercase',
            whiteSpace: 'nowrap'
          }}>
            ‚ùì Questions
          </span>
          
          <div
            onClick={() => setCurrentView(currentView === 'questions' ? 'plans' : 'questions')}
            style={{
              position: 'relative',
              width: '48px',
              height: '24px',
              background: 'rgba(125, 211, 252, 0.2)',
              borderRadius: '999px',
              cursor: 'pointer',
              border: '1px solid rgba(125, 211, 252, 0.3)',
              transition: 'all 0.3s'
            }}
          >
            <div style={{
              position: 'absolute',
              top: '2px',
              left: currentView === 'plans' ? '24px' : '2px',
              width: '18px',
              height: '18px',
              background: '#7dd3fc',
              borderRadius: '50%',
              transition: 'all 0.3s',
              boxShadow: '0 2px 4px rgba(0, 0, 0, 0.3)'
            }} />
          </div>
          
          <span style={{
            fontSize: '0.7rem',
            color: currentView === 'plans' ? '#7dd3fc' : '#636366',
            fontWeight: 600,
            textTransform: 'uppercase',
            whiteSpace: 'nowrap'
          }}>
            üí° Essay Plans
          </span>
        </div>
      </div>

      {/* Main Content Card */}
      <div style={{
        background: 'rgba(20, 20, 22, 0.9)',
        backdropFilter: 'blur(30px)',
        borderRadius: '1.5rem',
        border: '1px solid rgba(255, 255, 255, 0.08)',
        overflow: 'hidden'
      }}>
        {/* Stage Dots - Only in Paragraph + Questions mode */}
        {currentMode === 'paragraphs' && currentView === 'questions' && !loading && (
          <div style={{
            padding: '0.85rem 1rem',
            background: 'rgba(0, 0, 0, 0.2)',
            borderBottom: '1px solid rgba(84, 84, 88, 0.2)',
            display: 'flex',
            justifyContent: 'center',
            gap: '1.5rem'
          }}>
            {paragraphLabels.map((label, idx) => (
              <div
                key={idx}
                onClick={() => setCurrentParagraph(idx)}
                style={{
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  gap: '0.3rem',
                  cursor: 'pointer'
                }}
              >
                <div style={{
                  width: '1rem',
                  height: '1rem',
                  borderRadius: '50%',
                  background: idx === currentParagraph ? 'rgba(201, 169, 97, 0.3)' : 'rgba(99, 99, 102, 0.3)',
                  border: `2px solid ${idx === currentParagraph ? '#C9A961' : 'rgba(99, 99, 102, 0.3)'}`,
                  transform: idx === currentParagraph ? 'scale(1.3)' : 'scale(1)',
                  transition: 'all 0.3s',
                  boxShadow: idx === currentParagraph ? '0 0 0 4px rgba(201, 169, 97, 0.15)' : 'none'
                }} />
                <span style={{
                  fontSize: '0.55rem',
                  fontWeight: 700,
                  color: idx === currentParagraph ? '#C9A961' : '#636366',
                  textTransform: 'uppercase'
                }}>
                  {label}
                </span>
              </div>
            ))}
          </div>
        )}

        {/* Content Area */}
        <div style={{
          position: 'relative',
          padding: '3rem 2.5rem',
          minHeight: '500px',
          background: 'linear-gradient(145deg, rgba(25, 25, 27, 0.8), rgba(15, 15, 17, 0.9))',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center'
        }}>
          {/* X-Ray Button (only in Questions view) */}
          {currentView === 'questions' && !loading && (
            <button
              onClick={() => setShowXRay(!showXRay)}
              style={{
                position: 'absolute',
                top: '1rem',
                right: '1rem',
                padding: '0.5rem 1rem',
                borderRadius: '999px',
                border: '1px solid rgba(255, 255, 255, 0.08)',
                background: 'rgba(0, 0, 0, 0.5)',
                backdropFilter: 'blur(10px)',
                color: '#C9A961',
                fontSize: '0.7rem',
                fontWeight: 700,
                textTransform: 'uppercase',
                cursor: 'pointer',
                transition: 'all 0.3s'
              }}
            >
              {showXRay ? 'Normal' : 'X-Ray'}
            </button>
          )}

          <div style={{ width: '100%', maxWidth: '900px' }}>
            {renderContent()}
          </div>
        </div>

        {/* Navigation Footer - Only in Questions view */}
        {currentView === 'questions' && !loading && (
          <div style={{
            padding: '0.85rem 1rem',
            background: 'rgba(0, 0, 0, 0.2)',
            borderTop: '1px solid rgba(84, 84, 88, 0.2)',
            display: 'flex',
            justifyContent: 'center',
            alignItems: 'center',
            gap: '1rem'
          }}>
            <button
              onClick={() => setCurrentEssayIndex(Math.max(0, currentEssayIndex - 1))}
              disabled={currentEssayIndex === 0}
              style={{
                width: '40px',
                height: '40px',
                borderRadius: '50%',
                border: '1px solid rgba(255, 255, 255, 0.08)',
                background: 'rgba(0, 0, 0, 0.3)',
                color: '#C9A961',
                fontSize: '1.2rem',
                cursor: currentEssayIndex === 0 ? 'not-allowed' : 'pointer',
                opacity: currentEssayIndex === 0 ? 0.3 : 1
              }}
            >
              ‚Üê
            </button>
            
            <div style={{ fontSize: '0.7rem', color: '#8e8e93' }}>
              Essay {currentEssayIndex + 1} of {samplesData.length}
            </div>
            
            <button
              onClick={() => setCurrentEssayIndex(Math.min(samplesData.length - 1, currentEssayIndex + 1))}
              disabled={currentEssayIndex === samplesData.length - 1}
              style={{
                width: '40px',
                height: '40px',
                borderRadius: '50%',
                border: '1px solid rgba(255, 255, 255, 0.08)',
                background: 'rgba(0, 0, 0, 0.3)',
                color: '#C9A961',
                fontSize: '1.2rem',
                cursor: currentEssayIndex === samplesData.length - 1 ? 'not-allowed' : 'pointer',
                opacity: currentEssayIndex === samplesData.length - 1 ? 0.3 : 1
              }}
            >
              ‚Üí
            </button>
          </div>
        )}
      </div>

      <style>{`
        .paragraph-text, .full-text-view {
          fontSize: 1.4rem;
          lineHeight: 1.75;
          color: #e5e7eb;
        }
        
        .essay-title-small {
          fontSize: 1.5rem;
          fontWeight: 800;
          color: #fef3c7;
          marginBottom: 0.5rem;
          textAlign: center;
          fontFamily: 'Space Grotesk', sans-serif;
        }
        
        .essay-subtitle {
          fontSize: 0.8rem;
          color: #9ca3af;
          textAlign: center;
          marginBottom: 2rem;
          textTransform: uppercase;
          letterSpacing: 0.1em;
        }
        
        .full-paragraph {
          marginBottom: 2rem;
        }
        
        .discourse {
          color: #7dd3fc !important;
          fontWeight: 600 !important;
          borderBottom: 2px solid rgba(125, 211, 252, 0.4) !important;
          paddingBottom: 2px !important;
        }
        
        .vocabulary {
          color: #34d399 !important;
          fontWeight: 600 !important;
          borderBottom: 2px solid rgba(52, 211, 153, 0.4) !important;
          paddingBottom: 2px !important;
        }
        
        /* Opinion and causal - treated as discourse (blue) */
        .opinion {
          color: #7dd3fc !important;
          fontWeight: 600 !important;
          borderBottom: 2px solid rgba(125, 211, 252, 0.4) !important;
          paddingBottom: 2px !important;
        }
        
        .causal {
          color: #7dd3fc !important;
          fontWeight: 600 !important;
          borderBottom: 2px solid rgba(125, 211, 252, 0.4) !important;
          paddingBottom: 2px !important;
        }
        
        .skeleton-view {
          width: 100%;
          maxHeight: 60vh;
          overflowY: auto;
        }
        
        .skeleton-section {
          marginBottom: 2rem;
          padding: 1.5rem;
          background: rgba(255, 255, 255, 0.02);
          borderRadius: 0.75rem;
          borderLeft: 4px solid #C9A961;
        }
        
        .skeleton-topic {
          fontSize: 0.75rem;
          color: #ff9500;
          textTransform: uppercase;
          marginBottom: 0.5rem;
          fontWeight: 600;
        }
        
        .skeleton-title {
          fontSize: 1rem;
          fontWeight: 800;
          color: #C9A961;
          marginBottom: 1rem;
          textTransform: uppercase;
          fontFamily: 'Space Grotesk', sans-serif;
        }
        
        .skeleton-note {
          display: flex;
          gap: 0.75rem;
          marginBottom: 0.75rem;
          alignItems: flex-start;
        }
        
        .note-marker {
          color: #ff9500;
          fontWeight: 700;
          fontSize: 0.95rem;
          minWidth: 2rem;
          textAlign: center;
        }
        
        .note-content {
          flex: 1;
        }
        
        .note-text {
          color: #9a9a9f;
          fontWeight: 600;
          fontSize: 0.875rem;
        }
        
        .note-verb {
          color: #87CEEB;
          fontSize: 0.75rem;
          fontWeight: 700;
          padding: 0.2rem 0.5rem;
          background: rgba(135, 206, 235, 0.15);
          borderRadius: 0.375rem;
          marginLeft: 0.5rem;
        }
        
        .note-sub {
          color: #6e6e73;
          fontSize: 0.75rem;
          marginTop: 0.25rem;
          fontStyle: italic;
        }
        
        .magic-verbs {
          marginTop: 2rem;
          paddingTop: 1.5rem;
          borderTop: 1px solid rgba(84, 84, 88, 0.3);
        }
        
        .magic-title {
          fontSize: 0.75rem;
          color: #C9A961;
          textTransform: uppercase;
          marginBottom: 0.75rem;
          fontWeight: 700;
        }
        
        .verb-list {
          display: flex;
          flexWrap: wrap;
          gap: 0.5rem;
        }
        
        .verb-tag {
          background: rgba(201, 169, 97, 0.15);
          border: 1px solid rgba(201, 169, 97, 0.3);
          borderRadius: 0.5rem;
          padding: 0.375rem 0.75rem;
          fontSize: 0.75rem;
          color: #C9A961;
          fontWeight: 600;
        }
        
        .loading {
          textAlign: center;
          color: #8e8e93;
          fontSize: 1.125rem;
        }
      `}</style>
    </div>
  );
};

export default EssayMaster;
