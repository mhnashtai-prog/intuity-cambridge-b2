<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>INTUITY - Essay Writer</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: #0d0d0d;
      color: white;
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .background {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: radial-gradient(circle at 30% 20%, rgba(201, 169, 97, 0.08) 0%, transparent 50%),
                  radial-gradient(circle at 70% 80%, rgba(201, 169, 97, 0.06) 0%, transparent 45%),
                  #0d0d0d;
      z-index: 0;
    }

    /* COMPRESSED HEADER */
    .top-bar {
      position: relative;
      z-index: 10;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      border-bottom: 1px solid rgba(84, 84, 88, 0.2);
      flex-wrap: wrap;
    }

    .nav-link {
      color: #8e8e93;
      text-decoration: none;
      font-size: 0.8rem;
      font-weight: 500;
      transition: color 0.3s;
      white-space: nowrap;
    }

    .nav-link:hover { color: #C9A961; }

    .logo {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.1rem;
      font-weight: 700;
      color: #C9A961;
      letter-spacing: -0.02em;
    }

    .question-select {
      flex: 1;
      max-width: 250px;
      background: rgba(28, 28, 30, 0.6);
      border: 1px solid rgba(84, 84, 88, 0.25);
      border-radius: 0.5rem;
      padding: 0.4rem 0.6rem;
      color: #e5e5e7;
      font-size: 0.75rem;
      font-family: 'Inter';
      cursor: pointer;
    }

    .question-select:focus {
      outline: none;
      border-color: rgba(201, 169, 97, 0.5);
    }

    /* EXPRESSION STATUS BADGE */
    .expression-status {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.4rem 0.8rem;
      background: rgba(28, 28, 30, 0.6);
      border: 1px solid rgba(84, 84, 88, 0.25);
      border-radius: 0.5rem;
      font-size: 0.7rem;
      white-space: nowrap;
    }

    .expression-status.low {
      border-color: rgba(251, 146, 60, 0.4);
      background: rgba(251, 146, 60, 0.1);
    }

    .expression-status.good {
      border-color: rgba(132, 204, 22, 0.4);
      background: rgba(132, 204, 22, 0.1);
    }

    .expr-count {
      font-weight: 600;
      color: #C9A961;
    }

    .practice-link {
      color: #8e8e93;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s;
    }

    .practice-link:hover { color: #C9A961; }

    /* MODE TOGGLE */
    .mode-toggle-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.7rem;
      font-weight: 600;
      color: #636366;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .mode-toggle-label {
      opacity: 0.7;
      transition: opacity 0.3s;
      white-space: nowrap;
    }

    .mode-toggle-container:hover .mode-toggle-label {
      opacity: 0.9;
    }

    .mode-toggle-switch {
      position: relative;
      width: 2.5rem;
      height: 1.25rem;
      background: rgba(99, 99, 102, 0.25);
      border-radius: 0.625rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(99, 99, 102, 0.2);
    }

    .mode-toggle-switch:hover {
      background: rgba(99, 99, 102, 0.35);
    }

    .mode-toggle-switch::after {
      content: '';
      position: absolute;
      top: 0.1rem;
      left: 0.1rem;
      width: 0.95rem;
      height: 0.95rem;
      background: #8e8e93;
      border-radius: 50%;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .mode-toggle-switch.active {
      background: rgba(201, 169, 97, 0.25);
      border-color: rgba(201, 169, 97, 0.3);
    }

    .mode-toggle-switch.active::after {
      left: 1.35rem;
      background: #C9A961;
    }

    .main-container {
      position: relative;
      z-index: 2;
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }

    .two-panel {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 1rem;
      height: calc(100vh - 140px);
      transition: grid-template-columns 0.3s ease;
    }

    .two-panel.panel-collapsed {
      grid-template-columns: 1fr 0px;
    }

    /* WRITE PANEL */
    .write-panel {
      background: rgba(28, 28, 30, 0.6);
      backdrop-filter: blur(40px) saturate(150%);
      border-radius: 1rem;
      border: 1px solid rgba(84, 84, 88, 0.25);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      display: flex;
      flex-direction: column;
      padding: 1rem;
    }

    /* STAGE NAVIGATION - 5 DOTS */
    .stage-nav {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem 0;
      border-bottom: 1px solid rgba(84, 84, 88, 0.2);
      margin-bottom: 0.75rem;
    }

    .stage-dot {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      background: rgba(99, 99, 102, 0.3);
      border: 2px solid rgba(99, 99, 102, 0.3);
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      color: #636366;
    }

    .stage-dot:hover {
      background: rgba(99, 99, 102, 0.45);
      transform: scale(1.1);
    }

    .stage-dot.current {
      background: rgba(201, 169, 97, 0.3);
      border-color: #C9A961;
      color: #C9A961;
      transform: scale(1.15);
      box-shadow: 0 0 0 3px rgba(201, 169, 97, 0.15);
    }

    .stage-dot.empty {
      background: rgba(99, 99, 102, 0.2);
      border-color: rgba(99, 99, 102, 0.2);
    }

    .stage-dot.good {
      background: rgba(132, 204, 22, 0.25);
      border-color: #84cc16;
      color: #84cc16;
    }

    .stage-dot.needs-work {
      background: rgba(251, 146, 60, 0.25);
      border-color: #fb923c;
      color: #fb923c;
    }

    /* VIEW TOGGLE (Read mode: paragraph/full) */
    .view-toggle-container {
      display: none;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.65rem;
      font-weight: 600;
      color: #636366;
      text-transform: uppercase;
      justify-content: center;
      margin-bottom: 0.5rem;
    }

    .view-toggle-label {
      opacity: 0.7;
      transition: opacity 0.3s;
      white-space: nowrap;
    }

    .view-toggle-container:hover .view-toggle-label {
      opacity: 0.9;
    }

    .view-toggle-switch {
      position: relative;
      width: 2.5rem;
      height: 1.25rem;
      background: rgba(99, 99, 102, 0.25);
      border-radius: 0.625rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(99, 99, 102, 0.2);
    }

    .view-toggle-switch:hover {
      background: rgba(99, 99, 102, 0.35);
    }

    .view-toggle-switch::after {
      content: '';
      position: absolute;
      top: 0.1rem;
      left: 0.1rem;
      width: 0.95rem;
      height: 0.95rem;
      background: #8e8e93;
      border-radius: 50%;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .view-toggle-switch.active {
      background: rgba(201, 169, 97, 0.25);
      border-color: rgba(201, 169, 97, 0.3);
    }

    .view-toggle-switch.active::after {
      left: 1.35rem;
      background: #C9A961;
    }

    /* HIGHLIGHT FILTERS (Read mode NEW) */
    .highlight-filters {
      display: none;
      gap: 0.4rem;
      padding: 0.5rem 0;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 0.5rem;
    }

    .highlight-btn {
      padding: 0.35rem 0.65rem;
      background: rgba(28, 28, 30, 0.6);
      border: 1px solid rgba(84, 84, 88, 0.25);
      border-radius: 0.5rem;
      color: #8e8e93;
      font-size: 0.65rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Inter';
      white-space: nowrap;
    }

    .highlight-btn.active {
      background: rgba(201, 169, 97, 0.2);
      border-color: rgba(201, 169, 97, 0.4);
      color: #C9A961;
    }

    .highlight-btn:hover:not(.active) {
      background: rgba(84, 84, 88, 0.15);
      color: #aeaeb2;
    }

    /* STAGE HEADER */
    .stage-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .stage-title {
      font-size: 0.8rem;
      color: #C9A961;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* QUICK ACCESS BUTTONS (Write mode) */
    .quick-access-bar {
      display: none;
      gap: 0.4rem;
      flex-wrap: wrap;
      margin-bottom: 0.5rem;
      justify-content: center;
    }

    .quick-btn {
      padding: 0.35rem 0.65rem;
      background: rgba(28, 28, 30, 0.6);
      border: 1px solid rgba(84, 84, 88, 0.25);
      border-radius: 0.5rem;
      color: #8e8e93;
      font-size: 0.65rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Inter';
      white-space: nowrap;
    }

    .quick-btn.active {
      background: rgba(201, 169, 97, 0.2);
      border-color: rgba(201, 169, 97, 0.4);
      color: #C9A961;
    }

    .quick-btn:hover:not(.active) {
      background: rgba(84, 84, 88, 0.15);
      color: #aeaeb2;
    }

    /* WORD COUNT WITH PROGRESS BAR */
    .word-count-container {
      display: none;
      flex-direction: column;
      gap: 0.25rem;
      margin-bottom: 0.5rem;
    }

    .word-count-bar {
      width: 100%;
      height: 4px;
      background: rgba(99, 99, 102, 0.3);
      border-radius: 2px;
      overflow: hidden;
    }

    .word-count-fill {
      height: 100%;
      background: #84cc16;
      transition: all 0.3s;
    }

    .word-count-fill.amber { background: #fb923c; }
    .word-count-fill.red { background: #ef4444; }

    .word-count-text {
      font-size: 0.7rem;
      color: #8e8e93;
      text-align: center;
    }

    .count-current {
      color: #C9A961;
      font-weight: 700;
    }

    /* TEXTAREA */
    .textarea {
      flex: 1;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(84, 84, 88, 0.25);
      border-radius: 0.75rem;
      padding: 0.75rem;
      color: #e5e5e7;
      font-size: 0.9rem;
      font-family: 'Inter';
      line-height: 1.7;
      resize: none;
      margin-bottom: 0.75rem;
      display: none;
    }

    .textarea:focus {
      outline: none;
      border-color: rgba(201, 169, 97, 0.4);
    }

    .textarea::placeholder {
      color: #636366;
    }

    /* SAMPLE DISPLAY */
    .sample-display {
      flex: 1;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(84, 84, 88, 0.25);
      border-radius: 0.75rem;
      padding: 0.75rem;
      color: #e5e5e7;
      font-size: 0.85rem;
      font-family: 'Inter';
      line-height: 1.7;
      overflow-y: auto;
      margin-bottom: 0.75rem;
      display: block;
    }

    .sample-display h3 {
      color: #C9A961;
      margin-bottom: 1rem;
      font-size: 1rem;
    }

    .sample-display p {
      margin-bottom: 1rem;
    }

    /* SAMPLE HIGHLIGHTING */
    .discourse {
      background: rgba(52, 199, 89, 0.3);
      border-bottom: 2px solid rgba(52, 199, 89, 0.8);
      border-radius: 2px;
      padding: 0 2px;
      transition: all 0.3s;
    }

    .opinion {
      background: rgba(255, 149, 0, 0.3);
      border-bottom: 2px solid rgba(255, 149, 0, 0.8);
      border-radius: 2px;
      padding: 0 2px;
      transition: all 0.3s;
    }

    .causal {
      background: rgba(90, 200, 250, 0.3);
      border-bottom: 2px solid rgba(90, 200, 250, 0.8);
      border-radius: 2px;
      padding: 0 2px;
      transition: all 0.3s;
    }

    .example {
      background: rgba(201, 169, 97, 0.3);
      border-bottom: 2px solid rgba(201, 169, 97, 0.8);
      border-radius: 2px;
      padding: 0 2px;
      transition: all 0.3s;
    }

    /* FOOTER NAV */
    .footer-nav {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.5rem 1rem;
      background: rgba(28, 28, 30, 0.6);
      border: 1px solid rgba(84, 84, 88, 0.25);
      border-radius: 0.5rem;
      color: #8e8e93;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Inter';
      white-space: nowrap;
      text-decoration: none;
      display: inline-block;
    }

    .btn:hover:not(:disabled) {
      border-color: rgba(201, 169, 97, 0.3);
      color: #C9A961;
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn.primary {
      background: rgba(201, 169, 97, 0.2);
      border-color: rgba(201, 169, 97, 0.3);
      color: #C9A961;
    }

    .btn.primary:hover:not(:disabled) {
      background: rgba(201, 169, 97, 0.3);
    }

    .action-btns {
      display: flex;
      gap: 0.5rem;
      margin-left: auto;
    }

    /* REFERENCE PANEL */
    .ref-panel {
      background: rgba(28, 28, 30, 0.6);
      backdrop-filter: blur(40px) saturate(150%);
      border-radius: 1rem;
      border: 1px solid rgba(84, 84, 88, 0.25);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
      position: relative;
    }

    .panel-collapsed .ref-panel {
      width: 0;
      min-width: 0;
      opacity: 0;
      pointer-events: none;
    }

    .panel-toggle-btn {
      position: absolute;
      left: -2.5rem;
      top: 50%;
      transform: translateY(-50%);
      width: 2rem;
      height: 4rem;
      background: rgba(28, 28, 30, 0.9);
      backdrop-filter: blur(40px);
      border: 1px solid rgba(84, 84, 88, 0.25);
      border-right: none;
      border-radius: 0.5rem 0 0 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #8e8e93;
      font-size: 1rem;
      transition: all 0.3s;
      z-index: 10;
    }

    .panel-toggle-btn:hover {
      background: rgba(201, 169, 97, 0.2);
      color: #C9A961;
    }

    .tab-nav {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.25rem;
      padding: 0.5rem;
      background: rgba(0, 0, 0, 0.3);
      border-bottom: 1px solid rgba(84, 84, 88, 0.2);
    }

    .tab-btn {
      padding: 0.5rem 0.375rem;
      background: transparent;
      border: none;
      color: #636366;
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.02em;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Inter';
    }

    .tab-btn.active {
      background: rgba(201, 169, 97, 0.15);
      color: #C9A961;
    }

    .tab-btn:hover:not(.active) {
      background: rgba(84, 84, 88, 0.1);
      color: #8e8e93;
    }

    .tab-content {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding: 0.875rem;
    }

    .tab-content.active {
      display: block;
    }

    .phrase-group {
      margin-bottom: 1rem;
    }

    .phrase-group-title {
      font-size: 0.7rem;
      color: #C9A961;
      font-weight: 700;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .phrase-item {
      font-size: 0.75rem;
      color: #e5e5e7;
      line-height: 1.5;
      padding: 0.5rem;
      margin-bottom: 0.25rem;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 0.5rem;
      border-left: 2px solid rgba(201, 169, 97, 0.3);
      transition: all 0.2s;
      position: relative;
    }

    .phrase-item.clickable {
      cursor: pointer;
    }

    .phrase-item.clickable:hover {
      background: rgba(201, 169, 97, 0.15);
      border-left-color: #C9A961;
      transform: translateX(4px);
    }

    .phrase-item.used {
      opacity: 0.5;
      background: rgba(0, 0, 0, 0.15);
      cursor: default !important;
    }

    .phrase-item.used::after {
      content: '‚úì';
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      color: #84cc16;
      font-weight: 700;
    }

    .phrase-item.used:hover {
      transform: none;
      background: rgba(0, 0, 0, 0.15);
    }

    .phrase-item.mastered {
      border-left-color: #84cc16;
    }

    .phrase-item.mastered::before {
      content: '‚òÖ';
      margin-right: 0.25rem;
      color: #84cc16;
    }

    /* IDEAS TAB */
    .question-display {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 0.75rem;
      padding: 0.875rem;
      border-left: 3px solid #C9A961;
      margin-bottom: 0.875rem;
    }

    .question-display h4 {
      font-size: 0.75rem;
      color: #C9A961;
      margin-bottom: 0.5rem;
      font-weight: 700;
    }

    .question-context {
      font-size: 0.65rem;
      color: #aeaeb2;
      line-height: 1.5;
      margin-bottom: 0.625rem;
      font-style: italic;
    }

    .question-main {
      font-size: 0.7rem;
      color: #e5e5e7;
      line-height: 1.6;
      margin-bottom: 0.75rem;
      font-weight: 600;
    }

    .key-points {
      margin-bottom: 0.75rem;
    }

    .key-points-title {
      font-size: 0.65rem;
      color: #8e8e93;
      margin-bottom: 0.375rem;
      font-weight: 600;
    }

    .point-item {
      font-size: 0.65rem;
      color: #e5e5e7;
      padding: 0.375rem 0.5rem;
      margin-bottom: 0.25rem;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 0.375rem;
      line-height: 1.4;
    }

    /* SAMPLES TAB */
    .sample-list-item {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 0.75rem;
      padding: 0.75rem;
      margin-bottom: 0.75rem;
      border-left: 3px solid rgba(201, 169, 97, 0.3);
      cursor: pointer;
      transition: all 0.3s;
    }

    .sample-list-item:hover {
      background: rgba(201, 169, 97, 0.1);
      border-left-color: #C9A961;
      transform: translateX(4px);
    }

    .sample-list-item.selected {
      background: rgba(201, 169, 97, 0.15);
      border-left-color: #C9A961;
    }

    .sample-list-item h4 {
      font-size: 0.75rem;
      color: #C9A961;
      margin-bottom: 0.375rem;
      font-weight: 700;
    }

    .sample-list-item p {
      font-size: 0.65rem;
      color: #aeaeb2;
      line-height: 1.4;
      margin-bottom: 0.25rem;
    }

    .sample-list-item .sample-preview {
      font-size: 0.65rem;
      color: #8e8e93;
      margin-top: 0.5rem;
      font-style: italic;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #636366;
    }

    .empty-state-icon {
      font-size: 2rem;
      margin-bottom: 0.75rem;
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 0.75rem;
      line-height: 1.5;
    }

    /* TIP BANNER */
    .tip-banner {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(251, 146, 60, 0.95);
      backdrop-filter: blur(20px);
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      font-size: 0.8rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      gap: 1rem;
      z-index: 1000;
      transition: transform 0.3s;
    }

    .tip-banner.show {
      display: flex;
      transform: translateX(-50%) translateY(0);
    }

    .tip-banner button {
      background: white;
      color: #fb923c;
      border: none;
      padding: 0.25rem 0.75rem;
      border-radius: 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
    }

    /* SCROLLBAR */
    .phrase-container::-webkit-scrollbar,
    .textarea::-webkit-scrollbar,
    .sample-display::-webkit-scrollbar {
      width: 4px;
    }

    .phrase-container::-webkit-scrollbar-thumb,
    .textarea::-webkit-scrollbar-thumb,
    .sample-display::-webkit-scrollbar-thumb {
      background: rgba(99, 99, 102, 0.3);
      border-radius: 4px;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .two-panel {
        grid-template-columns: 1fr;
        height: auto;
      }
      
      .write-panel {
        height: 50vh;
      }

      .ref-panel {
        height: 40vh;
      }

      .top-bar {
        gap: 0.5rem;
      }

      .question-select {
        flex-basis: 100%;
        max-width: 100%;
      }

      .stage-nav {
        gap: 0.5rem;
      }

      .stage-dot {
        width: 2rem;
        height: 2rem;
        font-size: 0.6rem;
      }
    }
  </style>
</head>
<body>
  <div class="background"></div>

  <div class="top-bar">
    <a href="../../../index.html?openModal=writing" class="nav-link">‚Üê Home</a>
    <div class="logo">INTUITY</div>
    <select id="questionSelect" class="question-select">
      <option value="">Select essay topic...</option>
    </select>
    <div id="expressionStatus" class="expression-status">
      <span>Expressions: <span class="expr-count">0/36</span></span>
     <a href="essay-expressions-interface.html" class="practice-link btn-compact" title="Practice expressions">Practice ‚Üí</a>
    </div>
    <div class="mode-toggle-container">
      <span class="mode-toggle-label">Read</span>
      <div class="mode-toggle-switch" id="modeToggle" onclick="switchMode()"></div>
      <span class="mode-toggle-label">Write</span>
    </div>
  </div>

  <div class="main-container">
    <div class="two-panel">
      
      <div class="write-panel">
        
        <div class="stage-nav">
          <div class="stage-dot current" onclick="jumpStage(0)" title="Introduction">
            <span>I</span>
          </div>
          <div class="stage-dot empty" onclick="jumpStage(1)" title="Claim 1">
            <span>C1</span>
          </div>
          <div class="stage-dot empty" onclick="jumpStage(2)" title="Claim 2">
            <span>C2</span>
          </div>
          <div class="stage-dot empty" onclick="jumpStage(3)" title="Claim 3">
            <span>C3</span>
          </div>
          <div class="stage-dot empty" onclick="jumpStage(4)" title="Conclusion">
            <span>C</span>
          </div>
        </div>

        <div class="view-toggle-container" id="viewToggleContainer">
          <span class="view-toggle-label">Paragraph</span>
          <div class="view-toggle-switch active" id="viewToggleSwitch" onclick="toggleSampleView()"></div>
          <span class="view-toggle-label">Full</span>
        </div>

        <div class="highlight-filters" id="highlightFilters">
          <button class="highlight-btn active" onclick="setHighlightFilter('all')">üé® All</button>
          <button class="highlight-btn" onclick="setHighlightFilter('discourse')">üîó Transitions</button>
          <button class="highlight-btn" onclick="setHighlightFilter('opinion')">üí≠ Opinions</button>
          <button class="highlight-btn" onclick="setHighlightFilter('causal')">‚û°Ô∏è Cause/Effect</button>
          <button class="highlight-btn" onclick="setHighlightFilter('examples')">üìå Examples</button>
        </div>

        <div class="quick-access-bar" id="quickAccessBar"></div>

        <div class="stage-header">
          <div class="stage-title" id="stageName">Introduction</div>
        </div>

        <div class="word-count-container" id="wordCountContainer">
          <div class="word-count-bar">
            <div class="word-count-fill" id="wordCountFill"></div>
          </div>
          <div class="word-count-text">
            <span class="count-current" id="currentWords">0</span>/<span id="targetWords">35</span> words
          </div>
        </div>

        <textarea 
          id="textarea" 
          class="textarea" 
          placeholder="Start writing..."
        ></textarea>

        <div id="sampleDisplay" class="sample-display">
          <p style="color: #8e8e93; text-align: center; padding: 2rem;">Select a question to begin</p>
        </div>

        <div class="footer-nav">
          <button class="btn" id="prevBtn" onclick="prevStage()" disabled>‚Üê Previous</button>
          <button class="btn primary" id="nextBtn" onclick="nextStage()">Next ‚Üí</button>
          
          <div class="action-btns">
            <button class="btn" onclick="saveEssay()" title="Save as JSON">üíæ</button>
            <button class="btn" onclick="exportEssay()" title="Export as TXT">üì•</button>
            <button class="btn" onclick="resetEssay()">üîÑ Reset</button>
          </div>
        </div>

      </div>

      <div class="ref-panel">
        <button class="panel-toggle-btn" onclick="togglePanel()" title="Show/Hide Reference Panel">
          <span id="panelToggleIcon">‚óÄ</span>
        </button>

        <div class="tab-nav">
          <button class="tab-btn active" onclick="switchTab('phrases')">Phrases</button>
          <button class="tab-btn" onclick="switchTab('ideas')">Ideas</button>
          <button class="tab-btn" onclick="switchTab('samples')">Samples</button>
        </div>

        <div class="tab-content active" id="phrasesTab">
          <div class="empty-state">
            <div class="empty-state-icon">üìù</div>
            <div class="empty-state-text">Loading phrases...</div>
          </div>
        </div>

        <div class="tab-content" id="ideasTab">
          <p style="color: #8e8e93; text-align: center; padding: 2rem;">Select a question to view ideas</p>
        </div>

        <div class="tab-content" id="samplesTab">
          <p style="color: #8e8e93; text-align: center; padding: 2rem;">Loading samples...</p>
        </div>
      </div>

    </div>
  </div>

  <div class="tip-banner" id="tipBanner">
    <span id="tipText"></span>
    <button onclick="dismissTip()">Got it</button>
  </div>

  <script>
    // GLOBAL STATE
    let currentMode = 'read';
    let currentStage = 0;
    let essayData = ['', '', '', '', ''];
    let sampleViewMode = 'full';
    let selectedQuestion = null;
    let selectedSample = null;
    let activeHighlightFilter = 'all';
    let activeWriteFilter = null;
    let usedPhrases = new Set();
    let masteredPhrases = [];
    let tipShownForStage = new Set();
    
    let bodyPhrasesData = {};
    let introHooksData = {};
    let thesisStatementsData = {};
    let supportingPhrasesData = {};
    let conclusionPhrasesData = {};
    let samplesData = {};
    let questionsData = {};
    let ideasData = {};

    const stageInfo = [
      { 
        name: 'INTRODUCTION', 
        target: 35,
        placeholder: 'Hook + Present topic + State your opinion\n\nüí° Tip: Click phrases to insert them',
        quickButtons: ['hooks', 'presenting_topic', 'stating_opinion']
      },
      { 
        name: 'CLAIM 1', 
        target: 45,
        placeholder: 'First main argument\n\nStructure: Topic sentence ‚Üí Explain ‚Üí Example ‚Üí Why it matters',
        quickButtons: ['topic_sentences', 'explaining', 'examples']
      },
      { 
        name: 'CLAIM 2', 
        target: 45,
        placeholder: 'Second main argument\n\nStructure: Topic sentence ‚Üí Explain ‚Üí Example ‚Üí Link to claim',
        quickButtons: ['topic_sentences', 'explaining', 'examples']
      },
      { 
        name: 'CLAIM 3', 
        target: 45,
        placeholder: 'Third argument or counter-argument\n\nStructure: Present opposing view OR add final supporting point',
        quickButtons: ['contrasting', 'topic_sentences', 'examples']
      },
      { 
        name: 'CONCLUSION', 
        target: 20,
        placeholder: 'Wrap up your essay\n\nSummarize 3 claims and restate final position',
        quickButtons: ['summarizing', 'restating', 'final_thought']
      }
    ];

    async function init() {
      console.log('üöÄ Initializing Essay Writer in READ mode...');
      
      try {
        await loadAllJSON();
        loadMasteredExpressions();
        populateQuestionDropdown();
        
        // Set first sample as default if available
        if (samplesData && samplesData.opinion && samplesData.opinion.length > 0) {
          selectedSample = samplesData.opinion[0];
          console.log('‚úì Default sample loaded:', selectedSample.title);
        }
        
        updateInterface();
        
        document.getElementById('textarea').addEventListener('input', handleInput);
        
        // Load draft if exists
        loadDraft();
        
        console.log('‚úÖ Initialization complete!');
      } catch (error) {
        console.error('‚ùå Initialization error:', error);
      }
    }

    async function loadAllJSON() {
      console.log('üì¶ Loading JSON files...');
      
      try {
        const [body, introHooks, thesis, supporting, conclusion, samples, questions, ideas] = await Promise.all([
          fetch('data/body-phrases.json').then(r => r.json()),
          fetch('data/introduction-hooks.json').then(r => r.json()),
          fetch('data/thesis-statements.json').then(r => r.json()),
          fetch('data/supporting-phrases-b2.json').then(r => r.json()),
          fetch('data/conclusion-phrases.json').then(r => r.json()),
          fetch('data/samples.json').then(r => r.json()),
          fetch('data/essay-questions.json').then(r => r.json()),
          fetch('data/ideas.json').then(r => r.json())
        ]);
        
        bodyPhrasesData = body;
        introHooksData = introHooks;
        thesisStatementsData = thesis;
        supportingPhrasesData = supporting;
        conclusionPhrasesData = conclusion;
        samplesData = samples;
        questionsData = questions;
        ideasData = ideas;
        
        console.log('‚úÖ All JSON files loaded');
        
      } catch (error) {
        console.error('‚ùå Error loading JSON:', error);
      }
    }

    function loadMasteredExpressions() {
      try {
        const scores = localStorage.getItem('essay_progress_useful expressions_scores') || 
                       localStorage.getItem('essay_expressions_scores');
        
        if (scores) {
          const parsed = JSON.parse(scores);
          const masteredCount = Object.keys(parsed).length * 8;
          updateExpressionStatus(masteredCount);
        }
      } catch (e) {
        console.error('Error loading mastered expressions:', e);
      }
    }

    function updateExpressionStatus(count) {
      const badge = document.getElementById('expressionStatus');
      const countSpan = badge.querySelector('.expr-count');
      countSpan.textContent = `${count}/36`;
      
      badge.classList.remove('low', 'good');
      if (count < 12) {
        badge.classList.add('low');
      } else if (count >= 24) {
        badge.classList.add('good');
      }
    }

    function populateQuestionDropdown() {
      const dropdown = document.getElementById('questionSelect');
      dropdown.innerHTML = '<option value="">Select essay topic...</option>';
      
      if (questionsData.questions && questionsData.questions.length > 0) {
        questionsData.questions.forEach((q) => {
          const option = document.createElement('option');
          option.value = q.id;
          option.textContent = q.topic;
          dropdown.appendChild(option);
        });
        
        dropdown.addEventListener('change', (e) => {
          selectedQuestion = questionsData.questions.find(q => q.id === e.target.value);
          console.log('Selected question:', selectedQuestion?.topic);
          
          // Auto-match sample to question
          if (selectedQuestion) {
            autoMatchSample(selectedQuestion);
          }
          
          updateInterface();
        });
      }
    }

    function autoMatchSample(question) {
      if (!samplesData || !samplesData.opinion) return;
      
      // Try to find matching sample by:
      // 1. Exact ID match
      // 2. Topic similarity
      // 3. Question text similarity
      
      let matchedSample = null;
      
      // Try ID match first
      matchedSample = samplesData.opinion.find(sample => 
        sample.id === question.id || 
        sample.essayId === question.id
      );
      
      // Try topic match
      if (!matchedSample) {
        matchedSample = samplesData.opinion.find(sample => 
          sample.topic && question.topic &&
          sample.topic.toLowerCase().includes(question.topic.toLowerCase().substring(0, 15))
        );
      }
      
      // Try question text match
      if (!matchedSample) {
        matchedSample = samplesData.opinion.find(sample => 
          sample.question && question.mainQuestion &&
          sample.question.toLowerCase().includes(question.mainQuestion.toLowerCase().substring(0, 20))
        );
      }
      
      if (matchedSample) {
        selectedSample = matchedSample;
        console.log('‚úì Auto-matched sample:', matchedSample.title);
        updateSampleDisplay();
        renderSamplesTab(); // Update samples tab to show selected
      }
    }

    function switchMode() {
      currentMode = currentMode === 'read' ? 'write' : 'read';
      console.log(`üîÑ Switching to ${currentMode.toUpperCase()} mode`);
      
      const modeSwitch = document.getElementById('modeToggle');
      modeSwitch.classList.toggle('active', currentMode === 'write');
      
      updateInterface();
    }

    function updateInterface() {
      const info = stageInfo[currentStage];
      
      // Update stage title
      document.getElementById('stageName').textContent = info.name;
      document.getElementById('targetWords').textContent = info.target;
      document.getElementById('textarea').value = essayData[currentStage];
      document.getElementById('textarea').placeholder = info.placeholder;
      
      // Update stage dots
      document.querySelectorAll('.stage-dot').forEach((dot, i) => {
        dot.classList.remove('current', 'empty', 'good', 'needs-work');
        
        if (i === currentStage) {
          dot.classList.add('current');
        } else {
          const quality = evaluateStageQuality(i);
          dot.classList.add(quality);
        }
      });
      
      // Update nav buttons
      document.getElementById('prevBtn').disabled = currentStage === 0;
      document.getElementById('nextBtn').disabled = currentStage === 4;
      
      // Mode-specific rendering
      if (currentMode === 'write') {
        renderWriteMode();
      } else {
        renderReadMode();
      }
    }

    function togglePanel() {
      const twoPanel = document.querySelector('.two-panel');
      const icon = document.getElementById('panelToggleIcon');
      
      twoPanel.classList.toggle('panel-collapsed');
      icon.textContent = twoPanel.classList.contains('panel-collapsed') ? '‚ñ∂' : '‚óÄ';
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      event.target.classList.add('active');
      document.getElementById(tabName + 'Tab').classList.add('active');
      
      // Render tab content when switched
      if (tabName === 'ideas') {
        renderIdeasTab();
      } else if (tabName === 'samples') {
        renderSamplesTab();
      }
    }

    function renderReadMode() {
      // Show/hide elements
      document.getElementById('textarea').style.display = 'none';
      document.getElementById('sampleDisplay').style.display = 'block';
      document.getElementById('viewToggleContainer').style.display = 'flex';
      document.getElementById('highlightFilters').style.display = 'flex';
      document.getElementById('quickAccessBar').style.display = 'none';
      document.getElementById('wordCountContainer').style.display = 'none';
      
      // Update header
      document.getElementById('refHeader').textContent = 'Reference phrases';
      
      // Render sample
      updateSampleDisplay();
      
      // Render phrases (non-clickable)
      renderPhrasesForReadMode();
    }

    function renderWriteMode() {
      // Show/hide elements
      document.getElementById('textarea').style.display = 'block';
      document.getElementById('sampleDisplay').style.display = 'none';
      document.getElementById('viewToggleContainer').style.display = 'none';
      document.getElementById('highlightFilters').style.display = 'none';
      document.getElementById('quickAccessBar').style.display = 'flex';
      document.getElementById('wordCountContainer').style.display = 'flex';
      
      // Update header
      document.getElementById('refHeader').textContent = 'Click phrases to insert ‚Üí';
      
      // Render quick access buttons
      renderQuickAccessButtons();
      
      // Render phrases
      if (activeWriteFilter) {
        renderFilteredPhrasesForWrite(activeWriteFilter);
      } else {
        showEmptyPhrasesState();
      }
      
      // Update word count
      updateWordCount();
      
      // Check for tips
      setTimeout(() => checkParagraphQuality(), 1000);
    }

    function updateSampleDisplay() {
      const display = document.getElementById('sampleDisplay');
      
      if (!selectedSample || !selectedSample.answer) {
        if (selectedQuestion) {
          display.innerHTML = `
            <h3>Selected Question</h3>
            <p><strong>Topic:</strong> ${selectedQuestion.topic}</p>
            <p><strong>Type:</strong> ${selectedQuestion.essayType}</p>
            <p style="color: #aeaeb2; font-style: italic;">${selectedQuestion.mainQuestion}</p>
            <p style="margin-top: 1rem; color: #8e8e93; font-size: 0.75rem;">üí° No sample essay available. Write your own!</p>
          `;
        } else {
          display.innerHTML = '<p style="color: #8e8e93; text-align: center; padding: 2rem;">Select a question to begin</p>';
        }
        return;
      }
      
      // Parse HTML from sample
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = selectedSample.answer;
      const paragraphs = Array.from(tempDiv.querySelectorAll('p')).map(p => p.innerHTML);
      
      if (sampleViewMode === 'full') {
        display.innerHTML = `
          <h3>${selectedSample.title || 'Sample Essay'}</h3>
          ${paragraphs.map(p => `<p>${p}</p>`).join('')}
        `;
      } else {
        const paragraph = paragraphs[currentStage];
        if (paragraph) {
          display.innerHTML = `
            <h3>${stageInfo[currentStage].name}</h3>
            <p>${paragraph}</p>
          `;
        } else {
          display.innerHTML = '<p style="color: #8e8e93; text-align: center; padding: 2rem;">No sample for this stage</p>';
        }
      }
      
      // Apply highlight filter
      applyHighlightFilter(activeHighlightFilter);
    }

    function toggleSampleView() {
      sampleViewMode = sampleViewMode === 'paragraph' ? 'full' : 'paragraph';
      
      const viewSwitch = document.getElementById('viewToggleSwitch');
      viewSwitch.classList.toggle('active', sampleViewMode === 'full');
      
      updateSampleDisplay();
    }

    function setHighlightFilter(filterId) {
      activeHighlightFilter = filterId;
      
      // Update button states
      document.querySelectorAll('.highlight-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      applyHighlightFilter(filterId);
    }

    function applyHighlightFilter(filterId) {
      const display = document.getElementById('sampleDisplay');
      
      // Reset all highlights
      display.querySelectorAll('.discourse, .opinion, .causal, .example').forEach(el => {
        el.style.background = 'transparent';
        el.style.borderBottom = 'none';
      });
      
      // Apply selected filter
      const filterMap = {
        'all': ['.discourse', '.opinion', '.causal', '.example'],
        'discourse': ['.discourse'],
        'opinion': ['.opinion'],
        'causal': ['.causal'],
        'examples': ['.example']
      };
      
      const classes = filterMap[filterId] || filterMap['all'];
      
      classes.forEach(className => {
        display.querySelectorAll(className).forEach(el => {
          // Restore original styling
          const colors = {
            '.discourse': 'rgba(52, 199, 89, 0.3)',
            '.opinion': 'rgba(255, 149, 0, 0.3)',
            '.causal': 'rgba(90, 200, 250, 0.3)',
            '.example': 'rgba(201, 169, 97, 0.3)'
          };
          const borderColors = {
            '.discourse': 'rgba(52, 199, 89, 0.8)',
            '.opinion': 'rgba(255, 149, 0, 0.8)',
            '.causal': 'rgba(90, 200, 250, 0.8)',
            '.example': 'rgba(201, 169, 97, 0.8)'
          };
          el.style.background = colors[className];
          el.style.borderBottom = `2px solid ${borderColors[className]}`;
        });
      });
    }

    function renderPhrasesForReadMode() {
      const container = document.getElementById('phrasesTab');
      container.innerHTML = '';
      
      const stageFilters = [
        ['hooks', 'presenting_topic', 'stating_opinion'],
        ['topic_sentences', 'explaining', 'examples'],
        ['topic_sentences', 'explaining', 'examples'],
        ['contrasting', 'topic_sentences', 'examples'],
        ['summarizing', 'restating', 'final_thought']
      ];
      
      const filters = stageFilters[currentStage];
      
      filters.forEach(filter => {
        renderPhrasesByFilter(filter, container, false);
      });
    }

    function renderQuickAccessButtons() {
      const bar = document.getElementById('quickAccessBar');
      const buttons = stageInfo[currentStage].quickButtons;
      
      bar.innerHTML = buttons.map(filter => `
        <button 
          class="quick-btn ${activeWriteFilter === filter ? 'active' : ''}" 
          onclick="setWriteFilter('${filter}')">
          ${filter.replace(/_/g, ' ')}
        </button>
      `).join('');
    }

    function setWriteFilter(filter) {
      activeWriteFilter = filter;
      renderQuickAccessButtons();
      renderFilteredPhrasesForWrite(filter);
    }

    function renderFilteredPhrasesForWrite(filter) {
      const container = document.getElementById('phrasesTab');
      container.innerHTML = '';
      renderPhrasesByFilter(filter, container, true);
    }

    function showEmptyPhrasesState() {
      const container = document.getElementById('phrasesTab');
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üëÜ</div>
          <div class="empty-state-text">Click a button above to see phrases</div>
        </div>
      `;
    }

    function renderIdeasTab() {
      const tab = document.getElementById('ideasTab');
      
      if (!selectedQuestion) {
        tab.innerHTML = '<p style="color: #8e8e93; text-align: center; padding: 2rem;">Select a question from the dropdown</p>';
        return;
      }

      let html = `
        <div class="question-display">
          <h4>üìù Essay Task</h4>
          <div class="question-context">${selectedQuestion.context}</div>
          <div class="question-main">${selectedQuestion.mainQuestion}</div>
          
          <div class="key-points">
            <div class="key-points-title">Write about:</div>`;
      
      selectedQuestion.writingPoints.forEach((point, i) => {
        html += `<div class="point-item">${i + 1}. ${point}</div>`;
      });

      if (selectedQuestion.suggestedOwnIdeas && selectedQuestion.suggestedOwnIdeas.length > 0) {
        html += `
          </div>
          <div class="key-points">
            <div class="key-points-title">Suggested ideas for your own point:</div>`;
        
        selectedQuestion.suggestedOwnIdeas.forEach((idea) => {
          html += `<div class="point-item">‚Ä¢ ${idea}</div>`;
        });
      }

      html += `
          </div>
        </div>
      `;
      
      tab.innerHTML = html;
    }

    function renderSamplesTab() {
      const tab = document.getElementById('samplesTab');
      
      if (!samplesData || !samplesData.opinion || samplesData.opinion.length === 0) {
        tab.innerHTML = '<p style="color: #8e8e93; text-align: center; padding: 2rem;">No sample essays available</p>';
        return;
      }

      let html = '';
      
      samplesData.opinion.forEach((essay, index) => {
        const isSelected = selectedSample === essay;
        
        // Parse HTML to extract first paragraph preview
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = essay.answer;
        const firstPara = tempDiv.querySelector('p');
        const preview = firstPara ? firstPara.textContent.substring(0, 100) + '...' : '';
        
        html += `
          <div class="sample-list-item ${isSelected ? 'selected' : ''}" onclick="selectSample(${index})">
            <h4>${isSelected ? '‚úì ' : ''}${essay.title || `Essay ${index + 1}`}</h4>
            <p><strong>Topic:</strong> ${essay.topic}</p>
            <p><strong>Question:</strong> ${essay.question}</p>
            <div class="sample-preview">${preview}</div>
          </div>
        `;
      });
      
      tab.innerHTML = html;
    }

    function selectSample(index) {
      if (samplesData && samplesData.opinion && samplesData.opinion[index]) {
        selectedSample = samplesData.opinion[index];
        updateSampleDisplay();
        renderSamplesTab();
        console.log('‚úì Selected sample:', selectedSample.title);
      }
    }

    function renderPhrasesByFilter(filter, container, clickable) {
      // Introduction filters
      if (filter === 'hooks') {
        if (introHooksData.question_hooks) {
          createPhraseGroup('‚ùì Question Hooks', introHooksData.question_hooks, container, clickable);
        }
        if (introHooksData.statement_hooks) {
          createPhraseGroup('üí¨ Statement Hooks', introHooksData.statement_hooks, container, clickable);
        }
      }
      
      if (filter === 'presenting_topic') {
        if (supportingPhrasesData.presenting_topic) {
          createPhraseGroup('üìå Presenting Topic', supportingPhrasesData.presenting_topic, container, clickable);
        }
      }
      
      if (filter === 'stating_opinion') {
        if (thesisStatementsData.strong_opinion) {
          createPhraseGroup('üí™ Strong Opinion', thesisStatementsData.strong_opinion, container, clickable);
        }
        if (thesisStatementsData.balanced_opinion) {
          createPhraseGroup('‚öñÔ∏è Balanced Opinion', thesisStatementsData.balanced_opinion, container, clickable);
        }
      }
      
      // Body paragraph filters
      if (filter === 'topic_sentences') {
        if (supportingPhrasesData.topic_sentences) {
          createPhraseGroup('üéØ Topic Sentences', supportingPhrasesData.topic_sentences, container, clickable);
        }
      }
      
      if (filter === 'explaining') {
        if (supportingPhrasesData.explaining) {
          createPhraseGroup('üí° Explaining', supportingPhrasesData.explaining, container, clickable);
        }
        if (supportingPhrasesData.reasons) {
          createPhraseGroup('üîç Giving Reasons', supportingPhrasesData.reasons, container, clickable);
        }
      }
      
      if (filter === 'examples') {
        if (supportingPhrasesData.examples) {
          createPhraseGroup('üìå Examples', supportingPhrasesData.examples, container, clickable);
        }
      }
      
      if (filter === 'contrasting') {
        if (supportingPhrasesData.however_phrases) {
          createPhraseGroup('‚öñÔ∏è Contrasting', supportingPhrasesData.however_phrases, container, clickable);
        }
      }
      
      // Conclusion filters
      if (filter === 'summarizing') {
        if (conclusionPhrasesData.opening_conclusion) {
          createPhraseGroup('üîö Conclusion Starters', conclusionPhrasesData.opening_conclusion, container, clickable);
        }
        if (conclusionPhrasesData.summarizing) {
          createPhraseGroup('üìù Summarizing', conclusionPhrasesData.summarizing, container, clickable);
        }
      }
      
      if (filter === 'restating') {
        if (conclusionPhrasesData.restating_position && conclusionPhrasesData.restating_position.strong_agreement) {
          createPhraseGroup('üîÑ Restating Opinion', conclusionPhrasesData.restating_position.strong_agreement, container, clickable);
        }
      }
      
      if (filter === 'final_thought') {
        if (conclusionPhrasesData.final_thought && conclusionPhrasesData.final_thought.call_to_action) {
          createPhraseGroup('üí≠ Final Thoughts', conclusionPhrasesData.final_thought.call_to_action, container, clickable);
        }
      }
    }

    function createPhraseGroup(title, phrases, container, clickable) {
      if (!phrases || phrases.length === 0) return;

      const group = document.createElement('div');
      group.className = 'phrase-group';
      
      const titleEl = document.createElement('div');
      titleEl.className = 'phrase-group-title';
      titleEl.textContent = title;
      
      group.appendChild(titleEl);
      
      phrases.slice(0, 8).forEach(phrase => {
        const item = document.createElement('div');
        item.className = 'phrase-item';
        
        if (clickable) {
          item.classList.add('clickable');
        }
        
        // Check if used
        if (usedPhrases.has(phrase)) {
          item.classList.add('used');
        }
        
        // Check if mastered
        if (masteredPhrases.includes(phrase)) {
          item.classList.add('mastered');
        }
        
        item.textContent = phrase;
        
        // Add click handler if in write mode
        if (clickable) {
          item.onclick = () => insertPhrase(phrase, item);
        }
        
        group.appendChild(item);
      });
      
      container.appendChild(group);
    }

    function insertPhrase(phrase, element) {
      if (element.classList.contains('used')) return;
      
      const textarea = document.getElementById('textarea');
      const pos = textarea.selectionStart;
      const current = textarea.value;
      
      // Smart spacing
      const before = current[pos - 1];
      const spacePrefix = (before && before !== ' ' && before !== '\n') ? ' ' : '';
      const spaceSuffix = phrase.endsWith(',') ? ' ' : ', ';
      
      const textToInsert = spacePrefix + phrase + spaceSuffix;
      
      textarea.value = current.slice(0, pos) + textToInsert + current.slice(pos);
      textarea.focus();
      textarea.selectionStart = textarea.selectionEnd = pos + textToInsert.length;
      
      // Mark as used
      element.classList.add('used');
      usedPhrases.add(phrase);
      
      // Update essay data
      essayData[currentStage] = textarea.value;
      handleInput();
      
      // Visual feedback
      textarea.style.background = 'rgba(201, 169, 97, 0.1)';
      setTimeout(() => {
        textarea.style.background = 'rgba(0, 0, 0, 0.3)';
      }, 300);
    }

    function evaluateStageQuality(stageIndex) {
      const text = essayData[stageIndex].trim();
      if (!text) return 'empty';
      
      const wordCount = text.split(/\s+/).length;
      const target = stageInfo[stageIndex].target;
      const ratio = wordCount / target;
      
      if (ratio >= 0.8 && ratio <= 1.2) {
        return 'good';
      } else if (wordCount > 0) {
        return 'needs-work';
      }
      return 'empty';
    }

    function handleInput() {
      essayData[currentStage] = document.getElementById('textarea').value;
      updateWordCount();
      updateStageDot(currentStage);
      
      clearTimeout(window.autoSaveTimer);
      window.autoSaveTimer = setTimeout(saveDraft, 5000);
    }

    function updateWordCount() {
      const text = document.getElementById('textarea').value;
      const words = text.trim() ? text.trim().split(/\s+/).length : 0;
      const target = stageInfo[currentStage].target;
      const ratio = words / target;
      
      document.getElementById('currentWords').textContent = words;
      
      // Update progress bar
      const fill = document.getElementById('wordCountFill');
      const percentage = Math.min((words / target) * 100, 100);
      fill.style.width = percentage + '%';
      
      // Color coding
      fill.classList.remove('amber', 'red');
      if (ratio >= 0.8 && ratio <= 1.2) {
        // Green - good
      } else if (ratio >= 0.6 && ratio <= 1.4) {
        fill.classList.add('amber');
      } else if (words > 0) {
        fill.classList.add('red');
      }
    }

    function updateStageDot(stageIndex) {
      const dots = document.querySelectorAll('.stage-dot');
      const quality = evaluateStageQuality(stageIndex);
      
      dots[stageIndex].classList.remove('empty', 'good', 'needs-work');
      if (!dots[stageIndex].classList.contains('current')) {
        dots[stageIndex].classList.add(quality);
      }
    }

    function checkParagraphQuality() {
      if (currentMode !== 'write') return;
      
      const text = essayData[currentStage].toLowerCase();
      const wordCount = text.split(/\s+/).length;
      
      if (wordCount < 30) return;
      if (tipShownForStage.has(currentStage)) return;
      
      let tipMessage = '';
      
      if (currentStage === 0) {
        const hasOpinion = /\b(believe|think|opinion|view|agree|disagree|feel|consider)\b/.test(text);
        if (!hasOpinion && wordCount > 30) {
          tipMessage = 'üí° Don\'t forget to state your opinion clearly';
        }
      } else if (currentStage === 1 || currentStage === 2 || currentStage === 3) {
        const hasExample = /\b(example|instance|such as|like|for example|for instance)\b/.test(text);
        if (!hasExample && wordCount > 40) {
          tipMessage = 'üí° Consider adding a specific example or evidence';
        }
      } else if (currentStage === 4) {
        const hasSummary = /\b(conclusion|summary|overall|in short|to sum up|all things considered)\b/.test(text);
        if (!hasSummary && wordCount > 15) {
          tipMessage = 'üí° Start with a conclusion phrase';
        }
      }
      
      if (tipMessage) {
        showTip(tipMessage);
        tipShownForStage.add(currentStage);
      }
    }

    function showTip(message) {
      const banner = document.getElementById('tipBanner');
      const textEl = document.getElementById('tipText');
      
      textEl.textContent = message;
      banner.classList.add('show');
      
      setTimeout(() => {
        dismissTip();
      }, 8000);
    }

    function dismissTip() {
      document.getElementById('tipBanner').classList.remove('show');
    }

    function nextStage() {
      if (currentStage < 4) {
        essayData[currentStage] = document.getElementById('textarea').value;
        currentStage++;
        usedPhrases.clear();
        activeWriteFilter = null;
        updateInterface();
      }
    }

    function prevStage() {
      if (currentStage > 0) {
        essayData[currentStage] = document.getElementById('textarea').value;
        currentStage--;
        usedPhrases.clear();
        activeWriteFilter = null;
        updateInterface();
      }
    }

    function jumpStage(stage) {
      if (currentMode === 'write') {
        essayData[currentStage] = document.getElementById('textarea').value;
      }
      currentStage = stage;
      usedPhrases.clear();
      activeWriteFilter = null;
      updateInterface();
    }

    function saveDraft() {
      try {
        const draft = {
          questionId: selectedQuestion?.id || null,
          stages: essayData,
          timestamp: new Date().toISOString(),
          currentStage: currentStage
        };
        localStorage.setItem('essay_current_draft', JSON.stringify(draft));
        console.log('‚úÖ Draft auto-saved');
      } catch (e) {
        console.error('Error saving draft:', e);
      }
    }

    function loadDraft() {
      try {
        const draft = localStorage.getItem('essay_current_draft');
        if (draft) {
          const parsed = JSON.parse(draft);
          essayData = parsed.stages || ['', '', '', '', ''];
          currentStage = parsed.currentStage || 0;
          
          if (parsed.questionId) {
            document.getElementById('questionSelect').value = parsed.questionId;
            selectedQuestion = questionsData.questions?.find(q => q.id === parsed.questionId);
          }
          
          console.log('‚úÖ Draft loaded');
        }
      } catch (e) {
        console.error('Error loading draft:', e);
      }
    }

    function saveEssay() {
      essayData[currentStage] = document.getElementById('textarea').value;
      const data = {
        type: 'essay',
        question: selectedQuestion?.topic || 'Untitled',
        questionId: selectedQuestion?.id || null,
        timestamp: new Date().toISOString(),
        stages: essayData,
        wordCounts: essayData.map(s => s.trim().split(/\s+/).length)
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `essay-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportEssay() {
      essayData[currentStage] = document.getElementById('textarea').value;
      const fullEssay = essayData.filter(s => s.trim()).join('\n\n');
      const blob = new Blob([fullEssay], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `essay-${Date.now()}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function resetEssay() {
      if (confirm('Reset all content? This will clear your current essay.')) {
        essayData = ['', '', '', '', ''];
        currentStage = 0;
        usedPhrases.clear();
        tipShownForStage.clear();
        activeWriteFilter = null;
        localStorage.removeItem('essay_current_draft');
        updateInterface();
      }
    }
    
    init();
  </script>
</body>
</html>
