<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>INTUITY - Paragraph Builder</title>
  <script src="https://cdn.tailwin<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>INTUITY - Paragraph Builder</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'DM Sans', 'Inter', sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0a0a0a 100%);
      color: #e5e5e7;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      padding-top: 2rem;
      overflow-x: hidden;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background:
        radial-gradient(circle at 30% 20%, rgba(201, 169, 97, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 70% 80%, rgba(201, 169, 97, 0.08) 0%, transparent 45%);
      pointer-events: none;
      z-index: 0;
    }

    .main-container {
      position: relative;
      z-index: 1;
      max-width: 1000px;
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    /* HEADER */
    .header {
      text-align: center;
      margin-bottom: 1rem;
    }

    .brand-logo {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.75rem;
      font-weight: 700;
      background: linear-gradient(135deg, #C9A961 0%, rgba(201, 169, 97, 0.8) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-transform: uppercase;
      letter-spacing: -0.04em;
      margin-bottom: 0.25rem;
    }

    .brand-subtitle {
      font-size: 0.75rem;
      color: #8e8e93;
      font-weight: 500;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      margin-bottom: 0.25rem;
    }

    .brand-author {
      font-size: 0.625rem;
      color: #636366;
      font-weight: 400;
      letter-spacing: 0.02em;
    }

    /* BACK BUTTON */
    .back-btn {
      position: absolute;
      top: 1.25rem;
      left: 1rem;
      padding: 0.5rem 1rem;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 0.75rem;
      color: #C9A961;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      z-index: 100;
    }

    .back-btn:hover {
      background: rgba(0, 0, 0, 0.6);
      border-color: rgba(201, 169, 97, 0.3);
      transform: translateX(-2px);
    }

    /* CENTRAL CARD */
    .central-card {
      background: rgba(28, 28, 30, 0.6);
      backdrop-filter: blur(40px) saturate(150%);
      -webkit-backdrop-filter: blur(40px) saturate(150%);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 1.5rem;
      padding: 1.25rem;
      box-shadow:
        0 30px 80px rgba(0, 0, 0, 0.8),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      position: relative;
      display: flex;
      flex-direction: column;
      margin-bottom: 1rem;
    }

    /* TOP BAR */
    .top-bar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      margin-bottom: 0.75rem;
    }

    /* SEGMENTED CONTROL */
    .segmented-toggle {
      display: inline-flex;
      align-items: center;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 999px;
      padding: 0.25rem;
      height: 38px;
      position: relative;
    }

    .segmented-bg {
      position: absolute;
      height: calc(100% - 6px);
      top: 3px;
      left: 3px;
      width: calc((100% - 6px) / 2);
      border-radius: 999px;
      background: linear-gradient(135deg, #C9A961 0%, #d4b46e 100%);
      box-shadow: 0 2px 8px rgba(201, 169, 97, 0.3);
      transition: transform 0.25s ease;
      z-index: 0;
    }

    .segmented-btn {
      position: relative;
      border: none;
      background: transparent;
      padding: 0 1rem;
      height: 100%;
      font-size: 0.72rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e5e5ea;
      border-radius: 999px;
      cursor: pointer;
      z-index: 2;
      transition: color 0.25s;
    }

    .segmented-btn.active { color: #111; }

    /* X-RAY TOGGLE */
    .xray-btn {
      font-size: 0.625rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0.5rem 1rem;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 999px;
      color: #C9A961;
      cursor: pointer;
      transition: all 0.3s;
    }

    .xray-btn:hover {
      background: rgba(0, 0, 0, 0.5);
      border-color: rgba(201, 169, 97, 0.3);
    }

    /* CONTENT AREA */
    .content-area {
      flex: 1;
      padding: 1rem;
      border-radius: 1rem;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(20px) saturate(120%);
      -webkit-backdrop-filter: blur(20px) saturate(120%);
      border: 1px solid rgba(255, 255, 255, 0.06);
      margin-bottom: 0.75rem;
      min-height: 400px;
    }

    /* READ MODE - NAVIGATION DOTS */
    .nav-dots {
      display: flex;
      justify-content: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .nav-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .nav-dot.active {
      background: #C9A961;
      box-shadow: 0 0 12px rgba(201, 169, 97, 0.5);
      transform: scale(1.2);
    }

    .nav-dot:hover:not(.active) {
      background: rgba(201, 169, 97, 0.4);
      transform: scale(1.1);
    }

    /* PARAGRAPH STYLING */
    .base-sentence {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.75rem;
      font-weight: 900;
      line-height: 1.2;
      color: #fef3c7;
      letter-spacing: -0.02em;
      margin-bottom: 1.5rem;
      text-transform: none;
      text-shadow: 0 2px 20px rgba(254, 243, 199, 0.4);
      padding: 1rem 0;
      border-bottom: 3px solid rgba(201, 169, 97, 0.4);
      display: block;
    }

    .linking-word {
      color: #34d399;
      font-weight: 700;
    }

    .opener-text {
      color: #34d399;
      font-weight: 700;
    }

    .paragraph-text {
      font-size: 1rem;
      line-height: 1.75;
      color: #e5e7eb;
    }

    /* First sentence in READ mode - Poster style */
    .paragraph-text .first-sentence {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.75rem;
      font-weight: 900;
      line-height: 1.2;
      color: #fef3c7;
      letter-spacing: -0.02em;
      display: block;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 3px solid rgba(201, 169, 97, 0.4);
      text-shadow: 0 2px 20px rgba(254, 243, 199, 0.4);
    }

    /* X-RAY MODE */
    .xray-part {
      padding: 1.25rem;
      border-radius: 0.75rem;
      border-left: 4px solid;
      margin-bottom: 1rem;
    }

    .xray-label {
      font-size: 0.625rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      opacity: 0.7;
      margin-bottom: 0.5rem;
    }

    .xray-text {
      font-size: 0.9375rem;
      line-height: 1.6;
      color: #e5e7eb;
    }

    .xray-opener { background: rgba(52, 211, 153, 0.1); border-color: #34d399; }
    .xray-topic { background: rgba(254, 243, 199, 0.15); border-color: #fef3c7; }
    .xray-explain { background: rgba(167, 139, 250, 0.1); border-color: #a78bfa; }
    .xray-reason { background: rgba(96, 165, 250, 0.1); border-color: #60a5fa; }
    .xray-example { background: rgba(52, 211, 153, 0.1); border-color: #34d399; }
    .xray-result { background: rgba(251, 146, 60, 0.1); border-color: #fb923c; }

    /* COMPACT FOOTER BUTTONS */
    .footer-buttons {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 0.375rem;
    }

    .footer-btn {
      padding: 0.5rem 0.875rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      color: #C9A961;
      font-size: 0.625rem;
      text-transform: uppercase;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      letter-spacing: 0.05em;
      white-space: nowrap;
    }

    .footer-btn:hover:not(.disabled) {
      background: rgba(201, 169, 97, 0.15);
      border-color: rgba(201, 169, 97, 0.3);
      transform: translateY(-1px);
    }

    .footer-btn.primary {
      background: linear-gradient(135deg, #C9A961 0%, #d4b46e 100%);
      color: #000;
      border-color: #C9A961;
      box-shadow: 0 2px 8px rgba(201, 169, 97, 0.3);
    }

    .footer-btn.primary:hover {
      background: linear-gradient(135deg, #d4b46e 0%, #e0c078 100%);
      box-shadow: 0 4px 12px rgba(201, 169, 97, 0.4);
    }

    .footer-btn.disabled {
      opacity: 0.3;
      cursor: not-allowed;
      background: rgba(0, 0, 0, 0.2);
    }

    /* OPENER DROPDOWN */
    .opener-menu {
      position: absolute;
      bottom: 110%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(20, 20, 22, 0.95);
      backdrop-filter: blur(40px) saturate(150%);
      -webkit-backdrop-filter: blur(40px) saturate(150%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.75rem;
      padding: 0.5rem;
      min-width: 260px;
      max-height: 260px;
      overflow-y: auto;
      display: none;
      z-index: 1000;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.9);
    }

    .opener-menu.show { display: block; }

    .opener-option {
      width: 100%;
      text-align: left;
      background: transparent;
      border: none;
      padding: 0.5rem;
      font-size: 0.8125rem;
      color: #e5e7eb;
      cursor: pointer;
      border-radius: 0.5rem;
      transition: background 0.2s;
    }

    .opener-option:hover {
      background: rgba(201, 169, 97, 0.15);
    }

    /* MODAL */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      z-index: 9999;
    }

    .modal-overlay.show { display: flex; }

    .modal-content {
      position: relative;
      background: rgba(20, 20, 22, 0.95);
      backdrop-filter: blur(40px) saturate(150%);
      -webkit-backdrop-filter: blur(40px) saturate(150%);
      border-radius: 1.5rem;
      padding: 2rem;
      max-width: 700px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow:
        0 25px 50px rgba(0, 0, 0, 0.9),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }

    .modal-title {
      font-family: 'Space Grotesk', serif;
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: #C9A961;
      text-transform: uppercase;
      text-align: center;
    }

    .modal-option {
      display: flex;
      align-items: start;
      gap: 1rem;
      margin-bottom: 1rem;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 0.75rem;
      transition: all 0.3s;
    }

    .modal-option:hover {
      background: rgba(0, 0, 0, 0.5);
      border-color: rgba(255, 255, 255, 0.08);
    }

    .option-number {
      font-weight: 700;
      color: #C9A961;
      min-width: 2rem;
    }

    .option-text {
      flex: 1;
      color: #e5e7eb;
      line-height: 1.6;
    }

    .use-btn {
      padding: 0.5rem 1rem;
      border-radius: 999px;
      background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
      color: #000;
      border: none;
      font-size: 0.75rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      white-space: nowrap;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .use-btn:hover {
      background: linear-gradient(135deg, #34d399 0%, #6ee7b7 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      color: #8e8e93;
      font-size: 1.25rem;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      background: rgba(0, 0, 0, 0.6);
      color: #e5e5e7;
      border-color: rgba(255, 255, 255, 0.15);
    }

    /* MOBILE */
    @media (max-width: 768px) {
      body { 
        padding: 0.75rem; 
        padding-top: 3rem;
        align-items: flex-start;
      }
      
      .back-btn {
        top: 0.5rem;
        left: 0.5rem;
        padding: 0.4rem 0.75rem;
        font-size: 0.625rem;
      }

      .brand-logo { font-size: 1.25rem; }
      .brand-subtitle { font-size: 0.625rem; }
      .brand-author { font-size: 0.5625rem; }

      .header {
        margin-bottom: 0.75rem;
      }

      .central-card {
        padding: 1rem;
        border-radius: 1.25rem;
      }

      .top-bar {
        flex-direction: column;
        align-items: stretch;
        gap: 0.5rem;
        padding-bottom: 0.5rem;
        margin-bottom: 0.5rem;
      }

      .segmented-toggle {
        width: 100%;
        justify-content: center;
        height: 36px;
      }

      .xray-btn {
        padding: 0.4rem 0.875rem;
        font-size: 0.5625rem;
      }

      .content-area {
        padding: 0.875rem;
        min-height: 300px;
        margin-bottom: 0.5rem;
      }

      .base-sentence { 
        font-size: 1.3rem;
        line-height: 1.3;
        padding: 0.75rem 0;
        margin-bottom: 1rem;
        font-weight: 900;
      }
      
      .paragraph-text { 
        font-size: 0.875rem;
        line-height: 1.6;
      }

      .paragraph-text .first-sentence {
        font-size: 1.3rem;
        line-height: 1.3;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom-width: 2px;
      }

      .nav-dots {
        margin-bottom: 1rem;
        gap: 0.5rem;
      }

      .nav-dot {
        width: 10px;
        height: 10px;
      }

      .footer-buttons {
        gap: 0.375rem;
        flex-wrap: wrap;
      }

      .footer-btn {
        padding: 0.4rem 0.625rem;
        font-size: 0.5625rem;
      }

      .xray-part {
        padding: 0.875rem;
        margin-bottom: 0.75rem;
      }

      .xray-label {
        font-size: 0.5625rem;
        margin-bottom: 0.375rem;
      }

      .xray-text {
        font-size: 0.875rem;
        line-height: 1.5;
      }
    }
  </style>
</head>
<body>

<button class="back-btn" onclick="window.location.href='index.html?openModal=writing'">
  <span>‚Üê</span>
  <span>Back</span>
</button>

<div class="main-container">
  <!-- HEADER -->
  <div class="header">
    <h1 class="brand-logo">INTUITY</h1>
    <p class="brand-subtitle">Paragraph Builder</p>
    <p class="brand-author">Majid Nashtai</p>
  </div>

  <!-- CENTRAL CARD -->
  <div class="central-card">
    <!-- TOP BAR -->
    <div class="top-bar">
      <!-- MODE TOGGLE -->
      <div class="segmented-toggle">
        <div class="segmented-bg" id="modeBg"></div>
        <button class="segmented-btn active" data-mode="read">Read</button>
        <button class="segmented-btn" data-mode="build">Build</button>
      </div>

      <!-- X-RAY TOGGLE -->
      <button class="xray-btn" id="xrayBtn">X-Ray</button>
    </div>

    <!-- CONTENT AREA -->
    <div class="content-area" id="contentArea">
      Loading...
    </div>

    <!-- COMPACT FOOTER BUTTONS -->
    <div class="footer-buttons" id="footerButtons"></div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal()">√ó</button>
    <h2 class="modal-title" id="modalTitle">Select Option</h2>
    <div id="modalOptions"></div>
  </div>
</div>

<!-- OPENER MENU (POPUP) -->
<div id="openerDropdownPopup" style="position: fixed; display: none; z-index: 10000;">
  <div class="opener-menu show" id="openerMenuPopup"></div>
</div>

<script>
// ==================== DATA ====================
let sentencesData = [];
let openersByType = {};
let readModeSamples = []; // READ mode progressive samples

const linkingWords = [
  'For example', 'For instance', 'However', 'Therefore', 'Thus', 'Hence',
  'As a result', 'Consequently', 'Moreover', 'Furthermore', 'In addition',
  'Nevertheless', 'Nonetheless', 'On the other hand', 'In contrast',
  'Similarly', 'Likewise', 'In fact', 'Indeed', 'Specifically',
  'This is because', 'This happens because', 'Given that', 'Since',
  'Although', 'While', 'Whereas', 'By comparison', 'Compared to',
  'Unlike', 'In other words', 'That is to say', 'Namely'
];

// ==================== STATE ====================
let mode = 'read';
let currentSentenceIndex = 0;
let usedTransforms = {};
let paragraphText = '';
let currentOpener = '';
let showXRay = false;

// READ MODE SPECIFIC STATE
let readDotIndex = 0; // Current dot position (0-3)
let readParagraphSteps = []; // Array of progressive paragraph states

// ==================== DATA LOADING ====================
async function loadSentencesFromJSON() {
  try {
    const response = await fetch('data/transformations.json');
    const data = await response.json();
    sentencesData = data.sentences;
    console.log('‚úì Sentences loaded:', sentencesData.length, 'sentences');
    return true;
  } catch (error) {
    console.error('‚úó Error loading sentences:', error);
    document.getElementById('contentArea').innerHTML = `
      <div style="text-align: center; padding: 2rem; color: #fb923c;">
        <p style="font-size: 1.2rem; margin-bottom: 1rem;">‚ö†Ô∏è Data Loading Error</p>
        <p style="color: #8e8e93;">Could not load transformations.json</p>
        <p style="color: #636366; font-size: 0.875rem; margin-top: 0.5rem;">
          Expected path: data/transformations.json
        </p>
      </div>
    `;
    return false;
  }
}

async function loadOpenersFromJSON() {
  try {
    const response = await fetch('data/transformations-opener-sets.json');
    const data = await response.json();
    openersByType = data;
    console.log('‚úì Openers loaded:', Object.keys(openersByType).length, 'categories');
    return true;
  } catch (error) {
    console.error('‚úó Error loading openers:', error);
    document.getElementById('contentArea').innerHTML = `
      <div style="text-align: center; padding: 2rem; color: #fb923c;">
        <p style="font-size: 1.2rem; margin-bottom: 1rem;">‚ö†Ô∏è Data Loading Error</p>
        <p style="color: #8e8e93;">Could not load transformations-opener-sets.json</p>
        <p style="color: #636366; font-size: 0.875rem; margin-top: 0.5rem;">
          Expected path: data/transformations-opener-sets.json
        </p>
      </div>
    `;
    return false;
  }
}

async function loadReadModeSamples() {
  try {
    const response = await fetch('data/transformations-read-mode.json');
    const data = await response.json();
    readModeSamples = data.samples || [];
    console.log('‚úì READ mode samples loaded:', readModeSamples.length, 'samples');
    return true;
  } catch (error) {
    console.error('‚úó Error loading READ mode samples:', error);
    // Not critical - can fall back to generated samples
    return false;
  }
}

function getCurrentOpeners() {
  return openersByType.essays?.openers || [];
}

function getRandomSentence() {
  if (!sentencesData || sentencesData.length === 0) return null;
  const randomIndex = Math.floor(Math.random() * sentencesData.length);
  return sentencesData[randomIndex];
}

// ==================== READ MODE LOGIC ====================
function generateReadModeParagraph() {
  // Use Majid's pedagogically crafted samples if available
  if (readModeSamples && readModeSamples.length > 0) {
    const sample = readModeSamples[currentSentenceIndex];
    if (sample && sample.steps) {
      return sample.steps.map(step => step.text);
    }
  }
  
  // Fallback: Generate from transformation data
  const sentence = sentencesData[currentSentenceIndex];
  const transforms = getTransforms();
  
  // Randomly select 3 transforms
  const shuffled = [...transforms].sort(() => Math.random() - 0.5);
  const selected = shuffled.slice(0, 3);
  
  // Build progressive steps
  const steps = [];
  
  // Step 0: Just the opener + topic sentence
  const opener = getCurrentOpeners()[Math.floor(Math.random() * getCurrentOpeners().length)];
  const topicWithOpener = opener + ' ' + sentence.base.charAt(0).toLowerCase() + sentence.base.slice(1);
  steps.push(topicWithOpener);
  
  // Steps 1-3: Add each selected transform
  let building = topicWithOpener;
  selected.forEach(transform => {
    const options = sentence[transform] || [];
    if (options.length > 0) {
      const randomOption = options[Math.floor(Math.random() * options.length)];
      building += ' ' + randomOption;
      steps.push(building);
    }
  });
  
  return steps;
}

// ==================== LOGIC ====================
function getTransforms() {
  // Always use body paragraph transforms
  return ['explain', 'reason', 'example', 'result'];
}

function resetParagraph() {
  const sentence = getRandomSentence();
  if (sentence) {
    paragraphText = sentence.base;
    currentSentenceIndex = sentencesData.indexOf(sentence);
  }
  usedTransforms = {};
  currentOpener = '';
  
  // Reset READ mode
  readDotIndex = 0;
  readParagraphSteps = generateReadModeParagraph();
}

function highlightLinkingWords(text) {
  if (!text) return '';
  const pattern = new RegExp(`(${linkingWords.join('|')})`, 'gi');
  return text.replace(pattern, '<span class="linking-word">$1</span>');
}

function formatParagraphWithPosterStyle(text) {
  if (!text) return '';
  
  // Find the first sentence (ends with period, exclamation, or question mark)
  const firstSentenceMatch = text.match(/^[^.!?]+[.!?]/);
  
  if (firstSentenceMatch) {
    const firstSentence = firstSentenceMatch[0];
    const restOfText = text.substring(firstSentence.length).trim();
    
    // Apply poster style to first sentence, linking words to the rest
    return `<span class="first-sentence">${firstSentence}</span>${restOfText ? ' ' + highlightLinkingWords(restOfText) : ''}`;
  }
  
  // Fallback: just highlight linking words
  return highlightLinkingWords(text);
}

function addSentence(transform, index) {
  if (usedTransforms[transform]) return;
  const currentSentence = sentencesData[currentSentenceIndex];
  const sentenceArray = currentSentence[transform] || [];
  const sentence = sentenceArray[index];
  if (!sentence) return;
  paragraphText = (paragraphText.trim() + ' ' + sentence).trim();
  usedTransforms = { ...usedTransforms, [transform]: true };
  closeModal();
  render();
}

function getFullParagraph() {
  const currentSentence = sentencesData[currentSentenceIndex];
  const base = currentSentence.base;
  let additional = paragraphText.replace(base, '').trim();
  let full = base;
  if (additional) full = base + ' ' + additional;
  if (currentOpener && full) {
    full = currentOpener + ' ' + full.charAt(0).toLowerCase() + full.slice(1);
  }
  return full;
}

function copyText() {
  const text = mode === 'build'
    ? getFullParagraph()
    : (readParagraphSteps[readParagraphSteps.length - 1] || '');
  navigator.clipboard.writeText(text).catch(() => {});
}

function analyzeParagraphStructure() {
  const parts = [];
  const currentSentence = sentencesData[currentSentenceIndex];
  const base = currentSentence.base;

  if (currentOpener) {
    parts.push({
      type: 'opener',
      text: currentOpener,
      color: 'xray-opener',
      label: 'OPENER'
    });
  }

  parts.push({
    type: 'topic',
    text: base,
    color: 'xray-topic',
    label: 'TOPIC SENTENCE'
  });

  const colors = {
    explain: { color: 'xray-explain', label: 'EXPLANATION' },
    reason: { color: 'xray-reason', label: 'REASON' },
    example: { color: 'xray-example', label: 'EXAMPLE' },
    result: { color: 'xray-result', label: 'RESULT' }
  };

  Object.keys(usedTransforms).forEach(transform => {
    const sentences = currentSentence[transform];
    if (!sentences) return;
    const matchedSentence = sentences.find(s => paragraphText.includes(s));
    if (matchedSentence) {
      parts.push({
        type: transform,
        text: matchedSentence,
        ...colors[transform]
      });
    }
  });

  return parts;
}

function analyzeReadParagraph(paragraph) {
  const sentences = paragraph.split(/(?<=[.!?])\s+/).filter(s => s.trim());
  
  return sentences.map((sentence, i) => {
    let type = 'supporting';
    let color = 'xray-explain';
    let label = 'SUPPORTING';
    const s = sentence.toLowerCase();

    if (i === 0) {
      // Check if it has an opener
      const hasOpener = getCurrentOpeners().some(opener => 
        sentence.toLowerCase().startsWith(opener.toLowerCase())
      );
      
      if (hasOpener) {
        type = 'opener+topic';
        color = 'xray-opener';
        label = 'OPENER + TOPIC';
      } else {
        type = 'topic';
        color = 'xray-topic';
        label = 'TOPIC SENTENCE';
      }
    } else if (/for example|for instance/i.test(s)) {
      type = 'example';
      color = 'xray-example';
      label = 'EXAMPLE';
    } else if (/this is because|this happens because|given that|since/i.test(s)) {
      type = 'reason';
      color = 'xray-reason';
      label = 'REASON';
    } else if (/therefore|thus|as a result|consequently|ultimately/i.test(s)) {
      type = 'result';
      color = 'xray-result';
      label = 'RESULT';
    } else {
      type = 'explain';
      color = 'xray-explain';
      label = 'EXPLANATION';
    }

    return {
      type,
      text: sentence,
      color,
      label
    };
  });
}

// ==================== RENDER ====================
function renderContent() {
  if (mode === 'read') {
    const currentParagraph = readParagraphSteps[readDotIndex] || readParagraphSteps[0];
    
    if (!showXRay) {
      // Navigation dots
      let dotsHtml = '<div class="nav-dots">';
      for (let i = 0; i < readParagraphSteps.length; i++) {
        const activeClass = i === readDotIndex ? 'active' : '';
        dotsHtml += `<div class="nav-dot ${activeClass}" onclick="jumpToReadStep(${i})"></div>`;
      }
      dotsHtml += '</div>';
      
      // Paragraph with highlighted linking words and poster-style first sentence
      const paragraphHtml = `
        <div class="paragraph-text">
          ${formatParagraphWithPosterStyle(currentParagraph)}
        </div>
      `;
      
      return dotsHtml + paragraphHtml;
    } else {
      // X-Ray mode
      const parts = analyzeReadParagraph(currentParagraph);
      return parts.map(part => `
        <div class="${part.color} xray-part">
          <div class="xray-label">${part.label}</div>
          <div class="xray-text">${part.text}</div>
        </div>
      `).join('');
    }
  } else {
    // BUILD MODE
    const currentSentence = sentencesData[currentSentenceIndex];
    const base = currentSentence.base;
    const additional = paragraphText !== base ? paragraphText.replace(base, '').trim() : '';
    const topic = currentOpener ? base.charAt(0).toLowerCase() + base.slice(1) : base;

    if (!showXRay) {
      let html = '<div class="paragraph-text">';
      if (currentOpener) {
        html += `<span class="opener-text">${currentOpener} </span>`;
      }
      html += `<span class="base-sentence">${topic}</span>`;
      if (additional) {
        html += ' ' + highlightLinkingWords(additional);
      }
      html += '</div>';
      return html;
    } else {
      const parts = analyzeParagraphStructure();
      return parts.map(part => `
        <div class="${part.color} xray-part">
          <div class="xray-label">${part.label}</div>
          <div class="xray-text">${part.text}</div>
        </div>
      `).join('');
    }
  }
}

function renderFooterButtons() {
  const footerButtons = document.getElementById('footerButtons');
  
  if (mode === 'read') {
    // READ MODE: Navigation arrows + Copy + New
    const prevDisabled = readDotIndex === 0 ? 'disabled' : '';
    const nextDisabled = readDotIndex === readParagraphSteps.length - 1 ? 'disabled' : '';
    
    footerButtons.innerHTML = `
      <button class="footer-btn ${prevDisabled}" onclick="prevReadStep()" ${prevDisabled ? 'disabled' : ''}>‚Üê Prev</button>
      <button class="footer-btn ${nextDisabled}" onclick="nextReadStep()" ${nextDisabled ? 'disabled' : ''}>Next ‚Üí</button>
      <button class="footer-btn" onclick="copyText()">Copy</button>
      <button class="footer-btn primary" onclick="newSentence()">üîÑ New</button>
    `;
  } else {
    // BUILD MODE: All 7 buttons
    const transforms = getTransforms();
    let html = '<button class="footer-btn" onclick="copyText()">Copy</button>';
    html += '<button class="footer-btn" onclick="showOpenerMenu(event)">Opener ‚ñæ</button>';
    
    transforms.forEach(t => {
      const disabled = usedTransforms[t] ? 'disabled' : '';
      html += `<button class="footer-btn ${disabled}" onclick="openTransformModal('${t}')" ${disabled ? 'disabled' : ''}>${t}</button>`;
    });
    
    html += '<button class="footer-btn primary" onclick="resetParagraph();render()">üîÑ Fresh</button>';
    footerButtons.innerHTML = html;
  }
}

// ==================== READ MODE NAVIGATION ====================
function nextReadStep() {
  if (readDotIndex < readParagraphSteps.length - 1) {
    readDotIndex++;
    render();
  }
}

function prevReadStep() {
  if (readDotIndex > 0) {
    readDotIndex--;
    render();
  }
}

function jumpToReadStep(index) {
  if (index >= 0 && index < readParagraphSteps.length) {
    readDotIndex = index;
    render();
  }
}

// ==================== BUILD MODE FUNCTIONS ====================
function showOpenerMenu(event) {
  const popup = document.getElementById('openerDropdownPopup');
  const menu = document.getElementById('openerMenuPopup');
  const button = event.target;
  const rect = button.getBoundingClientRect();
  
  popup.style.left = rect.left + 'px';
  popup.style.top = (rect.top - 10) + 'px';
  popup.style.display = 'block';
  
  const openers = getCurrentOpeners();
  menu.innerHTML = openers.map((opener, i) => `
    <button class="opener-option" onclick="selectOpener(${i})">${opener}‚Ä¶</button>
  `).join('');
}

function hideOpenerMenu() {
  document.getElementById('openerDropdownPopup').style.display = 'none';
}

function selectOpener(index) {
  const openers = getCurrentOpeners();
  currentOpener = openers[index];
  hideOpenerMenu();
  render();
}

function newSentence() {
  resetParagraph();
  render();
}

function render() {
  const modeBg = document.getElementById('modeBg');
  modeBg.style.transform = mode === 'build' ? 'translateX(100%)' : 'translateX(0)';
  document.querySelectorAll('.segmented-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.mode === mode);
  });

  document.getElementById('xrayBtn').textContent = showXRay ? 'Normal' : 'X-Ray';
  document.getElementById('contentArea').innerHTML = renderContent();
  renderFooterButtons();
}

function openTransformModal(transform) {
  if (usedTransforms[transform]) return;
  const currentSentence = sentencesData[currentSentenceIndex];
  const options = currentSentence[transform] || [];
  
  document.getElementById('modalTitle').textContent = transform.toUpperCase();
  const modalOptions = document.getElementById('modalOptions');
  modalOptions.innerHTML = options.map((option, i) => `
    <div class="modal-option">
      <span class="option-number">${i + 1}.</span>
      <span class="option-text">${option}</span>
      <button class="use-btn" onclick="addSentence('${transform}', ${i})">‚ûï Use</button>
    </div>
  `).join('');
  
  document.getElementById('modalOverlay').classList.add('show');
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('show');
}

// ==================== EVENT LISTENERS ====================
document.querySelectorAll('.segmented-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    mode = btn.dataset.mode;
    showXRay = false;
    if (mode === 'read') {
      readDotIndex = 0; // Reset to first step when switching to READ
    }
    render();
  });
});

document.getElementById('xrayBtn').addEventListener('click', () => {
  showXRay = !showXRay;
  render();
});

document.addEventListener('click', (e) => {
  if (!e.target.closest('#openerDropdownPopup') && !e.target.closest('.footer-btn')) {
    hideOpenerMenu();
  }
});

document.getElementById('modalOverlay').addEventListener('click', (e) => {
  if (e.target.id === 'modalOverlay') closeModal();
});

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeModal();
    hideOpenerMenu();
  }
  
  // Arrow key navigation in READ mode
  if (mode === 'read' && !showXRay) {
    if (e.key === 'ArrowRight') nextReadStep();
    if (e.key === 'ArrowLeft') prevReadStep();
  }
});

// ==================== INITIALIZE ====================
async function init() {
  document.getElementById('contentArea').innerHTML = `
    <div style="text-align: center; padding: 2rem; color: #8e8e93;">
      <div style="font-size: 1.5rem; margin-bottom: 1rem;">‚è≥</div>
      <p>Loading data...</p>
      <p style="font-size: 0.75rem; margin-top: 0.5rem; color: #636366;">
        Fetching transformations, openers, and READ mode samples
      </p>
    </div>
  `;
  
  const [sentencesLoaded, openersLoaded, readModeLoaded] = await Promise.all([
    loadSentencesFromJSON(),
    loadOpenersFromJSON(),
    loadReadModeSamples()
  ]);
  
  if (sentencesLoaded && openersLoaded) {
    console.log('‚úÖ All data loaded successfully');
    console.log('   - Sentences:', sentencesData.length);
    console.log('   - Opener categories:', Object.keys(openersByType).join(', '));
    console.log('   - READ mode samples:', readModeLoaded ? readModeSamples.length : '0 (using fallback)');
    resetParagraph();
    render();
  } else {
    console.error('‚ùå Failed to load required data files');
    // Error message already shown by individual load functions
  }
}

init();
</script>
</body>
</html>dcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'DM Sans', 'Inter', sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0a0a0a 100%);
      color: #e5e5e7;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      padding-top: 2rem;
      overflow-x: hidden;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background:
        radial-gradient(circle at 30% 20%, rgba(201, 169, 97, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 70% 80%, rgba(201, 169, 97, 0.08) 0%, transparent 45%);
      pointer-events: none;
      z-index: 0;
    }

    .main-container {
      position: relative;
      z-index: 1;
      max-width: 1000px;
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    /* HEADER */
    .header {
      text-align: center;
      margin-bottom: 1rem;
    }

    .brand-logo {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.75rem;
      font-weight: 700;
      background: linear-gradient(135deg, #C9A961 0%, rgba(201, 169, 97, 0.8) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-transform: uppercase;
      letter-spacing: -0.04em;
      margin-bottom: 0.25rem;
    }

    .brand-subtitle {
      font-size: 0.75rem;
      color: #8e8e93;
      font-weight: 500;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      margin-bottom: 0.25rem;
    }

    .brand-author {
      font-size: 0.625rem;
      color: #636366;
      font-weight: 400;
      letter-spacing: 0.02em;
    }

    /* BACK BUTTON */
    .back-btn {
      position: absolute;
      top: 1.25rem;
      left: 1rem;
      padding: 0.5rem 1rem;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 0.75rem;
      color: #C9A961;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      z-index: 100;
    }

    .back-btn:hover {
      background: rgba(0, 0, 0, 0.6);
      border-color: rgba(201, 169, 97, 0.3);
      transform: translateX(-2px);
    }

    /* CENTRAL CARD */
    .central-card {
      background: rgba(28, 28, 30, 0.6);
      backdrop-filter: blur(40px) saturate(150%);
      -webkit-backdrop-filter: blur(40px) saturate(150%);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 1.5rem;
      padding: 1.25rem;
      box-shadow:
        0 30px 80px rgba(0, 0, 0, 0.8),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      position: relative;
      display: flex;
      flex-direction: column;
      margin-bottom: 1rem;
    }

    /* TOP BAR */
    .top-bar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      margin-bottom: 0.75rem;
    }

    /* SEGMENTED CONTROL */
    .segmented-toggle {
      display: inline-flex;
      align-items: center;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 999px;
      padding: 0.25rem;
      height: 38px;
      position: relative;
    }

    .segmented-bg {
      position: absolute;
      height: calc(100% - 6px);
      top: 3px;
      left: 3px;
      width: calc((100% - 6px) / 2);
      border-radius: 999px;
      background: linear-gradient(135deg, #C9A961 0%, #d4b46e 100%);
      box-shadow: 0 2px 8px rgba(201, 169, 97, 0.3);
      transition: transform 0.25s ease;
      z-index: 0;
    }

    .segmented-btn {
      position: relative;
      border: none;
      background: transparent;
      padding: 0 1rem;
      height: 100%;
      font-size: 0.72rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e5e5ea;
      border-radius: 999px;
      cursor: pointer;
      z-index: 2;
      transition: color 0.25s;
    }

    .segmented-btn.active { color: #111; }

    /* X-RAY TOGGLE */
    .xray-btn {
      font-size: 0.625rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0.5rem 1rem;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 999px;
      color: #C9A961;
      cursor: pointer;
      transition: all 0.3s;
    }

    .xray-btn:hover {
      background: rgba(0, 0, 0, 0.5);
      border-color: rgba(201, 169, 97, 0.3);
    }

    /* CONTENT AREA */
    .content-area {
      flex: 1;
      padding: 1rem;
      border-radius: 1rem;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(20px) saturate(120%);
      -webkit-backdrop-filter: blur(20px) saturate(120%);
      border: 1px solid rgba(255, 255, 255, 0.06);
      margin-bottom: 0.75rem;
      min-height: 400px;
    }

    /* READ MODE - NAVIGATION DOTS */
    .nav-dots {
      display: flex;
      justify-content: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .nav-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .nav-dot.active {
      background: #C9A961;
      box-shadow: 0 0 12px rgba(201, 169, 97, 0.5);
      transform: scale(1.2);
    }

    .nav-dot:hover:not(.active) {
      background: rgba(201, 169, 97, 0.4);
      transform: scale(1.1);
    }

    /* PARAGRAPH STYLING */
    .base-sentence {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.5rem;
      font-weight: 900;
      line-height: 1.3;
      color: #fef3c7;
      letter-spacing: -0.02em;
      margin-bottom: 1rem;
      text-transform: uppercase;
      text-shadow: 0 2px 20px rgba(254, 243, 199, 0.3);
      padding: 0.75rem 0;
      border-bottom: 2px solid rgba(201, 169, 97, 0.3);
    }

    .linking-word {
      color: #34d399;
      font-weight: 700;
    }

    .opener-text {
      color: #34d399;
      font-weight: 700;
    }

    .paragraph-text {
      font-size: 1rem;
      line-height: 1.75;
      color: #e5e7eb;
    }

    /* X-RAY MODE */
    .xray-part {
      padding: 1.25rem;
      border-radius: 0.75rem;
      border-left: 4px solid;
      margin-bottom: 1rem;
    }

    .xray-label {
      font-size: 0.625rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      opacity: 0.7;
      margin-bottom: 0.5rem;
    }

    .xray-text {
      font-size: 0.9375rem;
      line-height: 1.6;
      color: #e5e7eb;
    }

    .xray-opener { background: rgba(52, 211, 153, 0.1); border-color: #34d399; }
    .xray-topic { background: rgba(254, 243, 199, 0.15); border-color: #fef3c7; }
    .xray-explain { background: rgba(167, 139, 250, 0.1); border-color: #a78bfa; }
    .xray-reason { background: rgba(96, 165, 250, 0.1); border-color: #60a5fa; }
    .xray-example { background: rgba(52, 211, 153, 0.1); border-color: #34d399; }
    .xray-result { background: rgba(251, 146, 60, 0.1); border-color: #fb923c; }

    /* COMPACT FOOTER BUTTONS */
    .footer-buttons {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 0.375rem;
    }

    .footer-btn {
      padding: 0.5rem 0.875rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      color: #C9A961;
      font-size: 0.625rem;
      text-transform: uppercase;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      letter-spacing: 0.05em;
      white-space: nowrap;
    }

    .footer-btn:hover:not(.disabled) {
      background: rgba(201, 169, 97, 0.15);
      border-color: rgba(201, 169, 97, 0.3);
      transform: translateY(-1px);
    }

    .footer-btn.primary {
      background: linear-gradient(135deg, #C9A961 0%, #d4b46e 100%);
      color: #000;
      border-color: #C9A961;
      box-shadow: 0 2px 8px rgba(201, 169, 97, 0.3);
    }

    .footer-btn.primary:hover {
      background: linear-gradient(135deg, #d4b46e 0%, #e0c078 100%);
      box-shadow: 0 4px 12px rgba(201, 169, 97, 0.4);
    }

    .footer-btn.disabled {
      opacity: 0.3;
      cursor: not-allowed;
      background: rgba(0, 0, 0, 0.2);
    }

    /* OPENER DROPDOWN */
    .opener-menu {
      position: absolute;
      bottom: 110%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(20, 20, 22, 0.95);
      backdrop-filter: blur(40px) saturate(150%);
      -webkit-backdrop-filter: blur(40px) saturate(150%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.75rem;
      padding: 0.5rem;
      min-width: 260px;
      max-height: 260px;
      overflow-y: auto;
      display: none;
      z-index: 1000;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.9);
    }

    .opener-menu.show { display: block; }

    .opener-option {
      width: 100%;
      text-align: left;
      background: transparent;
      border: none;
      padding: 0.5rem;
      font-size: 0.8125rem;
      color: #e5e7eb;
      cursor: pointer;
      border-radius: 0.5rem;
      transition: background 0.2s;
    }

    .opener-option:hover {
      background: rgba(201, 169, 97, 0.15);
    }

    /* MODAL */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      z-index: 9999;
    }

    .modal-overlay.show { display: flex; }

    .modal-content {
      position: relative;
      background: rgba(20, 20, 22, 0.95);
      backdrop-filter: blur(40px) saturate(150%);
      -webkit-backdrop-filter: blur(40px) saturate(150%);
      border-radius: 1.5rem;
      padding: 2rem;
      max-width: 700px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow:
        0 25px 50px rgba(0, 0, 0, 0.9),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }

    .modal-title {
      font-family: 'Space Grotesk', serif;
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: #C9A961;
      text-transform: uppercase;
      text-align: center;
    }

    .modal-option {
      display: flex;
      align-items: start;
      gap: 1rem;
      margin-bottom: 1rem;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 0.75rem;
      transition: all 0.3s;
    }

    .modal-option:hover {
      background: rgba(0, 0, 0, 0.5);
      border-color: rgba(255, 255, 255, 0.08);
    }

    .option-number {
      font-weight: 700;
      color: #C9A961;
      min-width: 2rem;
    }

    .option-text {
      flex: 1;
      color: #e5e7eb;
      line-height: 1.6;
    }

    .use-btn {
      padding: 0.5rem 1rem;
      border-radius: 999px;
      background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
      color: #000;
      border: none;
      font-size: 0.75rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      white-space: nowrap;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .use-btn:hover {
      background: linear-gradient(135deg, #34d399 0%, #6ee7b7 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      color: #8e8e93;
      font-size: 1.25rem;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      background: rgba(0, 0, 0, 0.6);
      color: #e5e5e7;
      border-color: rgba(255, 255, 255, 0.15);
    }

    /* MOBILE */
    @media (max-width: 768px) {
      body { 
        padding: 0.75rem; 
        padding-top: 3rem;
        align-items: flex-start;
      }
      
      .back-btn {
        top: 0.5rem;
        left: 0.5rem;
        padding: 0.4rem 0.75rem;
        font-size: 0.625rem;
      }

      .brand-logo { font-size: 1.25rem; }
      .brand-subtitle { font-size: 0.625rem; }
      .brand-author { font-size: 0.5625rem; }

      .header {
        margin-bottom: 0.75rem;
      }

      .central-card {
        padding: 1rem;
        border-radius: 1.25rem;
      }

      .top-bar {
        flex-direction: column;
        align-items: stretch;
        gap: 0.5rem;
        padding-bottom: 0.5rem;
        margin-bottom: 0.5rem;
      }

      .segmented-toggle {
        width: 100%;
        justify-content: center;
        height: 36px;
      }

      .xray-btn {
        padding: 0.4rem 0.875rem;
        font-size: 0.5625rem;
      }

      .content-area {
        padding: 0.875rem;
        min-height: 300px;
        margin-bottom: 0.5rem;
      }

      .base-sentence { 
        font-size: 1.125rem;
        line-height: 1.25;
        padding: 0.5rem 0;
        margin-bottom: 0.75rem;
      }
      
      .paragraph-text { 
        font-size: 0.875rem;
        line-height: 1.6;
      }

      .nav-dots {
        margin-bottom: 1rem;
        gap: 0.5rem;
      }

      .nav-dot {
        width: 10px;
        height: 10px;
      }

      .footer-buttons {
        gap: 0.375rem;
        flex-wrap: wrap;
      }

      .footer-btn {
        padding: 0.4rem 0.625rem;
        font-size: 0.5625rem;
      }

      .xray-part {
        padding: 0.875rem;
        margin-bottom: 0.75rem;
      }

      .xray-label {
        font-size: 0.5625rem;
        margin-bottom: 0.375rem;
      }

      .xray-text {
        font-size: 0.875rem;
        line-height: 1.5;
      }
    }
  </style>
</head>
<body>

<button class="back-btn" onclick="window.location.href='index.html?openModal=writing'">
  <span>‚Üê</span>
  <span>Back</span>
</button>

<div class="main-container">
  <!-- HEADER -->
  <div class="header">
    <h1 class="brand-logo">INTUITY</h1>
    <p class="brand-subtitle">Paragraph Builder</p>
    <p class="brand-author">Majid Nashtai</p>
  </div>

  <!-- CENTRAL CARD -->
  <div class="central-card">
    <!-- TOP BAR -->
    <div class="top-bar">
      <!-- MODE TOGGLE -->
      <div class="segmented-toggle">
        <div class="segmented-bg" id="modeBg"></div>
        <button class="segmented-btn active" data-mode="read">Read</button>
        <button class="segmented-btn" data-mode="build">Build</button>
      </div>

      <!-- X-RAY TOGGLE -->
      <button class="xray-btn" id="xrayBtn">X-Ray</button>
    </div>

    <!-- CONTENT AREA -->
    <div class="content-area" id="contentArea">
      Loading...
    </div>

    <!-- COMPACT FOOTER BUTTONS -->
    <div class="footer-buttons" id="footerButtons"></div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal()">√ó</button>
    <h2 class="modal-title" id="modalTitle">Select Option</h2>
    <div id="modalOptions"></div>
  </div>
</div>

<!-- OPENER MENU (POPUP) -->
<div id="openerDropdownPopup" style="position: fixed; display: none; z-index: 10000;">
  <div class="opener-menu show" id="openerMenuPopup"></div>
</div>

<script>
// ==================== DATA ====================
let sentencesData = [];
let openersByType = {};

const linkingWords = [
  'For example', 'For instance', 'However', 'Therefore', 'Thus', 'Hence',
  'As a result', 'Consequently', 'Moreover', 'Furthermore', 'In addition',
  'Nevertheless', 'Nonetheless', 'On the other hand', 'In contrast',
  'Similarly', 'Likewise', 'In fact', 'Indeed', 'Specifically',
  'This is because', 'This happens because', 'Given that', 'Since',
  'Although', 'While', 'Whereas', 'By comparison', 'Compared to',
  'Unlike', 'In other words', 'That is to say', 'Namely'
];

// ==================== STATE ====================
let mode = 'read';
let currentSentenceIndex = 0;
let usedTransforms = {};
let paragraphText = '';
let currentOpener = '';
let showXRay = false;

// READ MODE SPECIFIC STATE
let readDotIndex = 0; // Current dot position (0-3)
let readParagraphSteps = []; // Array of progressive paragraph states

// ==================== DATA LOADING ====================
async function loadSentencesFromJSON() {
  try {
    const response = await fetch('data/transformations.json');
    const data = await response.json();
    sentencesData = data.sentences;
    console.log('‚úì Sentences loaded:', sentencesData.length, 'sentences');
    return true;
  } catch (error) {
    console.error('‚úó Error loading sentences:', error);
    document.getElementById('contentArea').innerHTML = `
      <div style="text-align: center; padding: 2rem; color: #fb923c;">
        <p style="font-size: 1.2rem; margin-bottom: 1rem;">‚ö†Ô∏è Data Loading Error</p>
        <p style="color: #8e8e93;">Could not load transformations.json</p>
        <p style="color: #636366; font-size: 0.875rem; margin-top: 0.5rem;">
          Expected path: data/transformations.json
        </p>
      </div>
    `;
    return false;
  }
}

async function loadOpenersFromJSON() {
  try {
    const response = await fetch('data/transformations-opener-sets.json');
    const data = await response.json();
    openersByType = data;
    console.log('‚úì Openers loaded:', Object.keys(openersByType).length, 'categories');
    return true;
  } catch (error) {
    console.error('‚úó Error loading openers:', error);
    document.getElementById('contentArea').innerHTML = `
      <div style="text-align: center; padding: 2rem; color: #fb923c;">
        <p style="font-size: 1.2rem; margin-bottom: 1rem;">‚ö†Ô∏è Data Loading Error</p>
        <p style="color: #8e8e93;">Could not load transformations-opener-sets.json</p>
        <p style="color: #636366; font-size: 0.875rem; margin-top: 0.5rem;">
          Expected path: data/transformations-opener-sets.json
        </p>
      </div>
    `;
    return false;
  }
}

function getCurrentOpeners() {
  return openersByType.essays?.openers || [];
}

function getRandomSentence() {
  if (!sentencesData || sentencesData.length === 0) return null;
  const randomIndex = Math.floor(Math.random() * sentencesData.length);
  return sentencesData[randomIndex];
}

// ==================== READ MODE LOGIC ====================
function generateReadModeParagraph() {
  const sentence = sentencesData[currentSentenceIndex];
  const transforms = getTransforms();
  
  // Randomly select 3 transforms (always keep opener slot)
  const shuffled = [...transforms].sort(() => Math.random() - 0.5);
  const selected = shuffled.slice(0, 3);
  
  // Build progressive steps
  const steps = [];
  
  // Step 0: Just the opener + topic sentence
  const opener = getCurrentOpeners()[Math.floor(Math.random() * getCurrentOpeners().length)];
  const topicWithOpener = opener + ' ' + sentence.base.charAt(0).toLowerCase() + sentence.base.slice(1);
  steps.push(topicWithOpener);
  
  // Steps 1-3: Add each selected transform
  let building = topicWithOpener;
  selected.forEach(transform => {
    const options = sentence[transform] || [];
    if (options.length > 0) {
      const randomOption = options[Math.floor(Math.random() * options.length)];
      building += ' ' + randomOption;
      steps.push(building);
    }
  });
  
  return steps;
}

// ==================== LOGIC ====================
function getTransforms() {
  // Always use body paragraph transforms
  return ['explain', 'reason', 'example', 'result'];
}

function resetParagraph() {
  const sentence = getRandomSentence();
  if (sentence) {
    paragraphText = sentence.base;
    currentSentenceIndex = sentencesData.indexOf(sentence);
  }
  usedTransforms = {};
  currentOpener = '';
  
  // Reset READ mode
  readDotIndex = 0;
  readParagraphSteps = generateReadModeParagraph();
}

function highlightLinkingWords(text) {
  if (!text) return '';
  const pattern = new RegExp(`(${linkingWords.join('|')})`, 'gi');
  return text.replace(pattern, '<span class="linking-word">$1</span>');
}

function addSentence(transform, index) {
  if (usedTransforms[transform]) return;
  const currentSentence = sentencesData[currentSentenceIndex];
  const sentenceArray = currentSentence[transform] || [];
  const sentence = sentenceArray[index];
  if (!sentence) return;
  paragraphText = (paragraphText.trim() + ' ' + sentence).trim();
  usedTransforms = { ...usedTransforms, [transform]: true };
  closeModal();
  render();
}

function getFullParagraph() {
  const currentSentence = sentencesData[currentSentenceIndex];
  const base = currentSentence.base;
  let additional = paragraphText.replace(base, '').trim();
  let full = base;
  if (additional) full = base + ' ' + additional;
  if (currentOpener && full) {
    full = currentOpener + ' ' + full.charAt(0).toLowerCase() + full.slice(1);
  }
  return full;
}

function copyText() {
  const text = mode === 'build'
    ? getFullParagraph()
    : (readParagraphSteps[readParagraphSteps.length - 1] || '');
  navigator.clipboard.writeText(text).catch(() => {});
}

function analyzeParagraphStructure() {
  const parts = [];
  const currentSentence = sentencesData[currentSentenceIndex];
  const base = currentSentence.base;

  if (currentOpener) {
    parts.push({
      type: 'opener',
      text: currentOpener,
      color: 'xray-opener',
      label: 'OPENER'
    });
  }

  parts.push({
    type: 'topic',
    text: base,
    color: 'xray-topic',
    label: 'TOPIC SENTENCE'
  });

  const colors = {
    explain: { color: 'xray-explain', label: 'EXPLANATION' },
    reason: { color: 'xray-reason', label: 'REASON' },
    example: { color: 'xray-example', label: 'EXAMPLE' },
    result: { color: 'xray-result', label: 'RESULT' }
  };

  Object.keys(usedTransforms).forEach(transform => {
    const sentences = currentSentence[transform];
    if (!sentences) return;
    const matchedSentence = sentences.find(s => paragraphText.includes(s));
    if (matchedSentence) {
      parts.push({
        type: transform,
        text: matchedSentence,
        ...colors[transform]
      });
    }
  });

  return parts;
}

function analyzeReadParagraph(paragraph) {
  const sentences = paragraph.split(/(?<=[.!?])\s+/).filter(s => s.trim());
  
  return sentences.map((sentence, i) => {
    let type = 'supporting';
    let color = 'xray-explain';
    let label = 'SUPPORTING';
    const s = sentence.toLowerCase();

    if (i === 0) {
      // Check if it has an opener
      const hasOpener = getCurrentOpeners().some(opener => 
        sentence.toLowerCase().startsWith(opener.toLowerCase())
      );
      
      if (hasOpener) {
        type = 'opener+topic';
        color = 'xray-opener';
        label = 'OPENER + TOPIC';
      } else {
        type = 'topic';
        color = 'xray-topic';
        label = 'TOPIC SENTENCE';
      }
    } else if (/for example|for instance/i.test(s)) {
      type = 'example';
      color = 'xray-example';
      label = 'EXAMPLE';
    } else if (/this is because|this happens because|given that|since/i.test(s)) {
      type = 'reason';
      color = 'xray-reason';
      label = 'REASON';
    } else if (/therefore|thus|as a result|consequently|ultimately/i.test(s)) {
      type = 'result';
      color = 'xray-result';
      label = 'RESULT';
    } else {
      type = 'explain';
      color = 'xray-explain';
      label = 'EXPLANATION';
    }

    return {
      type,
      text: sentence,
      color,
      label
    };
  });
}

// ==================== RENDER ====================
function renderContent() {
  if (mode === 'read') {
    const currentParagraph = readParagraphSteps[readDotIndex] || readParagraphSteps[0];
    
    if (!showXRay) {
      // Navigation dots
      let dotsHtml = '<div class="nav-dots">';
      for (let i = 0; i < readParagraphSteps.length; i++) {
        const activeClass = i === readDotIndex ? 'active' : '';
        dotsHtml += `<div class="nav-dot ${activeClass}" onclick="jumpToReadStep(${i})"></div>`;
      }
      dotsHtml += '</div>';
      
      // Paragraph with highlighted linking words
      const paragraphHtml = `
        <div class="paragraph-text">
          ${highlightLinkingWords(currentParagraph)}
        </div>
      `;
      
      return dotsHtml + paragraphHtml;
    } else {
      // X-Ray mode
      const parts = analyzeReadParagraph(currentParagraph);
      return parts.map(part => `
        <div class="${part.color} xray-part">
          <div class="xray-label">${part.label}</div>
          <div class="xray-text">${part.text}</div>
        </div>
      `).join('');
    }
  } else {
    // BUILD MODE
    const currentSentence = sentencesData[currentSentenceIndex];
    const base = currentSentence.base;
    const additional = paragraphText !== base ? paragraphText.replace(base, '').trim() : '';
    const topic = currentOpener ? base.charAt(0).toLowerCase() + base.slice(1) : base;

    if (!showXRay) {
      let html = '<div class="paragraph-text">';
      if (currentOpener) {
        html += `<span class="opener-text">${currentOpener} </span>`;
      }
      html += `<span class="base-sentence">${topic}</span>`;
      if (additional) {
        html += ' ' + highlightLinkingWords(additional);
      }
      html += '</div>';
      return html;
    } else {
      const parts = analyzeParagraphStructure();
      return parts.map(part => `
        <div class="${part.color} xray-part">
          <div class="xray-label">${part.label}</div>
          <div class="xray-text">${part.text}</div>
        </div>
      `).join('');
    }
  }
}

function renderFooterButtons() {
  const footerButtons = document.getElementById('footerButtons');
  
  if (mode === 'read') {
    // READ MODE: Navigation arrows + Copy + New
    const prevDisabled = readDotIndex === 0 ? 'disabled' : '';
    const nextDisabled = readDotIndex === readParagraphSteps.length - 1 ? 'disabled' : '';
    
    footerButtons.innerHTML = `
      <button class="footer-btn ${prevDisabled}" onclick="prevReadStep()" ${prevDisabled ? 'disabled' : ''}>‚Üê Prev</button>
      <button class="footer-btn ${nextDisabled}" onclick="nextReadStep()" ${nextDisabled ? 'disabled' : ''}>Next ‚Üí</button>
      <button class="footer-btn" onclick="copyText()">Copy</button>
      <button class="footer-btn primary" onclick="newSentence()">üîÑ New</button>
    `;
  } else {
    // BUILD MODE: All 7 buttons
    const transforms = getTransforms();
    let html = '<button class="footer-btn" onclick="copyText()">Copy</button>';
    html += '<button class="footer-btn" onclick="showOpenerMenu(event)">Opener ‚ñæ</button>';
    
    transforms.forEach(t => {
      const disabled = usedTransforms[t] ? 'disabled' : '';
      html += `<button class="footer-btn ${disabled}" onclick="openTransformModal('${t}')" ${disabled ? 'disabled' : ''}>${t}</button>`;
    });
    
    html += '<button class="footer-btn primary" onclick="resetParagraph();render()">üîÑ Fresh</button>';
    footerButtons.innerHTML = html;
  }
}

// ==================== READ MODE NAVIGATION ====================
function nextReadStep() {
  if (readDotIndex < readParagraphSteps.length - 1) {
    readDotIndex++;
    render();
  }
}

function prevReadStep() {
  if (readDotIndex > 0) {
    readDotIndex--;
    render();
  }
}

function jumpToReadStep(index) {
  if (index >= 0 && index < readParagraphSteps.length) {
    readDotIndex = index;
    render();
  }
}

// ==================== BUILD MODE FUNCTIONS ====================
function showOpenerMenu(event) {
  const popup = document.getElementById('openerDropdownPopup');
  const menu = document.getElementById('openerMenuPopup');
  const button = event.target;
  const rect = button.getBoundingClientRect();
  
  popup.style.left = rect.left + 'px';
  popup.style.top = (rect.top - 10) + 'px';
  popup.style.display = 'block';
  
  const openers = getCurrentOpeners();
  menu.innerHTML = openers.map((opener, i) => `
    <button class="opener-option" onclick="selectOpener(${i})">${opener}‚Ä¶</button>
  `).join('');
}

function hideOpenerMenu() {
  document.getElementById('openerDropdownPopup').style.display = 'none';
}

function selectOpener(index) {
  const openers = getCurrentOpeners();
  currentOpener = openers[index];
  hideOpenerMenu();
  render();
}

function newSentence() {
  resetParagraph();
  render();
}

function render() {
  const modeBg = document.getElementById('modeBg');
  modeBg.style.transform = mode === 'build' ? 'translateX(100%)' : 'translateX(0)';
  document.querySelectorAll('.segmented-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.mode === mode);
  });

  document.getElementById('xrayBtn').textContent = showXRay ? 'Normal' : 'X-Ray';
  document.getElementById('contentArea').innerHTML = renderContent();
  renderFooterButtons();
}

function openTransformModal(transform) {
  if (usedTransforms[transform]) return;
  const currentSentence = sentencesData[currentSentenceIndex];
  const options = currentSentence[transform] || [];
  
  document.getElementById('modalTitle').textContent = transform.toUpperCase();
  const modalOptions = document.getElementById('modalOptions');
  modalOptions.innerHTML = options.map((option, i) => `
    <div class="modal-option">
      <span class="option-number">${i + 1}.</span>
      <span class="option-text">${option}</span>
      <button class="use-btn" onclick="addSentence('${transform}', ${i})">‚ûï Use</button>
    </div>
  `).join('');
  
  document.getElementById('modalOverlay').classList.add('show');
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('show');
}

// ==================== EVENT LISTENERS ====================
document.querySelectorAll('.segmented-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    mode = btn.dataset.mode;
    showXRay = false;
    if (mode === 'read') {
      readDotIndex = 0; // Reset to first step when switching to READ
    }
    render();
  });
});

document.getElementById('xrayBtn').addEventListener('click', () => {
  showXRay = !showXRay;
  render();
});

document.addEventListener('click', (e) => {
  if (!e.target.closest('#openerDropdownPopup') && !e.target.closest('.footer-btn')) {
    hideOpenerMenu();
  }
});

document.getElementById('modalOverlay').addEventListener('click', (e) => {
  if (e.target.id === 'modalOverlay') closeModal();
});

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeModal();
    hideOpenerMenu();
  }
  
  // Arrow key navigation in READ mode
  if (mode === 'read' && !showXRay) {
    if (e.key === 'ArrowRight') nextReadStep();
    if (e.key === 'ArrowLeft') prevReadStep();
  }
});

// ==================== INITIALIZE ====================
async function init() {
  document.getElementById('contentArea').innerHTML = `
    <div style="text-align: center; padding: 2rem; color: #8e8e93;">
      <div style="font-size: 1.5rem; margin-bottom: 1rem;">‚è≥</div>
      <p>Loading data...</p>
      <p style="font-size: 0.75rem; margin-top: 0.5rem; color: #636366;">
        Fetching transformations and openers
      </p>
    </div>
  `;
  
  const [sentencesLoaded, openersLoaded] = await Promise.all([
    loadSentencesFromJSON(),
    loadOpenersFromJSON()
  ]);
  
  if (sentencesLoaded && openersLoaded) {
    console.log('‚úÖ All data loaded successfully');
    console.log('   - Sentences:', sentencesData.length);
    console.log('   - Opener categories:', Object.keys(openersByType).join(', '));
    resetParagraph();
    render();
  } else {
    console.error('‚ùå Failed to load required data files');
    // Error message already shown by individual load functions
  }
}

init();
</script>
</body>
</html>
