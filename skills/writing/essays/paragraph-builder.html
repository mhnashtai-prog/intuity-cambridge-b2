<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>INTUITY - Paragraph Builder</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'DM Sans', 'Inter', sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0a0a0a 100%);
      color: #e5e5e7;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      padding-top: 3rem;
      overflow-x: hidden;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background:
        radial-gradient(circle at 30% 20%, rgba(201, 169, 97, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 70% 80%, rgba(201, 169, 97, 0.08) 0%, transparent 45%);
      pointer-events: none;
      z-index: 0;
    }

    .main-container {
      position: relative;
      z-index: 1;
      max-width: 1000px;
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    /* HEADER */
    .header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .brand-logo {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 2.25rem;
      font-weight: 700;
      background: linear-gradient(135deg, #C9A961 0%, rgba(201, 169, 97, 0.8) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-transform: uppercase;
      letter-spacing: -0.04em;
      margin-bottom: 0.5rem;
    }

    .brand-subtitle {
      font-size: 0.8125rem;
      color: #8e8e93;
      font-weight: 500;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      margin-bottom: 0.375rem;
    }

    .brand-author {
      font-size: 0.6875rem;
      color: #636366;
      font-weight: 400;
      letter-spacing: 0.02em;
    }

    /* BACK BUTTON */
    .back-btn {
      position: absolute;
      top: 1.25rem;
      left: 1rem;
      padding: 0.5rem 1rem;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 0.75rem;
      color: #C9A961;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      z-index: 100;
    }

    .back-btn:hover {
      background: rgba(0, 0, 0, 0.6);
      border-color: rgba(201, 169, 97, 0.3);
      transform: translateX(-2px);
    }

    /* CENTRAL CARD */
    .central-card {
      background: rgba(28, 28, 30, 0.6);
      backdrop-filter: blur(40px) saturate(150%);
      -webkit-backdrop-filter: blur(40px) saturate(150%);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 2rem;
      padding: 2rem;
      box-shadow:
        0 30px 80px rgba(0, 0, 0, 0.8),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      position: relative;
      min-height: 600px;
      display: flex;
      flex-direction: column;
      margin-bottom: 1.5rem;
    }

    /* TOP BAR */
    .top-bar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      margin-bottom: 1rem;
    }

    /* PARAGRAPH TYPE SELECTOR */
    .type-selector {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: rgba(0, 0, 0, 0.3);
      padding: 0.5rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .type-btn {
      padding: 0.5rem 1rem;
      border-radius: 999px;
      background: transparent;
      border: none;
      color: #8e8e93;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .type-btn.active {
      background: linear-gradient(135deg, #C9A961 0%, #d4b46e 100%);
      color: #000;
      box-shadow: 0 2px 8px rgba(201, 169, 97, 0.3);
    }

    .type-btn:hover:not(.active) {
      background: rgba(201, 169, 97, 0.15);
      color: #C9A961;
    }

    /* SEGMENTED CONTROL */
    .segmented-toggle {
      display: inline-flex;
      align-items: center;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 999px;
      padding: 0.25rem;
      height: 38px;
      position: relative;
    }

    .segmented-bg {
      position: absolute;
      height: calc(100% - 6px);
      top: 3px;
      left: 3px;
      width: calc((100% - 6px) / 2);
      border-radius: 999px;
      background: linear-gradient(135deg, #C9A961 0%, #d4b46e 100%);
      box-shadow: 0 2px 8px rgba(201, 169, 97, 0.3);
      transition: transform 0.25s ease;
      z-index: 0;
    }

    .segmented-btn {
      position: relative;
      border: none;
      background: transparent;
      padding: 0 1rem;
      height: 100%;
      font-size: 0.72rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e5e5ea;
      border-radius: 999px;
      cursor: pointer;
      z-index: 2;
      transition: color 0.25s;
    }

    .segmented-btn.active { color: #111; }

    /* X-RAY TOGGLE */
    .xray-btn {
      font-size: 0.625rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0.5rem 1rem;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 999px;
      color: #C9A961;
      cursor: pointer;
      transition: all 0.3s;
    }

    .xray-btn:hover {
      background: rgba(0, 0, 0, 0.5);
      border-color: rgba(201, 169, 97, 0.3);
    }

    /* CONTENT AREA */
    .content-area {
      flex: 1;
      padding: 1.5rem;
      border-radius: 1rem;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(20px) saturate(120%);
      -webkit-backdrop-filter: blur(20px) saturate(120%);
      border: 1px solid rgba(255, 255, 255, 0.06);
      min-height: 400px;
      margin-bottom: 1rem;
    }

    .base-sentence {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.3rem;
      font-weight: 800;
      line-height: 1.6;
      color: #fef3c7;
      letter-spacing: -0.01em;
    }

    .linking-word {
      color: #34d399;
      font-weight: 700;
    }

    .opener-text {
      color: #34d399;
      font-weight: 700;
    }

    .paragraph-text {
      font-size: 1rem;
      line-height: 1.75;
      color: #e5e7eb;
    }

    /* X-RAY MODE */
    .xray-part {
      padding: 1.25rem;
      border-radius: 0.75rem;
      border-left: 4px solid;
      margin-bottom: 1rem;
    }

    .xray-label {
      font-size: 0.625rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      opacity: 0.7;
      margin-bottom: 0.5rem;
    }

    .xray-text {
      font-size: 0.9375rem;
      line-height: 1.6;
      color: #e5e7eb;
    }

    .xray-opener { background: rgba(52, 211, 153, 0.1); border-color: #34d399; }
    .xray-topic { background: rgba(254, 243, 199, 0.15); border-color: #fef3c7; }
    .xray-explain { background: rgba(167, 139, 250, 0.1); border-color: #a78bfa; }
    .xray-reason { background: rgba(96, 165, 250, 0.1); border-color: #60a5fa; }
    .xray-example { background: rgba(52, 211, 153, 0.1); border-color: #34d399; }
    .xray-result { background: rgba(251, 146, 60, 0.1); border-color: #fb923c; }

    /* COMPACT FOOTER BUTTONS */
    .footer-buttons {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 0.375rem;
    }

    .footer-btn {
      padding: 0.5rem 0.875rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      color: #C9A961;
      font-size: 0.625rem;
      text-transform: uppercase;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      letter-spacing: 0.05em;
      white-space: nowrap;
    }

    .footer-btn:hover:not(.disabled) {
      background: rgba(201, 169, 97, 0.15);
      border-color: rgba(201, 169, 97, 0.3);
      transform: translateY(-1px);
    }

    .footer-btn.primary {
      background: linear-gradient(135deg, #C9A961 0%, #d4b46e 100%);
      color: #000;
      border-color: #C9A961;
      box-shadow: 0 2px 8px rgba(201, 169, 97, 0.3);
    }

    .footer-btn.primary:hover {
      background: linear-gradient(135deg, #d4b46e 0%, #e0c078 100%);
      box-shadow: 0 4px 12px rgba(201, 169, 97, 0.4);
    }

    .footer-btn.disabled {
      opacity: 0.3;
      cursor: not-allowed;
      background: rgba(0, 0, 0, 0.2);
    }

    /* OPENER DROPDOWN */
    .opener-menu {
      position: absolute;
      bottom: 110%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(20, 20, 22, 0.95);
      backdrop-filter: blur(40px) saturate(150%);
      -webkit-backdrop-filter: blur(40px) saturate(150%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.75rem;
      padding: 0.5rem;
      min-width: 260px;
      max-height: 260px;
      overflow-y: auto;
      display: none;
      z-index: 1000;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.9);
    }

    .opener-menu.show { display: block; }

    .opener-option {
      width: 100%;
      text-align: left;
      background: transparent;
      border: none;
      padding: 0.5rem;
      font-size: 0.8125rem;
      color: #e5e7eb;
      cursor: pointer;
      border-radius: 0.5rem;
      transition: background 0.2s;
    }

    .opener-option:hover {
      background: rgba(201, 169, 97, 0.15);
    }

    /* MODAL */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      z-index: 9999;
    }

    .modal-overlay.show { display: flex; }

    .modal-content {
      position: relative;
      background: rgba(20, 20, 22, 0.95);
      backdrop-filter: blur(40px) saturate(150%);
      -webkit-backdrop-filter: blur(40px) saturate(150%);
      border-radius: 1.5rem;
      padding: 2rem;
      max-width: 700px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow:
        0 25px 50px rgba(0, 0, 0, 0.9),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }

    .modal-title {
      font-family: 'Space Grotesk', serif;
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: #C9A961;
      text-transform: uppercase;
      text-align: center;
    }

    .modal-option {
      display: flex;
      align-items: start;
      gap: 1rem;
      margin-bottom: 1rem;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 0.75rem;
      transition: all 0.3s;
    }

    .modal-option:hover {
      background: rgba(0, 0, 0, 0.5);
      border-color: rgba(255, 255, 255, 0.08);
    }

    .option-number {
      font-weight: 700;
      color: #C9A961;
      min-width: 2rem;
    }

    .option-text {
      flex: 1;
      color: #e5e7eb;
      line-height: 1.6;
    }

    .use-btn {
      padding: 0.5rem 1rem;
      border-radius: 999px;
      background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
      color: #000;
      border: none;
      font-size: 0.75rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      white-space: nowrap;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .use-btn:hover {
      background: linear-gradient(135deg, #34d399 0%, #6ee7b7 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      color: #8e8e93;
      font-size: 1.25rem;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      background: rgba(0, 0, 0, 0.6);
      color: #e5e5e7;
      border-color: rgba(255, 255, 255, 0.15);
    }

    /* MOBILE */
    @media (max-width: 768px) {
      body { padding: 1rem; padding-top: 4rem; }
      
      .back-btn {
        top: 0.5rem;
        left: 0.5rem;
        padding: 0.4rem 0.75rem;
        font-size: 0.625rem;
      }

      .brand-logo { font-size: 1.5rem; }
      .brand-subtitle { font-size: 0.625rem; }
      .brand-author { font-size: 0.5625rem; }

      .central-card {
        padding: 1.25rem;
        border-radius: 1.5rem;
        min-height: 500px;
      }

      .top-bar {
        flex-direction: column;
        align-items: stretch;
        gap: 0.75rem;
      }

      .type-selector {
        width: 100%;
        justify-content: center;
      }

      .type-btn {
        flex: 1;
        padding: 0.5rem 0.5rem;
        font-size: 0.625rem;
      }

      .segmented-toggle {
        width: 100%;
        justify-content: center;
      }

      .content-area {
        padding: 1rem;
        min-height: 300px;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      .base-sentence { font-size: 1.1rem; }
      .paragraph-text { font-size: 0.9375rem; }

      .footer-buttons {
        gap: 0.25rem;
      }

      .footer-btn {
        padding: 0.5rem 0.625rem;
        font-size: 0.5625rem;
      }
    }
  </style>
</head>
<body>

<button class="back-btn" onclick="window.location.href='index.html?openModal=writing'">
  <span>‚Üê</span>
  <span>Back</span>
</button>

<div class="main-container">
  <!-- HEADER -->
  <div class="header">
    <h1 class="brand-logo">INTUITY</h1>
    <p class="brand-subtitle">Paragraph Builder</p>
    <p class="brand-author">Majid Nashtai</p>
  </div>

  <!-- CENTRAL CARD -->
  <div class="central-card">
    <!-- TOP BAR -->
    <div class="top-bar">
      <!-- PARAGRAPH TYPE SELECTOR -->
      <div class="type-selector">
        <button class="type-btn active" data-type="body" onclick="setParagraphType('body')">Body</button>
        <button class="type-btn" data-type="intro" onclick="setParagraphType('intro')">Intro</button>
        <button class="type-btn" data-type="conclusion" onclick="setParagraphType('conclusion')">Conclusion</button>
      </div>
      
      <!-- MODE TOGGLE -->
      <div class="segmented-toggle">
        <div class="segmented-bg" id="modeBg"></div>
        <button class="segmented-btn active" data-mode="read">Read</button>
        <button class="segmented-btn" data-mode="write">Write</button>
      </div>

      <!-- X-RAY TOGGLE -->
      <button class="xray-btn" id="xrayBtn">X-Ray</button>
    </div>

    <!-- CONTENT AREA -->
    <div class="content-area" id="contentArea">
      Loading...
    </div>

    <!-- COMPACT FOOTER BUTTONS -->
    <div class="footer-buttons" id="footerButtons"></div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal()">√ó</button>
    <h2 class="modal-title" id="modalTitle">Select Option</h2>
    <div id="modalOptions"></div>
  </div>
</div>

<!-- OPENER MENU (POPUP) -->
<div id="openerDropdownPopup" style="position: fixed; display: none; z-index: 10000;">
  <div class="opener-menu show" id="openerMenuPopup"></div>
</div>

<script>
// ==================== DATA ====================
let sentencesData = [];
let openersByType = {};

const linkingWords = [
  'For example', 'For instance', 'However', 'Therefore', 'Thus', 'Hence',
  'As a result', 'Consequently', 'Moreover', 'Furthermore', 'In addition',
  'Nevertheless', 'Nonetheless', 'On the other hand', 'In contrast',
  'Similarly', 'Likewise', 'In fact', 'Indeed', 'Specifically',
  'This is because', 'This happens because', 'Given that', 'Since',
  'Although', 'While', 'Whereas', 'By comparison', 'Compared to',
  'Unlike', 'In other words', 'That is to say', 'Namely'
];

// ==================== STATE ====================
let mode = 'read';
let paragraphType = 'body'; // 'body', 'intro', 'conclusion'
let currentSentenceIndex = 0;
let usedTransforms = {};
let paragraphText = '';
let currentOpener = '';
let showXRay = false;

// ==================== DATA LOADING ====================
async function loadSentencesFromJSON() {
  try {
    const response = await fetch('data/transformations.json');
    const data = await response.json();
    sentencesData = data.sentences;
    console.log('‚úì Sentences loaded');
    return true;
  } catch (error) {
    console.error('‚úó Error loading sentences:', error);
    sentencesData = [{
      base: "Data could not be loaded. Please refresh the page.",
      explain: [],
      reason: [],
      example: [],
      result: []
    }];
    return false;
  }
}

async function loadOpenersFromJSON() {
  try {
    const response = await fetch('data/transformations-opener-sets.json');
    const data = await response.json();
    openersByType = data;
    console.log('‚úì Openers loaded');
    return true;
  } catch (error) {
    console.error('‚úó Error loading openers:', error);
    openersByType = {
      essays: {
        label: "Essay body paragraph openers",
        openers: ["One important point is that", "Another key idea is that"]
      }
    };
    return false;
  }
}

function getCurrentOpeners() {
  return openersByType.essays?.openers || [];
}

function getRandomSentence() {
  if (!sentencesData || sentencesData.length === 0) return null;
  const randomIndex = Math.floor(Math.random() * sentencesData.length);
  return sentencesData[randomIndex];
}

// ==================== LOGIC ====================
function getTransforms() {
  if (paragraphType === 'conclusion') {
    return ['explain', 'result'];
  }
  return ['explain', 'reason', 'example', 'result'];
}

function resetParagraph() {
  const sentence = getRandomSentence();
  if (sentence) {
    paragraphText = sentence.base;
    currentSentenceIndex = sentencesData.indexOf(sentence);
  }
  usedTransforms = {};
  currentOpener = '';
}

function highlightLinkingWords(text) {
  if (!text) return '';
  const pattern = new RegExp(`(${linkingWords.join('|')})`, 'gi');
  return text.replace(pattern, '<span class="linking-word">$1</span>');
}

function addSentence(transform, index) {
  if (usedTransforms[transform]) return;
  const currentSentence = sentencesData[currentSentenceIndex];
  const sentenceArray = currentSentence[transform] || [];
  const sentence = sentenceArray[index];
  if (!sentence) return;
  paragraphText = (paragraphText.trim() + ' ' + sentence).trim();
  usedTransforms = { ...usedTransforms, [transform]: true };
  closeModal();
  render();
}

function getFullParagraph() {
  const currentSentence = sentencesData[currentSentenceIndex];
  const base = currentSentence.base;
  let additional = paragraphText.replace(base, '').trim();
  let full = base;
  if (additional) full = base + ' ' + additional;
  if (currentOpener && full) {
    full = currentOpener + ' ' + full.charAt(0).toLowerCase() + full.slice(1);
  }
  return full;
}

function copyText() {
  const text = mode === 'write'
    ? getFullParagraph()
    : generateSampleParagraph();
  navigator.clipboard.writeText(text).catch(() => {});
}

function analyzeParagraphStructure() {
  const parts = [];
  const currentSentence = sentencesData[currentSentenceIndex];
  const base = currentSentence.base;

  if (currentOpener) {
    parts.push({
      type: 'opener',
      text: currentOpener,
      color: 'xray-opener',
      label: 'OPENER'
    });
  }

  parts.push({
    type: 'topic',
    text: base,
    color: 'xray-topic',
    label: 'TOPIC SENTENCE'
  });

  const colors = {
    explain: { color: 'xray-explain', label: 'EXPLANATION' },
    reason: { color: 'xray-reason', label: 'REASON' },
    example: { color: 'xray-example', label: 'EXAMPLE' },
    result: { color: 'xray-result', label: 'RESULT' }
  };

  Object.keys(usedTransforms).forEach(transform => {
    const sentences = currentSentence[transform];
    if (!sentences) return;
    const matchedSentence = sentences.find(s => paragraphText.includes(s));
    if (matchedSentence) {
      parts.push({
        type: transform,
        text: matchedSentence,
        ...colors[transform]
      });
    }
  });

  return parts;
}

function generateSampleParagraph() {
  const sentence = sentencesData[currentSentenceIndex];
  let paragraph = sentence.base;
  
  if (paragraphType === 'conclusion') {
    if (sentence.explain && sentence.explain[0]) paragraph += ' ' + sentence.explain[0];
    if (sentence.result && sentence.result[0]) paragraph += ' ' + sentence.result[0];
  } else {
    if (sentence.explain && sentence.explain[0]) paragraph += ' ' + sentence.explain[0];
    if (sentence.reason && sentence.reason[0]) paragraph += ' ' + sentence.reason[0];
    if (sentence.example && sentence.example[0]) paragraph += ' ' + sentence.example[0];
    if (sentence.result && sentence.result[0]) paragraph += ' ' + sentence.result[0];
  }
  
  return paragraph;
}

function analyzeSampleParagraph(paragraph) {
  const sentences = paragraph.split('. ').map(s => s.trim()).filter(s => s);
  return sentences.map((sentence, i) => {
    let type = 'supporting';
    let color = 'xray-explain';
    let label = 'SUPPORTING';
    const s = sentence;

    if (i === 0) {
      type = 'topic';
      color = 'xray-topic';
      label = 'TOPIC SENTENCE';
    } else if (/for example|for instance/i.test(s)) {
      type = 'example';
      color = 'xray-example';
      label = 'EXAMPLE';
    } else if (/this is because|this happens because|since|because/i.test(s)) {
      type = 'reason';
      color = 'xray-reason';
      label = 'REASON';
    } else if (/therefore|thus|as a result|consequently|ultimately/i.test(s)) {
      type = 'result';
      color = 'xray-result';
      label = 'RESULT';
    } else if (/one important|another key|from my point|in many situations/i.test(s)) {
      type = 'opener';
      color = 'xray-opener';
      label = 'OPENER';
    }

    return {
      type,
      text: sentence.endsWith('.') ? sentence : sentence + '.',
      color,
      label
    };
  });
}

// ==================== RENDER ====================
function renderContent() {
  if (mode === 'read') {
    const paragraph = generateSampleParagraph();
    if (!showXRay) {
      return `<div class="paragraph-text">${highlightLinkingWords(paragraph)}</div>`;
    } else {
      const parts = analyzeSampleParagraph(paragraph);
      return parts.map(part => `
        <div class="${part.color} xray-part">
          <div class="xray-label">${part.label}</div>
          <div class="xray-text">${part.text}</div>
        </div>
      `).join('');
    }
  } else {
    const currentSentence = sentencesData[currentSentenceIndex];
    const base = currentSentence.base;
    const additional = paragraphText !== base ? paragraphText.replace(base, '').trim() : '';
    const topic = currentOpener ? base.charAt(0).toLowerCase() + base.slice(1) : base;

    if (!showXRay) {
      let html = '<div class="paragraph-text">';
      if (currentOpener) {
        html += `<span class="opener-text">${currentOpener} </span>`;
      }
      html += `<span class="base-sentence">${topic}</span>`;
      if (additional) {
        html += ' ' + highlightLinkingWords(additional);
      }
      html += '</div>';
      return html;
    } else {
      const parts = analyzeParagraphStructure();
      return parts.map(part => `
        <div class="${part.color} xray-part">
          <div class="xray-label">${part.label}</div>
          <div class="xray-text">${part.text}</div>
        </div>
      `).join('');
    }
  }
}

function renderFooterButtons() {
  const footerButtons = document.getElementById('footerButtons');
  
  if (mode === 'read') {
    footerButtons.innerHTML = `
      <button class="footer-btn" onclick="copyText()">Copy</button>
      <button class="footer-btn" onclick="newSentence()">üîÑ New</button>
    `;
  } else {
    const transforms = getTransforms();
    let html = '<button class="footer-btn" onclick="copyText()">Copy</button>';
    html += '<button class="footer-btn" onclick="showOpenerMenu(event)">Opener ‚ñæ</button>';
    
    transforms.forEach(t => {
      const disabled = usedTransforms[t] ? 'disabled' : '';
      html += `<button class="footer-btn ${disabled}" onclick="openTransformModal('${t}')" ${disabled ? 'disabled' : ''}>${t}</button>`;
    });
    
    html += '<button class="footer-btn primary" onclick="resetParagraph();render()">üîÑ Fresh</button>';
    footerButtons.innerHTML = html;
  }
}

function showOpenerMenu(event) {
  const popup = document.getElementById('openerDropdownPopup');
  const menu = document.getElementById('openerMenuPopup');
  const button = event.target;
  const rect = button.getBoundingClientRect();
  
  popup.style.left = rect.left + 'px';
  popup.style.top = (rect.top - 10) + 'px';
  popup.style.display = 'block';
  
  const openers = getCurrentOpeners();
  menu.innerHTML = openers.map((opener, i) => `
    <button class="opener-option" onclick="selectOpener(${i})">${opener}‚Ä¶</button>
  `).join('');
}

function hideOpenerMenu() {
  document.getElementById('openerDropdownPopup').style.display = 'none';
}

function selectOpener(index) {
  const openers = getCurrentOpeners();
  currentOpener = openers[index];
  hideOpenerMenu();
  render();
}

function newSentence() {
  resetParagraph();
  render();
}

function render() {
  const modeBg = document.getElementById('modeBg');
  modeBg.style.transform = mode === 'write' ? 'translateX(100%)' : 'translateX(0)';
  document.querySelectorAll('.segmented-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.mode === mode);
  });

  document.getElementById('xrayBtn').textContent = showXRay ? 'Normal' : 'X-Ray';
  document.getElementById('contentArea').innerHTML = renderContent();
  renderFooterButtons();
}

function setParagraphType(type) {
  paragraphType = type;
  document.querySelectorAll('.type-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.type === type);
  });
  resetParagraph();
  render();
}

function openTransformModal(transform) {
  if (usedTransforms[transform]) return;
  const currentSentence = sentencesData[currentSentenceIndex];
  const options = currentSentence[transform] || [];
  
  document.getElementById('modalTitle').textContent = transform.toUpperCase();
  const modalOptions = document.getElementById('modalOptions');
  modalOptions.innerHTML = options.map((option, i) => `
    <div class="modal-option">
      <span class="option-number">${i + 1}.</span>
      <span class="option-text">${option}</span>
      <button class="use-btn" onclick="addSentence('${transform}', ${i})">‚ûï Use</button>
    </div>
  `).join('');
  
  document.getElementById('modalOverlay').classList.add('show');
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('show');
}

// ==================== EVENT LISTENERS ====================
document.querySelectorAll('.segmented-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    mode = btn.dataset.mode;
    showXRay = false;
    render();
  });
});

document.getElementById('xrayBtn').addEventListener('click', () => {
  showXRay = !showXRay;
  render();
});

document.addEventListener('click', (e) => {
  if (!e.target.closest('#openerDropdownPopup') && !e.target.closest('.footer-btn')) {
    hideOpenerMenu();
  }
});

document.getElementById('modalOverlay').addEventListener('click', (e) => {
  if (e.target.id === 'modalOverlay') closeModal();
});

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeModal();
    hideOpenerMenu();
  }
});

// ==================== INITIALIZE ====================
async function init() {
  document.getElementById('contentArea').innerHTML = '<div style="text-align: center; padding: 2rem; color: #8e8e93;">Loading data...</div>';
  
  await Promise.all([
    loadSentencesFromJSON(),
    loadOpenersFromJSON()
  ]);
  
  resetParagraph();
  render();
}

init();
</script>
</body>
</html>
