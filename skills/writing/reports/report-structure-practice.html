<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>INTUITY - Report Structures Guide</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700;800;900&family=DM+Sans:wght@400;500;600;700;800&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'DM Sans', sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0a0a0a 100%);
      color: #e5e5e7;
      min-height: 100vh;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: radial-gradient(circle at 30% 20%, rgba(201, 169, 97, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 70% 80%, rgba(201, 169, 97, 0.08) 0%, transparent 45%);
      pointer-events: none;
      z-index: 0;
    }

    .container {
      position: relative;
      z-index: 2;
      max-width: 900px;
      margin: 0 auto;
      padding: 0.5rem;
    }

    /* UNIFIED HEADER */
    .global-header {
      background: rgba(28, 28, 30, 0.95);
      backdrop-filter: blur(40px);
      border-bottom: 1px solid rgba(84, 84, 88, 0.3);
      padding: 0.75rem 1.5rem;
      margin-bottom: 1rem;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .header-row-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .brand {
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
    }

    .header-brand-logo {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.4rem;
      font-weight: 700;
      background: linear-gradient(135deg, #C9A961 0%, rgba(255,255,255,0.85) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-transform: uppercase;
      letter-spacing: -0.04em;
    }

    .header-brand-subtitle {
      font-size: 0.7rem;
      color: #636366;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-family: 'IBM Plex Mono', monospace;
    }

    .home-link {
      color: #8e8e93;
      text-decoration: none;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.4rem 0.75rem;
      border-radius: 0.5rem;
      transition: all 0.3s;
    }

    .home-link:hover {
      color: #C9A961;
      background: rgba(201, 169, 97, 0.1);
    }

    /* MODE TABS */
    .mode-tabs {
      display: flex;
      gap: 0.25rem;
      padding: 0.25rem;
      border-radius: 0.625rem;
    }

    .tab {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.125rem;
      padding: 0.375rem 0.5rem;
      background: transparent;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      color: #8e8e93;
    }

    .tab:hover {
      background: rgba(142, 142, 147, 0.1);
    }

    .tab.active {
      background: rgba(201, 169, 97, 0.15);
      color: #C9A961;
    }

    .tab-icon {
      font-size: 1.125rem;
      line-height: 1;
    }

    .tab-label {
      font-size: 0.625rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
      font-family: 'DM Sans', sans-serif;
    }
    
    /* CENTRAL CARD */
    .unified-box {
      background: rgba(28, 28, 30, 0.6);
      backdrop-filter: blur(40px);
      border-radius: 1.25rem;
      border: 1px solid rgba(84, 84, 88, 0.25);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      overflow: hidden;
      margin-bottom: 1.5rem;
      margin-top: 0.5rem;
    }

    /* REPORT TYPE SELECTOR - HIDDEN (students focus on universal structure) */
    .type-selector-section {
      display: none;
    }

    .type-btn {
      flex-shrink: 0;
      padding: 0.4rem 0.9rem;
      background: transparent;
      border: none;
      color: #8e8e93;
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: capitalize;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'DM Sans', sans-serif;
      white-space: nowrap;
      min-height: 36px;
    }

    .type-btn:hover {
      background: rgba(255, 255, 255, 0.03);
      color: #C9A961;
    }

    .type-btn:active {
      transform: scale(0.98);
    }

    .type-btn.active {
      color: #C9A961;
      font-weight: 600;
      background: transparent;
    }

    /* PARAGRAPH NAVIGATION */
    .paragraph-nav {
      padding: 0.6rem 1rem;
      background: rgba(0, 0, 0, 0.08);
      border-bottom: 1px solid rgba(84, 84, 88, 0.15);
      display: flex;
      gap: 0.4rem;
      overflow-x: auto;
      scrollbar-width: none;
      justify-content: center;
      flex-wrap: wrap;
    }

    .paragraph-nav::-webkit-scrollbar {
      display: none;
    }

    .para-btn {
      flex-shrink: 0;
      padding: 0.35rem 0.75rem;
      background: transparent;
      border: none;
      color: #8e8e93;
      font-size: 0.7rem;
      font-weight: 500;
      text-transform: capitalize;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'DM Sans', sans-serif;
      white-space: nowrap;
      min-height: 32px;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .para-btn:hover {
      background: rgba(255, 255, 255, 0.03);
      color: #C9A961;
    }

    .para-btn:active {
      transform: scale(0.98);
    }

    .para-btn.active {
      color: #C9A961;
      font-weight: 600;
      background: transparent;
    }

    /* VIEW MODE TOGGLE + TOP ACTION BUTTONS */
    .view-toggle-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1rem;
      background: rgba(0, 0, 0, 0.1);
      border-bottom: 1px solid rgba(84, 84, 88, 0.15);
      gap: 1rem;
      flex-wrap: wrap;
    }

    .view-toggle-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .view-mode-label {
      font-size: 0.7rem;
      color: #636366;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-family: 'IBM Plex Mono', monospace;
    }

    .view-toggle-group {
      display: flex;
      gap: 0.5rem;
    }

    .view-option {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.5rem 1rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #8e8e93;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
      background: transparent;
    }

    .view-option:hover {
      background: rgba(142, 142, 147, 0.1);
      color: #9ca3af;
    }

    .view-option.active {
      background: rgba(201, 169, 97, 0.15);
      color: #C9A961;
    }

    .view-option span:first-child {
      font-size: 1.125rem;
    }

    /* TOP ACTION BUTTONS */
    .top-action-buttons {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .xray-btn {
      padding: 0.5rem 1rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
      color: #C9A961;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      min-height: 44px;
      min-width: 44px;
      font-family: 'IBM Plex Mono', monospace;
      letter-spacing: 0.05em;
      position: relative;
      overflow: hidden;
    }

    .xray-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle, rgba(201, 169, 97, 0.2), transparent);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .xray-btn:hover::before {
      opacity: 1;
    }

    .xray-btn:hover {
      background: rgba(0, 0, 0, 0.7);
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(201, 169, 97, 0.2);
    }

    .xray-btn:active {
      transform: scale(0.95);
    }

    .xray-btn.hidden {
      display: none;
    }

    .phrase-toggle-btn {
      padding: 0.5rem 1rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
      color: #10b981;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      min-height: 44px;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-family: 'IBM Plex Mono', monospace;
      letter-spacing: 0.05em;
      position: relative;
      overflow: hidden;
    }

    .phrase-toggle-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle, rgba(16, 185, 129, 0.2), transparent);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .phrase-toggle-btn:hover::before {
      opacity: 1;
    }

    .phrase-toggle-btn:hover {
      background: rgba(16, 185, 129, 0.15);
      border-color: rgba(16, 185, 129, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(16, 185, 129, 0.2);
    }

    .phrase-toggle-btn:active {
      transform: scale(0.95);
    }

    .phrase-toggle-btn.active {
      background: rgba(16, 185, 129, 0.2);
      border-color: rgba(16, 185, 129, 0.4);
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
    }

    .phrase-toggle-btn.hidden {
      display: none;
    }

    /* CONTENT AREA */
    .content-area {
      padding: 2rem 1.5rem;
      min-height: 500px;
      scroll-behavior: smooth;
      position: relative;
    }

    /* Phrase Status */
    .phrase-status {
      position: absolute;
      top: 1rem;
      left: 1rem;
      font-size: 0.65rem;
      color: #636366;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      opacity: 0;
      transition: opacity 0.3s;
      font-family: 'IBM Plex Mono', monospace;
      z-index: 10;
    }

    .phrase-status.visible {
      opacity: 1;
    }

    .phrase-status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #10b981;
      animation: pulse-glow 2s ease-in-out infinite;
    }

    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 4px rgba(16, 185, 129, 0.4); }
      50% { box-shadow: 0 0 12px rgba(16, 185, 129, 0.8); }
    }

    /* VIEW MODES */
    .view-mode {
      display: none;
    }

    .view-mode.active {
      display: block;
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ============ LIBRARY VIEW ============ */
    .section-card {
      background: linear-gradient(145deg, rgba(25, 25, 27, 0.6), rgba(15, 15, 17, 0.8));
      border-left: 4px solid #C9A961;
      border-radius: 0.75rem;
      padding: 1.25rem 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 
        8px 8px 16px rgba(0, 0, 0, 0.4),
        -4px -4px 12px rgba(40, 40, 42, 0.1);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .section-label {
      font-size: 0.65rem;
      color: #ff9500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 600;
      padding: 0.2rem 0.5rem;
      background: rgba(255, 149, 0, 0.1);
      border-radius: 0.375rem;
      border: 1px solid rgba(255, 149, 0, 0.2);
    }

    .section-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: #e5e5e7;
      font-family: 'Space Grotesk', sans-serif;
    }

    .section-purpose-text {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 1rem;
      font-style: italic;
    }

    .phrase-list {
      display: flex;
      flex-direction: column;
      gap: 0.625rem;
    }

    .phrase-item {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.625rem 0.875rem;
      background: rgba(0, 0, 0, 0.25);
      border-radius: 0.5rem;
      transition: all 0.3s;
      border-left: 2px solid transparent;
      cursor: pointer;
    }

    .phrase-item:hover {
      background: rgba(201, 169, 97, 0.08);
      border-left-color: #C9A961;
      transform: translateX(3px);
    }

    .phrase-item:active {
      transform: translateX(3px) scale(0.98);
    }

    .phrase-bullet {
      color: #C9A961;
      font-weight: 700;
      font-size: 1rem;
      line-height: 1.6;
      flex-shrink: 0;
    }

    .phrase-content {
      flex: 1;
    }

    .variation-label {
      font-size: 0.7rem;
      color: #ff9500;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.375rem;
      display: inline-block;
      padding: 0.125rem 0.5rem;
      background: rgba(255, 149, 0, 0.1);
      border-radius: 0.25rem;
    }

    .phrase-text {
      color: #e5e7eb;
      font-size: 0.9rem;
      line-height: 1.6;
      font-weight: 500;
      display: block;
    }

    .phrase-highlight {
      color: #7dd3fc;
      font-weight: 600;
    }

    /* X-Ray Highlighting */
    .phrase-text .discourse,
    .phrase-text .formal,
    .phrase-text .recommend {
      color: inherit;
      font-weight: inherit;
      border-bottom: none;
      padding-bottom: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .phrase-text.xray-active .discourse,
    .phrase-text.xray-active .formal,
    .phrase-text.xray-active .recommend {
      color: #7dd3fc !important;
      font-weight: 600 !important;
      border-bottom: 2px solid rgba(125, 211, 252, 0.4) !important;
      padding-bottom: 2px !important;
      text-shadow: 0 0 8px rgba(125, 211, 252, 0.2);
    }

    /* Phrase Explorer */
    .phrase-enhanced {
      position: relative;
      display: inline;
      color: inherit;
    }

    .phrase-hint-btn {
      display: none;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      margin-left: 3px;
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 50%;
      font-size: 11px;
      cursor: pointer;
      opacity: 0.75;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      vertical-align: middle;
      position: relative;
      top: -2px;
      padding: 0;
    }

    .content-area.phrase-explorer-active .phrase-hint-btn {
      display: inline-flex;
      animation: hintAppear 0.3s ease-out;
    }

    @keyframes hintAppear {
      from { opacity: 0; transform: scale(0); }
      to { opacity: 0.75; transform: scale(1); }
    }

    .phrase-hint-btn:hover {
      opacity: 1;
      background: rgba(16, 185, 129, 0.25);
      transform: scale(1.2);
      box-shadow: 0 0 16px rgba(16, 185, 129, 0.5);
    }

    .phrase-hint-btn:active {
      transform: scale(0.95);
    }

    /* ============ SLIDES VIEW ============ */
    .slides-container {
      padding: 2rem 0;
    }

    .slide-card {
      background: linear-gradient(145deg, rgba(25, 25, 27, 0.7), rgba(15, 15, 17, 0.9));
      border: 1px solid rgba(84, 84, 88, 0.25);
      border-radius: 1rem;
      padding: 2.5rem 2rem;
      min-height: 450px;
      display: flex;
      flex-direction: column;
      box-shadow: 
        0 20px 60px rgba(0, 0, 0, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      position: relative;
      overflow: hidden;
    }

    .slide-card::before {
      content: '';
      position: absolute;
      top: -80px;
      right: -80px;
      width: 250px;
      height: 250px;
      background: radial-gradient(circle, rgba(201, 169, 97, 0.15) 0%, transparent 70%);
      pointer-events: none;
    }

    /* SOUND ICON */
    .sound-icon {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: rgba(28, 28, 30, 0.7);
      border: 1px solid rgba(84, 84, 88, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.125rem;
      z-index: 10;
      color: #636366;
      opacity: 0.6;
    }

    .sound-icon:hover {
      background: rgba(201, 169, 97, 0.2);
      border-color: rgba(201, 169, 97, 0.4);
      transform: scale(1.05);
      opacity: 1;
    }

    .sound-icon.active {
      color: #C9A961;
      border-color: rgba(201, 169, 97, 0.5);
      background: rgba(201, 169, 97, 0.15);
      opacity: 1;
    }

    .section-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0.875rem;
      background: rgba(201, 169, 97, 0.1);
      border: 1px solid rgba(201, 169, 97, 0.3);
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
      color: #C9A961;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 1.25rem;
      align-self: flex-start;
    }

    .slide-purpose {
      font-size: 0.875rem;
      color: #9ca3af;
      line-height: 1.5;
      margin-bottom: 2rem;
      font-style: italic;
    }

    .phrase-showcase {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem 0;
    }

    .phrase-display {
      font-size: 1.35rem;
      line-height: 1.7;
      color: #e5e5e7;
      text-align: center;
      font-weight: 400;
      max-width: 700px;
      animation: phraseAppear 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes phraseAppear {
      from { 
        opacity: 0; 
        transform: translateY(15px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }

    .phrase-display .bracket {
      color: #ffd89c;
      font-weight: 600;
      background: rgba(255, 216, 156, 0.12);
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
    }

    /* X-Ray in Slides */
    .phrase-display .discourse,
    .phrase-display .formal,
    .phrase-display .recommend {
      color: inherit;
      font-weight: inherit;
      border-bottom: none;
      padding-bottom: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .phrase-display.xray-active .discourse,
    .phrase-display.xray-active .formal,
    .phrase-display.xray-active .recommend {
      color: #7dd3fc !important;
      font-weight: 600 !important;
      border-bottom: 2px solid rgba(125, 211, 252, 0.4) !important;
      padding-bottom: 2px !important;
      text-shadow: 0 0 8px rgba(125, 211, 252, 0.2);
    }

    .slide-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid rgba(84, 84, 88, 0.2);
    }

    .progress-info {
      display: flex;
      align-items: center;
      gap: 0.875rem;
      color: #636366;
      font-size: 0.8125rem;
      font-weight: 600;
    }

    .progress-bar {
      width: 100px;
      height: 3px;
      background: rgba(201, 169, 97, 0.2);
      border-radius: 999px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #C9A961, #d4a574);
      border-radius: 999px;
      transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 8px rgba(201, 169, 97, 0.5);
    }

    .slide-nav {
      display: flex;
      gap: 0.625rem;
    }

    .slide-nav-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(28, 28, 30, 0.6);
      border: 1px solid rgba(84, 84, 88, 0.25);
      color: #C9A961;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .slide-nav-btn:hover:not(:disabled) {
      background: rgba(201, 169, 97, 0.2);
      border-color: rgba(201, 169, 97, 0.4);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(201, 169, 97, 0.3);
    }

    .slide-nav-btn:active:not(:disabled) {
      transform: translateY(0);
    }

    .slide-nav-btn:disabled {
      opacity: 0.2;
      cursor: not-allowed;
    }

    .slide-nav-btn.play {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #C9A961, #d4a574);
      border-color: transparent;
      color: #0a0a0a;
      font-weight: 700;
    }

    .slide-nav-btn.play:hover {
      transform: scale(1.05);
    }

    /* FOOTER */
    .footer-actions {
      padding: 0.85rem 1rem;
      background: rgba(0, 0, 0, 0.2);
      border-top: 1px solid rgba(84, 84, 88, 0.2);
      display: flex;
      justify-content: center;
      gap: 0.75rem;
    }

    .action-btn {
      padding: 0.5rem 1.25rem;
      background: rgba(28, 28, 30, 0.6);
      border: 1px solid rgba(84, 84, 88, 0.25);
      border-radius: 999px;
      color: #C9A961;
      font-size: 0.7rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'DM Sans';
      text-transform: uppercase;
      letter-spacing: 0.05em;
      min-height: 44px;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .action-btn:hover {
      background: rgba(201, 169, 97, 0.15);
      border-color: rgba(201, 169, 97, 0.4);
      transform: translateY(-1px);
    }

    .action-btn:active {
      transform: scale(0.95);
    }

    /* SLIDE CONTROLS BAR */
    .slide-controls-bar {
      padding: 1rem;
      background: rgba(0, 0, 0, 0.25);
      border-top: 1px solid rgba(84, 84, 88, 0.2);
      display: flex;
      justify-content: center;
      gap: 1rem;
    }

    .slide-control-btn {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: rgba(28, 28, 30, 0.7);
      border: 1px solid rgba(84, 84, 88, 0.3);
      color: #C9A961;
      font-size: 1.25rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
    }

    .slide-control-btn:hover:not(:disabled) {
      background: rgba(201, 169, 97, 0.2);
      border-color: rgba(201, 169, 97, 0.4);
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(201, 169, 97, 0.3);
    }

    .slide-control-btn:active:not(:disabled) {
      transform: translateY(-1px);
    }

    .slide-control-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .slide-control-btn:first-child {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, #C9A961, #d4a574);
      border-color: transparent;
      color: #0a0a0a;
      font-weight: 700;
      box-shadow: 0 8px 24px rgba(201, 169, 97, 0.4);
    }

    .slide-control-btn:first-child:hover {
      transform: scale(1.08);
      box-shadow: 0 12px 32px rgba(201, 169, 97, 0.5);
    }

    /* ============ SKELETON VIEW ============ */
    .skeleton-container {
      padding: 2rem 1.5rem;
      min-height: 500px;
    }

    .skeleton-card {
      background: linear-gradient(145deg, rgba(25, 25, 27, 0.7), rgba(15, 15, 17, 0.9));
      border: 1px solid rgba(84, 84, 88, 0.25);
      border-radius: 1rem;
      padding: 2.5rem;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      margin-bottom: 2rem;
    }

    .skeleton-section {
      margin-bottom: 2.5rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid rgba(84, 84, 88, 0.2);
    }

    .skeleton-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .skeleton-section-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .skeleton-section-icon {
      font-size: 1.5rem;
    }

    .skeleton-section-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.125rem;
      font-weight: 700;
      color: #C9A961;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .skeleton-section-text {
      font-size: 1rem;
      line-height: 1.8;
      color: #e5e7eb;
      font-weight: 400;
    }

    /* X-Ray in Skeleton */
    .skeleton-section-text .discourse,
    .skeleton-section-text .formal,
    .skeleton-section-text .recommend {
      color: inherit;
      font-weight: inherit;
      border-bottom: none;
      padding-bottom: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .skeleton-section-text.xray-active .discourse,
    .skeleton-section-text.xray-active .formal,
    .skeleton-section-text.xray-active .recommend {
      color: #7dd3fc !important;
      font-weight: 600 !important;
      border-bottom: 2px solid rgba(125, 211, 252, 0.4) !important;
      padding-bottom: 2px !important;
      text-shadow: 0 0 8px rgba(125, 211, 252, 0.2);
    }

    /* ============ ENHANCED X-RAY: POSITIVE & NEGATIVE ============ */
    /* Positive evaluation - Green */
    .phrase-text .positive,
    .phrase-display .positive,
    .skeleton-section-text .positive {
      color: inherit;
      font-weight: inherit;
      border-bottom: none;
      padding-bottom: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .phrase-text.xray-active .positive,
    .phrase-display.xray-active .positive,
    .skeleton-section-text.xray-active .positive {
      color: #10b981 !important;
      font-weight: 600 !important;
      border-bottom: 2px solid rgba(16, 185, 129, 0.4) !important;
      padding-bottom: 2px !important;
      text-shadow: 0 0 8px rgba(16, 185, 129, 0.2);
    }

    /* Negative evaluation - Amber */
    .phrase-text .negative,
    .phrase-display .negative,
    .skeleton-section-text .negative {
      color: inherit;
      font-weight: inherit;
      border-bottom: none;
      padding-bottom: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .phrase-text.xray-active .negative,
    .phrase-display.xray-active .negative,
    .skeleton-section-text.xray-active .negative {
      color: #f59e0b !important;
      font-weight: 600 !important;
      border-bottom: 2px solid rgba(245, 158, 11, 0.4) !important;
      padding-bottom: 2px !important;
      text-shadow: 0 0 8px rgba(245, 158, 11, 0.2);
    }

    .skeleton-nav {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1.5rem;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 0.75rem;
    }

    .skeleton-nav-btn {
      padding: 0.625rem 1.5rem;
      background: rgba(28, 28, 30, 0.6);
      border: 1px solid rgba(84, 84, 88, 0.3);
      border-radius: 999px;
      color: #C9A961;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'DM Sans';
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .skeleton-nav-btn:hover:not(:disabled) {
      background: rgba(201, 169, 97, 0.15);
      border-color: rgba(201, 169, 97, 0.4);
      transform: translateY(-1px);
    }

    .skeleton-nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .skeleton-btn-gen {
      padding: 0.75rem 1.75rem;
      background: linear-gradient(135deg, #C9A961, #d4a574);
      border: none;
      border-radius: 999px;
      color: #0a0a0a;
      font-size: 0.8rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'DM Sans';
      text-transform: uppercase;
      letter-spacing: 0.05em;
      box-shadow: 0 4px 12px rgba(201, 169, 97, 0.3);
    }

    .skeleton-btn-gen:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(201, 169, 97, 0.5);
    }

    .skeleton-btn-gen:active {
      transform: translateY(0);
    }

    .skeleton-counter {
      font-size: 0.875rem;
      color: #8e8e93;
      font-weight: 600;
      min-width: 80px;
      text-align: center;
    }

    /* LOADING STATE */
    .loading {
      text-align: center;
      padding: 3rem;
      color: #8e8e93;
      font-size: 0.875rem;
    }

    .loading-sub {
      font-size: 0.75rem;
      color: #636366;
      margin-top: 0.5rem;
    }

    /* ERROR STATE */
    .error-state {
      text-align: center;
      padding: 3rem;
    }

    .error-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .error-title {
      font-size: 1.125rem;
      color: #f5f5f7;
      margin-bottom: 0.5rem;
    }

    .error-message {
      font-size: 0.875rem;
      color: #8e8e93;
      margin-bottom: 1rem;
    }

    /* ALTERNATIVES MODAL */
    .alternatives-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(6px);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      animation: fadeInModal 0.2s ease;
    }

    .alternatives-modal-overlay.active {
      display: flex;
    }

    @keyframes fadeInModal {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .alternatives-modal {
      position: relative;
      background: rgba(20, 20, 22, 0.98);
      backdrop-filter: blur(30px);
      border-radius: 1.25rem;
      border: 1px solid rgba(16, 185, 129, 0.3);
      max-width: 520px;
      width: 100%;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9),
                  0 0 40px rgba(16, 185, 129, 0.15);
      animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideUp {
      from { transform: translateY(30px) scale(0.95); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }

    .modal-header {
      padding: 1.5rem 2rem;
      background: linear-gradient(145deg, rgba(16, 185, 129, 0.1), rgba(0, 0, 0, 0.3));
      border-bottom: 1px solid rgba(16, 185, 129, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.25rem;
      font-weight: 700;
      color: #10b981;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      letter-spacing: -0.01em;
    }

    .modal-close {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #8e8e93;
      font-size: 1.25rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #e5e5e7;
      transform: rotate(90deg);
    }

    .modal-close:active {
      transform: rotate(90deg) scale(0.95);
    }

    .modal-body {
      padding: 2rem;
      max-height: calc(80vh - 100px);
      overflow-y: auto;
    }

    .modal-body::-webkit-scrollbar {
      width: 8px;
    }

    .modal-body::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
    }

    .modal-body::-webkit-scrollbar-thumb {
      background: rgba(201, 169, 97, 0.3);
      border-radius: 4px;
    }

    .modal-body::-webkit-scrollbar-thumb:hover {
      background: rgba(201, 169, 97, 0.5);
    }

    .current-phrase-section {
      background: rgba(16, 185, 129, 0.08);
      border-left: 3px solid #10b981;
      border-radius: 0.75rem;
      padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
    }

    .current-phrase-label {
      font-size: 0.65rem;
      color: #10b981;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 700;
      margin-bottom: 0.5rem;
      font-family: 'IBM Plex Mono', monospace;
    }

    .current-phrase-text {
      font-size: 1.1rem;
      color: #e5e7eb;
      font-weight: 600;
    }

    .alternatives-section {
      margin-bottom: 1rem;
    }

    .alternatives-header {
      font-size: 0.7rem;
      color: #C9A961;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 700;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(201, 169, 97, 0.2);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-family: 'IBM Plex Mono', monospace;
    }

    .phrase-count {
      font-size: 0.6rem;
      color: #8e8e93;
      font-weight: 600;
      background: rgba(0, 0, 0, 0.3);
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
    }

    .alternative-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: 0.875rem 1rem;
      background: rgba(0, 0, 0, 0.25);
      border-radius: 0.625rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border-left: 3px solid transparent;
    }

    .alternative-item:hover {
      background: rgba(16, 185, 129, 0.08);
      border-left-color: #10b981;
      transform: translateX(6px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
    }

    .alternative-text {
      flex: 1;
      color: #e5e7eb;
      font-size: 0.95rem;
      font-weight: 500;
      line-height: 1.4;
    }

    .copy-btn {
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 0.5rem;
      padding: 0.375rem 0.75rem;
      color: #10b981;
      font-size: 0.7rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      opacity: 0;
      flex-shrink: 0;
      font-family: 'IBM Plex Mono', monospace;
    }

    .alternative-item:hover .copy-btn {
      opacity: 1;
    }

    .copy-btn:hover {
      background: rgba(16, 185, 129, 0.25);
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .copy-btn:active {
      transform: scale(0.95);
    }

    /* TOAST */
    .toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(16, 185, 129, 0.95);
      color: #000;
      padding: 0.875rem 1.5rem;
      border-radius: 999px;
      font-size: 0.875rem;
      font-weight: 600;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      z-index: 3000;
      opacity: 0;
      transition: all 0.3s ease;
      font-family: 'IBM Plex Mono', monospace;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* MOBILE OPTIMIZATION */
    @media (max-width: 768px) {
      .container { padding: 0.375rem; }
      .global-header { padding: 0.5rem 0.75rem; margin-bottom: 0.75rem; }
      .header-brand-logo { font-size: 1.2rem; }
      .header-brand-subtitle { font-size: 0.6rem; }
      .tab { padding: 0.3rem 0.25rem; }
      .tab-icon { font-size: 1rem; }
      .tab-label { font-size: 0.5625rem; }
      .type-selector-section { padding: 0.65rem 0.75rem; gap: 0.375rem; }
      .type-btn { padding: 0.4rem 0.75rem; font-size: 0.6rem; }
      .para-btn { padding: 0.4rem 0.75rem; font-size: 0.6rem; }
      .view-toggle-container { flex-direction: column; align-items: stretch; gap: 0.75rem; }
      .view-toggle-left { flex-direction: column; align-items: center; gap: 0.75rem; }
      .top-action-buttons { justify-content: center; width: 100%; }
      .content-area { padding: 1.5rem 1.25rem; min-height: 400px; }
      .slide-card { padding: 2rem 1.5rem; min-height: 380px; }
      .phrase-display { font-size: 1.125rem; }
      .section-card { padding: 1rem 1.25rem; margin-bottom: 1.25rem; }
      .phrase-item { padding: 0.5rem 0.75rem; gap: 0.5rem; }
      .phrase-text { font-size: 0.8rem; }
      .footer-actions { padding: 0.65rem 0.75rem; flex-wrap: wrap; }
      .action-btn { padding: 0.4rem 1rem; font-size: 0.65rem; }
    }

    .content-area::-webkit-scrollbar { width: 6px; }
    .content-area::-webkit-scrollbar-thumb { background: rgba(99, 99, 102, 0.3); border-radius: 6px; }
    .content-area::-webkit-scrollbar-thumb:hover { background: rgba(99, 99, 102, 0.5); }
  </style>
</head>
<body>
  <div class="container">
    
    <header class="global-header">
      <div class="header-row-main">
        <div class="brand">
          <span class="header-brand-logo">INTUITY</span>
          <span class="header-brand-subtitle">Report Structures</span>
        </div>
        <a href="../../../index.html?openModal=writing&submenu=reports" class="home-link">‚Üê Reports</a>
      </div>
      
      <nav class="mode-tabs">
        <a href="report-question-selector.html" class="tab">
          <span class="tab-icon">üìä</span>
          <span class="tab-label">Browse</span>
        </a>
        <a href="report-structure-practice.html" class="tab active">
          <span class="tab-icon">üèóÔ∏è</span>
          <span class="tab-label">Structures</span>
        </a>
        <a href="report-master.html" class="tab">
          <span class="tab-icon">üìñ</span>
          <span class="tab-label">Samples</span>
        </a>
        <a href="report-writer.html?mode=write" class="tab">
          <span class="tab-icon">‚úçÔ∏è</span>
          <span class="tab-label">Write</span>
        </a>
        <a href="report-language.html" class="tab">
          <span class="tab-icon">üìö</span>
          <span class="tab-label">Language</span>
        </a>
      </nav>
    </header>

    <div class="unified-box">
      
      <!-- Type selector removed - students focus on universal structure, not categories -->

      <div class="paragraph-nav" id="paragraphNav"></div>

      <div class="view-toggle-container">
        <div class="view-toggle-left">
          <span class="view-mode-label">View Mode:</span>
          <div class="view-toggle-group">
            <div class="view-option active" id="listOption" onclick="switchViewMode('list')">
              <span>üìö</span>
              <span>List</span>
            </div>
            <div class="view-option" id="slidesOption" onclick="switchViewMode('slides')">
              <span>üé¨</span>
              <span>Slides</span>
            </div>
            <div class="view-option" id="skeletonOption" onclick="switchViewMode('skeleton')">
              <span>üíÄ</span>
              <span>Skeleton</span>
            </div>
          </div>
        </div>

        <div class="top-action-buttons">
          <button class="phrase-toggle-btn hidden" id="phraseToggleBtn" onclick="togglePhraseExplorer()">
            <span>üí°</span>
            <span>Phrases</span>
          </button>
          <button class="xray-btn" id="xrayBtn" onclick="toggleXRay()">X-Ray</button>
        </div>
      </div>

      <div class="content-area" id="contentArea">
        
        <div class="phrase-status" id="phraseStatus">
          <span class="phrase-status-dot"></span>
          <span id="phraseCount">0 phrases detected</span>
        </div>

        <div class="view-mode active" id="listView">
          <div class="loading">
            <div>Loading report structures...</div>
            <div class="loading-sub" id="loadingStatus">Initializing...</div>
          </div>
        </div>

        <div class="view-mode" id="slidesView">
          <div class="slides-container">
            <div class="slide-card">
              
              <div class="sound-icon" id="soundIcon" title="Click to enable sound">
                <span id="soundEmoji">üîá</span>
              </div>

              <div class="section-badge" id="slideSectionBadge">
                <span id="slideSectionIcon">üìù</span>
                <span id="slideSectionName">Loading...</span>
              </div>
              
              <p class="slide-purpose" id="slidePurpose"></p>
              
              <div class="phrase-showcase">
                <p class="phrase-display" id="phraseDisplay">
                  Loading phrases...
                </p>
              </div>

              <div class="slide-controls">
                <div class="progress-info">
                  <span id="currentNum">1</span>
                  <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                  </div>
                  <span id="totalNum">10</span>
                </div>

                <div class="slide-nav">
                  <button class="slide-nav-btn" id="prevBtn" onclick="prevPhrase()">‚Üê</button>
                  <button class="slide-nav-btn play" id="playBtn" onclick="toggleAutoPlay()">‚ñ∂</button>
                  <button class="slide-nav-btn" id="nextBtn" onclick="nextPhrase()">‚Üí</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="view-mode" id="skeletonView">
          <div class="skeleton-container">
            <div class="skeleton-card" id="skeletonCard">
              Loading complete report structure...
            </div>
            <div class="skeleton-nav">
              <button class="skeleton-nav-btn" id="prevSkeletonBtn" onclick="prevSkeleton()">‚Üê Previous</button>
              <span class="skeleton-counter" id="skeletonCounter">1 / 10</span>
              <button class="skeleton-btn-gen" onclick="generateRandomSkeleton()">üé≤ Generate Random</button>
              <button class="skeleton-nav-btn" id="nextSkeletonBtn" onclick="nextSkeleton()">Next ‚Üí</button>
            </div>
          </div>
        </div>

      </div>

      <div class="footer-actions">
        <button class="action-btn" onclick="copyCurrentContent()">
          <span>üìã</span>
          <span id="copyBtnText">Copy All</span>
        </button>
        <button class="action-btn" onclick="shufflePhrases()" id="shuffleBtn">
          <span>üîÄ</span>
          <span>Shuffle</span>
        </button>
        <button class="action-btn" onclick="printGuide()">
          <span>üñ®Ô∏è</span>
          <span>Print</span>
        </button>
      </div>

      <div class="slide-controls-bar" id="slideControlsBar" style="display: none;">
        <button class="slide-control-btn" onclick="toggleAutoPlay()" id="autoPlayBtn">
          <span>‚ñ∂</span>
        </button>
        <button class="slide-control-btn" onclick="prevPhrase()" id="prevSlideBtn">
          <span>‚Üê</span>
        </button>
        <button class="slide-control-btn" onclick="nextPhrase()" id="nextSlideBtn">
          <span>‚Üí</span>
        </button>
        <button class="slide-control-btn" onclick="repeatPhrase()">
          <span>‚Üª</span>
        </button>
      </div>

    </div>

  </div>

  <div class="alternatives-modal-overlay" id="alternativesModal" onclick="closeAlternativesModal(event)">
    <div class="alternatives-modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">
          <span>üí°</span>
          <span>Alternative Expressions</span>
        </div>
        <button class="modal-close" onclick="closeAlternativesModal()">√ó</button>
      </div>
      <div class="modal-body" id="alternativesModalBody"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- JAVASCRIPT CONTINUES IN PART 2 -->
</body>
</html>  <script>
    // ==================== STATE ====================
    let REPORT_STRUCTURES_LIST = null;
    let REPORT_STRUCTURES_SLIDES = null;
    let REPORT_STRUCTURES_SKELETON = null;
    let currentType = null;
    let currentSectionKey = null;
    let currentPhraseIndex = 0;
    let currentPhrases = [];
    let autoPlayInterval = null;
    let isAutoPlaying = false;
    let viewMode = 'list';
    let typeKeys = [];
    let soundEnabled = false;
    let currentUtterance = null;
    let speechFinished = true;
    
    let skeletonSlides = [];
    let currentSkeletonIndex = 0;

    // X-Ray and Phrase Explorer state
    let showXRay = false;
    let phraseExplorerActive = false;
    let phraseDatabase = {};
    let phraseDataLoaded = false;

    const SECTION_ICONS = {
      'introduction': 'üìù',
      'neutral': '‚öñÔ∏è',
      'praising': '‚≠ê',
      'criticising': '‚ö†Ô∏è',
      'recommending': 'üí°',
      'conclusion': '‚úÖ'
    };

    const SECTION_LABELS = {
      'introduction': 'A: Introduction & Context',
      'neutral': 'B: Neutral General Views',
      'praising': 'C: Praising',
      'criticising': 'D: Criticising',
      'recommending': 'E: Recommending',
      'conclusion': 'F: Conclusion'
    };

    // X-Ray patterns to detect functional language
    // X-Ray patterns - loaded from JSON
    let XRAY_PATTERNS = null;
    let xrayPatternsLoaded = false;

    // Load X-Ray patterns from JSON
    async function loadXRayPatterns() {
      try {
        const response = await fetch('data/xray-patterns.json');
        if (!response.ok) {
          console.warn('X-Ray patterns file not found, using fallback patterns');
          return loadFallbackXRayPatterns();
        }
        
        const patterns = await response.json();
        
        // Flatten all pattern categories into our format
        XRAY_PATTERNS = {
          discourse: [
            ...(patterns.discourse_markers?.patterns || []),
            ...(patterns.conclusion_phrases?.patterns || [])
          ],
          formal: [
            ...(patterns.formal_introductions?.patterns || []),
            ...(patterns.methodology_phrases?.patterns || []),
            ...(patterns.neutral_assessment?.patterns || []),
            ...(patterns.emphasis_phrases?.patterns || []),
            ...(patterns.hedging_phrases?.patterns || [])
          ],
          recommend: [
            ...(patterns.recommendation_phrases?.patterns || [])
          ],
          positive: [
            ...(patterns.positive_evaluation?.patterns || [])
          ],
          negative: [
            ...(patterns.negative_evaluation?.patterns || [])
          ]
        };
        
        xrayPatternsLoaded = true;
        console.log('‚úÖ X-Ray patterns loaded from JSON:', {
          discourse: XRAY_PATTERNS.discourse.length,
          formal: XRAY_PATTERNS.formal.length,
          recommend: XRAY_PATTERNS.recommend.length,
          positive: XRAY_PATTERNS.positive.length,
          negative: XRAY_PATTERNS.negative.length
        });
        
      } catch (error) {
        console.error('Error loading X-Ray patterns:', error);
        loadFallbackXRayPatterns();
      }
    }

    function loadFallbackXRayPatterns() {
      // Minimal fallback if JSON doesn't load
      XRAY_PATTERNS = {
        discourse: ['however', 'furthermore', 'in conclusion', 'overall', 'on the whole'],
        formal: ['the aim of this report', 'based on', 'according to', 'it is recommended that'],
        recommend: ['to improve', 'it would be advisable', 'a practical step'],
        positive: ['worked really well', 'a definite strength'],
        negative: ['a common complaint', 'one major issue']
      };
      xrayPatternsLoaded = true;
      console.log('‚ö†Ô∏è Using fallback X-Ray patterns');
    }

    function escapeRegex(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // ==================== INITIALIZATION ====================
    async function init() {
      try {
        updateLoadingStatus('Loading structures data...');
        
        const [listResponse, slidesResponse, skeletonResponse] = await Promise.all([
          fetch('data/report-structures.json'),
          fetch('data/report-structures-text.json'),
          fetch('data/report-structures-skeleton.json')
        ]);
        
        if (!listResponse.ok) {
          throw new Error(`Failed to load report-structures.json (${listResponse.status})`);
        }
        if (!slidesResponse.ok) {
          throw new Error(`Failed to load report-structures-text.json (${slidesResponse.status})`);
        }
        if (!skeletonResponse.ok) {
          throw new Error(`Failed to load report-structures-skeleton.json (${skeletonResponse.status})`);
        }
        
        REPORT_STRUCTURES_LIST = await listResponse.json();
        REPORT_STRUCTURES_SLIDES = await slidesResponse.json();
        REPORT_STRUCTURES_SKELETON = await skeletonResponse.json();
        
        console.log('‚úÖ List structures loaded:', Object.keys(REPORT_STRUCTURES_LIST).length, 'types');
        console.log('‚úÖ Slides structures loaded:', Object.keys(REPORT_STRUCTURES_SLIDES).length, 'types');
        console.log('‚úÖ Skeleton structures loaded:', Object.keys(REPORT_STRUCTURES_SKELETON).length, 'types');
        
        updateLoadingStatus('Loading phrase database...');
        await loadPhraseDatabase();
        
        updateLoadingStatus('Loading X-Ray patterns...');
        await loadXRayPatterns();
        
        typeKeys = Object.keys(REPORT_STRUCTURES_LIST);
        
        if (typeKeys.length === 0) {
          throw new Error('No report structures found in data');
        }
        
        // Lock to 'educational' as the universal template
        // Students learn ONE structure that works for all topics
        currentType = 'educational';
        currentSectionKey = 'all';
        
        // buildTypeSelector() removed - no need for confusing type tabs
        buildParagraphNav();
        setupViewToggle();
        setupSoundIcon();
        initializeSkeleton();
        renderAllSections();
        
      } catch (error) {
        console.error('Error loading structures:', error);
        showError(error.message);
      }
    }

    function updateLoadingStatus(message) {
      const status = document.getElementById('loadingStatus');
      if (status) status.textContent = message;
    }

    function showError(message) {
      const container = document.getElementById('listView');
      container.innerHTML = `
        <div class="error-state">
          <div class="error-icon">‚ö†Ô∏è</div>
          <div class="error-title">Error Loading Structures</div>
          <div class="error-message">${escapeHtml(message)}</div>
          <button class="action-btn" onclick="location.reload()" style="margin: 0 auto;">
            <span>üîÑ</span>
            <span>Reload</span>
          </button>
        </div>
      `;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ==================== PHRASE DATABASE LOADING ====================
    async function loadPhraseDatabase() {
      try {
        // Extract phrases directly from the report structures we've already loaded
        if (REPORT_STRUCTURES_LIST) {
          Object.entries(REPORT_STRUCTURES_LIST).forEach(([reportType, structure]) => {
            if (structure.sections) {
              Object.entries(structure.sections).forEach(([sectionKey, section]) => {
                const source = `${structure.title} - ${section.label}`;
                
                // Extract from phrases array
                if (section.phrases && Array.isArray(section.phrases)) {
                  buildPhraseDatabaseFromArray(section.phrases, source);
                }
                
                // Extract from examples array
                if (section.examples && Array.isArray(section.examples)) {
                  const phrases = section.examples.map(ex => ex.text || ex);
                  buildPhraseDatabaseFromArray(phrases, source);
                }
              });
            }
          });
        }

        const phraseCount = Object.keys(phraseDatabase).length;
        phraseDataLoaded = phraseCount > 0;
        
        console.log(`‚úÖ Phrase database loaded: ${phraseCount} phrases from report structures`);
        
        const toggleBtn = document.getElementById('phraseToggleBtn');
        if (toggleBtn) {
          toggleBtn.classList.toggle('hidden', !phraseDataLoaded);
        }

      } catch (error) {
        console.warn('Phrase database loading error:', error);
        phraseDataLoaded = false;
        const toggleBtn = document.getElementById('phraseToggleBtn');
        if (toggleBtn) {
          toggleBtn.classList.add('hidden');
        }
      }
    }

    function buildPhraseDatabaseFromArray(phrases, source) {
      phrases.forEach(phrase => {
        if (typeof phrase !== 'string') return;
        
        // Clean the phrase
        const cleanPhrase = phrase
          .replace(/\[([^\]]+)\]/g, '$1') // Remove brackets but keep content
          .replace(/[.,;:!?]+$/, '') // Remove trailing punctuation
          .trim();
        
        // Only include phrases with at least 2 words
        if (cleanPhrase.split(/\s+/).length < 2) return;
        
        // Add to database with source
        if (!phraseDatabase[cleanPhrase]) {
          phraseDatabase[cleanPhrase] = {
            category: source,
            alternatives: []
          };
        }
      });
    }

    // ==================== X-RAY FUNCTIONALITY ====================
    function toggleXRay() {
      showXRay = !showXRay;
      document.getElementById('xrayBtn').textContent = showXRay ? 'Normal' : 'X-Ray';
      applyXRay();
    }

    function applyXRay() {
      document.querySelectorAll('.phrase-text').forEach(el => {
        el.classList.toggle('xray-active', showXRay);
      });

      const phraseDisplay = document.getElementById('phraseDisplay');
      if (phraseDisplay) {
        phraseDisplay.classList.toggle('xray-active', showXRay);
      }

      document.querySelectorAll('.skeleton-section-text').forEach(el => {
        el.classList.toggle('xray-active', showXRay);
      });
    }

    function wrapXRayPatterns(text) {
      if (!xrayPatternsLoaded || !XRAY_PATTERNS) return text;
      
      let wrapped = text;
      
      // Wrap discourse markers (cyan)
      if (XRAY_PATTERNS.discourse) {
        XRAY_PATTERNS.discourse.forEach(pattern => {
          const regex = new RegExp(`\\b(${escapeRegex(pattern)})\\b`, 'gi');
          wrapped = wrapped.replace(regex, '<span class="discourse">$1</span>');
        });
      }

      // Wrap formal phrases (cyan)
      if (XRAY_PATTERNS.formal) {
        XRAY_PATTERNS.formal.forEach(pattern => {
          const regex = new RegExp(`(${escapeRegex(pattern)})`, 'gi');
          wrapped = wrapped.replace(regex, '<span class="formal">$1</span>');
        });
      }

      // Wrap recommendation phrases (cyan)
      if (XRAY_PATTERNS.recommend) {
        XRAY_PATTERNS.recommend.forEach(pattern => {
          const regex = new RegExp(`(${escapeRegex(pattern)})`, 'gi');
          wrapped = wrapped.replace(regex, '<span class="recommend">$1</span>');
        });
      }

      // Wrap positive evaluation (green)
      if (XRAY_PATTERNS.positive) {
        XRAY_PATTERNS.positive.forEach(pattern => {
          const regex = new RegExp(`(${escapeRegex(pattern)})`, 'gi');
          wrapped = wrapped.replace(regex, '<span class="positive">$1</span>');
        });
      }

      // Wrap negative evaluation (amber)
      if (XRAY_PATTERNS.negative) {
        XRAY_PATTERNS.negative.forEach(pattern => {
          const regex = new RegExp(`(${escapeRegex(pattern)})`, 'gi');
          wrapped = wrapped.replace(regex, '<span class="negative">$1</span>');
        });
      }

      return wrapped;
    }

    // ==================== PHRASE EXPLORER FUNCTIONALITY ====================
    function togglePhraseExplorer() {
      phraseExplorerActive = !phraseExplorerActive;
      
      const btn = document.getElementById('phraseToggleBtn');
      btn.classList.toggle('active', phraseExplorerActive);
      
      const contentArea = document.querySelector('.content-area');
      contentArea.classList.toggle('phrase-explorer-active', phraseExplorerActive);
      
      const status = document.getElementById('phraseStatus');
      status.classList.toggle('visible', phraseExplorerActive);
      
      if (viewMode === 'list') {
        if (currentSectionKey === 'all') {
          renderAllSections();
        } else {
          renderList(currentType, currentSectionKey);
        }
      } else if (viewMode === 'slides') {
        renderPhrase();
      } else if (viewMode === 'skeleton') {
        renderSkeletonSlide();
      }
    }

    function enhanceWithPhraseHints(htmlContent) {
      if (!phraseDataLoaded || Object.keys(phraseDatabase).length === 0 || !phraseExplorerActive) {
        return { html: htmlContent, count: 0 };
      }

      let enhanced = htmlContent;
      let matchCount = 0;
      const matchedPhrases = new Set();

      const sortedPhrases = Object.keys(phraseDatabase)
        .filter(p => phraseDatabase[p].alternatives.length > 0)
        .sort((a, b) => b.length - a.length);

      sortedPhrases.forEach(phrase => {
        const escapedPhrase = phrase.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`(?<!<[^>]*)\\b(${escapedPhrase})\\b(?![^<]*>)`, 'gi');
        
        enhanced = enhanced.replace(regex, (match) => {
          if (matchedPhrases.has(match.toLowerCase())) return match;
          
          matchedPhrases.add(match.toLowerCase());
          matchCount++;
          
          const escapedPhraseForJs = phrase.replace(/'/g, "\\'").replace(/"/g, '\\"');
          return `<span class="phrase-enhanced">${match}<button class="phrase-hint-btn" onclick="event.stopPropagation(); showAlternatives('${escapedPhraseForJs}')" title="${phraseDatabase[phrase].alternatives.length} alternatives">üí°</button></span>`;
        });
      });

      return { html: enhanced, count: matchCount };
    }

    function showAlternatives(phrase) {
      const data = phraseDatabase[phrase];
      
      if (!data || !data.alternatives || data.alternatives.length === 0) {
        console.warn('No alternatives found for:', phrase);
        showToast('No alternatives available', false);
        return;
      }

      const modalBody = document.getElementById('alternativesModalBody');
      
      let html = `
        <div class="current-phrase-section">
          <div class="current-phrase-label">Currently Used</div>
          <div class="current-phrase-text">${escapeHtml(phrase)}</div>
        </div>

        <div class="alternatives-section">
          <div class="alternatives-header">
            <span>üìö</span>
            <span>${escapeHtml(data.category)}</span>
            <span class="phrase-count">${data.alternatives.length} alternatives</span>
          </div>
      `;

      data.alternatives.forEach(alt => {
        const escapedAlt = alt.replace(/'/g, "\\'").replace(/"/g, '\\"');
        html += `
          <div class="alternative-item" onclick="copyAlternative('${escapedAlt}')">
            <span class="alternative-text">${escapeHtml(alt)}</span>
            <button class="copy-btn" onclick="event.stopPropagation(); copyAlternative('${escapedAlt}')">Copy</button>
          </div>
        `;
      });

      html += `</div>`;
      
      modalBody.innerHTML = html;
      document.getElementById('alternativesModal').classList.add('active');
    }

    function closeAlternativesModal(event) {
      if (!event || event.target.id === 'alternativesModal') {
        document.getElementById('alternativesModal').classList.remove('active');
      }
    }

    function copyAlternative(text) {
      navigator.clipboard.writeText(text).then(() => {
        showToast(`Copied: "${text}" ‚úì`);
      }).catch(err => {
        console.error('Failed to copy:', err);
        showToast('Failed to copy', false);
      });
    }

    // ==================== DATA ACCESS HELPER ====================
    function getCurrentDataset() {
      return viewMode === 'list' ? REPORT_STRUCTURES_LIST : REPORT_STRUCTURES_SLIDES;
    }

    // ==================== VIEW MODE SWITCHING ====================
    function switchViewMode(mode) {
      if (mode === viewMode) return;
      
      viewMode = mode;
      
      document.querySelectorAll('.view-option').forEach(opt => opt.classList.remove('active'));
      if (mode === 'list') document.getElementById('listOption').classList.add('active');
      if (mode === 'slides') document.getElementById('slidesOption').classList.add('active');
      if (mode === 'skeleton') document.getElementById('skeletonOption').classList.add('active');
      
      document.getElementById('listView').classList.toggle('active', mode === 'list');
      document.getElementById('slidesView').classList.toggle('active', mode === 'slides');
      document.getElementById('skeletonView').classList.toggle('active', mode === 'skeleton');
      
      document.getElementById('slideControlsBar').style.display = mode === 'slides' ? 'flex' : 'none';
      
      const copyBtn = document.getElementById('copyBtnText');
      if (mode === 'list') copyBtn.textContent = 'Copy All';
      else if (mode === 'slides') copyBtn.textContent = 'Copy Phrase';
      else copyBtn.textContent = 'Copy Report';
      
      if (mode === 'list') {
        if (currentSectionKey === 'all') {
          renderAllSections();
        } else {
          renderList(currentType, currentSectionKey);
        }
        if (isAutoPlaying) toggleAutoPlay();
        if (window.speechSynthesis) window.speechSynthesis.cancel();
        speechFinished = true;
        
      } else if (mode === 'slides') {
        if (currentSectionKey === 'all') {
          const firstSection = Object.keys(REPORT_STRUCTURES_SLIDES[currentType].sections)[0];
          loadSection(firstSection);
        } else {
          loadSection(currentSectionKey);
        }
        
      } else if (mode === 'skeleton') {
        renderSkeletonSlide();
      }

      if (showXRay) {
        applyXRay();
      }
    }

    function setupViewToggle() {
      console.log('‚úÖ View mode system initialized (3-mode buttons)');
    }

    // ==================== PARAGRAPH NAVIGATION ====================
    function buildParagraphNav() {
      const nav = document.getElementById('paragraphNav');
      nav.innerHTML = '';
      
      const structure = getCurrentDataset()[currentType];
      
      // Check if structure exists for this report type
      if (!structure || !structure.sections) {
        console.warn(`No ${viewMode} data available for report type: ${currentType}`);
        
        // Show a message button instead
        const msgBtn = document.createElement('button');
        msgBtn.className = 'para-btn';
        msgBtn.style.cursor = 'default';
        msgBtn.style.opacity = '0.6';
        msgBtn.innerHTML = `<span>‚ö†Ô∏è</span><span>No sections available for this report type</span>`;
        nav.appendChild(msgBtn);
        return;
      }
      
      const allBtn = document.createElement('button');
      allBtn.className = 'para-btn active';
      allBtn.setAttribute('data-section', 'all');
      allBtn.innerHTML = `<span>üìö</span><span>All Sections</span>`;
      allBtn.onclick = () => selectSection('all', allBtn);
      nav.appendChild(allBtn);
      
      Object.keys(structure.sections).forEach((key, index) => {
        const btn = document.createElement('button');
        btn.className = 'para-btn';
        btn.setAttribute('data-section', key);
        btn.innerHTML = `<span>${SECTION_ICONS[key] || 'üìù'}</span><span>${SECTION_LABELS[key]}</span>`;
        btn.onclick = () => selectSection(key, btn);
        nav.appendChild(btn);
      });
    }

    function selectSection(sectionKey, btnElement) {
      document.querySelectorAll('.para-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      btnElement.classList.add('active');
      
      currentSectionKey = sectionKey;
      
      if (viewMode === 'list') {
        if (sectionKey === 'all') {
          renderAllSections();
        } else {
          renderList(currentType, sectionKey);
        }
      } else {
        if (sectionKey === 'all') {
          const firstSection = Object.keys(getCurrentDataset()[currentType].sections)[0];
          loadSection(firstSection);
        } else {
          loadSection(sectionKey);
        }
      }
    }

    // ==================== TYPE SELECTOR ====================
    // Type selector removed - students focus on ONE universal structure
    // Using 'educational' as the template since structure is the same for all topics

    // ==================== LIST VIEW ====================
    function renderList(type, sectionKey = null) {
      const container = document.getElementById('listView');
      const structure = REPORT_STRUCTURES_LIST[type];
      
      if (!structure) {
        container.innerHTML = '<div class="loading">Structure not found</div>';
        return;
      }

      if (!sectionKey && structure.sections) {
        sectionKey = Object.keys(structure.sections)[0];
      }

      let html = '';

      if (structure.sections && sectionKey && structure.sections[sectionKey]) {
        html += renderSection(structure.sections[sectionKey], sectionKey);
      }

      container.innerHTML = html;
      
      if (showXRay) {
        applyXRay();
      }
    }

    function renderAllSections() {
      const container = document.getElementById('listView');
      const structure = REPORT_STRUCTURES_LIST[currentType];
      
      if (!structure) {
        container.innerHTML = '<div class="loading">Structure not found</div>';
        return;
      }

      let html = '';
      let totalPhraseCount = 0;
      
      Object.entries(structure.sections).forEach(([key, section]) => {
        const sectionHtml = renderSection(section, key);
        html += sectionHtml;
      });

      container.innerHTML = html;
      
      if (phraseExplorerActive) {
        totalPhraseCount = document.querySelectorAll('.phrase-hint-btn').length;
        const phraseCountEl = document.getElementById('phraseCount');
        if (phraseCountEl) {
          phraseCountEl.textContent = `${totalPhraseCount} phrase${totalPhraseCount !== 1 ? 's' : ''} detected`;
        }
      }
      
      if (showXRay) {
        applyXRay();
      }
    }

    function renderSection(section, key) {
      let html = `
        <div class="section-card">
          <div class="section-header">
            <span class="section-label">${escapeHtml(SECTION_LABELS[key] || section.label)}</span>
          </div>
          <div class="section-purpose-text">${escapeHtml(section.purpose)}</div>
          <div class="phrase-list">
      `;

      if (section.examples && Array.isArray(section.examples)) {
        section.examples.forEach((example) => {
          const variationLabel = example.variation ? `Variation ${example.variation}` : '';
          let displayText = escapeHtml(example.text || example);
          
          displayText = wrapXRayPatterns(displayText);
          
          if (phraseExplorerActive) {
            const enhanced = enhanceWithPhraseHints(displayText);
            displayText = enhanced.html;
          }
          
          html += `
            <div class="phrase-item" data-phrase-text="${escapeHtml(example.text || example)}" onclick="copyPhraseFromElement(this)">
              <span class="phrase-bullet">‚Ä¢</span>
              <div class="phrase-content">
                ${variationLabel ? `<div class="variation-label">${variationLabel}</div>` : ''}
                <span class="phrase-text">${displayText}</span>
              </div>
            </div>
          `;
        });
      } else if (section.phrases && Array.isArray(section.phrases)) {
        section.phrases.forEach((phrase) => {
          let displayText = escapeHtml(phrase);
          
          displayText = displayText.replace(
            /\[([^\]]+)\]/g, 
            '<span class="phrase-highlight">[$1]</span>'
          );
          
          displayText = wrapXRayPatterns(displayText);
          
          if (phraseExplorerActive) {
            const enhanced = enhanceWithPhraseHints(displayText);
            displayText = enhanced.html;
          }
          
          html += `
            <div class="phrase-item" data-phrase-text="${escapeHtml(phrase)}" onclick="copyPhraseFromElement(this)">
              <span class="phrase-bullet">‚Ä¢</span>
              <span class="phrase-text">${displayText}</span>
            </div>
          `;
        });
      }

      html += `
          </div>
        </div>
      `;

      return html;
    }

    // ==================== SLIDES VIEW ====================
    function loadFirstSection() {
      const structure = REPORT_STRUCTURES_SLIDES[currentType];
      const sections = structure.sections;
      currentSectionKey = Object.keys(sections)[0];
      loadSection(currentSectionKey);
    }

    function loadSection(sectionKey) {
      currentSectionKey = sectionKey;
      const section = REPORT_STRUCTURES_SLIDES[currentType].sections[sectionKey];
      
      if (section.examples && Array.isArray(section.examples)) {
        currentPhrases = section.examples.map(ex => ex.text || ex);
      } else if (section.phrases && Array.isArray(section.phrases)) {
        currentPhrases = [...section.phrases];
      } else {
        currentPhrases = [];
      }
      
      currentPhraseIndex = 0;
      
      document.getElementById('slideSectionIcon').textContent = SECTION_ICONS[sectionKey] || 'üìù';
      document.getElementById('slideSectionName').textContent = SECTION_LABELS[sectionKey] || section.label;
      document.getElementById('slidePurpose').textContent = section.purpose;
      
      renderPhrase();
    }

    function renderPhrase() {
      if (currentPhrases.length === 0) return;
      
      const phrase = currentPhrases[currentPhraseIndex];
      const display = document.getElementById('phraseDisplay');
      
      if (window.speechSynthesis) {
        window.speechSynthesis.cancel();
      }
      speechFinished = false;
      
      let highlighted = phrase.replace(/\[([^\]]+)\]/g, '<span class="bracket">[$1]</span>');
      
      highlighted = wrapXRayPatterns(highlighted);
      
      if (phraseExplorerActive) {
        const enhanced = enhanceWithPhraseHints(highlighted);
        highlighted = enhanced.html;
        
        const phraseCountEl = document.getElementById('phraseCount');
        if (phraseCountEl) {
          phraseCountEl.textContent = `${enhanced.count} phrase${enhanced.count !== 1 ? 's' : ''} detected`;
        }
      }
      
      display.style.opacity = '0';
      
      setTimeout(() => {
        display.innerHTML = highlighted;
        display.style.opacity = '1';
        
        if (showXRay) {
          display.classList.add('xray-active');
        } else {
          display.classList.remove('xray-active');
        }
        
        if (soundEnabled) {
          speakPhrase(phrase);
        } else {
          speechFinished = true;
        }
      }, 200);
      
      updateProgress();
    }

    // ==================== TEXT-TO-SPEECH ====================
    function toggleSound() {
      soundEnabled = !soundEnabled;
      const soundIcon = document.getElementById('soundIcon');
      const soundEmoji = document.getElementById('soundEmoji');
      
      if (soundEnabled) {
        soundIcon.classList.add('active');
        soundEmoji.textContent = 'üîä';
        soundIcon.title = 'Sound ON - Click to mute';
        showToast('Sound enabled');
        
        if (viewMode === 'slides' && currentPhrases.length > 0) {
          speakPhrase(currentPhrases[currentPhraseIndex]);
        }
      } else {
        soundIcon.classList.remove('active');
        soundEmoji.textContent = 'üîá';
        soundIcon.title = 'Sound OFF - Click to enable';
        
        if (window.speechSynthesis) {
          window.speechSynthesis.cancel();
        }
        speechFinished = true;
        showToast('Sound disabled');
      }
    }

    function speakPhrase(phrase) {
      if (!('speechSynthesis' in window) || !soundEnabled) {
        speechFinished = true;
        return;
      }
      
      window.speechSynthesis.cancel();
      speechFinished = false;
      
      const cleanText = phrase.replace(/\[([^\]]+)\]/g, '$1');
      
      setTimeout(() => {
        currentUtterance = new SpeechSynthesisUtterance(cleanText);
        currentUtterance.lang = 'en-GB';
        currentUtterance.rate = 0.85;
        currentUtterance.pitch = 1.0;
        currentUtterance.volume = 1.0;

        const voices = window.speechSynthesis.getVoices();
        const ukVoice = voices.find(v => v.lang === 'en-GB' || v.lang.startsWith('en-GB'));
        if (ukVoice) {
          currentUtterance.voice = ukVoice;
        }
        
        currentUtterance.onend = () => {
          speechFinished = true;
        };
        
        currentUtterance.onerror = (error) => {
          console.error('Speech error:', error);
          speechFinished = true;
        };
        
        window.speechSynthesis.speak(currentUtterance);
      }, 300);
    }

    function updateProgress() {
      document.getElementById('currentNum').textContent = currentPhraseIndex + 1;
      document.getElementById('totalNum').textContent = currentPhrases.length;
      
      const progress = ((currentPhraseIndex + 1) / currentPhrases.length) * 100;
      document.getElementById('progressFill').style.width = progress + '%';
      
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const prevSlideBtn = document.getElementById('prevSlideBtn');
      const nextSlideBtn = document.getElementById('nextSlideBtn');
      
      if (prevBtn) prevBtn.disabled = currentPhraseIndex === 0;
      if (nextBtn) nextBtn.disabled = currentPhraseIndex === currentPhrases.length - 1;
      if (prevSlideBtn) prevSlideBtn.disabled = currentPhraseIndex === 0;
      if (nextSlideBtn) nextSlideBtn.disabled = currentPhraseIndex === currentPhrases.length - 1;
    }

    function nextPhrase() {
      if (currentPhraseIndex < currentPhrases.length - 1) {
        currentPhraseIndex++;
        renderPhrase();
      }
    }

    function prevPhrase() {
      if (currentPhraseIndex > 0) {
        currentPhraseIndex--;
        renderPhrase();
      }
    }

    function toggleAutoPlay() {
      isAutoPlaying = !isAutoPlaying;
      const btn = document.getElementById('playBtn');
      const controlBtn = document.getElementById('autoPlayBtn');
      
      if (isAutoPlaying) {
        if (btn) btn.textContent = '‚è∏';
        if (controlBtn) controlBtn.innerHTML = '<span>‚è∏</span>';
        
        autoPlayInterval = setInterval(() => {
          if (soundEnabled && !speechFinished) {
            return;
          }
          
          if (!soundEnabled) {
            clearInterval(autoPlayInterval);
            setTimeout(() => {
              if (isAutoPlaying) {
                advanceToNextPhrase();
                if (isAutoPlaying) toggleAutoPlay();
              }
            }, 5000);
            return;
          }
          
          advanceToNextPhrase();
        }, 500);
        
      } else {
        if (btn) btn.textContent = '‚ñ∂';
        if (controlBtn) controlBtn.innerHTML = '<span>‚ñ∂</span>';
        if (autoPlayInterval) {
          clearInterval(autoPlayInterval);
          autoPlayInterval = null;
        }
      }
    }

    function advanceToNextPhrase() {
      if (currentPhraseIndex < currentPhrases.length - 1) {
        nextPhrase();
      } else {
        toggleAutoPlay();
      }
    }

    function repeatPhrase() {
      if (viewMode === 'slides') {
        renderPhrase();
        showToast('Phrase repeated');
      }
    }

    function shufflePhrases() {
      if (viewMode === 'slides') {
        currentPhrases.sort(() => Math.random() - 0.5);
        currentPhraseIndex = 0;
        renderPhrase();
        showToast('Phrases shuffled!');
      } else {
        showToast('Switch to Slides view to shuffle');
      }
    }

    // ==================== ACTIONS ====================
    function copyPhraseFromElement(element) {
      const phrase = element.getAttribute('data-phrase-text');
      if (phrase) {
        navigator.clipboard.writeText(phrase).then(() => {
          showToast(`Copied!`);
          element.style.background = 'rgba(16, 185, 129, 0.15)';
          element.style.borderLeftColor = '#10b981';
          setTimeout(() => {
            element.style.background = '';
            element.style.borderLeftColor = '';
          }, 1000);
        });
      }
    }

    function copyCurrentContent() {
      if (viewMode === 'slides') {
        const phrase = currentPhrases[currentPhraseIndex];
        navigator.clipboard.writeText(phrase).then(() => {
          showToast('Phrase copied!');
        });
      } else if (viewMode === 'skeleton') {
        const skeleton = skeletonSlides[currentSkeletonIndex];
        let text = '';
        const sections = [
          { key: 'introduction', title: 'A: INTRODUCTION' },
          { key: 'neutral', title: 'B: GENERAL VIEW (NEUTRAL)' },
          { key: 'praising', title: 'C: PRAISING (POSITIVE)' },
          { key: 'criticising', title: 'D: CRITICISING (NEGATIVE)' },
          { key: 'recommending', title: 'E: RECOMMENDING (SUGGESTION)' },
          { key: 'conclusion', title: 'F: CONCLUSION' }
        ];
        
        sections.forEach(section => {
          text += `${section.title}\n`;
          text += `${skeleton[section.key] || ''}\n\n`;
        });
        
        navigator.clipboard.writeText(text).then(() => {
          showToast('Report copied!');
        });
      } else {
        copyAllPhrases();
      }
    }

    function copyAllPhrases() {
      const structure = getCurrentDataset()[currentType];
      if (!structure) return;
      
      let text = `${structure.title}\n${'='.repeat(structure.title.length)}\n\n`;
      text += `${structure.purpose}\n\n`;
      
      Object.entries(structure.sections).forEach(([key, section]) => {
        text += `${SECTION_LABELS[key] || section.label}\n`;
        text += `${'-'.repeat((SECTION_LABELS[key] || section.label).length)}\n`;
        text += `${section.purpose}\n\n`;
        
        if (section.examples && Array.isArray(section.examples)) {
          section.examples.forEach((example) => {
            if (example.variation) {
              text += `Variation ${example.variation}:\n`;
            }
            text += `‚Ä¢ ${example.text || example}\n\n`;
          });
        } else if (section.phrases && Array.isArray(section.phrases)) {
          section.phrases.forEach(phrase => {
            text += `‚Ä¢ ${phrase}\n`;
          });
        }
        text += '\n';
      });

      navigator.clipboard.writeText(text).then(() => {
        showToast('All phrases copied to clipboard ‚úì');
      }).catch(err => {
        console.error('Failed to copy:', err);
        showToast('Failed to copy to clipboard', false);
      });
    }

    function printGuide() {
      window.print();
    }

    // ==================== SKELETON MODE ====================
    function initializeSkeleton() {
      skeletonSlides = [];
      
      if (!REPORT_STRUCTURES_SKELETON[currentType]) {
        console.error('‚ùå No skeleton data for type:', currentType);
        return;
      }
      
      const skeletonData = REPORT_STRUCTURES_SKELETON[currentType];
      
      if (!skeletonData.fixed_template) {
        console.error('‚ùå No fixed_template found in skeleton data');
        return;
      }
      
      skeletonSlides[0] = skeletonData.fixed_template;
      
      for (let i = 1; i < 10; i++) {
        try {
          skeletonSlides[i] = generateRandomReport();
        } catch (error) {
          console.error(`‚ùå Error generating random report ${i}:`, error);
        }
      }
      
      currentSkeletonIndex = 0;
    }

    function generateRandomReport() {
      const skeletonData = REPORT_STRUCTURES_SKELETON[currentType];
      
      if (!skeletonData || !skeletonData.random_pools) {
        throw new Error('Missing random_pools in skeleton data');
      }
      
      const pools = skeletonData.random_pools;
      const report = {};
      
      if (pools.introduction) {
        const aim = pools.introduction.aims[Math.floor(Math.random() * pools.introduction.aims.length)];
        const topic = pools.introduction.topics[Math.floor(Math.random() * pools.introduction.topics.length)];
        const method = pools.introduction.methods[Math.floor(Math.random() * pools.introduction.methods.length)];
        report.introduction = `${aim} ${topic}. ${method}`;
      }
      
      if (pools.neutral) {
        const neutralOpen = pools.neutral.opening[Math.floor(Math.random() * pools.neutral.opening.length)];
        const assessment = pools.neutral.assessment[Math.floor(Math.random() * pools.neutral.assessment.length)];
        const reason = pools.neutral.reason[Math.floor(Math.random() * pools.neutral.reason.length)];
        report.neutral = `${neutralOpen} ${assessment}. ${reason}`;
      }
      
      if (pools.praising) {
        const praiseOpen = pools.praising.opening[Math.floor(Math.random() * pools.praising.opening.length)];
        const subject = pools.praising.subject[Math.floor(Math.random() * pools.praising.subject.length)];
        const elaboration = pools.praising.elaboration[Math.floor(Math.random() * pools.praising.elaboration.length)];
        report.praising = `${praiseOpen} ${subject}. ${elaboration}`;
      }
      
      if (pools.criticising) {
        const critOpen = pools.criticising.opening[Math.floor(Math.random() * pools.criticising.opening.length)];
        const problem = pools.criticising.problem[Math.floor(Math.random() * pools.criticising.problem.length)];
        const impact = pools.criticising.impact[Math.floor(Math.random() * pools.criticising.impact.length)];
        report.criticising = `${critOpen} ${problem}. ${impact}`;
      }
      
      if (pools.recommending) {
        const recOpen = pools.recommending.opening[Math.floor(Math.random() * pools.recommending.opening.length)];
        const action = pools.recommending.action[Math.floor(Math.random() * pools.recommending.action.length)];
        const benefit = pools.recommending.benefit[Math.floor(Math.random() * pools.recommending.benefit.length)];
        report.recommending = `${recOpen} ${action}. ${benefit}`;
      }
      
      if (pools.conclusion) {
        const summary = pools.conclusion.summary[Math.floor(Math.random() * pools.conclusion.summary.length)];
        const priority = pools.conclusion.priority[Math.floor(Math.random() * pools.conclusion.priority.length)];
        const final = pools.conclusion.final[Math.floor(Math.random() * pools.conclusion.final.length)];
        report.conclusion = `${summary}. ${priority} ${final}`;
      }
      
      return report;
    }

    function renderSkeletonSlide() {
      if (!skeletonSlides || skeletonSlides.length === 0) {
        const card = document.getElementById('skeletonCard');
        card.innerHTML = '<div class="loading">No skeleton data available</div>';
        return;
      }
      
      const skeleton = skeletonSlides[currentSkeletonIndex];
      const card = document.getElementById('skeletonCard');
      
      let html = '';
      let totalPhraseCount = 0;
      
      const sections = [
        { key: 'introduction', icon: 'üìù', title: 'A: INTRODUCTION' },
        { key: 'neutral', icon: '‚öñÔ∏è', title: 'B: GENERAL VIEW (NEUTRAL)' },
        { key: 'praising', icon: '‚≠ê', title: 'C: PRAISING (POSITIVE)' },
        { key: 'criticising', icon: '‚ö†Ô∏è', title: 'D: CRITICISING (NEGATIVE)' },
        { key: 'recommending', icon: 'üí°', title: 'E: RECOMMENDING (SUGGESTION)' },
        { key: 'conclusion', icon: '‚úÖ', title: 'F: CONCLUSION' }
      ];
      
      sections.forEach(section => {
        let text = skeleton[section.key] || `[${section.key} not available]`;
        
        text = wrapXRayPatterns(text);
        
        if (phraseExplorerActive) {
          const enhanced = enhanceWithPhraseHints(text);
          text = enhanced.html;
          totalPhraseCount += enhanced.count;
        }
        
        html += `
          <div class="skeleton-section">
            <div class="skeleton-section-header">
              <span class="skeleton-section-icon">${section.icon}</span>
              <span class="skeleton-section-title">${section.title}</span>
            </div>
            <p class="skeleton-section-text" style="color: #9ca3af; font-style: italic; line-height: 1.8;">
              ${text}
            </p>
          </div>
        `;
      });
      
      card.innerHTML = html;
      
      if (phraseExplorerActive) {
        const phraseCountEl = document.getElementById('phraseCount');
        if (phraseCountEl) {
          phraseCountEl.textContent = `${totalPhraseCount} phrase${totalPhraseCount !== 1 ? 's' : ''} detected`;
        }
      }
      
      const counter = document.getElementById('skeletonCounter');
      counter.style.display = 'block';
      counter.textContent = `Skeleton ${currentSkeletonIndex + 1} / ${skeletonSlides.length}`;
      
      const prevBtn = document.getElementById('prevSkeletonBtn');
      const nextBtn = document.getElementById('nextSkeletonBtn');
      prevBtn.style.display = 'inline-block';
      nextBtn.style.display = 'inline-block';
      prevBtn.disabled = currentSkeletonIndex === 0;
      nextBtn.disabled = currentSkeletonIndex === skeletonSlides.length - 1;
      
      if (showXRay) {
        applyXRay();
      }
    }
    
    function prevSkeleton() {
      if (currentSkeletonIndex > 0) {
        currentSkeletonIndex--;
        renderSkeletonSlide();
      }
    }

    function nextSkeleton() {
      if (currentSkeletonIndex < 9) {
        currentSkeletonIndex++;
        renderSkeletonSlide();
      }
    }

    function generateRandomSkeleton() {
      for (let i = 1; i < 10; i++) {
        skeletonSlides[i] = generateRandomReport();
      }
      
      if (currentSkeletonIndex > 0) {
        renderSkeletonSlide();
      }
      
      showToast('üé≤ New random reports generated!');
    }

    // ==================== TOAST ====================
    function showToast(message, success = true) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.style.background = success 
        ? 'rgba(16, 185, 129, 0.95)' 
        : 'rgba(239, 68, 68, 0.95)';
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 2500);
    }

    // ==================== EVENT LISTENERS ====================
    function setupSoundIcon() {
      const soundIcon = document.getElementById('soundIcon');
      if (soundIcon) {
        soundIcon.addEventListener('click', toggleSound);
      }
    }

    if (window.speechSynthesis) {
      window.speechSynthesis.onvoiceschanged = () => {
        console.log('‚úÖ Speech voices loaded');
      };
    }

    document.addEventListener('keydown', (e) => {
      if (viewMode !== 'slides') return;
      
      if (e.key === 'ArrowRight') nextPhrase();
      if (e.key === 'ArrowLeft') prevPhrase();
      if (e.key === ' ') {
        e.preventDefault();
        toggleAutoPlay();
      }
      if (e.key === 'r' || e.key === 'R') shufflePhrases();
      if (e.key === 's' || e.key === 'S') toggleSound();
      if (e.key === 'x' || e.key === 'X') toggleXRay();
      if (e.key === 'p' || e.key === 'P') togglePhraseExplorer();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeAlternativesModal();
      }
    });

    // ==================== START ====================
    init();
  </script>
