<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>INTUITY - Review Writer</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0d0d0d;
      color: #e5e5e7;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      position: relative;
      overflow-x: hidden;
    }
    
    .background {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: radial-gradient(circle at 30% 20%, rgba(201, 169, 97, 0.08) 0%, transparent 50%),
                  radial-gradient(circle at 70% 80%, rgba(201, 169, 97, 0.06) 0%, transparent 45%),
                  #0d0d0d;
      z-index: 0;
    }
    
    .container {
      position: relative;
      z-index: 1;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0.5rem;
    }
    
    /* ============================================
       UNIFIED HEADER
       ============================================ */
    
    .global-header {
      background: rgba(28, 28, 30, 0.95);
      backdrop-filter: blur(40px);
      border-bottom: 1px solid rgba(84, 84, 88, 0.3);
      padding: 0.5rem 1rem;
      margin-bottom: 1rem;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .header-row-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }
    
    .brand {
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
    }
    
    .brand-logo {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.125rem;
      font-weight: 700;
      color: #C9A961;
      text-transform: uppercase;
      letter-spacing: -0.02em;
    }
    
    .brand-subtitle {
      font-size: 0.625rem;
      color: #636366;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    
    .home-link {
      color: #8e8e93;
      text-decoration: none;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.375rem 0.75rem;
      border-radius: 0.5rem;
      transition: all 0.3s;
    }
    
    .home-link:hover {
      color: #C9A961;
      background: rgba(201, 169, 97, 0.1);
    }
    
    /* Mode tabs */
    .mode-tabs {
      display: flex;
      gap: 0.25rem;
      background: rgba(0, 0, 0, 0.3);
      padding: 0.25rem;
      border-radius: 0.625rem;
      margin-bottom: 0.75rem;
    }
    
    .tab {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.125rem;
      padding: 0.375rem 0.5rem;
      background: transparent;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      color: #8e8e93;
    }
    
    .tab:hover {
      background: rgba(142, 142, 147, 0.1);
    }
    
    .tab.active {
      background: rgba(201, 169, 97, 0.15);
      color: #C9A961;
    }
    
    .tab-icon {
      font-size: 1.125rem;
      line-height: 1;
    }
    
    .tab-label {
      font-size: 0.625rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
      font-family: 'DM Sans', sans-serif;
    }
    
    /* Progress bar */
    .progress-bar {
      display: flex;
      flex-direction: column;
      gap: 0.375rem;
    }
    
    .progress-track {
      width: 100%;
      height: 4px;
      background: rgba(84, 84, 88, 0.3);
      border-radius: 2px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #C9A961, rgba(201, 169, 97, 0.6));
      border-radius: 2px;
      transition: width 0.4s ease;
    }
    
    .progress-text {
      font-size: 0.6875rem;
      color: #636366;
      text-align: center;
      font-weight: 500;
    }
    
    .progress-text .current {
      color: #C9A961;
      font-weight: 700;
    }
    
    /* ============================================
       WRITE MODE LAYOUT
       ============================================ */
    
    .write-mode-layout {
      display: grid;
      grid-template-columns: 1fr 64px;
      gap: 0;
      height: calc(100vh - 180px);
      position: relative;
      transition: grid-template-columns 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .write-mode-layout.hub-open {
      grid-template-columns: 1fr 400px;
    }
    
    /* ============================================
       MAIN WRITING CANVAS
       ============================================ */
    
    .write-canvas {
      background: rgba(28, 28, 30, 0.6);
      backdrop-filter: blur(40px);
      border-radius: 1.25rem;
      border: 1px solid rgba(84, 84, 88, 0.25);
      padding: 2rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      margin-right: 1rem;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }
    
    .stage-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .stage-info {
      flex: 1;
      min-width: 200px;
    }
    
    .stage-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #C9A961;
      margin-bottom: 0.25rem;
    }
    
    .stage-target {
      font-size: 0.75rem;
      color: #8e8e93;
      font-weight: 500;
    }
    
    .stage-dots {
      display: flex;
      gap: 0.75rem;
    }
    
    .stage-dot {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      background: rgba(99, 99, 102, 0.2);
      border: 2px solid rgba(99, 99, 102, 0.3);
      color: #8e8e93;
      font-size: 0.875rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .stage-dot:hover {
      background: rgba(99, 99, 102, 0.3);
      transform: scale(1.1);
    }
    
    .stage-dot.active {
      background: rgba(201, 169, 97, 0.25);
      border-color: #C9A961;
      color: #C9A961;
      transform: scale(1.15);
      box-shadow: 0 0 0 4px rgba(201, 169, 97, 0.15);
    }
    
    .stage-dot.completed {
      background: rgba(132, 204, 22, 0.15);
      border-color: #84cc16;
      color: #84cc16;
    }
    
    /* Main textarea */
    .write-textarea-main {
      flex: 1;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(84, 84, 88, 0.3);
      border-radius: 1rem;
      padding: 1.5rem;
      color: #e5e5e7;
      font-size: 1rem;
      line-height: 1.8;
      resize: none;
      font-family: 'DM Sans', sans-serif;
      transition: all 0.3s;
    }
    
    .write-textarea-main:focus {
      outline: none;
      border-color: rgba(201, 169, 97, 0.5);
      background: rgba(0, 0, 0, 0.5);
      box-shadow: 0 0 0 4px rgba(201, 169, 97, 0.1);
    }
    
    .write-textarea-main::placeholder {
      color: #636366;
      font-style: italic;
      line-height: 1.6;
    }
    
    /* Footer */
    .write-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(84, 84, 88, 0.2);
    }
    
    .word-stats {
      display: flex;
      gap: 1.5rem;
      font-size: 0.875rem;
      color: #8e8e93;
    }
    
    .word-stats strong {
      color: #C9A961;
      font-weight: 700;
    }
    
    .write-actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    
    .action-btn {
      padding: 0.625rem 1.25rem;
      background: rgba(28, 28, 30, 0.6);
      border: 1px solid rgba(84, 84, 88, 0.3);
      border-radius: 0.625rem;
      color: #e5e5e7;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'DM Sans', sans-serif;
    }
    
    .action-btn:hover:not(:disabled) {
      background: rgba(28, 28, 30, 0.8);
      border-color: rgba(201, 169, 97, 0.4);
      color: #C9A961;
      transform: translateY(-2px);
    }
    
    .action-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    .action-btn.primary {
      background: rgba(201, 169, 97, 0.2);
      border-color: rgba(201, 169, 97, 0.4);
      color: #C9A961;
    }
    
    .action-btn.primary:hover:not(:disabled) {
      background: rgba(201, 169, 97, 0.3);
      box-shadow: 0 4px 12px rgba(201, 169, 97, 0.3);
    }
    
    /* ============================================
       DATA HUB SIDEBAR
       ============================================ */
    
    .data-hub {
      display: flex;
      flex-direction: column;
      position: relative;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Icon strip */
    .hub-icons {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      background: rgba(28, 28, 30, 0.6);
      backdrop-filter: blur(40px);
      border-radius: 1rem;
      padding: 0.75rem 0.5rem;
      border: 1px solid rgba(84, 84, 88, 0.25);
    }
    
    .hub-icon {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: 0.625rem;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }
    
    .hub-icon .icon {
      font-size: 1.5rem;
      transition: transform 0.3s;
    }
    
    .hub-icon:hover {
      background: rgba(99, 99, 102, 0.15);
    }
    
    .hub-icon:hover .icon {
      transform: scale(1.2);
    }
    
    .hub-icon.active {
      background: rgba(201, 169, 97, 0.2);
    }
    
    .hub-icon.active::after {
      content: '';
      position: absolute;
      right: -2px;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 60%;
      background: #C9A961;
      border-radius: 2px;
    }
    
    /* Expandable panel */
    .hub-panel {
      position: absolute;
      top: 0;
      right: 0;
      width: 380px;
      height: 100%;
      background: rgba(28, 28, 30, 0.95);
      backdrop-filter: blur(40px);
      border-radius: 1rem;
      border: 1px solid rgba(201, 169, 97, 0.3);
      box-shadow: -4px 0 24px rgba(0, 0, 0, 0.4);
      transform: translateX(calc(100% + 1rem));
      opacity: 0;
      pointer-events: none;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      z-index: 10;
    }
    
    .hub-panel.open {
      transform: translateX(0);
      opacity: 1;
      pointer-events: all;
    }
    
    .hub-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid rgba(84, 84, 88, 0.2);
    }
    
    .hub-panel-title {
      font-size: 1rem;
      font-weight: 700;
      color: #C9A961;
      margin: 0;
    }
    
    .hub-panel-close {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(99, 99, 102, 0.2);
      border: none;
      border-radius: 0.5rem;
      color: #8e8e93;
      font-size: 1.25rem;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .hub-panel-close:hover {
      background: rgba(99, 99, 102, 0.3);
      color: #e5e5e7;
    }
    
    .hub-panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
    }
    
    .hub-panel-content::-webkit-scrollbar {
      width: 6px;
    }
    
    .hub-panel-content::-webkit-scrollbar-thumb {
      background: rgba(201, 169, 97, 0.3);
      border-radius: 3px;
    }
    
    /* Panel content styles */
    .phrase-group {
      margin-bottom: 1.5rem;
    }
    
    .phrase-title {
      font-size: 0.75rem;
      color: #C9A961;
      font-weight: 700;
      margin-bottom: 0.5rem;
      padding: 0.375rem 0.5rem;
      background: rgba(201, 169, 97, 0.08);
      border-radius: 0.5rem;
    }
    
    .phrase-item {
      font-size: 0.75rem;
      color: #e5e5e7;
      line-height: 1.6;
      padding: 0.5rem;
      margin-bottom: 0.375rem;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 0.375rem;
      border-left: 2px solid rgba(201, 169, 97, 0.3);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .phrase-item:hover {
      background: rgba(0, 0, 0, 0.3);
      border-left-color: #C9A961;
      transform: translateX(2px);
    }
    
    .question-display {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 0.75rem;
      padding: 1rem;
      border-left: 3px solid #C9A961;
      margin-bottom: 1rem;
    }
    
    .question-display h4 {
      font-size: 0.8125rem;
      color: #C9A961;
      margin-bottom: 0.5rem;
      font-weight: 700;
    }
    
    .question-text {
      font-size: 0.75rem;
      color: #d1d1d6;
      line-height: 1.6;
    }
    
    /* ============================================
       MOBILE RESPONSIVE
       ============================================ */
    
    @media (max-width: 768px) {
      .container {
        padding: 0.375rem;
      }
      
      .global-header {
        padding: 0.375rem 0.5rem;
      }
      
      .brand-subtitle {
        display: none;
      }
      
      .tab {
        padding: 0.3rem 0.25rem;
      }
      
      .tab-icon {
        font-size: 1rem;
      }
      
      .tab-label {
        font-size: 0.5625rem;
      }
      
      .write-mode-layout {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr auto;
        height: calc(100vh - 200px);
      }
      
      .write-canvas {
        margin-right: 0;
        margin-bottom: 0.5rem;
        padding: 1.25rem;
      }
      
      .stage-title {
        font-size: 1rem;
      }
      
      .stage-dots {
        gap: 0.5rem;
      }
      
      .stage-dot {
        width: 2rem;
        height: 2rem;
        font-size: 0.75rem;
      }
      
      .write-textarea-main {
        font-size: 0.9375rem;
        padding: 1rem;
      }
      
      .hub-icons {
        flex-direction: row;
        justify-content: space-around;
        border-radius: 1rem 1rem 0 0;
        padding: 0.5rem;
      }
      
      .hub-icon {
        width: auto;
        height: 56px;
        flex: 1;
      }
      
      .hub-icon.active::after {
        display: none;
      }
      
      .hub-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        top: auto;
        width: 100%;
        height: 70vh;
        border-radius: 1rem 1rem 0 0;
        transform: translateY(100%);
        box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.4);
      }
      
      .hub-panel.open {
        transform: translateY(0);
      }
      
      .action-btn {
        padding: 0.5rem 1rem;
        font-size: 0.8125rem;
      }
    }
  </style>
</head>
<body>
  <div class="background"></div>
  
  <div class="container">
    
    <!-- UNIFIED HEADER -->
    <header class="global-header">
      <div class="header-row-main">
        <div class="brand">
          <span class="brand-logo">INTUITY</span>
          <span class="brand-subtitle">B2 Review Practice</span>
        </div>
        <a href="index.html" class="home-link">‚Üê Home</a>
      </div>
      
      <!-- Mode tabs -->
      <nav class="mode-tabs">
        <a href="fce-review-samples.html" class="tab">
          <span class="tab-icon">üìñ</span>
          <span class="tab-label">Read</span>
        </a>
        <a href="review-writer.html?mode=read" class="tab">
          <span class="tab-icon">üß†</span>
          <span class="tab-label">Study</span>
        </a>
        <a href="review-writer.html?mode=write" class="tab active">
          <span class="tab-icon">‚úçÔ∏è</span>
          <span class="tab-label">Write</span>
        </a>
        <a href="adjective-practice.html" class="tab">
          <span class="tab-icon">üìö</span>
          <span class="tab-label">Vocab</span>
        </a>
      </nav>
      
      <!-- Progress -->
      <div class="progress-bar">
        <div class="progress-track">
          <div class="progress-fill" id="progressFill" style="width: 25%"></div>
        </div>
        <span class="progress-text" id="progressText">Stage <span class="current">1</span> of 4</span>
      </div>
    </header>
    
    <!-- WRITE MODE LAYOUT -->
    <div class="write-mode-layout" id="writeLayout">
      
      <!-- MAIN: Writing Canvas -->
      <main class="write-canvas">
        
        <div class="stage-header">
          <div class="stage-info">
            <h2 class="stage-title" id="stageTitle">üìù Write Your Introduction</h2>
            <span class="stage-target" id="stageTarget">Target: ~50 words</span>
          </div>
          
          <div class="stage-dots">
            <button class="stage-dot active" onclick="jumpStage(0)">1</button>
            <button class="stage-dot" onclick="jumpStage(1)">2</button>
            <button class="stage-dot" onclick="jumpStage(2)">3</button>
            <button class="stage-dot" onclick="jumpStage(3)">4</button>
          </div>
        </div>
        
        <textarea 
          class="write-textarea-main" 
          id="writeArea"
          placeholder="Start writing your introduction here...

Tip: Begin with context about when/where/why, then introduce what you're reviewing."
        ></textarea>
        
        <div class="write-footer">
          <div class="word-stats">
            <span><strong id="currentWords">0</strong> / <span id="targetWords">50</span> words</span>
            <span>Total: <strong id="totalWords">0</strong> / 190</span>
          </div>
          
          <div class="write-actions">
            <button class="action-btn" onclick="saveDraft()">üíæ Save</button>
            <button class="action-btn" onclick="prevStage()" id="prevStageBtn" disabled>‚Üê Previous</button>
            <button class="action-btn primary" onclick="nextStage()" id="nextStageBtn">Next ‚Üí</button>
          </div>
        </div>
        
      </main>
      
      <!-- SIDEBAR: Data Hub -->
      <aside class="data-hub">
        
        <nav class="hub-icons">
          <button class="hub-icon" data-panel="phrases" title="Useful Phrases" onclick="toggleHubPanel('phrases')">
            <span class="icon">üí¨</span>
          </button>
          <button class="hub-icon" data-panel="ideas" title="Planning Ideas" onclick="toggleHubPanel('ideas')">
            <span class="icon">üí°</span>
          </button>
          <button class="hub-icon" data-panel="samples" title="Example Text" onclick="toggleHubPanel('samples')">
            <span class="icon">üìÑ</span>
          </button>
          <button class="hub-icon" data-panel="vocab" title="Vocabulary" onclick="toggleHubPanel('vocab')">
            <span class="icon">üìö</span>
          </button>
          <button class="hub-icon" data-panel="question" title="Task Question" onclick="toggleHubPanel('question')">
            <span class="icon">üéØ</span>
          </button>
        </nav>
        
        <div class="hub-panel" id="hubPanel">
          <div class="hub-panel-header">
            <h3 class="hub-panel-title" id="hubPanelTitle">Reference</h3>
            <button class="hub-panel-close" onclick="closeHubPanel()">‚úï</button>
          </div>
          
          <div class="hub-panel-content" id="hubPanelContent">
            <!-- Content loaded dynamically -->
          </div>
        </div>
        
      </aside>
      
    </div>
    
  </div>

  <script>
    // ============================================
    // STATE MANAGEMENT
    // ============================================
    
    let currentStage = 0;
    let reviewDraft = ['', '', '', ''];
    let currentHubPanel = null;
    
    const stageInfo = [
      { name: 'Write Your Introduction', target: 50, icon: 'üìù' },
      { name: 'Describe Feature 1', target: 55, icon: 'üéØ' },
      { name: 'Describe Feature 2', target: 45, icon: 'üí°' },
      { name: 'Give Your Recommendation', target: 45, icon: '‚úÖ' }
    ];
    
    // Sample phrases data
    const phrasesData = {
      introduction: [
        "Choosing a... can be difficult",
        "Last weekend I went to...",
        "I recently visited...",
        "When I was planning...",
        "I have to say it was...",
        "It turned out to be..."
      ],
      feature1: [
        "The thing that impressed me most was...",
        "What really stands out is...",
        "The first thing you'll notice is...",
        "One aspect that immediately caught my attention was...",
        "What makes this so special is..."
      ],
      feature2: [
        "The other impressive thing was...",
        "Another aspect worth mentioning is...",
        "What's also worth highlighting is...",
        "Equally impressive is...",
        "On top of that..."
      ],
      recommendation: [
        "I would highly recommend...",
        "I would definitely recommend...",
        "This is a must for...",
        "You won't regret...",
        "It's worth every penny/minute"
      ]
    };
    
    const sampleQuestion = {
      context: "You see this announcement in an English-language website.",
      task: "Write us a review of a restaurant where you had a wonderful meal. Tell us what the restaurant was like, describe what you ate and explain why it was so good.",
      wordCount: "140-190 words"
    };
    
    // ============================================
    // INITIALIZATION
    // ============================================
    
    function init() {
      loadDraft();
      updateInterface();
      
      // Auto-save on input
      document.getElementById('writeArea').addEventListener('input', () => {
        handleInput();
        saveDraftToStorage();
      });
      
      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && currentHubPanel) {
          closeHubPanel();
        }
      });
    }
    
    // ============================================
    // STAGE MANAGEMENT
    // ============================================
    
    function updateInterface() {
      const info = stageInfo[currentStage];
      
      document.getElementById('stageTitle').textContent = `${info.icon} ${info.name}`;
      document.getElementById('stageTarget').textContent = `Target: ~${info.target} words`;
      document.getElementById('targetWords').textContent = info.target;
      document.getElementById('writeArea').value = reviewDraft[currentStage];
      
      // Update stage dots
      document.querySelectorAll('.stage-dot').forEach((dot, i) => {
        dot.classList.remove('active', 'completed');
        if (i === currentStage) {
          dot.classList.add('active');
        } else if (reviewDraft[i]?.trim()) {
          dot.classList.add('completed');
        }
      });
      
      // Update navigation
      document.getElementById('prevStageBtn').disabled = currentStage === 0;
      document.getElementById('nextStageBtn').disabled = currentStage === 3;
      
      // Update progress
      const progress = ((currentStage + 1) / 4) * 100;
      document.getElementById('progressFill').style.width = `${progress}%`;
      document.getElementById('progressText').innerHTML = `Stage <span class="current">${currentStage + 1}</span> of 4`;
      
      updateWordCount();
    }
    
    function nextStage() {
      if (currentStage < 3) {
        reviewDraft[currentStage] = document.getElementById('writeArea').value;
        currentStage++;
        updateInterface();
        saveDraftToStorage();
      }
    }
    
    function prevStage() {
      if (currentStage > 0) {
        reviewDraft[currentStage] = document.getElementById('writeArea').value;
        currentStage--;
        updateInterface();
        saveDraftToStorage();
      }
    }
    
    function jumpStage(stage) {
      reviewDraft[currentStage] = document.getElementById('writeArea').value;
      currentStage = stage;
      updateInterface();
      saveDraftToStorage();
    }
    
    // ============================================
    // WORD COUNTING
    // ============================================
    
    function handleInput() {
      reviewDraft[currentStage] = document.getElementById('writeArea').value;
      updateWordCount();
    }
    
    function updateWordCount() {
      const text = document.getElementById('writeArea').value;
      const words = text.trim() ? text.trim().split(/\s+/).length : 0;
      document.getElementById('currentWords').textContent = words;
      
      const totalWords = reviewDraft.reduce((sum, stage) => {
        return sum + (stage.trim() ? stage.trim().split(/\s+/).length : 0);
      }, 0);
      document.getElementById('totalWords').textContent = totalWords;
    }
    
    // ============================================
    // HUB PANEL MANAGEMENT
    // ============================================
    
    function toggleHubPanel(panelType) {
      const panel = document.getElementById('hubPanel');
      const layout = document.getElementById('writeLayout');
      
      if (currentHubPanel === panelType) {
        closeHubPanel();
        return;
      }
      
      // Update active icon
      document.querySelectorAll('.hub-icon').forEach(icon => {
        icon.classList.toggle('active', icon.dataset.panel === panelType);
      });
      
      // Render content
      renderHubPanel(panelType);
      
      // Open panel
      panel.classList.add('open');
      layout.classList.add('hub-open');
      
      currentHubPanel = panelType;
    }
    
    function closeHubPanel() {
      const panel = document.getElementById('hubPanel');
      const layout = document.getElementById('writeLayout');
      
      panel.classList.remove('open');
      layout.classList.remove('hub-open');
      
      document.querySelectorAll('.hub-icon').forEach(icon => {
        icon.classList.remove('active');
      });
      
      currentHubPanel = null;
    }
    
    function renderHubPanel(type) {
      const title = document.getElementById('hubPanelTitle');
      const content = document.getElementById('hubPanelContent');
      
      const titles = {
        phrases: 'üí¨ Useful Phrases',
        ideas: 'üí° Planning Ideas',
        samples: 'üìÑ Example Text',
        vocab: 'üìö Vocabulary',
        question: 'üéØ Task Question'
      };
      
      title.textContent = titles[type];
      
      switch(type) {
        case 'phrases':
          renderPhrases(content);
          break;
        case 'ideas':
          renderIdeas(content);
          break;
        case 'samples':
          renderSamples(content);
          break;
        case 'vocab':
          renderVocab(content);
          break;
        case 'question':
          renderQuestion(content);
          break;
      }
    }
    
    function renderPhrases(container) {
      const stageKeys = ['introduction', 'feature1', 'feature2', 'recommendation'];
      const key = stageKeys[currentStage];
      const phrases = phrasesData[key];
      
      let html = '<div class="phrase-group">';
      html += `<div class="phrase-title">For ${stageInfo[currentStage].name}</div>`;
      
      phrases.forEach(phrase => {
        html += `<div class="phrase-item" onclick="insertPhrase('${phrase}')">${phrase}</div>`;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }
    
    function renderIdeas(container) {
      container.innerHTML = `
        <div class="phrase-group">
          <div class="phrase-title">Planning Tips</div>
          <div class="phrase-item">üí° Start with context (when/where/why)</div>
          <div class="phrase-item">üí° Name what you're reviewing early</div>
          <div class="phrase-item">üí° Include your overall opinion</div>
          <div class="phrase-item">üí° Each feature needs 50-60 words</div>
          <div class="phrase-item">üí° End with a clear recommendation</div>
        </div>
      `;
    }
    
    function renderSamples(container) {
      container.innerHTML = `
        <div class="phrase-group">
          <div class="phrase-title">Example Introduction</div>
          <div class="phrase-item" style="line-height: 1.6; cursor: default;">
            Last weekend I went to a restaurant called Bella Napoli to celebrate my birthday. 
            It's a small Italian restaurant in the city centre and I have to say it was one of 
            the best meals I've ever had.
          </div>
        </div>
      `;
    }
    
    function renderVocab(container) {
      const vocabSets = {
        0: ['amazing', 'impressive', 'wonderful', 'excellent', 'outstanding'],
        1: ['fascinating', 'captivating', 'remarkable', 'stunning', 'breathtaking'],
        2: ['delicious', 'incredible', 'fantastic', 'superb', 'magnificent'],
        3: 'highly recommend', 'definitely worth', 'absolutely essential', 'must-see', 'unmissable']
      };
      
      const vocab = vocabSets[currentStage];
      let html = '<div class="phrase-group">';
      html += '<div class="phrase-title">Useful Adjectives</div>';
      
      if (Array.isArray(vocab)) {
        vocab.forEach(word => {
          html += `<div class="phrase-item" onclick="insertPhrase('${word}')">${word}</div>`;
        });
      } else {
        vocab.split(', ').forEach(phrase => {
          html += `<div class="phrase-item" onclick="insertPhrase('${phrase}')">${phrase}</div>`;
        });
      }
      
      html += '</div>';
      container.innerHTML = html;
    }
    
    function renderQuestion(container) {
      container.innerHTML = `
        <div class="question-display">
          <h4>üìù Your Task</h4>
          <p class="question-text" style="margin-bottom: 0.75rem; font-style: italic; color: #8e8e93;">${sampleQuestion.context}</p>
          <p class="question-text" style="margin-bottom: 0.75rem;">${sampleQuestion.task}</p>
          <p class="question-text" style="font-size: 0.6875rem; color: #636366;">Word count: ${sampleQuestion.wordCount}</p>
        </div>
      `;
    }
    
    function insertPhrase(phrase) {
      const textarea = document.getElementById('writeArea');
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const text = textarea.value;
      
      textarea.value = text.substring(0, start) + phrase + ' ' + text.substring(end);
      textarea.focus();
      textarea.selectionStart = textarea.selectionEnd = start + phrase.length + 1;
      
      handleInput();
    }
    
    // ============================================
    // DRAFT MANAGEMENT
    // ============================================
    
    function saveDraft() {
      reviewDraft[currentStage] = document.getElementById('writeArea').value;
      saveDraftToStorage();
      alert('‚úÖ Draft saved!');
    }
    
    function saveDraftToStorage() {
      localStorage.setItem('reviewDraft', JSON.stringify({
        stage: currentStage,
        content: reviewDraft,
        timestamp: new Date().toISOString()
      }));
    }
    
    function loadDraft() {
      const saved = localStorage.getItem('reviewDraft');
      if (saved) {
        const data = JSON.parse(saved);
        reviewDraft = data.content;
        currentStage = data.stage;
      }
    }
    
    // Initialize
    init();
  </script>
</body>
</html>
