<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>INTUITY - Paragraph Builder</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --accent: #C9A961;
      --accent-soft: rgba(201, 169, 97, 0.32);
      --accent-bg: rgba(201, 169, 97, 0.2);
    }

    body {
      font-family: 'DM Sans', 'Inter', sans-serif;
      background: radial-gradient(circle at top, #1a1a1a 0, #050505 45%, #000 100%);
      color: #e5e5e7;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      overflow-x: hidden;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at 20% 10%, rgba(201, 169, 97, 0.12) 0%, transparent 55%),
        radial-gradient(circle at 80% 90%, rgba(201, 169, 97, 0.06) 0%, transparent 45%);
      pointer-events: none;
      z-index: 0;
    }

    .container {
      position: relative;
      z-index: 2;
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    /* HEADER */
    .header {
      background: rgba(28, 28, 30, 0.85);
      backdrop-filter: blur(40px);
      border-bottom: 1px solid rgba(84, 84, 88, 0.2);
      padding: 0.5rem 1rem;
      margin-bottom: 1rem;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      text-align: center;
    }

    .brand-logo {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.35rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent) 0%, rgba(255,255,255,0.85) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.04em;
      text-transform: uppercase;
      margin-bottom: 0.15rem;
    }

    .brand-subtitle {
      font-size: 0.65rem;
      color: #8e8e93;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    /* BACK BUTTON */
    .back-btn {
      position: absolute;
      top: 1rem;
      left: 1rem;
      padding: 0.4rem 0.8rem;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 999px;
      color: #C9A961;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      z-index: 100;
    }

    .back-btn:hover {
      background: rgba(0, 0, 0, 0.6);
      border-color: rgba(201, 169, 97, 0.3);
      transform: translateX(-2px);
    }

    /* MAIN CARD */
    .card {
      background: rgba(20, 20, 22, 0.85);
      backdrop-filter: blur(30px) saturate(160%);
      -webkit-backdrop-filter: blur(30px) saturate(160%);
      border-radius: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow:
        0 20px 40px rgba(0, 0, 0, 0.9),
        inset 0 1px 0 rgba(255, 255, 255, 0.04);
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      flex: 1;
      margin-bottom: 1rem;
    }

    /* TOP BAR */
    .card-top {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      font-size: 0.7rem;
      color: #a1a1aa;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      padding-bottom: 0.5rem;
    }

    /* MODE TOGGLE */
    .mode-toggle {
      display: inline-flex;
      background: rgba(0,0,0,0.4);
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.06);
      overflow: hidden;
    }

    .mode-btn {
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 0.65rem;
      padding: 0.4rem 1rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
    }

    .mode-btn.active {
      background: var(--accent-bg);
      color: #f9fafb;
    }

    /* X-RAY BUTTON */
    .xray-btn {
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 0.4rem 1rem;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 999px;
      color: #C9A961;
      cursor: pointer;
      transition: all 0.3s;
    }

    .xray-btn:hover {
      background: rgba(0, 0, 0, 0.5);
      border-color: rgba(201, 169, 97, 0.3);
    }

    /* NAVIGATION DOTS */
    .nav-section {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin-top: 0.25rem;
    }

    .nav-dots {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
    }

    .nav-dot {
      width: 11px;
      height: 11px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      transition: all 0.3s;
    }

    .nav-dot.active {
      background: var(--accent);
      border-color: var(--accent);
      box-shadow: 0 0 16px var(--accent-soft);
      transform: scale(1.3);
    }

    .nav-dot:hover:not(.active) {
      background: var(--accent-soft);
      transform: scale(1.15);
    }

    /* PRESENTATION AREA - SPEAKING SLIDES STYLE */
    .presentation-area {
      margin-top: 0.25rem;
      padding: 2rem 2rem;
      border-radius: 1.2rem;
      background: 
        linear-gradient(145deg, rgba(25, 25, 27, 0.7), rgba(15, 15, 17, 0.85));
      box-shadow: 
        inset 8px 8px 16px rgba(0, 0, 0, 0.6),
        inset -8px -8px 16px rgba(40, 40, 42, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.02);
      min-height: 360px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 1.5rem;
      text-align: center;
    }

    /* MASSIVE POSTER-STYLE TEXT */
    .poster-text {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.8rem;
      font-weight: 800;
      line-height: 1.15;
      color: #fef3c7;
      letter-spacing: -0.03em;
      text-shadow: 
        0 2px 20px rgba(0, 0, 0, 0.9),
        0 0 40px rgba(254, 243, 199, 0.3);
      max-width: 95%;
      margin: 0 auto;
    }

    /* OPENER - GREEN HIGHLIGHT */
    .opener-highlight {
      color: #10b981;
      text-shadow: 
        0 2px 20px rgba(0, 0, 0, 0.9),
        0 0 40px rgba(16, 185, 129, 0.4);
    }

    /* LINKING WORDS - BLUE HIGHLIGHT */
    .linking-highlight {
      color: #3b82f6;
      text-shadow: 
        0 2px 20px rgba(0, 0, 0, 0.9),
        0 0 40px rgba(59, 130, 246, 0.4);
    }

    /* SUPPORT CHIPS */
    .support-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
      margin-top: 0.75rem;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.45rem 0.85rem;
      border-radius: 999px;
      font-size: 0.8rem;
      background: rgba(15, 15, 16, 0.8);
      border: 1px solid var(--accent-soft);
      color: #e5e7eb;
      font-weight: 500;
    }

    .chip-emoji {
      font-size: 1rem;
    }

    /* X-RAY MODE */
    .xray-part {
      padding: 1.25rem;
      border-radius: 0.75rem;
      border-left: 4px solid;
      margin-bottom: 1rem;
      text-align: left;
      max-width: 90%;
    }

    .xray-label {
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      opacity: 0.8;
      margin-bottom: 0.75rem;
      color: var(--accent);
    }

    .xray-text {
      font-size: 1rem;
      line-height: 1.7;
      color: #e5e7eb;
    }

    .xray-opener { background: rgba(52, 211, 153, 0.1); border-color: #34d399; }
    .xray-topic { background: rgba(254, 243, 199, 0.15); border-color: #fef3c7; }
    .xray-explain { background: rgba(167, 139, 250, 0.1); border-color: #a78bfa; }
    .xray-reason { background: rgba(96, 165, 250, 0.1); border-color: #60a5fa; }
    .xray-example { background: rgba(52, 211, 153, 0.1); border-color: #34d399; }
    .xray-result { background: rgba(251, 146, 60, 0.1); border-color: #fb923c; }
    .xray-reformulate { background: rgba(168, 85, 247, 0.1); border-color: #a855f7; }
    .xray-compare { background: rgba(236, 72, 153, 0.1); border-color: #ec4899; }
    .xray-contrast { background: rgba(239, 68, 68, 0.1); border-color: #ef4444; }

    /* BOTTOM NAVIGATION */
    .bottom-nav {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 0.5rem;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .btn {
      min-height: 2.5rem;
      padding: 0 1.25rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      color: #e5e5e7;
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn:hover:not(.btn-disabled) {
      background: rgba(0, 0, 0, 0.5);
      border-color: rgba(201, 169, 97, 0.3);
      transform: translateY(-1px);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent) 0%, #fef9c3 100%);
      color: #111827;
      border-color: var(--accent);
      box-shadow: 0 3px 10px var(--accent-soft);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #d4b46e 0%, #fef9c3 100%);
      box-shadow: 0 4px 12px var(--accent-soft);
      transform: translateY(-2px);
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .btn-disabled {
      opacity: 0.3;
      cursor: not-allowed;
      box-shadow: none;
    }

    .btn-small {
      padding: 0 0.9rem;
      min-height: 2.25rem;
    }

    /* MODAL */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      z-index: 9999;
    }

    .modal-overlay.show { display: flex; }

    .modal-content {
      position: relative;
      background: rgba(20, 20, 22, 0.95);
      backdrop-filter: blur(40px) saturate(150%);
      -webkit-backdrop-filter: blur(40px) saturate(150%);
      border-radius: 1.5rem;
      padding: 2rem;
      max-width: 700px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow:
        0 25px 50px rgba(0, 0, 0, 0.9),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }

    .modal-title {
      font-family: 'Space Grotesk', serif;
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: #C9A961;
      text-transform: uppercase;
      text-align: center;
    }

    .modal-option {
      display: flex;
      align-items: start;
      gap: 1rem;
      margin-bottom: 1rem;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 0.75rem;
      transition: all 0.3s;
    }

    .modal-option:hover {
      background: rgba(0, 0, 0, 0.5);
      border-color: rgba(255, 255, 255, 0.08);
    }

    .option-number {
      font-weight: 700;
      color: #C9A961;
      min-width: 2rem;
    }

    .option-text {
      flex: 1;
      color: #e5e7eb;
      line-height: 1.6;
    }

    .use-btn {
      padding: 0.5rem 1rem;
      border-radius: 999px;
      background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
      color: #000;
      border: none;
      font-size: 0.75rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      white-space: nowrap;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .use-btn:hover {
      background: linear-gradient(135deg, #34d399 0%, #6ee7b7 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      color: #8e8e93;
      font-size: 1.25rem;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      background: rgba(0, 0, 0, 0.6);
      color: #e5e5e7;
      border-color: rgba(255, 255, 255, 0.15);
    }

   /* OPENER MODAL - CENTERED LIKE ESSAY PLAN */
.opener-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(10px);
  z-index: 10000;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 1rem;
  animation: fadeIn 0.3s ease;
}

.opener-modal-overlay.show {
  display: flex;
}

.opener-modal-content {
  background: rgba(20, 20, 22, 0.95);
  backdrop-filter: blur(30px);
  border-radius: 1.5rem;
  border: 1px solid rgba(255, 255, 255, 0.08);
  max-width: 500px;
  width: 100%;
  max-height: 70vh;
  overflow: hidden;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.9);
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from {
    transform: translateY(20px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.opener-modal-header {
  padding: 1.5rem 2rem;
  background: rgba(0, 0, 0, 0.3);
  border-bottom: 1px solid rgba(84, 84, 88, 0.2);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.opener-modal-title {
  font-family: 'Space Grotesk', sans-serif;
  font-size: 1.25rem;
  font-weight: 700;
  color: #C9A961;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.opener-modal-close {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 50%;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #8e8e93;
  font-size: 1.25rem;
  cursor: pointer;
  transition: all 0.3s;
}

.opener-modal-close:hover {
  background: rgba(255, 255, 255, 0.1);
  color: #e5e5e7;
}

.opener-modal-body {
  padding: 1.5rem;
  max-height: calc(70vh - 100px);
  overflow-y: auto;
}

.opener-option {
  width: 100%;
  text-align: left;
  background: rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(255, 255, 255, 0.05);
  padding: 1rem 1.25rem;
  margin-bottom: 0.75rem;
  font-size: 0.9rem;
  color: #e5e7eb;
  cursor: pointer;
  border-radius: 0.75rem;
  transition: all 0.3s;
  display: block;
}

.opener-option:hover {
  background: rgba(201, 169, 97, 0.15);
  border-color: rgba(201, 169, 97, 0.3);
  transform: translateX(4px);
}

.opener-option:last-child {
  margin-bottom: 0;
}

    /* OPENER CATEGORIES */
.opener-category {
  margin-bottom: 1.5rem;
}

.opener-category:last-child {
  margin-bottom: 0;
}

.opener-category-title {
  font-family: 'Space Grotesk', sans-serif;
  font-size: 0.75rem;
  font-weight: 700;
  color: #C9A961;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  margin-bottom: 0.75rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid rgba(201, 169, 97, 0.2);
}

.opener-category-list {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}
    
    /* MOBILE */
    @media (max-width: 768px) {
      body {
        padding: 0.4rem;
        padding-top: 0.4rem;
      }

      .container {
        padding: 0;
      }

      .back-btn {
        top: 0.4rem;
        left: 0.4rem;
        padding: 0.3rem 0.5rem;
        font-size: 0.55rem;
      }

      .header {
        padding: 0.4rem 0.6rem;
        margin-bottom: 0.5rem;
      }

      .brand-logo {
        font-size: 1rem;
        margin-bottom: 0.1rem;
      }

      .brand-subtitle {
        font-size: 0.55rem;
      }

      .card {
        padding: 0.75rem;
        gap: 0.4rem;
      }

      .presentation-area {
        padding: 1.5rem 1rem;
        min-height: 280px;
        gap: 1rem;
      }

      .poster-text {
        font-size: 1.5rem;
      }

      .nav-dot {
        width: 10px;
        height: 10px;
        border: 1px solid rgba(255, 255, 255, 0.15);
      }

      .btn {
        min-height: 2.25rem;
        font-size: 0.65rem;
        padding: 0 0.85rem;
      }

      .btn-small {
        padding: 0 0.65rem;
        min-height: 2rem;
      }

      .chip {
        font-size: 0.7rem;
        padding: 0.35rem 0.6rem;
      }

      .chip-emoji {
        font-size: 0.85rem;
      }

      .xray-part {
        padding: 0.85rem;
        margin-bottom: 0.65rem;
      }

      .xray-text {
        font-size: 0.85rem;
        line-height: 1.5;
      }

      .xray-label {
        font-size: 0.6rem;
        margin-bottom: 0.4rem;
      }
    }
  </style>
</head>
<body>

<button class="back-btn" id="backBtn">
  <span>‚Üê</span>
  <span id="backText">Back</span>
</button>

<div class="container">
  <!-- HEADER -->
  <header class="header">
    <div class="brand-logo">INTUITY</div>
    <div class="brand-subtitle">Paragraph Builder</div>
  </header>

  <!-- MAIN CARD -->
  <main class="card">
    <!-- TOP BAR -->
    <div class="card-top">
      <!-- MODE TOGGLE -->
      <div class="mode-toggle">
        <button class="mode-btn active" data-mode="read">Read</button>
        <button class="mode-btn" data-mode="build">Build</button>
      </div>

      <!-- X-RAY TOGGLE -->
      <button class="xray-btn" id="xrayBtn">X-Ray</button>
    </div>

    <!-- NAVIGATION DOTS (READ MODE) -->
    <div class="nav-section" id="navSection" style="display: none;">
      <div class="nav-dots" id="navDots"></div>
    </div>

    <!-- PRESENTATION AREA -->
    <section class="presentation-area" id="presentationArea">
      Loading...
    </section>

    <!-- BOTTOM NAVIGATION -->
    <div class="bottom-nav" id="bottomNav"></div>
  </main>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal()">√ó</button>
    <h2 class="modal-title" id="modalTitle">Select Option</h2>
    <div id="modalOptions"></div>
  </div>
</div>

<!-- OPENER MODAL -->
<div class="opener-modal-overlay" id="openerModal" onclick="closeOpenerModal(event)">
  <div class="opener-modal-content" onclick="event.stopPropagation()">
    <div class="opener-modal-header">
      <div class="opener-modal-title">
        <span>‚úèÔ∏è</span>
        <span>Choose an Opener</span>
      </div>
      <button class="opener-modal-close" onclick="closeOpenerModal()">&times;</button>
    </div>
    <div class="opener-modal-body" id="openerModalBody"></div>
  </div>
</div>

<script>
// ==================== DATA ====================
let sentencesData = [];
let openersByType = {};
let readModeSamples = [];

const linkingWords = [
  'For example', 'For instance', 'However', 'Therefore', 'Thus', 'Hence',
  'As a result', 'Consequently', 'Moreover', 'Furthermore', 'In addition',
  'Nevertheless', 'Nonetheless', 'On the other hand', 'In contrast',
  'Similarly', 'Likewise', 'In fact', 'Indeed', 'Specifically',
  'This is because', 'This happens because', 'Given that', 'Since',
  'Although', 'While', 'Whereas', 'By comparison', 'Compared to',
  'Unlike', 'In other words', 'That is to say', 'Namely', 'Put simply',
  'To say it another way'
];

// ==================== STATE ====================
let mode = 'read';
let currentSentenceIndex = 0;
let usedTransforms = {};
let paragraphText = '';
let currentOpener = '';
let showXRay = false;

// READ MODE SPECIFIC STATE
let readDotIndex = 0;
let readParagraphSteps = [];

// ==================== DATA LOADING ====================
async function loadSentencesFromJSON() {
  try {
    const response = await fetch('data/transformations.json');
    const data = await response.json();
    sentencesData = data.sentences;
    console.log('‚úì Sentences loaded:', sentencesData.length, 'sentences');
    return true;
  } catch (error) {
    console.error('‚úó Error loading sentences:', error);
    document.getElementById('presentationArea').innerHTML = `
      <div style="text-align: center; padding: 2rem; color: #fb923c;">
        <p style="font-size: 1.2rem; margin-bottom: 1rem;">‚ö†Ô∏è Data Loading Error</p>
        <p style="color: #8e8e93;">Could not load transformations.json</p>
      </div>
    `;
    return false;
  }
}

async function loadOpenersFromJSON() {
  try {
    const response = await fetch('data/transformations-opener-sets.json');
    const data = await response.json();
    openersByType = data;
    console.log('‚úì Openers loaded:', Object.keys(openersByType).length, 'categories');
    return true;
  } catch (error) {
    console.error('‚úó Error loading openers:', error);
    return false;
  }
}

async function loadReadModeSamples() {
  try {
    const response = await fetch('data/transformations-read-mode.json');
    const data = await response.json();
    readModeSamples = data.samples || [];
    console.log('‚úì READ mode samples loaded:', readModeSamples.length, 'samples');
    return true;
  } catch (error) {
    console.error('‚úó Error loading READ mode samples:', error);
    return false;
  }
}

function getCurrentOpeners() {
  // Combine all opener categories into one array
  const allOpeners = [];
  
  for (const key in openersByType) {
    if (openersByType[key].openers) {
      allOpeners.push(...openersByType[key].openers);
    }
  }
  
  return allOpeners;
}
  
function getRandomSentence() {
  if (!sentencesData || sentencesData.length === 0) return null;
  const randomIndex = Math.floor(Math.random() * sentencesData.length);
  return sentencesData[randomIndex];
}

// ==================== READ MODE LOGIC ====================
function generateReadModeParagraph() {
  if (readModeSamples && readModeSamples.length > 0) {
    const sample = readModeSamples[currentSentenceIndex];
    if (sample && sample.steps) {
      return sample.steps.map(step => step.text);
    }
  }
  
  const sentence = sentencesData[currentSentenceIndex];
  const transforms = getTransforms();
  
  const shuffled = [...transforms].sort(() => Math.random() - 0.5);
  const selected = shuffled.slice(0, 3);
  
  const steps = [];
  
  const opener = getCurrentOpeners()[Math.floor(Math.random() * getCurrentOpeners().length)];
  const topicWithOpener = opener + ' ' + sentence.base.charAt(0).toLowerCase() + sentence.base.slice(1);
  steps.push(topicWithOpener);
  
  let building = topicWithOpener;
  selected.forEach(transform => {
    const options = sentence[transform] || [];
    if (options.length > 0) {
      const randomOption = options[Math.floor(Math.random() * options.length)];
      building += ' ' + randomOption;
      steps.push(building);
    }
  });
  
  return steps;
}

// ==================== LOGIC ====================
function getTransforms() {
  return ['explain', 'reason', 'example', 'result', 'reformulate', 'compare', 'contrast'];
}

function resetParagraph() {
  const sentence = getRandomSentence();
  if (sentence) {
    paragraphText = sentence.base;
    currentSentenceIndex = sentencesData.indexOf(sentence);
  }
  usedTransforms = {};
  currentOpener = '';
  
  readDotIndex = 0;
  readParagraphSteps = generateReadModeParagraph();
}

function highlightLinkingWords(text) {
  if (!text) return '';
  const pattern = new RegExp(`\\b(${linkingWords.join('|')})\\b`, 'gi');
  return text.replace(pattern, '<span class="linking-highlight">$1</span>');
}

function addSentence(transform, index) {
  if (usedTransforms[transform]) return;
  const currentSentence = sentencesData[currentSentenceIndex];
  const sentenceArray = currentSentence[transform] || [];
  const sentence = sentenceArray[index];
  if (!sentence) return;
  paragraphText = (paragraphText.trim() + ' ' + sentence).trim();
  usedTransforms = { ...usedTransforms, [transform]: true };
  closeModal();
  render();
}

function getFullParagraph() {
  const currentSentence = sentencesData[currentSentenceIndex];
  const base = currentSentence.base;
  let additional = paragraphText.replace(base, '').trim();
  let full = base;
  if (additional) full = base + ' ' + additional;
  if (currentOpener && full) {
    full = currentOpener + ' ' + full.charAt(0).toLowerCase() + full.slice(1);
  }
  return full;
}

function copyText() {
  const text = mode === 'build'
    ? getFullParagraph()
    : (readParagraphSteps[readParagraphSteps.length - 1] || '');
  navigator.clipboard.writeText(text).catch(() => {});
}

function analyzeParagraphStructure() {
  const parts = [];
  const currentSentence = sentencesData[currentSentenceIndex];
  const base = currentSentence.base;

  if (currentOpener) {
    parts.push({
      type: 'opener',
      text: currentOpener,
      color: 'xray-opener',
      label: 'OPENER'
    });
  }

  parts.push({
    type: 'topic',
    text: base,
    color: 'xray-topic',
    label: 'TOPIC SENTENCE'
  });

  const colors = {
    explain: { color: 'xray-explain', label: 'EXPLANATION' },
    reason: { color: 'xray-reason', label: 'REASON' },
    example: { color: 'xray-example', label: 'EXAMPLE' },
    result: { color: 'xray-result', label: 'RESULT' },
    reformulate: { color: 'xray-reformulate', label: 'REFORMULATION' },
    compare: { color: 'xray-compare', label: 'COMPARISON' },
    contrast: { color: 'xray-contrast', label: 'CONTRAST' }
  };

  Object.keys(usedTransforms).forEach(transform => {
    const sentences = currentSentence[transform];
    if (!sentences) return;
    const matchedSentence = sentences.find(s => paragraphText.includes(s));
    if (matchedSentence) {
      parts.push({
        type: transform,
        text: matchedSentence,
        ...colors[transform]
      });
    }
  });

  return parts;
}

function analyzeReadParagraph(paragraph) {
  const sentences = paragraph.split(/(?<=[.!?])\s+/).filter(s => s.trim());
  
  return sentences.map((sentence, i) => {
    let type = 'supporting';
    let color = 'xray-explain';
    let label = 'SUPPORTING';
    const s = sentence.toLowerCase();

    if (i === 0) {
      const hasOpener = getCurrentOpeners().some(opener => 
        sentence.toLowerCase().startsWith(opener.toLowerCase())
      );
      
      if (hasOpener) {
        type = 'opener+topic';
        color = 'xray-opener';
        label = 'OPENER + TOPIC';
      } else {
        type = 'topic';
        color = 'xray-topic';
        label = 'TOPIC SENTENCE';
      }
    } else if (/for example|for instance/i.test(s)) {
      type = 'example';
      color = 'xray-example';
      label = 'EXAMPLE';
    } else if (/this is because|this happens because|given that|since/i.test(s)) {
      type = 'reason';
      color = 'xray-reason';
      label = 'REASON';
    } else if (/therefore|thus|as a result|consequently|ultimately/i.test(s)) {
      type = 'result';
      color = 'xray-result';
      label = 'RESULT';
    } else if (/in other words|put simply|to say it another way/i.test(s)) {
      type = 'reformulate';
      color = 'xray-reformulate';
      label = 'REFORMULATION';
    } else if (/compared to|unlike|in contrast to/i.test(s)) {
      type = 'compare';
      color = 'xray-compare';
      label = 'COMPARISON';
    } else if (/however|on the other hand|in contrast/i.test(s)) {
      type = 'contrast';
      color = 'xray-contrast';
      label = 'CONTRAST';
    } else {
      type = 'explain';
      color = 'xray-explain';
      label = 'EXPLANATION';
    }

    return {
      type,
      text: sentence,
      color,
      label
    };
  });
}

// ==================== RENDER ====================
function renderContent() {
  if (mode === 'read') {
    const currentParagraph = readParagraphSteps[readDotIndex] || readParagraphSteps[0];
    
    if (!showXRay) {
      // Find opener pattern
      const openers = getCurrentOpeners();
      let openerMatch = null;
      let restOfParagraph = currentParagraph;
      
      for (const opener of openers) {
        if (currentParagraph.toLowerCase().startsWith(opener.toLowerCase())) {
          openerMatch = currentParagraph.substring(0, opener.length);
          restOfParagraph = currentParagraph.substring(opener.length).trim();
          break;
        }
      }
      
      let html = '<div class="poster-text">';
      
      if (openerMatch) {
        html += `<span class="opener-highlight">${openerMatch}</span> `;
      }
      
      html += highlightLinkingWords(restOfParagraph);
      html += '</div>';
      
      return html;
    } else {
      const parts = analyzeReadParagraph(currentParagraph);
      return parts.map(part => `
        <div class="${part.color} xray-part">
          <div class="xray-label">${part.label}</div>
          <div class="xray-text">${part.text}</div>
        </div>
      `).join('');
    }
  } else {
    // BUILD MODE
    const currentSentence = sentencesData[currentSentenceIndex];
    const base = currentSentence.base;
    const additional = paragraphText !== base ? paragraphText.replace(base, '').trim() : '';

    if (!showXRay) {
      let html = '<div class="poster-text">';
      
      if (currentOpener) {
        html += `<span class="opener-highlight">${currentOpener}</span> ${base.charAt(0).toLowerCase() + base.slice(1)}`;
      } else {
        html += base;
      }
      
      if (additional) {
        html += ' ' + highlightLinkingWords(additional);
      }
      
      html += '</div>';
      
      // Show transform chips
      const usedKeys = Object.keys(usedTransforms);
      if (usedKeys.length > 0) {
        html += '<div class="support-chips">';
        usedKeys.forEach(key => {
          const emojis = {
            explain: 'üí°',
            reason: 'üîç',
            example: 'üìù',
            result: '‚ú®',
            reformulate: 'üîÑ',
            compare: '‚öñÔ∏è',
            contrast: 'üîÄ'
          };
          html += `<div class="chip"><span class="chip-emoji">${emojis[key] || 'üìå'}</span><span>${key}</span></div>`;
        });
        html += '</div>';
      }
      
      return html;
    } else {
      const parts = analyzeParagraphStructure();
      return parts.map(part => `
        <div class="${part.color} xray-part">
          <div class="xray-label">${part.label}</div>
          <div class="xray-text">${part.text}</div>
        </div>
      `).join('');
    }
  }
}

function renderBottomNav() {
  const bottomNav = document.getElementById('bottomNav');
  
  if (mode === 'read') {
    const prevDisabled = readDotIndex === 0 ? 'btn-disabled' : '';
    const nextDisabled = readDotIndex === readParagraphSteps.length - 1 ? 'btn-disabled' : '';
    
    bottomNav.innerHTML = `
      <button class="btn btn-small ${prevDisabled}" onclick="prevReadStep()">
        <span>‚Üê</span>
        <span>Back</span>
      </button>
      <button class="btn" onclick="copyText()">
        <span>üìã</span>
        <span>Copy</span>
      </button>
      <button class="btn btn-primary" onclick="newSentence()">
        <span>üîÑ</span>
        <span>New</span>
      </button>
      <button class="btn btn-small ${nextDisabled}" onclick="nextReadStep()">
        <span>Next</span>
        <span>‚Üí</span>
      </button>
    `;
  } else {
    const transforms = getTransforms();
    let html = '<button class="btn" onclick="copyText()"><span>üìã</span><span>Copy</span></button>';
    html += '<button class="btn" onclick="showOpenerMenu(event)"><span>‚úèÔ∏è</span><span>Opener</span></button>';
    
    transforms.forEach(t => {
      const disabled = usedTransforms[t] ? 'btn-disabled' : '';
      const emojis = {
        explain: 'üí°',
        reason: 'üîç',
        example: 'üìù',
        result: '‚ú®',
        reformulate: 'üîÑ',
        compare: '‚öñÔ∏è',
        contrast: 'üîÄ'
      };
      html += `<button class="btn ${disabled}" onclick="openTransformModal('${t}')"><span>${emojis[t]}</span><span>${t}</span></button>`;
    });
    
    html += '<button class="btn btn-primary" onclick="resetParagraph();render()"><span>üîÑ</span><span>Fresh</span></button>';
    bottomNav.innerHTML = html;
  }
}

function buildDots() {
  const navDots = document.getElementById('navDots');
  navDots.innerHTML = '';
  
  for (let i = 0; i < readParagraphSteps.length; i++) {
    const dot = document.createElement('div');
    dot.className = 'nav-dot';
    dot.addEventListener('click', () => {
      readDotIndex = i;
      render();
    });
    navDots.appendChild(dot);
  }
}

// ==================== READ MODE NAVIGATION ====================
function nextReadStep() {
  if (readDotIndex < readParagraphSteps.length - 1) {
    readDotIndex++;
    render();
  }
}

function prevReadStep() {
  if (readDotIndex > 0) {
    readDotIndex--;
    render();
  }
}

// ==================== BUILD MODE FUNCTIONS ====================
function showOpenerMenu(event) {
  const modalBody = document.getElementById('openerModalBody');
  
  let html = '';
  let globalIndex = 0;
  
  // Loop through each category
  for (const key in openersByType) {
    const category = openersByType[key];
    
    if (category.openers && category.openers.length > 0) {
      // Add category header
      const categoryTitle = category.description || category.label || key;
      html += `
        <div class="opener-category">
          <div class="opener-category-title">${categoryTitle}</div>
          <div class="opener-category-list">
      `;
      
      // Add openers for this category
      category.openers.forEach(opener => {
        html += `
          <button class="opener-option" onclick="selectOpener(${globalIndex})">${opener}‚Ä¶</button>
        `;
        globalIndex++;
      });
      
      html += `
          </div>
        </div>
      `;
    }
  }
  
  modalBody.innerHTML = html;
  document.getElementById('openerModal').classList.add('show');
}

function closeOpenerModal(event) {
  if (!event || event.target.id === 'openerModal') {
    document.getElementById('openerModal').classList.remove('show');
  }
}

function selectOpener(index) {
  const openers = getCurrentOpeners();
  currentOpener = openers[index];
  closeOpenerModal();
  render();
}

function newSentence() {
  resetParagraph();
  render();
}

function render() {
  // Update mode buttons
  document.querySelectorAll('.mode-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.mode === mode);
  });

  // Show/hide dots based on mode
  const navSection = document.getElementById('navSection');
  navSection.style.display = mode === 'read' ? 'flex' : 'none';

  // Update X-ray button
  document.getElementById('xrayBtn').textContent = showXRay ? 'Normal' : 'X-Ray';
  
  // Render content
  document.getElementById('presentationArea').innerHTML = renderContent();
  
  // Render navigation
  renderBottomNav();
  
  // Update dots if in READ mode
  if (mode === 'read') {
    const dots = document.querySelectorAll('.nav-dot');
    dots.forEach((dot, index) => {
      dot.classList.toggle('active', index === readDotIndex);
    });
  }
}

function openTransformModal(transform) {
  if (usedTransforms[transform]) return;
  const currentSentence = sentencesData[currentSentenceIndex];
  const options = currentSentence[transform] || [];
  
  document.getElementById('modalTitle').textContent = transform.toUpperCase();
  const modalOptions = document.getElementById('modalOptions');
  modalOptions.innerHTML = options.map((option, i) => `
    <div class="modal-option">
      <span class="option-number">${i + 1}.</span>
      <span class="option-text">${option}</span>
      <button class="use-btn" onclick="addSentence('${transform}', ${i})">‚ûï Use</button>
    </div>
  `).join('');
  
  document.getElementById('modalOverlay').classList.add('show');
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('show');
}


// ==================== EVENT LISTENERS ====================
document.querySelectorAll('.mode-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    mode = btn.dataset.mode;
    showXRay = false;
    if (mode === 'read') {
      readDotIndex = 0;
      buildDots();
    }
    render();
  });
});

document.getElementById('xrayBtn').addEventListener('click', () => {
  showXRay = !showXRay;
  render();
});

document.getElementById('modalOverlay').addEventListener('click', (e) => {
  if (e.target.id === 'modalOverlay') closeModal();
});

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeModal();
    closeOpenerModal();
  }
  
  if (mode === 'read' && !showXRay) {
    if (e.key === 'ArrowRight') nextReadStep();
    if (e.key === 'ArrowLeft') prevReadStep();
  }
});
  
// ==================== INITIALIZE ====================
async function init() {
  document.getElementById('presentationArea').innerHTML = `
    <div style="text-align: center; padding: 2rem; color: #8e8e93;">
      <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
      <p style="font-size: 1.2rem;">Loading data...</p>
    </div>
  `;
  
  const [sentencesLoaded, openersLoaded, readModeLoaded] = await Promise.all([
    loadSentencesFromJSON(),
    loadOpenersFromJSON(),
    loadReadModeSamples()
  ]);
  
  if (sentencesLoaded && openersLoaded) {
    console.log('‚úÖ All data loaded successfully');
    resetParagraph();
    buildDots();
    render();
  } else {
    console.error('‚ùå Failed to load required data files');
  }
}
// Dynamic back button setup
function setupBackButton() {
  const backBtn = document.getElementById('backBtn');
  const backText = document.getElementById('backText');
  const urlParams = new URLSearchParams(window.location.search);
  const from = urlParams.get('from');
  
  backBtn.addEventListener('click', () => {
    if (from === 'sentence-structure') {
      window.location.href = '../../../index.html?openModal=writing&submenu=sentence-structure';
    } else {
      window.location.href = '../../../index.html?openModal=writing&submenu=essays';
    }
  });
  
  // Update button text
  backText.textContent = from === 'sentence-structure' ? 'Sentence Structure' : 'Essays';
}

// Call setup when page loads
window.addEventListener('DOMContentLoaded', setupBackButton);

init();
</script>
</body>
</html>
