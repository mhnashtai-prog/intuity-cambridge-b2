<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>INTUITY - Paragraph Builder</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700;800&family=Kalam:wght@300;400;700&display=swap" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --accent: #C9A961;
      --accent-soft: rgba(201, 169, 97, 0.32);
      --accent-bg: rgba(201, 169, 97, 0.2);
    }

    body {
      font-family: 'DM Sans', 'Inter', sans-serif;
      background: radial-gradient(circle at top, #1a1a1a 0, #050505 45%, #000 100%);
      color: #e5e5e7;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      overflow-x: hidden;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at 20% 10%, rgba(201, 169, 97, 0.12) 0%, transparent 55%),
        radial-gradient(circle at 80% 90%, rgba(201, 169, 97, 0.06) 0%, transparent 45%);
      pointer-events: none;
      z-index: 0;
    }

    .container {
      position: relative;
      z-index: 2;
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    /* HEADER */
    .header {
      background: rgba(28, 28, 30, 0.85);
      backdrop-filter: blur(40px);
      border-bottom: 1px solid rgba(84, 84, 88, 0.2);
      padding: 0.5rem 1rem;
      margin-bottom: 1rem;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      text-align: center;
    }

    .brand-logo {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.35rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent) 0%, rgba(255,255,255,0.85) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.04em;
      text-transform: uppercase;
      margin-bottom: 0.15rem;
    }

    .brand-subtitle {
      font-size: 0.65rem;
      color: #8e8e93;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    /* BACK BUTTON */
    .back-btn {
      position: absolute;
      top: 1rem;
      left: 1rem;
      padding: 0.4rem 0.8rem;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 999px;
      color: #C9A961;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      z-index: 100;
    }

    .back-btn:hover {
      background: rgba(0, 0, 0, 0.6);
      border-color: rgba(201, 169, 97, 0.3);
      transform: translateX(-2px);
    }

    /* MAIN CARD */
    .card {
      background: rgba(20, 20, 22, 0.85);
      backdrop-filter: blur(30px) saturate(160%);
      -webkit-backdrop-filter: blur(30px) saturate(160%);
      border-radius: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow:
        0 20px 40px rgba(0, 0, 0, 0.9),
        inset 0 1px 0 rgba(255, 255, 255, 0.04);
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      flex: 1;
      margin-bottom: 1rem;
    }

    /* TOP BAR */
    .card-top {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      font-size: 0.7rem;
      color: #a1a1aa;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      padding-bottom: 0.5rem;
    }

    /* MODE TOGGLE */
    .mode-toggle {
      display: inline-flex;
      background: rgba(0,0,0,0.4);
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.06);
      overflow: hidden;
    }

    .mode-btn {
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 0.65rem;
      padding: 0.4rem 1rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
    }

    .mode-btn.active {
      background: var(--accent-bg);
      color: #f9fafb;
    }

    /* X-RAY BUTTON */
    .xray-btn {
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 0.4rem 1rem;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 999px;
      color: #C9A961;
      cursor: pointer;
      transition: all 0.3s;
    }

    .xray-btn:hover {
      background: rgba(0, 0, 0, 0.5);
      border-color: rgba(201, 169, 97, 0.3);
    }

    /* NAVIGATION DOTS */
    .nav-section {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin-top: 0.25rem;
    }

    .nav-dots {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
    }

    .nav-dot {
      width: 11px;
      height: 11px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      transition: all 0.3s;
    }

    .nav-dot.active {
      background: var(--accent);
      border-color: var(--accent);
      box-shadow: 0 0 16px var(--accent-soft);
      transform: scale(1.3);
    }

    .nav-dot:hover:not(.active) {
      background: var(--accent-soft);
      transform: scale(1.15);
    }

    /* PRESENTATION AREA - SPEAKING SLIDES STYLE */
    .presentation-area {
      margin-top: 0.25rem;
      padding: 2rem 2rem;
      border-radius: 1.2rem;
      background: 
        linear-gradient(145deg, rgba(25, 25, 27, 0.7), rgba(15, 15, 17, 0.85));
      box-shadow: 
        inset 8px 8px 16px rgba(0, 0, 0, 0.6),
        inset -8px -8px 16px rgba(40, 40, 42, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.02);
      min-height: 360px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 1.5rem;
      text-align: center;
    }

    /* MASSIVE POSTER-STYLE TEXT */
    .poster-text {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.8rem;
      font-weight: 800;
      line-height: 1.15;
      color: #fef3c7;
      letter-spacing: -0.03em;
      text-shadow: 
        0 2px 20px rgba(0, 0, 0, 0.9),
        0 0 40px rgba(254, 243, 199, 0.3);
      max-width: 95%;
      margin: 0 auto;
    }

    /* OPENER - GREEN HIGHLIGHT */
    .opener-highlight {
      color: #10b981;
      text-shadow: 
        0 2px 20px rgba(0, 0, 0, 0.9),
        0 0 40px rgba(16, 185, 129, 0.4);
    }

    /* LINKING WORDS - BLUE HIGHLIGHT */
    .linking-highlight {
      color: #3b82f6;
      text-shadow: 
        0 2px 20px rgba(0, 0, 0, 0.9),
        0 0 40px rgba(59, 130, 246, 0.4);
    }

    /* SUPPORT CHIPS */
    .support-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
      margin-top: 0.75rem;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.45rem 0.85rem;
      border-radius: 999px;
      font-size: 0.8rem;
      background: rgba(15, 15, 16, 0.8);
      border: 1px solid var(--accent-soft);
      color: #e5e7eb;
      font-weight: 500;
    }

    .chip-emoji {
      font-size: 1rem;
    }

    /* X-RAY MODE */
    .xray-part {
      padding: 1.25rem;
      border-radius: 0.75rem;
      border-left: 4px solid;
      margin-bottom: 1rem;
      text-align: left;
      max-width: 90%;
    }

    .xray-label {
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      opacity: 0.8;
      margin-bottom: 0.75rem;
      color: var(--accent);
    }

    .xray-text {
      font-size: 1rem;
      line-height: 1.7;
      color: #e5e7eb;
    }

    .xray-opener { background: rgba(52, 211, 153, 0.1); border-color: #34d399; }
    .xray-topic { background: rgba(254, 243, 199, 0.15); border-color: #fef3c7; }
    .xray-explain { background: rgba(167, 139, 250, 0.1); border-color: #a78bfa; }
    .xray-reason { background: rgba(96, 165, 250, 0.1); border-color: #60a5fa; }
    .xray-example { background: rgba(52, 211, 153, 0.1); border-color: #34d399; }
    .xray-result { background: rgba(251, 146, 60, 0.1); border-color: #fb923c; }
    .xray-reformulate { background: rgba(168, 85, 247, 0.1); border-color: #a855f7; }
    .xray-compare { background: rgba(236, 72, 153, 0.1); border-color: #ec4899; }
    .xray-contrast { background: rgba(239, 68, 68, 0.1); border-color: #ef4444; }

    /* INFOGRAPHIC MODE */
    .infographic-container {
      position: relative;
      width: 100%;
      min-height: 500px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 3rem 1rem;
    }

    /* CENTRAL SENTENCE */
    .central-sentence {
      position: relative;
      z-index: 10;
      background: linear-gradient(145deg, rgba(30, 30, 32, 0.95), rgba(20, 20, 22, 0.98));
      border: 2px solid var(--accent);
      border-radius: 1.5rem;
      padding: 2rem 2.5rem;
      max-width: 480px;
      box-shadow: 
        0 0 60px rgba(201, 169, 97, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      animation: centralPulse 3s ease-in-out infinite;
    }

    @keyframes centralPulse {
      0%, 100% { box-shadow: 0 0 60px rgba(201, 169, 97, 0.25); }
      50% { box-shadow: 0 0 80px rgba(201, 169, 97, 0.4); }
    }

    .central-sentence-text {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.35rem;
      font-weight: 600;
      line-height: 1.5;
      color: #fef3c7;
      text-align: center;
      letter-spacing: -0.02em;
    }

    /* FLOATING PILLS */
    .linking-pill {
      position: absolute;
      background: rgba(15, 15, 17, 0.85);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 999px;
      padding: 0.85rem 1.5rem;
      font-size: 0.85rem;
      font-weight: 600;
      color: #e5e7eb;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.6),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      animation: float 4s ease-in-out infinite;
      white-space: nowrap;
    }

    .linking-pill::before {
      content: '';
      position: absolute;
      inset: -1px;
      border-radius: 999px;
      padding: 1px;
      background: linear-gradient(135deg, transparent, rgba(201, 169, 97, 0.3));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .linking-pill:hover {
      transform: scale(1.15) translateY(-8px);
      border-color: var(--accent);
      box-shadow: 
        0 8px 24px rgba(201, 169, 97, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .linking-pill:hover::before {
      opacity: 1;
    }

    /* ORBITAL POSITIONS */
    .linking-pill:nth-child(3) { 
      top: 10%; left: 15%;
      animation-delay: 0s;
    }
    .linking-pill:nth-child(4) { 
      top: 15%; right: 12%;
      animation-delay: -1s;
    }
    .linking-pill:nth-child(5) { 
      bottom: 20%; left: 10%;
      animation-delay: -2s;
    }
    .linking-pill:nth-child(6) { 
      bottom: 15%; right: 15%;
      animation-delay: -3s;
    }
    .linking-pill:nth-child(7) { 
      top: 45%; left: 5%;
      animation-delay: -1.5s;
    }
    .linking-pill:nth-child(8) { 
      top: 50%; right: 8%;
      animation-delay: -2.5s;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      25% { transform: translateY(-12px) rotate(1deg); }
      50% { transform: translateY(0px) rotate(-1deg); }
      75% { transform: translateY(-8px) rotate(0.5deg); }
    }

    /* CONNECTION LINES (SVG) */
    .connection-line {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    .connection-line line {
      stroke: rgba(201, 169, 97, 0.15);
      stroke-width: 2;
      stroke-dasharray: 8, 8;
      animation: dashFlow 20s linear infinite;
    }

    @keyframes dashFlow {
      to { stroke-dashoffset: -200; }
    }

    /* READ MODE - STACKED SENTENCE STRIPS LIKE INDEX CARDS */
    .unified-paragraph-container {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 2.5rem;
      max-width: 900px;
      margin: 0 auto;
      gap: -0.25rem;
      position: relative;
    }

    .sentence-strip {
      display: block;
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      width: fit-content;
      max-width: 90%;
      box-shadow: 
        0 2px 4px rgba(0, 0, 0, 0.2),
        0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* Cascade positioning - each strip overlaps slightly */
    .sentence-strip {
      margin-top: -0.5rem;
    }

    .sentence-strip:first-child {
      margin-top: 0;
    }

    /* Diagonal stagger - each one slightly offset to the right */
    .sentence-strip:nth-child(1) {
      margin-left: 0;
      z-index: 5;
    }

    .sentence-strip:nth-child(2) {
      margin-left: 1.5rem;
      z-index: 4;
    }

    .sentence-strip:nth-child(3) {
      margin-left: 3rem;
      z-index: 3;
    }

    .sentence-strip:nth-child(4) {
      margin-left: 4.5rem;
      z-index: 2;
    }

    .sentence-strip:nth-child(5) {
      margin-left: 6rem;
      z-index: 1;
    }

    /* Monochromatic color scheme - golden/yellow tones from light to dark */
    .sentence-strip.strip-base {
      font-family: 'DM Sans', 'Inter', sans-serif;
      font-weight: 500;
      font-size: 1.25rem;
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      color: #1a1a1a;
      border-top: 3px solid #f59e0b;
      border-bottom: 1px solid rgba(245, 158, 11, 0.4);
      transform: rotate(-0.5deg);
    }

    .sentence-strip.strip-expansion-1 {
      font-family: 'Kalam', 'Comic Sans MS', cursive;
      font-weight: 400;
      font-size: 1.2rem;
      letter-spacing: 0.02em;
      line-height: 1.6;
      background: linear-gradient(135deg, #fde68a, #fcd34d);
      color: #1a1a1a;
      border-top: 3px solid #f59e0b;
      border-bottom: 1px solid rgba(245, 158, 11, 0.4);
      transform: rotate(0.6deg);
    }

    .sentence-strip.strip-expansion-2 {
      font-family: 'Kalam', 'Comic Sans MS', cursive;
      font-weight: 400;
      font-size: 1.2rem;
      letter-spacing: 0.02em;
      line-height: 1.6;
      background: linear-gradient(135deg, #fcd34d, #fbbf24);
      color: #1a1a1a;
      border-top: 3px solid #f59e0b;
      border-bottom: 1px solid rgba(245, 158, 11, 0.4);
      transform: rotate(-0.4deg);
    }

    .sentence-strip.strip-expansion-3 {
      font-family: 'Kalam', 'Comic Sans MS', cursive;
      font-weight: 400;
      font-size: 1.2rem;
      letter-spacing: 0.02em;
      line-height: 1.6;
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: #1a1a1a;
      border-top: 3px solid #f59e0b;
      border-bottom: 1px solid rgba(245, 158, 11, 0.4);
      transform: rotate(0.5deg);
    }

    .sentence-strip.strip-expansion-4 {
      font-family: 'Kalam', 'Comic Sans MS', cursive;
      font-weight: 400;
      font-size: 1.2rem;
      letter-spacing: 0.02em;
      line-height: 1.6;
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: #1a1a1a;
      border-top: 3px solid #f59e0b;
      border-bottom: 1px solid rgba(245, 158, 11, 0.4);
      transform: rotate(-0.3deg);
    }

    /* Hover effects - lift the strip */
    .sentence-strip:hover {
      transform: translateY(-4px) rotate(0deg) !important;
      box-shadow: 
        0 8px 16px rgba(0, 0, 0, 0.3),
        0 4px 8px rgba(0, 0, 0, 0.2);
      z-index: 100 !important;
    }

    /* Active state - slightly raised */
    .sentence-strip.active {
      transform: translateY(-2px) !important;
      box-shadow: 
        0 6px 12px rgba(0, 0, 0, 0.25),
        0 3px 6px rgba(0, 0, 0, 0.15);
    }

    /* Hidden state - faded and pushed back */
    .sentence-strip.hidden-strip {
      opacity: 0.3;
      transform: scale(0.98) !important;
      pointer-events: none;
    }

    /* Linking word highlights */
    .sentence-strip .opener-highlight {
      color: #059669;
      font-weight: 700;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .sentence-strip .linking-highlight {
      color: #2563eb;
      font-weight: 700;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* SENTENCE MODAL */
    .sentence-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.85);
      background: rgba(20, 20, 22, 0.98);
      backdrop-filter: blur(40px);
      border: 1px solid var(--accent);
      border-radius: 1.5rem;
      padding: 2.5rem;
      max-width: 650px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 
        0 25px 60px rgba(0, 0, 0, 0.95),
        0 0 100px rgba(201, 169, 97, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.08);
      z-index: 10001;
      opacity: 0;
      pointer-events: none;
      transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .sentence-modal.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
      pointer-events: auto;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(12px);
      z-index: 10000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s;
    }

    .modal-backdrop.show {
      opacity: 1;
      pointer-events: auto;
    }

    .modal-linking-word {
      display: inline-block;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1rem;
      font-weight: 700;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 1.5rem;
      padding: 0.5rem 1rem;
      background: rgba(201, 169, 97, 0.15);
      border-radius: 999px;
      border: 1px solid rgba(201, 169, 97, 0.3);
    }

    .modal-sentence-display {
      font-size: 1.25rem;
      line-height: 1.8;
      color: #e5e7eb;
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 1rem;
      border-left: 4px solid var(--accent);
    }

    .modal-sentence-display .linking-word-highlight {
      color: #3b82f6;
      font-weight: 700;
      text-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
    }

    .modal-xray-mini {
      display: grid;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }

    .xray-mini-part {
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      border-left: 3px solid;
      font-size: 0.85rem;
      line-height: 1.6;
    }

    .xray-mini-label {
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.7;
      margin-bottom: 0.4rem;
      color: var(--accent);
    }

    /* Category colors */
    .xray-mini-topic { background: rgba(254, 243, 199, 0.15); border-color: #fef3c7; }
    .xray-mini-explain { background: rgba(167, 139, 250, 0.1); border-color: #a78bfa; }
    .xray-mini-reason { background: rgba(96, 165, 250, 0.1); border-color: #60a5fa; }
    .xray-mini-example { background: rgba(52, 211, 153, 0.1); border-color: #34d399; }
    .xray-mini-result { background: rgba(251, 146, 60, 0.1); border-color: #fb923c; }
    .xray-mini-reformulate { background: rgba(168, 85, 247, 0.1); border-color: #a855f7; }
    .xray-mini-compare { background: rgba(236, 72, 153, 0.1); border-color: #ec4899; }
    .xray-mini-contrast { background: rgba(239, 68, 68, 0.1); border-color: #ef4444; }

    .modal-close-btn {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #8e8e93;
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .modal-close-btn:hover {
      background: rgba(0, 0, 0, 0.6);
      color: #e5e7eb;
      border-color: rgba(255, 255, 255, 0.2);
      transform: rotate(90deg);
    }

    /* BOTTOM NAVIGATION */
    .bottom-nav {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 0.5rem;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .btn {
      min-height: 2.5rem;
      padding: 0 1.25rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      color: #e5e5e7;
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn:hover:not(.btn-disabled) {
      background: rgba(0, 0, 0, 0.5);
      border-color: rgba(201, 169, 97, 0.3);
      transform: translateY(-1px);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent) 0%, #fef9c3 100%);
      color: #111827;
      border-color: var(--accent);
      box-shadow: 0 3px 10px var(--accent-soft);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #d4b46e 0%, #fef9c3 100%);
      box-shadow: 0 4px 12px var(--accent-soft);
      transform: translateY(-2px);
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .btn-disabled {
      opacity: 0.3;
      cursor: not-allowed;
      box-shadow: none;
    }

    .btn-small {
      padding: 0 0.9rem;
      min-height: 2.25rem;
    }

    /* MODAL */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      z-index: 9999;
    }

    .modal-overlay.show { display: flex; }

    .modal-content {
      position: relative;
      background: rgba(20, 20, 22, 0.95);
      backdrop-filter: blur(40px) saturate(150%);
      -webkit-backdrop-filter: blur(40px) saturate(150%);
      border-radius: 1.5rem;
      padding: 2rem;
      max-width: 700px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow:
        0 25px 50px rgba(0, 0, 0, 0.9),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }

    .modal-title {
      font-family: 'Space Grotesk', serif;
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: #C9A961;
      text-transform: uppercase;
      text-align: center;
    }

    .modal-option {
      display: flex;
      align-items: start;
      gap: 1rem;
      margin-bottom: 1rem;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 0.75rem;
      transition: all 0.3s;
    }

    .modal-option:hover {
      background: rgba(0, 0, 0, 0.5);
      border-color: rgba(255, 255, 255, 0.08);
    }

    .option-number {
      font-weight: 700;
      color: #C9A961;
      min-width: 2rem;
    }

    .option-text {
      flex: 1;
      color: #e5e7eb;
      line-height: 1.6;
    }

    .use-btn {
      padding: 0.5rem 1rem;
      border-radius: 999px;
      background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
      color: #000;
      border: none;
      font-size: 0.75rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      white-space: nowrap;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .use-btn:hover {
      background: linear-gradient(135deg, #34d399 0%, #6ee7b7 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      color: #8e8e93;
      font-size: 1.25rem;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      background: rgba(0, 0, 0, 0.6);
      color: #e5e5e7;
      border-color: rgba(255, 255, 255, 0.15);
    }

    /* OPENER MODAL - CENTERED LIKE ESSAY PLAN */
    .opener-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      z-index: 10000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      animation: fadeIn 0.3s ease;
    }

    .opener-modal-overlay.show {
      display: flex;
    }

    .opener-modal-content {
      background: rgba(20, 20, 22, 0.95);
      backdrop-filter: blur(30px);
      border-radius: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.08);
      max-width: 500px;
      width: 100%;
      max-height: 70vh;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.9);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .opener-modal-header {
      padding: 1.5rem 2rem;
      background: rgba(0, 0, 0, 0.3);
      border-bottom: 1px solid rgba(84, 84, 88, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .opener-modal-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.25rem;
      font-weight: 700;
      color: #C9A961;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .opener-modal-close {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #8e8e93;
      font-size: 1.25rem;
      cursor: pointer;
      transition: all 0.3s;
    }

    .opener-modal-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #e5e5e7;
    }

    .opener-modal-body {
      padding: 1.5rem;
      max-height: calc(70vh - 100px);
      overflow-y: auto;
    }

    .opener-option {
      width: 100%;
      text-align: left;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.05);
      padding: 1rem 1.25rem;
      margin-bottom: 0.75rem;
      font-size: 0.9rem;
      color: #e5e7eb;
      cursor: pointer;
      border-radius: 0.75rem;
      transition: all 0.3s;
      display: block;
    }

    .opener-option:hover {
      background: rgba(201, 169, 97, 0.15);
      border-color: rgba(201, 169, 97, 0.3);
      transform: translateX(4px);
    }

    .opener-option:last-child {
      margin-bottom: 0;
    }

    /* OPENER CATEGORIES */
    .opener-category {
      margin-bottom: 1.5rem;
    }

    .opener-category:last-child {
      margin-bottom: 0;
    }

    .opener-category-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 0.75rem;
      font-weight: 700;
      color: #C9A961;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(201, 169, 97, 0.2);
    }

    .opener-category-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    /* READ MODE CHEVRON INFOGRAPHIC */
    .chevron-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0;
      flex-wrap: wrap;
      padding: 2rem 1rem;
      max-width: 100%;
    }

    .chevron-step {
      position: relative;
      min-width: 180px;
      height: 140px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1rem 2rem 1rem 2.5rem;
      clip-path: polygon(0 0, calc(100% - 20px) 0, 100% 50%, calc(100% - 20px) 100%, 0 100%, 20px 50%);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .chevron-step:first-child {
      clip-path: polygon(0 0, calc(100% - 20px) 0, 100% 50%, calc(100% - 20px) 100%, 0 100%);
      padding-left: 1.5rem;
    }

    .chevron-step:last-child {
      clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%, 20px 50%);
      padding-right: 1.5rem;
    }

    .chevron-step.active {
      transform: scale(1.05);
      z-index: 10;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
    }

    .chevron-step:hover:not(.inactive) {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
    }

    /* Chevron colors */
    .chevron-opener { background: linear-gradient(135deg, #10b981 0%, #34d399 100%); }
    .chevron-topic { background: linear-gradient(135deg, #fbbf24 0%, #fcd34d 100%); }
    .chevron-explain { background: linear-gradient(135deg, #a78bfa 0%, #c4b5fd 100%); }
    .chevron-reason { background: linear-gradient(135deg, #60a5fa 0%, #93c5fd 100%); }
    .chevron-example { background: linear-gradient(135deg, #34d399 0%, #6ee7b7 100%); }
    .chevron-result { background: linear-gradient(135deg, #fb923c 0%, #fdba74 100%); }
    .chevron-reformulate { background: linear-gradient(135deg, #a855f7 0%, #c084fc 100%); }
    .chevron-compare { background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%); }
    .chevron-contrast { background: linear-gradient(135deg, #ef4444 0%, #f87171 100%); }
    .chevron-inactive { background: linear-gradient(135deg, #52525b 0%, #71717a 100%); opacity: 0.4; }

    .chevron-number {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 2rem;
      font-weight: 800;
      color: rgba(0, 0, 0, 0.3);
      margin-bottom: 0.25rem;
    }

    .chevron-label {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: rgba(0, 0, 0, 0.8);
      text-align: center;
    }

    .chevron-icon {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      font-size: 1.5rem;
      opacity: 0.3;
    }

    /* READ MODE TEXT DISPLAY */
    .read-text-display {
      margin-top: 2rem;
      padding: 2rem;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 1rem;
      border-left: 4px solid var(--accent);
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }

    .read-text-content {
      font-size: 1.1rem;
      line-height: 1.8;
      color: #e5e7eb;
    }

    /* Mobile chevrons */
    @media (max-width: 768px) {
      .chevron-container {
        flex-direction: column;
        padding: 1rem 0.5rem;
      }

      .chevron-step {
        width: 100%;
        min-width: unset;
        height: 80px;
        clip-path: polygon(0 0, 100% 0, calc(100% - 15px) 50%, 100% 100%, 0 100%);
        padding: 0.75rem 1.5rem;
        margin-bottom: 0.5rem;
      }

      .chevron-step:first-child {
        clip-path: polygon(0 0, 100% 0, calc(100% - 15px) 50%, 100% 100%, 0 100%);
      }

      .chevron-step:last-child {
        clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);
        margin-bottom: 0;
      }

      .chevron-number {
        font-size: 1.5rem;
      }

      .chevron-label {
        font-size: 0.65rem;
      }

      .read-text-display {
        padding: 1.5rem;
        margin-top: 1.5rem;
      }

      .read-text-content {
        font-size: 0.95rem;
      }
    }
    @media (max-width: 768px) {
      body {
        padding: 0.4rem;
        padding-top: 0.4rem;
      }

      .container {
        padding: 0;
      }

      .back-btn {
        top: 0.4rem;
        left: 0.4rem;
        padding: 0.3rem 0.5rem;
        font-size: 0.55rem;
      }

      .header {
        padding: 0.4rem 0.6rem;
        margin-bottom: 0.5rem;
      }

      .brand-logo {
        font-size: 1rem;
        margin-bottom: 0.1rem;
      }

      .brand-subtitle {
        font-size: 0.55rem;
      }

      .card {
        padding: 0.75rem;
        gap: 0.4rem;
      }

      .presentation-area {
        padding: 1.5rem 1rem;
        min-height: 280px;
        gap: 1rem;
      }

      .poster-text {
        font-size: 1.5rem;
      }

      .nav-dot {
        width: 10px;
        height: 10px;
        border: 1px solid rgba(255, 255, 255, 0.15);
      }

      .btn {
        min-height: 2.25rem;
        font-size: 0.65rem;
        padding: 0 0.85rem;
      }

      .btn-small {
        padding: 0 0.65rem;
        min-height: 2rem;
      }

      .chip {
        font-size: 0.7rem;
        padding: 0.35rem 0.6rem;
      }

      .chip-emoji {
        font-size: 0.85rem;
      }

      .xray-part {
        padding: 0.85rem;
        margin-bottom: 0.65rem;
      }

      .xray-text {
        font-size: 0.85rem;
        line-height: 1.5;
      }

      .xray-label {
        font-size: 0.6rem;
        margin-bottom: 0.4rem;
      }

      .infographic-container {
        min-height: 600px;
        padding: 2rem 0.5rem;
      }

      .central-sentence {
        padding: 1.5rem 1.75rem;
        max-width: 320px;
      }

      .central-sentence-text {
        font-size: 1.1rem;
      }

      .linking-pill {
        padding: 0.65rem 1.2rem;
        font-size: 0.75rem;
      }

      /* Tighter orbital positions */
      .linking-pill:nth-child(3) { top: 5%; left: 5%; }
      .linking-pill:nth-child(4) { top: 8%; right: 5%; }
      .linking-pill:nth-child(5) { bottom: 12%; left: 5%; }
      .linking-pill:nth-child(6) { bottom: 10%; right: 8%; }
      .linking-pill:nth-child(7) { top: 40%; left: 2%; }
      .linking-pill:nth-child(8) { top: 42%; right: 2%; }

      .sentence-modal {
        padding: 2rem 1.5rem;
        width: 95%;
      }

      .modal-sentence-display {
        font-size: 1.05rem;
      }
    }
  </style>
</head>
<body>

<button class="back-btn" id="backBtn">
  <span>←</span>
  <span id="backText">Back</span>
</button>

<div class="container">
  <!-- HEADER -->
  <header class="header">
    <div class="brand-logo">INTUITY</div>
    <div class="brand-subtitle">Paragraph Builder</div>
  </header>

  <!-- MAIN CARD -->
  <main class="card">
    <!-- TOP BAR -->
    <div class="card-top">
      <!-- MODE TOGGLE -->
      <div class="mode-toggle">
        <button class="mode-btn" data-mode="read">Read</button>
        <button class="mode-btn active" data-mode="infographic">Explore</button>
        <button class="mode-btn" data-mode="build">Build</button>
      </div>

      <!-- X-RAY TOGGLE -->
      <button class="xray-btn" id="xrayBtn">X-Ray</button>
    </div>

    <!-- NAVIGATION DOTS (READ MODE) -->
    <div class="nav-section" id="navSection" style="display: none;">
      <div class="nav-dots" id="navDots"></div>
    </div>

    <!-- PRESENTATION AREA -->
    <section class="presentation-area" id="presentationArea">
      Loading...
    </section>

    <!-- BOTTOM NAVIGATION -->
    <div class="bottom-nav" id="bottomNav"></div>
  </main>
</div>

<!-- TRANSFORM MODAL -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal()">×</button>
    <h2 class="modal-title" id="modalTitle">Select Option</h2>
    <div id="modalOptions"></div>
  </div>
</div>

<!-- OPENER MODAL -->
<div class="opener-modal-overlay" id="openerModal" onclick="closeOpenerModal(event)">
  <div class="opener-modal-content" onclick="event.stopPropagation()">
    <div class="opener-modal-header">
      <div class="opener-modal-title">
        <span>✏️</span>
        <span>Choose an Opener</span>
      </div>
      <button class="opener-modal-close" onclick="closeOpenerModal()">&times;</button>
    </div>
    <div class="opener-modal-body" id="openerModalBody"></div>
  </div>
</div>

<!-- INFOGRAPHIC SENTENCE MODAL -->
<div class="modal-backdrop" id="modalBackdrop" onclick="closeInfographicModal()"></div>
<div class="sentence-modal" id="sentenceModal">
  <button class="modal-close-btn" onclick="closeInfographicModal()">×</button>
  <div class="modal-linking-word" id="modalLinkingWord"></div>
  <div class="modal-sentence-display" id="modalSentenceDisplay"></div>
  <div class="modal-xray-mini" id="modalXrayMini"></div>
</div>

<script>
// ==================== DATA ====================
let sentencesData = [];
let openersByType = {};
let readModeSamples = [];

const linkingWords = [
  'For example', 'For instance', 'However', 'Therefore', 'Thus', 'Hence',
  'As a result', 'Consequently', 'Moreover', 'Furthermore', 'In addition',
  'Nevertheless', 'Nonetheless', 'On the other hand', 'In contrast',
  'Similarly', 'Likewise', 'In fact', 'Indeed', 'Specifically',
  'This is because', 'This happens because', 'Given that', 'Since',
  'Although', 'While', 'Whereas', 'By comparison', 'Compared to',
  'Unlike', 'In other words', 'That is to say', 'Namely', 'Put simply',
  'To say it another way'
];

const linkingCategories = {
  explain: ['This means', 'This helps', 'This allows', 'This gives'],
  reason: ['This is because', 'Since', 'Given that', 'Because'],
  example: ['For example', 'For instance', 'Specifically', 'Such as'],
  result: ['As a result', 'Therefore', 'Consequently', 'Thus', 'Hence'],
  reformulate: ['In other words', 'Put simply', 'To say it another way', 'That is to say'],
  compare: ['Compared to', 'Similarly', 'Likewise', 'Unlike'],
  contrast: ['However', 'On the other hand', 'In contrast', 'Nevertheless', 'Nonetheless']
};

// ==================== STATE ====================
let mode = 'infographic';
let currentSentenceIndex = 0;
let usedTransforms = {};
let paragraphText = '';
let currentOpener = '';
let showXRay = false;

// READ MODE SPECIFIC STATE
let readDotIndex = 0;
let readParagraphSteps = [];

// ==================== DATA LOADING ====================
async function loadSentencesFromJSON() {
  try {
    const response = await fetch('data/transformations.json');
    const data = await response.json();
    sentencesData = data.sentences;
    console.log('✓ Sentences loaded:', sentencesData.length, 'sentences');
    return true;
  } catch (error) {
    console.error('✗ Error loading sentences:', error);
    document.getElementById('presentationArea').innerHTML = `
      <div style="text-align: center; padding: 2rem; color: #fb923c;">
        <p style="font-size: 1.2rem; margin-bottom: 1rem;">⚠️ Data Loading Error</p>
        <p style="color: #8e8e93;">Could not load transformations.json</p>
      </div>
    `;
    return false;
  }
}

async function loadOpenersFromJSON() {
  try {
    const response = await fetch('data/transformations-opener-sets.json');
    const data = await response.json();
    openersByType = data;
    console.log('✓ Openers loaded:', Object.keys(openersByType).length, 'categories');
    return true;
  } catch (error) {
    console.error('✗ Error loading openers:', error);
    return false;
  }
}

async function loadReadModeSamples() {
  try {
    const response = await fetch('data/transformations-read-mode.json');
    const data = await response.json();
    readModeSamples = data.samples || [];
    console.log('✓ READ mode samples loaded:', readModeSamples.length, 'samples');
    return true;
  } catch (error) {
    console.error('✗ Error loading READ mode samples:', error);
    return false;
  }
}

function getCurrentOpeners() {
  const allOpeners = [];
  for (const key in openersByType) {
    if (openersByType[key].openers) {
      allOpeners.push(...openersByType[key].openers);
    }
  }
  return allOpeners;
}
  
function getRandomSentence() {
  if (!sentencesData || sentencesData.length === 0) return null;
  const randomIndex = Math.floor(Math.random() * sentencesData.length);
  return sentencesData[randomIndex];
}

// ==================== INFOGRAPHIC MODE ====================
function renderInfographic() {
  const sentence = sentencesData[currentSentenceIndex];
  const baseSentence = sentence.base;
  
  // Define only linking words that work properly across all categories
  const properLinkingWords = {
    explain: ['This means', 'This helps', 'This allows'],
    reason: ['This is because', 'Since', 'Because'],
    example: ['For example', 'For instance', 'Such as'],
    result: ['As a result', 'Therefore', 'Thus', 'Consequently'],
    reformulate: ['In other words', 'Put simply'],
    compare: ['Compared to', 'Similarly', 'Unlike'],
    contrast: ['However', 'On the other hand', 'In contrast']
  };
  
  // Select 6 random linking words from different categories
  const selectedWords = [];
  const categories = Object.keys(properLinkingWords);
  
  categories.forEach(cat => {
    const words = properLinkingWords[cat];
    const randomWord = words[Math.floor(Math.random() * words.length)];
    selectedWords.push({ word: randomWord, category: cat });
  });
  
  // Shuffle and take 6
  const shuffled = selectedWords.sort(() => Math.random() - 0.5).slice(0, 6);
  
  let html = '<div class="infographic-container">';
  
  // SVG Connection Lines
  html += '<svg class="connection-line">';
  shuffled.forEach((item, i) => {
    const positions = [
      { x1: '15%', y1: '15%' },
      { x1: '85%', y1: '20%' },
      { x1: '12%', y1: '75%' },
      { x1: '88%', y1: '80%' },
      { x1: '8%', y1: '50%' },
      { x1: '92%', y1: '55%' }
    ];
    html += `<line x1="${positions[i].x1}" y1="${positions[i].y1}" x2="50%" y2="50%" />`;
  });
  html += '</svg>';
  
  // Central Sentence
  html += `
    <div class="central-sentence">
      <div class="central-sentence-text">${baseSentence}</div>
    </div>
  `;
  
  // Floating Pills
  shuffled.forEach((item, index) => {
    html += `
      <div class="linking-pill" onclick="showSentenceWithLinking('${item.category}', '${item.word.replace(/'/g, "\\'")}')">
        ${item.word}
      </div>
    `;
  });
  
  html += '</div>';
  
  return html;
}

function showSentenceWithLinking(category, linkingWord) {
  const sentence = sentencesData[currentSentenceIndex];
  const baseSentence = sentence.base;
  const options = sentence[category] || [];
  
  if (options.length === 0) return;
  
  // Pick random option from category
  const expansion = options[Math.floor(Math.random() * options.length)];
  
  // Build full sentence with the clicked linking word
  // Replace the first word(s) of expansion with our clicked linking word if needed
  let modifiedExpansion = expansion;
  
  // Check if expansion starts with a linking word from the same category
  const categoryWords = linkingCategories[category] || [];
  for (const catWord of categoryWords) {
    if (expansion.toLowerCase().startsWith(catWord.toLowerCase())) {
      // Replace it with the clicked linking word
      modifiedExpansion = linkingWord + expansion.substring(catWord.length);
      break;
    }
  }
  
  const fullSentence = `${baseSentence} ${modifiedExpansion}`;
  
  // Build modal content
  document.getElementById('modalLinkingWord').textContent = linkingWord;
  
  // Highlight the linking word in the sentence
  const highlightedSentence = fullSentence.replace(
    new RegExp(`\\b(${linkingWord})\\b`, 'gi'),
    '<span class="linking-word-highlight">$1</span>'
  );
  document.getElementById('modalSentenceDisplay').innerHTML = highlightedSentence;
  
  // Clear X-Ray section (not needed - less is better)
  document.getElementById('modalXrayMini').innerHTML = '';
  
  // Show modal
  document.getElementById('modalBackdrop').classList.add('show');
  document.getElementById('sentenceModal').classList.add('show');
}

function closeInfographicModal() {
  document.getElementById('modalBackdrop').classList.remove('show');
  document.getElementById('sentenceModal').classList.remove('show');
}

// ==================== READ MODE LOGIC ====================
function generateReadModeParagraph() {
  if (readModeSamples && readModeSamples.length > 0) {
    const sample = readModeSamples[currentSentenceIndex];
    if (sample && sample.steps) {
      return sample.steps.map(step => step.text);
    }
  }
  
  const sentence = sentencesData[currentSentenceIndex];
  const transforms = getTransforms();
  
  const shuffled = [...transforms].sort(() => Math.random() - 0.5);
  const selected = shuffled.slice(0, 3);
  
  const steps = [];
  
  const opener = getCurrentOpeners()[Math.floor(Math.random() * getCurrentOpeners().length)];
  const topicWithOpener = opener + ' ' + sentence.base.charAt(0).toLowerCase() + sentence.base.slice(1);
  steps.push(topicWithOpener);
  
  let building = topicWithOpener;
  selected.forEach(transform => {
    const options = sentence[transform] || [];
    if (options.length > 0) {
      const randomOption = options[Math.floor(Math.random() * options.length)];
      building += ' ' + randomOption;
      steps.push(building);
    }
  });
  
  return steps;
}

// ==================== LOGIC ====================
function getTransforms() {
  return ['explain', 'reason', 'example', 'result', 'reformulate', 'compare', 'contrast'];
}

function resetParagraph() {
  const sentence = getRandomSentence();
  if (sentence) {
    paragraphText = sentence.base;
    currentSentenceIndex = sentencesData.indexOf(sentence);
  }
  usedTransforms = {};
  currentOpener = '';
  
  readDotIndex = 0;
  readParagraphSteps = generateReadModeParagraph();
}

function highlightLinkingWords(text) {
  if (!text) return '';
  const pattern = new RegExp(`\\b(${linkingWords.join('|')})\\b`, 'gi');
  return text.replace(pattern, '<span class="linking-highlight">$1</span>');
}

function addSentence(transform, index) {
  if (usedTransforms[transform]) return;
  const currentSentence = sentencesData[currentSentenceIndex];
  const sentenceArray = currentSentence[transform] || [];
  const sentence = sentenceArray[index];
  if (!sentence) return;
  paragraphText = (paragraphText.trim() + ' ' + sentence).trim();
  usedTransforms = { ...usedTransforms, [transform]: true };
  closeModal();
  render();
}

function getFullParagraph() {
  const currentSentence = sentencesData[currentSentenceIndex];
  const base = currentSentence.base;
  let additional = paragraphText.replace(base, '').trim();
  let full = base;
  if (additional) full = base + ' ' + additional;
  if (currentOpener && full) {
    full = currentOpener + ' ' + full.charAt(0).toLowerCase() + full.slice(1);
  }
  return full;
}

function copyText() {
  const text = mode === 'build'
    ? getFullParagraph()
    : (readParagraphSteps[readParagraphSteps.length - 1] || '');
  navigator.clipboard.writeText(text).catch(() => {});
}

function analyzeParagraphStructure() {
  const parts = [];
  const currentSentence = sentencesData[currentSentenceIndex];
  const base = currentSentence.base;

  if (currentOpener) {
    parts.push({
      type: 'opener',
      text: currentOpener,
      color: 'xray-opener',
      label: 'OPENER'
    });
  }

  parts.push({
    type: 'topic',
    text: base,
    color: 'xray-topic',
    label: 'TOPIC SENTENCE'
  });

  const colors = {
    explain: { color: 'xray-explain', label: 'EXPLANATION' },
    reason: { color: 'xray-reason', label: 'REASON' },
    example: { color: 'xray-example', label: 'EXAMPLE' },
    result: { color: 'xray-result', label: 'RESULT' },
    reformulate: { color: 'xray-reformulate', label: 'REFORMULATION' },
    compare: { color: 'xray-compare', label: 'COMPARISON' },
    contrast: { color: 'xray-contrast', label: 'CONTRAST' }
  };

  Object.keys(usedTransforms).forEach(transform => {
    const sentences = currentSentence[transform];
    if (!sentences) return;
    const matchedSentence = sentences.find(s => paragraphText.includes(s));
    if (matchedSentence) {
      parts.push({
        type: transform,
        text: matchedSentence,
        ...colors[transform]
      });
    }
  });

  return parts;
}

function analyzeReadParagraph(paragraph) {
  const sentences = paragraph.split(/(?<=[.!?])\s+/).filter(s => s.trim());
  
  return sentences.map((sentence, i) => {
    let type = 'supporting';
    let color = 'xray-explain';
    let label = 'SUPPORTING';
    const s = sentence.toLowerCase();

    if (i === 0) {
      const hasOpener = getCurrentOpeners().some(opener => 
        sentence.toLowerCase().startsWith(opener.toLowerCase())
      );
      
      if (hasOpener) {
        type = 'opener+topic';
        color = 'xray-opener';
        label = 'OPENER + TOPIC';
      } else {
        type = 'topic';
        color = 'xray-topic';
        label = 'TOPIC SENTENCE';
      }
    } else if (/for example|for instance/i.test(s)) {
      type = 'example';
      color = 'xray-example';
      label = 'EXAMPLE';
    } else if (/this is because|this happens because|given that|since/i.test(s)) {
      type = 'reason';
      color = 'xray-reason';
      label = 'REASON';
    } else if (/therefore|thus|as a result|consequently|ultimately/i.test(s)) {
      type = 'result';
      color = 'xray-result';
      label = 'RESULT';
    } else if (/in other words|put simply|to say it another way/i.test(s)) {
      type = 'reformulate';
      color = 'xray-reformulate';
      label = 'REFORMULATION';
    } else if (/compared to|unlike|in contrast to/i.test(s)) {
      type = 'compare';
      color = 'xray-compare';
      label = 'COMPARISON';
    } else if (/however|on the other hand|in contrast/i.test(s)) {
      type = 'contrast';
      color = 'xray-contrast';
      label = 'CONTRAST';
    } else {
      type = 'explain';
      color = 'xray-explain';
      label = 'EXPLANATION';
    }

    return {
      type,
      text: sentence,
      color,
      label
    };
  });
}

// ==================== RENDER ====================
function renderContent() {
  if (mode === 'infographic') {
    return renderInfographic();
  }
  
  if (mode === 'read') {
    if (!showXRay) {
      // Unified paragraph with color-shifted floating sentences
      let html = '<div class="unified-paragraph-container">';
      
      readParagraphSteps.forEach((step, index) => {
        const isActive = index === readDotIndex;
        const isVisible = index <= readDotIndex;
        
        // Determine sentence content
        let sentenceText = '';
        if (index === 0) {
          // Base sentence
          sentenceText = step;
        } else {
          // Extract only new clause added in this step
          const previousStep = readParagraphSteps[index - 1];
          sentenceText = step.substring(previousStep.length).trim();
        }
        
        // Find opener/linking words
        const openers = getCurrentOpeners();
        let hasOpener = false;
        for (const opener of openers) {
          if (sentenceText.toLowerCase().startsWith(opener.toLowerCase())) {
            hasOpener = true;
            break;
          }
        }
        
        // Apply color class based on position
        const stripClass = index === 0 ? 'strip-base' : `strip-expansion-${Math.min(index, 4)}`;
        
        html += `
          <div class="sentence-strip ${stripClass} ${isActive ? 'active' : ''} ${!isVisible ? 'hidden-strip' : ''}" 
               onclick="jumpToReadStep(${index})">
            ${hasOpener && index === 0 ? 
              sentenceText.replace(/^(\w+(?:\s+\w+){0,3})/i, '<span class="opener-highlight">$1</span>') : 
              highlightLinkingWords(sentenceText)
            }
          </div>
        `;
      });
      
      html += '</div>';
      return html;
    } else {
      // X-Ray mode
      const currentParagraph = readParagraphSteps[readDotIndex] || readParagraphSteps[0];
      const parts = analyzeReadParagraph(currentParagraph);
      return parts.map(part => `
        <div class="${part.color} xray-part">
          <div class="xray-label">${part.label}</div>
          <div class="xray-text">${part.text}</div>
        </div>
      `).join('');
    }
  } else {
    // BUILD MODE
    const currentSentence = sentencesData[currentSentenceIndex];
    const base = currentSentence.base;
    const additional = paragraphText !== base ? paragraphText.replace(base, '').trim() : '';

    if (!showXRay) {
      let html = '<div class="poster-text">';
      
      if (currentOpener) {
        html += `<span class="opener-highlight">${currentOpener}</span> ${base.charAt(0).toLowerCase() + base.slice(1)}`;
      } else {
        html += base;
      }
      
      if (additional) {
        html += ' ' + highlightLinkingWords(additional);
      }
      
      html += '</div>';
      
      const usedKeys = Object.keys(usedTransforms);
      if (usedKeys.length > 0) {
        html += '<div class="support-chips">';
        usedKeys.forEach(key => {
          const emojis = {
            explain: '💡',
            reason: '🔍',
            example: '📝',
            result: '✨',
            reformulate: '🔄',
            compare: '⚖️',
            contrast: '🔀'
          };
          html += `<div class="chip"><span class="chip-emoji">${emojis[key] || '📌'}</span><span>${key}</span></div>`;
        });
        html += '</div>';
      }
      
      return html;
    } else {
      const parts = analyzeParagraphStructure();
      return parts.map(part => `
        <div class="${part.color} xray-part">
          <div class="xray-label">${part.label}</div>
          <div class="xray-text">${part.text}</div>
        </div>
      `).join('');
    }
  }
}

function renderBottomNav() {
  const bottomNav = document.getElementById('bottomNav');
  
  if (mode === 'infographic') {
    bottomNav.innerHTML = `
      <button class="btn btn-primary" onclick="newSentence()">
        <span>🔄</span>
        <span>New Topic</span>
      </button>
    `;
    return;
  }
  
  if (mode === 'read') {
    const prevDisabled = readDotIndex === 0 ? 'btn-disabled' : '';
    const nextDisabled = readDotIndex === readParagraphSteps.length - 1 ? 'btn-disabled' : '';
    
    bottomNav.innerHTML = `
      <button class="btn btn-small ${prevDisabled}" onclick="prevReadStep()">
        <span>←</span>
        <span>Back</span>
      </button>
      <button class="btn" onclick="copyText()">
        <span>📋</span>
        <span>Copy</span>
      </button>
      <button class="btn btn-primary" onclick="newSentence()">
        <span>🔄</span>
        <span>New</span>
      </button>
      <button class="btn btn-small ${nextDisabled}" onclick="nextReadStep()">
        <span>Next</span>
        <span>→</span>
      </button>
    `;
  } else {
    const transforms = getTransforms();
    let html = '<button class="btn" onclick="copyText()"><span>📋</span><span>Copy</span></button>';
    html += '<button class="btn" onclick="showOpenerMenu(event)"><span>✏️</span><span>Opener</span></button>';
    
    transforms.forEach(t => {
      const disabled = usedTransforms[t] ? 'btn-disabled' : '';
      const emojis = {
        explain: '💡',
        reason: '🔍',
        example: '📝',
        result: '✨',
        reformulate: '🔄',
        compare: '⚖️',
        contrast: '🔀'
      };
      html += `<button class="btn ${disabled}" onclick="openTransformModal('${t}')"><span>${emojis[t]}</span><span>${t}</span></button>`;
    });
    
    html += '<button class="btn btn-primary" onclick="resetParagraph();render()"><span>🔄</span><span>Fresh</span></button>';
    bottomNav.innerHTML = html;
  }
}

function buildDots() {
  const navDots = document.getElementById('navDots');
  navDots.innerHTML = '';
  
  for (let i = 0; i < readParagraphSteps.length; i++) {
    const dot = document.createElement('div');
    dot.className = 'nav-dot';
    dot.addEventListener('click', () => {
      readDotIndex = i;
      render();
    });
    navDots.appendChild(dot);
  }
}

// ==================== READ MODE NAVIGATION ====================
function nextReadStep() {
  if (readDotIndex < readParagraphSteps.length - 1) {
    readDotIndex++;
    render();
  }
}

function prevReadStep() {
  if (readDotIndex > 0) {
    readDotIndex--;
    render();
  }
}

function jumpToReadStep(index) {
  readDotIndex = index;
  render();
}

function jumpToReadStep(index) {
  if (index < readParagraphSteps.length) {
    readDotIndex = index;
    render();
  }
}

// ==================== BUILD MODE FUNCTIONS ====================
function showOpenerMenu(event) {
  const modalBody = document.getElementById('openerModalBody');
  
  let html = '';
  let globalIndex = 0;
  
  for (const key in openersByType) {
    const category = openersByType[key];
    
    if (category.openers && category.openers.length > 0) {
      const categoryTitle = category.description || category.label || key;
      html += `
        <div class="opener-category">
          <div class="opener-category-title">${categoryTitle}</div>
          <div class="opener-category-list">
      `;
      
      category.openers.forEach(opener => {
        html += `
          <button class="opener-option" onclick="selectOpener(${globalIndex})">${opener}…</button>
        `;
        globalIndex++;
      });
      
      html += `
          </div>
        </div>
      `;
    }
  }
  
  modalBody.innerHTML = html;
  document.getElementById('openerModal').classList.add('show');
}

function closeOpenerModal(event) {
  if (!event || event.target.id === 'openerModal') {
    document.getElementById('openerModal').classList.remove('show');
  }
}

function selectOpener(index) {
  const openers = getCurrentOpeners();
  currentOpener = openers[index];
  closeOpenerModal();
  render();
}

function newSentence() {
  resetParagraph();
  render();
}

function render() {
  document.querySelectorAll('.mode-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.mode === mode);
  });

  const navSection = document.getElementById('navSection');
  navSection.style.display = mode === 'read' ? 'flex' : 'none';

  document.getElementById('xrayBtn').textContent = showXRay ? 'Normal' : 'X-Ray';
  
  document.getElementById('presentationArea').innerHTML = renderContent();
  
  renderBottomNav();
  
  if (mode === 'read') {
    const dots = document.querySelectorAll('.nav-dot');
    dots.forEach((dot, index) => {
      dot.classList.toggle('active', index === readDotIndex);
    });
  }
}

function openTransformModal(transform) {
  if (usedTransforms[transform]) return;
  const currentSentence = sentencesData[currentSentenceIndex];
  const options = currentSentence[transform] || [];
  
  document.getElementById('modalTitle').textContent = transform.toUpperCase();
  const modalOptions = document.getElementById('modalOptions');
  modalOptions.innerHTML = options.map((option, i) => `
    <div class="modal-option">
      <span class="option-number">${i + 1}.</span>
      <span class="option-text">${option}</span>
      <button class="use-btn" onclick="addSentence('${transform}', ${i})">➕ Use</button>
    </div>
  `).join('');
  
  document.getElementById('modalOverlay').classList.add('show');
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('show');
}

// ==================== EVENT LISTENERS ====================
document.querySelectorAll('.mode-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    mode = btn.dataset.mode;
    showXRay = false;
    if (mode === 'read') {
      readDotIndex = 0;
      buildDots();
    }
    render();
  });
});

document.getElementById('xrayBtn').addEventListener('click', () => {
  showXRay = !showXRay;
  render();
});

document.getElementById('modalOverlay').addEventListener('click', (e) => {
  if (e.target.id === 'modalOverlay') closeModal();
});

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeModal();
    closeOpenerModal();
    closeInfographicModal();
  }
  
  if (mode === 'read' && !showXRay) {
    if (e.key === 'ArrowRight') nextReadStep();
    if (e.key === 'ArrowLeft') prevReadStep();
  }
});
  
// ==================== INITIALIZE ====================
async function init() {
  document.getElementById('presentationArea').innerHTML = `
    <div style="text-align: center; padding: 2rem; color: #8e8e93;">
      <div style="font-size: 2rem; margin-bottom: 1rem;">⏳</div>
      <p style="font-size: 1.2rem;">Loading data...</p>
    </div>
  `;
  
  const [sentencesLoaded, openersLoaded, readModeLoaded] = await Promise.all([
    loadSentencesFromJSON(),
    loadOpenersFromJSON(),
    loadReadModeSamples()
  ]);
  
  if (sentencesLoaded && openersLoaded) {
    console.log('✅ All data loaded successfully');
    resetParagraph();
    buildDots();
    render();
  } else {
    console.error('❌ Failed to load required data files');
  }
}
  
// Dynamic back button setup
function setupBackButton() {
  const backBtn = document.getElementById('backBtn');
  const backText = document.getElementById('backText');
  const urlParams = new URLSearchParams(window.location.search);
  const from = urlParams.get('from');
  
  backBtn.addEventListener('click', () => {
    const referrer = document.referrer;
    
    if (from === 'essays' || referrer.includes('essay')) {
      window.location.href = '../../../index.html?openModal=writing&submenu=essays';
    } else {
      window.location.href = '../../../index.html?openModal=writing&submenu=sentence-structure';
    }
  });
  
  if (from === 'essays') {
    backText.textContent = 'Essays';
  } else {
    backText.textContent = 'Sentence Structure';
  }
}

window.addEventListener('DOMContentLoaded', setupBackButton);

init();
</script>
</body>
</html>
